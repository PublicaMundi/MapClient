/**
 * Author : Samuel Souk aloun
 *
 * Copyright (c) 2014 GeoLabs SARL
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 */

define(["xml2json","queryString","wpsPayload","utils"],function(e,t,n,r){var s=function(r){var s=new e({arrayAccessFormPaths:["ProcessDescriptions.ProcessDescription.DataInputs.Input","ProcessDescriptions.ProcessDescription.DataInputs.Input.ComplexData.Supported.Format","ProcessDescriptions.ProcessDescription.ProcessOutputs.Output","ProcessDescriptions.ProcessDescription.ProcessOutputs.Output.ComplexOutput.Supported.Format","Capabilities.ServiceIdentification.Keywords"]});this.debug=!1,this.url=r.url,this.version=r.version?r.version:"1.0.0",this.language=r.language?r.language:"en-US",this.statusLocation={},this.launched={},this.terminated={},this.percent={},this.delay=r.delay||2e3,this.getCapabilities=function(e){var t=this;e.hasOwnProperty("type")||(e.type="GET");var n={request:"GetCapabilities",service:"WPS",version:e.hasOwnProperty("version")?e.version:t.version};this.request(n,e.success,e.error,e.type)},this.describeProcess=function(e){var t=this;e.hasOwnProperty("type")||(e.type="GET");var n={Identifier:e.identifier,request:"DescribeProcess",service:"WPS",version:e.hasOwnProperty("version")?e.version:t.version};this.request(n,e.success,e.error,e.type)},this.convertParams=function(e){var t=this;t.debug&&(console.log("======== Execute "+e.identifier),console.log(e)),e.hasOwnProperty("type")||(e.type="GET");var n={request:"Execute",service:"WPS",version:e.hasOwnProperty("version")?e.version:t.version,Identifier:e.identifier,DataInputs:e.dataInputs?e.dataInputs:"",DataOutputs:e.dataOutputs?e.dataOutputs:""};return console.log(n),e.hasOwnProperty("responseDocument")&&(n.ResponseDocument=e.responseDocument),e.hasOwnProperty("mode")&&(n.mode=e.mode),e.hasOwnProperty("storeExecuteResponse")&&e.storeExecuteResponse&&(n.storeExecuteResponse="true"),e.hasOwnProperty("status")&&e.status&&(n.status="true"),e.hasOwnProperty("lineage")&&e.lineage&&(n.lineage="true"),n},this.buildRequest=function(e,t){var r=this;r.debug&&(console.log("======== REQUEST method="+t),console.log(e));var i=this.url,s,o;if(e.hasOwnProperty("DataOutputs"))for(var u=0;u<e.DataOutputs.length;u++)if(e.DataOutputs[u].type==="raw"){e.RawDataOutput=e.DataOutputs[u];break}return e.language=this.language,t=="GET"?i+="?"+this.getQueryString(e):t=="POST"&&(s=n.getPayload(e),r.debug&&(console.log("======== POST PAYLOAD ========"),console.log(s),console.log(e)),o={"Content-Type":"text/xml"}),r.debug&&console.log("ajax url: "+i),{url:i,headers:o,data:s,type:t}},this.getRequest=function(e){var t=this,n="GET";return e.hasOwnProperty("type")&&(n=e.type),t.buildRequest(t.convertParams(e),n)},this.execute=function(e){var t=this;this.request(t.convertParams(e),e.success,e.error,e.type)},this.request=function(e,t,n,r){var i=this,o;o=i.buildRequest(e,r),$.ajax(o).always(function(){}).fail(function(e,t,r){i.debug&&console.log("======== ERROR ========");var o=s.xml2json(e.responseXML);i.debug&&console.log(o),n&&n(o)}).done(function(n,r,o){i.debug&&(console.log("======== SUCCESS ========2"),console.log(n));var u=o.getResponseHeader("Content-Type").split(";")[0];if(u=="text/xml"){var a=n;n=s.xml2json(n),n._origin=a}var f,l=e.version?e.version:i.version;l=="1.0.0"?e.storeExecuteResponse=="true"&&e.status=="true"&&(f=i.parseStatusLocation(n),i.statusLocation[f.sid]=f.statusLocation,f.hasOwnProperty("sid")&&!i.launched.hasOwnProperty(f.sid)&&(i.launched[f.sid]=f.statusLocation)):e.mode=="async"&&(f=i.parseJobID(n),i.statusLocation[f.sid]=i.url+"?request=GetStatus&service=WPS&version=2.0.0&JobID="+f.jobid,f.hasOwnProperty("sid")&&!i.launched.hasOwnProperty(f.sid)&&(i.launched[f.sid]=f.jobid)),t&&t(n,f)})},this.watch=function(e,t){function n(i){s.debug&&(console.log("++++ getStatus SUCCESS "+e),console.log(i));if(i.StatusInfo||i.Result){if(i.Result){var o={sid:e,text:"",result:i};t.onProcessSucceeded instanceof Function&&t.onProcessSucceeded(o);return}if(i.StatusInfo.Status=="Running"){s.debug&&console.log("#### ProcessStarted");var u="";for(index=0;index<i._origin.childNodes[0].childNodes.length;index++)i._origin.childNodes[0].childNodes[index].nodeType==8&&(u=i._origin.childNodes[0].childNodes[index].textContent);var o={sid:e,percentCompleted:i.StatusInfo.PercentCompleted?i.StatusInfo.PercentCompleted:0,text:u,creationTime:""};t.onPercentCompleted instanceof Function&&t.onPercentCompleted(o)}else if(i.StatusInfo.Status=="Succeeded"){s.debug&&console.log("#### ProcessSucceeded");var a="";s.terminated[e]=!0,o={sid:e,text:a,result:i},s.getResult(e,n,r)}else s.debug&&console.log("#### UNHANDLED EXCEPTION"),s.terminated[e]=!0,o={sid:e,code:"BAD",text:"UNHANDLED EXCEPTION"},t.onError instanceof Function&&t.onError(o);return}if(i.ExecuteResponse.Status.ProcessAccepted){var o={sid:e,percentCompleted:0,text:i.ExecuteResponse.Status.ProcessAccepted.__text,creationTime:i.ExecuteResponse.Status._creationTime};s.percent[e]=o.percentCompleted,t.onPercentCompleted instanceof Function&&t.onPercentCompleted(o)}else if(i.ExecuteResponse.Status.ProcessStarted){s.debug&&console.log("#### ProcessStarted");var o={sid:e,percentCompleted:i.ExecuteResponse.Status.ProcessStarted._percentCompleted,text:i.ExecuteResponse.Status.ProcessStarted.__text,creationTime:i.ExecuteResponse.Status._creationTime};s.percent[e]=o.percentCompleted,t.onPercentCompleted instanceof Function&&t.onPercentCompleted(o)}else if(i.ExecuteResponse.Status.ProcessSucceeded){s.debug&&console.log("#### ProcessSucceeded");var a=i.ExecuteResponse.Status.ProcessSucceeded.__text;s.terminated[e]=!0,o={sid:e,text:a,result:i},t.onProcessSucceeded instanceof Function&&t.onProcessSucceeded(o)}else s.debug&&console.log("#### UNHANDLED EXCEPTION"),s.terminated[e]=!0,o={sid:e,code:"BAD",text:"UNHANDLED EXCEPTION"},t.onError instanceof Function&&t.onError(o)}function r(t){s.debug&&(console.log("++++ getStatus ERROR "+e),console.log(t))}function i(e){s.debug&&console.log("PING: "+e),s.getStatus(e,n,r),s.terminated[e]?s.debug&&console.log("++++ getStatus TERMINATED "+e):!s.percent.hasOwnProperty(e)||s.percent[e]<100?setTimeout(function(){i(e)},s.delay):s.debug&&console.log(s.percent)}var s=this;s.debug&&console.log("WATCH: "+e),i(e)},this.getStatus=function(e,t,n){var r=this;r.debug&&console.log("GET STATUS: "+e);if(r.terminated[e]){r.debug&&console.log("DEBUG TERMINATED");return}if(!r.launched[e]){r.debug&&console.log("DEBUG LAUNCHED");return}$.ajax({url:r.statusLocation[e]}).fail(function(e,t,i){r.debug&&console.log("======== ERROR ========");var o=s.xml2json(e.responseXML);r.debug&&console.log(o),n&&n(o)}).done(function(e,n,i){r.debug&&(console.log("======== SUCCESS ========2"),console.log(e));var o=i.getResponseHeader("Content-Type").split(";")[0];if(o=="text/xml"){var u=e;e=s.xml2json(e),e._origin=u}t&&t(e)})},this.getResult=function(e,t,n){var r=this;r.debug&&(console.log("GET STATUS: "+e),console.log(r.statusLocation[e].replace(/GetStatus/g,"GetResult"))),$.ajax({url:r.statusLocation[e].replace(/GetStatus/g,"GetResult")}).fail(function(e,t,i){r.debug&&console.log("======== ERROR ========");var o=s.xml2json(e.responseXML);r.debug&&console.log(o),n&&n(o)}).done(function(e,n,i){r.debug&&(console.log("======== SUCCESS ========2"),console.log(e));var o=i.getResponseHeader("Content-Type").split(";")[0];if(o=="text/xml"){var u=e;e=s.xml2json(e),e._origin=u}t&&t(e)})},this.getQueryString=function(e){var n=this,r="";serializeInputs=function(e){n.debug&&(console.log("SERIALIZE dataInputs"),console.log(e));var t=$.type(e);if(t==="string")return e;var r=[];for(var i in e)if(t==="array"){e[i].hasOwnProperty("href")?r.push(e[i].identifier+"=Reference"):r.push(e[i].identifier+"="+e[i].value);for(var s in e[i])s!="identifier"&&s!="value"&&s!="href"?r.push("@"+s+"="+e[i][s]):s=="href"&&r.push("@xlink:"+s+"="+encodeURIComponent(e[i][s]));r.push(";")}else e.hasOwnProperty(i)&&(i=="href"?r.push(i+"="+encodeURIComponent(e[i])):r.push(i+"="+e[i]));return r.join("")},serializeOutputs=function(e){n.debug&&(console.log("SERIALIZE dataOutputs"),console.log(e));var t=$.type(e);if(t==="string")return e;var r=[];for(var i in e){r.push(e[i].identifier);for(var s in e[i])s!="identifier"&&s!="type"&&r.push("@"+s+"="+e[i][s]);r.push(";")}return r.join("")};var i=e.ResponseDocument,s={},o=Object.keys||function(e){var t=[];for(var n in e)t.push(n);return t},u={DataInputs:!0,DataOutputs:!0,ResponseDocument:!0,RawDataOutput:!0},a=o(e);for(var f=0;f<a.length;f++){var l=a[f];if(u.hasOwnProperty(l)&&u[l])continue;e.hasOwnProperty(l)&&(s[l]=e[l])}r=t.stringify(s);if(e.hasOwnProperty("DataInputs")){var c=serializeInputs(e.DataInputs);n.debug&&console.log("dataInputs: "+c),r+="&DataInputs="+c}if(e.hasOwnProperty("DataOutputs")){var h=serializeOutputs(e.DataOutputs);n.debug&&console.log("dataOutputs: "+h);if(h!=""){var p=!0;for(var f=0;f<e.DataOutputs.length;f++)if(e.DataOutputs[f].type==="raw"){r+="&RawDataOutput="+h,p=!1;break}p&&(r+="&ResponseDocument="+h)}}else if(e.hasOwnProperty("RawDataOutput"))r+="&RawDataOutput="+e.RawDataOutput+";";else if(e.hasOwnProperty("ResponseDocument")){var d=$.type(e.ResponseDocument);if(d==="string")r+="&ResponseDocument="+e.ResponseDocument+";";else{var v=serializeOutputs(e.ResponseDocument);r+="&ResponseDocument="+tmp}}return r},this.parseStatusLocation=function(e){var t=this;if(statusLocation=e.ExecuteResponse._statusLocation){t.debug&&console.log("statusLocation: "+statusLocation);var n=0;for(i in t.statusLocation)n++;return{sid:n,statusLocation:statusLocation}}},this.parseJobID=function(e){var t=this;if(jobID=e.StatusInfo.JobID){var n=0;for(i in t.statusLocation)n++;return{sid:n,jobid:jobID}}},this.dismiss=function(e){var t=this;e.hasOwnProperty("type")||(e.type="GET");var n={Identifier:e.identifier,request:"Dismiss",service:"WPS",jobid:e.jobid,version:"2.0.0"};this.request(n,e.success,e.error,e.type)}};return s});