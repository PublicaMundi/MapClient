(function(){var e=function(e,t){"use strict";function n(e){var t={};for(var r in e)e.hasOwnProperty(r)&&(typeof e[r]=="object"?t[r]=n(e[r]):t[r]=e[r]);return t}function r(e){return e&&h.alias&&h.alias.hasOwnProperty(e)?h.alias[e]:e}function i(e,t){switch(typeof e){case"object":var n={name:""};if(!e.hasOwnProperty("name"))throw new l.Data.SyntaxException("Name of argument "+t+" is missing.");return n.name=e.name,e.hasOwnProperty("resource")&&(n.resource=r(e.resource)),n;case"string":case"number":return e;default:throw new l.Data.SyntaxException("Type of argument "+t+" is invalid.")}}function s(e,t){switch(typeof e){case"object":var n={name:""};if(!e.hasOwnProperty("name"))throw new l.Data.SyntaxException("Name of argument "+t+" is missing.");return n.name=e.name,e.hasOwnProperty("resource")&&(n.resource=r(e.resource)),n;case"string":return n={name:e};default:throw new l.Data.SyntaxException("Type of argument "+t+" is invalid.")}}function o(e,t){if(isNaN(e))throw new l.Data.SyntaxException("Type of argument "+t+" is invalid. Numeric value is expected.");return e}function u(e,t){return typeof e=="string"?e:e.toString()}function a(e,t){switch(typeof e){case"object":if(e.hasOwnProperty("coordinates")&&e.hasOwnProperty("type"))return e;var n={name:""};if(!e.hasOwnProperty("name"))throw new l.Data.SyntaxException("Name of argument "+t+" is missing.");return n.name=e.name,e.hasOwnProperty("resource")&&(n.resource=r(e.resource)),n;case"string":return{name:e};default:throw new l.Data.SyntaxException("Type of argument "+t+" is invalid.")}}function f(e){return typeof e=="object"&&e.hasOwnProperty("name")?!0:!1}var l=t;typeof l=="undefined"&&(l={__namespace:"PublicaMundi"}),l.Data={__namespace:"PublicaMundi.Data"},l.Data.CRS={__namespace:"PublicaMundi.Data.CRS",Google:"EPSG:900913",Mercator:"EPSG:3857",WGS84:"EPSG:4326",CRS84:"CRS:84",GGRS87:"EPSG:2100",ETRS89:"EPSG:4258"},l.Data.Format={__namespace:"PublicaMundi.Data.Format",JSON:"JSON",ESRI:"ESRI Shapefile",GML:"GML",KML:"KML",GPKG:"GPKG",DXF:"DXF",CSV:"CSV",GeoJSON:"GeoJSON",PDF:"PDF"};var c={EQUAL:"EQUAL",NOT_EQUAL:"NOT_EQUAL",GREATER:"GREATER",GREATER_OR_EQUAL:"GREATER_OR_EQUAL",LESS:"LESS",LESS_OR_EQUAL:"LESS_OR_EQUAL",LIKE:"LIKE",AREA:"AREA",DISTANCE:"DISTANCE",CONTAINS:"CONTAINS",INTERSECTS:"INTERSECTS"},h={debug:!1,endpoint:null,alias:{}};l.Data.configure=function(e){p(h,e),h.debug&&console.log(JSON.stringify(h,null,"	"))},l.Data.getConfiguration=function(){return n(h)},l.Data.SyntaxException=function(e){this.name="PublicaMundi.Data.SyntaxException",this.message=e},l.Data.SyntaxException.prototype=new Error,l.Data.SyntaxException.prototype.constructor=l.Data.SyntaxException,l.Data.SyntaxException.prototype.toString=function(){return this.name+": "+this.message};var p=function(e,t){if(!e)return;if(t)for(var n in t)t.hasOwnProperty(n)&&(typeof t[n]=="object"&&t[n]?(typeof e[n]!="object"&&(e[n]={}),p(e[n],t[n])):e[n]=t[n]);return e};return l.Data.Query=function(e){typeof e=="string"?this.endpoint=e:this.endpoint=h.endpoint,this.endpoint=this.endpoint||"",this.callbacks={success:null,failure:null,complete:null},this.reset()},l.Data.Query.prototype.toString=function(e){return e?JSON.stringify(this.request,null,"	"):JSON.stringify(this.request)},l.Data.Query.prototype.toObject=function(){return n(this.request)},l.Data.Query.prototype.parse=function(e){return this.reset(),this.request=JSON.parse(e),this},l.Data.Query.prototype.resource=function(e,t){var n={name:"",alias:""};switch(typeof e){case"object":if(!e.hasOwnProperty("name"))throw new l.Data.SyntaxException("Resource name is not defined.");n.name=r(e.name),e.hasOwnProperty("alias")?n.alias=e.alias:n.alias=n.name;break;case"string":n.name=r(e),typeof t=="string"?n.alias=t:n.alias=n.name;break;default:throw new l.Data.SyntaxException("Resource name is malformed.")}for(var i in this.query.resources)if(this.query.resources[i].alias===n.alias)throw new l.Data.SyntaxException("Resource "+n.alias+" is already registered.");return this.query.resources.push(n),this},l.Data.Query.prototype.field=function(e,t,n){var i,s={name:""};switch(typeof e){case"object":if(!e.hasOwnProperty("name"))throw new l.Data.SyntaxException("Field name is not defined.");s.name=e.name,e.hasOwnProperty("resource")&&(s.resource=r(e.resource)),e.hasOwnProperty("alias")?s.alias=e.alias:s.alias=e.name;break;case"string":switch(typeof t){case"undefined":s.name=e,s.alias=e;break;case"string":s.alias=t,s.name=t,s.resource=r(e);break;default:throw new l.Data.SyntaxException("Field name is malformed.")}typeof n=="string"&&(s.alias=n);var o=!1;if(s.resource){for(i in this.query.resources)if(this.query.resources[i].name===s.resource||this.query.resources[i].alias===s.resource){o=!0;break}if(!o)throw new l.Data.SyntaxException("Resource "+s.resource+" is does not exist.")}var u=!1;for(i in this.query.fields)if(s.alias===this.query.fields[i].alias)throw new l.Data.SyntaxException("Field "+s.alias+" already exists.");this.query.fields.push(s)}return this},l.Data.Query.prototype.area=function(e,t){var n={operator:c.AREA,arguments:[a(e)],alias:t?t:""};return this.query.fields.push(n),this},l.Data.Query.prototype.distance=function(e,t,n){var r={operator:c.DISTANCE,arguments:[a(e),a(t)],alias:n?n:""};return this.query.fields.push(r),this},l.Data.Query.prototype.equal=function(e,t){var n={operator:c.EQUAL,arguments:[i(e,1),i(t,2)]};return this.query.filters.push(n),this},l.Data.Query.prototype.notEqueal=function(e,t){var n={operator:c.NOT_EQUAL,arguments:[i(e,1),i(t,2)]};return this.query.filters.push(n),this},l.Data.Query.prototype.less=function(e,t){var n={operator:c.LESS,arguments:[i(e,1),i(t,2)]};return this.query.filters.push(n),this},l.Data.Query.prototype.lessOrEqual=function(e,t){var n={operator:c.LESS_OR_EQUAL,arguments:[i(e,1),i(t,2)]};return this.query.filters.push(n),this},l.Data.Query.prototype.greater=function(e,t){var n={operator:c.GREATER,arguments:[i(e,1),i(t,2)]};return this.query.filters.push(n),this},l.Data.Query.prototype.greaterOrEqual=function(e,t){var n={operator:c.GREATER_OR_EQUAL,arguments:[i(e,1),i(t,2)]};return this.query.filters.push(n),this},l.Data.Query.prototype.like=function(e,t){var n,r=i(e,1),o=i(t,2);if(f(r)&&f(o))throw new l.Data.SyntaxException("Operator "+c.LIKE+" requires exactly one field and one literal argument.");return!f(r)&&!f(o)?n={operator:c.LIKE,arguments:[s(e,1),u(t,2)]}:f(r)?n={operator:c.LIKE,arguments:[i(e,1),u(t,2)]}:n={operator:c.LIKE,arguments:[i(t,2),u(e,1)]},this.query.filters.push(n),this},l.Data.Query.prototype.distanceEqual=function(e,t,n){var r={operator:c.DISTANCE,arguments:[a(e),a(t),c.EQUAL,o(n)]};return this.query.filters.push(r),this},l.Data.Query.prototype.distanceLessOrEqual=function(e,t,n){var r={operator:c.DISTANCE,arguments:[a(e),a(t),c.LESS_OR_EQUAL,o(n)]};return this.query.filters.push(r),this},l.Data.Query.prototype.distanceLess=function(e,t,n){var r={operator:c.DISTANCE,arguments:[a(e),a(t),c.LESS,o(n)]};return this.query.filters.push(r),this},l.Data.Query.prototype.distanceGreaterOrEqual=function(e,t,n){var r={operator:c.DISTANCE,arguments:[a(e),a(t),c.GREATER_OR_EQUAL,o(n)]};return this.query.filters.push(r),this},l.Data.Query.prototype.distanceGreater=function(e,t,n){var r={operator:c.DISTANCE,arguments:[a(e),a(t),c.GREATER,o(n)]};return this.query.filters.push(r),this},l.Data.Query.prototype.areaEqual=function(e,t){var n={operator:c.AREA,arguments:[a(e),c.EQUAL,o(t)]};return this.query.filters.push(n),this},l.Data.Query.prototype.areaLessOrEqual=function(e,t){var n={operator:c.AREA,arguments:[a(e),c.LESS_OR_EQUAL,o(t)]};return this.query.filters.push(n),this},l.Data.Query.prototype.areaLess=function(e,t){var n={operator:c.AREA,arguments:[a(e),c.LESS,o(t)]};return this.query.filters.push(n),this},l.Data.Query.prototype.areaGreaterOrEqual=function(e,t){var n={operator:c.AREA,arguments:[a(e),c.GREATER_OR_EQUAL,o(t)]};return this.query.filters.push(n),this},l.Data.Query.prototype.areaGreater=function(e,t){var n={operator:c.AREA,arguments:[a(e),c.GREATER,o(t)]};return this.query.filters.push(n),this},l.Data.Query.prototype.contains=function(e,t){var n={operator:c.CONTAINS,arguments:[a(e),a(t)]};return this.query.filters.push(n),this},l.Data.Query.prototype.intersects=function(e,t){var n={operator:c.INTERSECTS,arguments:[a(e),a(t)]};return this.query.filters.push(n),this},l.Data.Query.prototype.orderBy=function(e,t,n){var i,s={name:"",desc:!1};switch(typeof e){case"object":if(!e.hasOwnProperty("name"))throw new l.Data.SyntaxException("Sorting field name is not defined.");s.name=e.name,e.hasOwnProperty("resource")&&(s.resource=r(e.resource)),e.hasOwnProperty("desc")&&typeof e.desc=="boolean"&&(s.desc=e.desc);break;case"string":switch(typeof t){case"undefined":s.name=e;break;case"string":s.name=t,s.resource=r(e);break;case"boolean":s.name=e,s.desc=t;break;default:throw new l.Data.SyntaxException("Sorting field name is malformed.")}typeof n=="boolean"&&(s.desc=n);var o=!1;if(s.resource){for(i in this.query.resources)if(this.query.resources[i].name===s.resource||this.query.resources[i].alias===s.resource){o=!0;break}if(!o)throw new l.Data.SyntaxException("Resource "+s.resource+" is does not exist.")}this.query.sort.push(s)}return this},l.Data.Query.prototype.setSuccess=function(e){return typeof e=="function"&&(this.callbacks.success=e),this},l.Data.Query.prototype.setFailure=function(e){return typeof e=="function"&&(this.callbacks.failure=e),this},l.Data.Query.prototype.setComplete=function(e){return typeof e=="function"&&(this.callbacks.complete=e),this},l.Data.Query.prototype.reset=function(){return this.request={queue:[],files:null,format:l.Data.Format.GeoJSON},this.queue(),this},l.Data.Query.prototype.queue=function(){return this.request.queue.push({resources:[],fields:[],filters:[],sort:[],offset:0,limit:-1}),this.query=this.request.queue[this.request.queue.length-1],this},l.Data.Query.prototype.format=function(e){for(var t in l.Data.Format)if(l.Data.Format[t]===e)return this.request.format=e,this;throw new l.Data.SyntaxException("Format is not supported.")},l.Data.Query.prototype.crs=function(e){var t=e.split(":");if(t.length!=2||t[0]!="EPSG")throw new l.Data.SyntaxException("CRS is not supported.");for(var n in l.Data.CRS)if(l.Data.CRS[n]===e)return this.request.crs=e,this;throw new l.Data.SyntaxException("CRS is not supported.")},l.Data.Query.prototype.execute=function(t){t=t||{},t.success=t.success||this.callbacks.success,t.failure=t.failure||this.callbacks.failure,t.complete=t.complete||this.callbacks.complete;var n={size:null,start:(new Date).getTime(),end:null};return e.ajax({type:"POST",url:this.endpoint+"api/query",context:this,contentType:"application/json; charset=utf-8",dataType:"json",data:JSON.stringify(this.request)}).done(function(e,r,i){n.end=(new Date).getTime();var s=i.getResponseHeader("Content-Length");s&&(n.size=s/1024),typeof t.success=="function"&&t.success.call(t.context||this,e,n)}).fail(function(e,r,i){n.end=(new Date).getTime(),typeof t.failure=="function"&&t.failure.call(t.context||this,i?i:r,n)}).always(function(e,n,r){typeof t.complete=="function"&&t.complete.call(t.context||this)}),this},l.Data.Query.prototype.export=function(t){t=t||{},t.success=t.success||this.callbacks.success,t.failure=t.failure||this.callbacks.failure,t.complete=t.complete||this.callbacks.complete,t.files=t.files||null;if(t.files){if(t.files.length!=this.request.queue.length)throw new l.Data.SyntaxException("Filenames and queries arrays must be of the same length.");this.request.files=t.files}var n={size:null,start:(new Date).getTime(),end:null};return e.ajax({type:"POST",url:this.endpoint+"api/export",context:this,contentType:"application/json; charset=utf-8",dataType:"json",data:JSON.stringify(this.request)}).done(function(e,r,i){n.end=(new Date).getTime();var s=i.getResponseHeader("Content-Length");s&&(n.size=s/1024),typeof t.success=="function"&&t.success.call(t.context||this,e,n)}).fail(function(e,r,i){n.end=(new Date).getTime(),typeof t.failure=="function"&&t.failure.call(t.context||this,i?i:r,n)}).always(function(e,n,r){typeof t.complete=="function"&&t.complete.call(t.context||this)}),this},l.Data.Query.prototype.take=function(e){if(isNaN(e))throw new l.Data.SyntaxException("Invalid number.");return this.query.limit=e,this},l.Data.Query.prototype.skip=function(e){if(isNaN(e))throw new l.Data.SyntaxException("Invalid number.");return this.query.offset=e,this},l.Data.Query.prototype.getResources=function(t){t=t||{},t.success=t.success||this.callbacks.success,t.failure=t.failure||this.callbacks.failure,t.complete=t.complete||this.callbacks.complete;var n={size:null,start:(new Date).getTime(),end:null};return e.ajax({url:this.endpoint+"api/resource_show",context:this}).done(function(e,r,i){n.end=(new Date).getTime();var s=i.getResponseHeader("Content-Length");s&&(n.size=s/1024);if(e.success&&e.resources&&h.alias)for(var o in e.resources)for(var u in h.alias)h.alias[u]==o&&(e.resources[o].alias=u);typeof t.success=="function"&&t.success.call(t.context||this,e,n)}).fail(function(e,r,i){n.end=(new Date).getTime(),typeof t.failure=="function"&&t.failure.call(t.context||this,i?i:r,n)}).always(function(e,n,r){typeof t.complete=="function"&&t.complete.call(t.context||this)}),this},l.Data.Query.prototype.describeResource=function(t){t.success=t.success||this.callbacks.success,t.failure=t.failure||this.callbacks.failure,t.complete=t.complete||this.callbacks.complete;var n={size:null,start:(new Date).getTime(),end:null};return e.ajax({url:this.endpoint+"api/resource_describe/"+(t.id?t.id:""),context:this}).done(function(e,r,i){n.end=(new Date).getTime();var s=i.getResponseHeader("Content-Length");s&&(n.size=s/1024),typeof t.success=="function"&&t.success.call(t.context||this,e,n)}).fail(function(e,r,i){n.end=(new Date).getTime(),typeof t.failure=="function"&&t.failure.call(t.context||this,i?i:r,n)}).always(function(e,n,r){typeof t.complete=="function"&&t.complete.call(t.context||this)}),this},l};typeof define!="undefined"&&define.amd?define(["jquery"],e):(typeof PublicaMundi=="undefined"&&(PublicaMundi={__namespace:"PublicaMundi"}),e($,PublicaMundi))})();