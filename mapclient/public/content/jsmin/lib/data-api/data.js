(function(){var e=function(e,t){"use strict";function s(e){var t={};for(var n in e)e.hasOwnProperty(n)&&(typeof e[n]=="object"?t[n]=s(e[n]):t[n]=e[n]);return t}function u(e){return e&&i.alias&&i.alias.hasOwnProperty(e)?i.alias[e]:e}function a(e,t){switch(typeof e){case"object":var r={name:""};if(!e.hasOwnProperty("name"))throw new n.Data.SyntaxException("Name of argument "+t+" is missing.");return r.name=e.name,e.hasOwnProperty("resource")&&(r.resource=u(e.resource)),r;case"string":case"number":return e;default:throw new n.Data.SyntaxException("Type of argument "+t+" is invalid.")}}function f(e,t){switch(typeof e){case"object":var r={name:""};if(!e.hasOwnProperty("name"))throw new n.Data.SyntaxException("Name of argument "+t+" is missing.");return r.name=e.name,e.hasOwnProperty("resource")&&(r.resource=u(e.resource)),r;case"string":return r={name:e};default:throw new n.Data.SyntaxException("Type of argument "+t+" is invalid.")}}function l(e,t){if(isNaN(e))throw new n.Data.SyntaxException("Type of argument "+t+" is invalid. Numeric value is expected.");return e}function c(e,t){return typeof e=="string"?e:e.toString()}function h(e,t){switch(typeof e){case"object":if(e.hasOwnProperty("coordinates")&&e.hasOwnProperty("type"))return e;var r={name:""};if(!e.hasOwnProperty("name"))throw new n.Data.SyntaxException("Name of argument "+t+" is missing.");return r.name=e.name,e.hasOwnProperty("resource")&&(r.resource=u(e.resource)),r;case"string":return{name:e};default:throw new n.Data.SyntaxException("Type of argument "+t+" is invalid.")}}function p(e){return typeof e=="object"&&e.hasOwnProperty("name")?!0:!1}var n=t;typeof n=="undefined"&&(n={__namespace:"PublicaMundi"}),n.Data={__namespace:"PublicaMundi.Data"},n.Data.CRS={__namespace:"PublicaMundi.Data.CRS",Google:"EPSG:900913",Mercator:"EPSG:3857",WGS84:"EPSG:4326",CRS84:"CRS:84",GGRS87:"EPSG:2100",ETRS89:"EPSG:4258"},n.Data.Format={__namespace:"PublicaMundi.Data.Format",JSON:"JSON",ESRI:"ESRI Shapefile",GML:"GML",KML:"KML",GPKG:"GPKG",DXF:"DXF",CSV:"CSV",GeoJSON:"GeoJSON",PDF:"PDF"};var r={EQUAL:"EQUAL",NOT_EQUAL:"NOT_EQUAL",GREATER:"GREATER",GREATER_OR_EQUAL:"GREATER_OR_EQUAL",LESS:"LESS",LESS_OR_EQUAL:"LESS_OR_EQUAL",LIKE:"LIKE",AREA:"AREA",DISTANCE:"DISTANCE",CONTAINS:"CONTAINS",INTERSECTS:"INTERSECTS"},i={debug:!1,endpoint:null,alias:{}};n.Data.configure=function(e){o(i,e),i.debug&&console.log(JSON.stringify(i,null,"	"))},n.Data.getConfiguration=function(){return s(i)},n.Data.SyntaxException=function(e){this.name="PublicaMundi.Data.SyntaxException",this.message=e},n.Data.SyntaxException.prototype=new Error,n.Data.SyntaxException.prototype.constructor=n.Data.SyntaxException,n.Data.SyntaxException.prototype.toString=function(){return this.name+": "+this.message};var o=function(e,t){if(!e)return;if(t)for(var n in t)t.hasOwnProperty(n)&&(typeof t[n]=="object"&&t[n]?(typeof e[n]!="object"&&(e[n]={}),o(e[n],t[n])):e[n]=t[n]);return e};return n.Data.Query=function(e){typeof e=="string"?this.endpoint=e:this.endpoint=i.endpoint,this.endpoint=this.endpoint||"",this.callbacks={success:null,failure:null,complete:null},this.reset()},n.Data.Query.prototype.toString=function(e){return e?JSON.stringify(this.request,null,"	"):JSON.stringify(this.request)},n.Data.Query.prototype.toObject=function(){return s(this.request)},n.Data.Query.prototype.parse=function(e){return this.reset(),this.request=JSON.parse(e),this},n.Data.Query.prototype.resource=function(e,t){var r={name:"",alias:""};switch(typeof e){case"object":if(!e.hasOwnProperty("name"))throw new n.Data.SyntaxException("Resource name is not defined.");r.name=u(e.name),e.hasOwnProperty("alias")?r.alias=e.alias:r.alias=r.name;break;case"string":r.name=u(e),typeof t=="string"?r.alias=t:r.alias=r.name;break;default:throw new n.Data.SyntaxException("Resource name is malformed.")}for(var i in this.query.resources)if(this.query.resources[i].alias===r.alias)throw new n.Data.SyntaxException("Resource "+r.alias+" is already registered.");return this.query.resources.push(r),this},n.Data.Query.prototype.field=function(e,t,r){var i,s={name:""};switch(typeof e){case"object":if(!e.hasOwnProperty("name"))throw new n.Data.SyntaxException("Field name is not defined.");s.name=e.name,e.hasOwnProperty("resource")&&(s.resource=u(e.resource)),e.hasOwnProperty("alias")?s.alias=e.alias:s.alias=e.name;break;case"string":switch(typeof t){case"undefined":s.name=e,s.alias=e;break;case"string":s.alias=t,s.name=t,s.resource=u(e);break;default:throw new n.Data.SyntaxException("Field name is malformed.")}typeof r=="string"&&(s.alias=r);var o=!1;if(s.resource){for(i in this.query.resources)if(this.query.resources[i].name===s.resource||this.query.resources[i].alias===s.resource){o=!0;break}if(!o)throw new n.Data.SyntaxException("Resource "+s.resource+" is does not exist.")}var a=!1;for(i in this.query.fields)if(s.alias===this.query.fields[i].alias)throw new n.Data.SyntaxException("Field "+s.alias+" already exists.");this.query.fields.push(s)}return this},n.Data.Query.prototype.area=function(e,t){var n={operator:r.AREA,arguments:[h(e)],alias:t?t:""};return this.query.fields.push(n),this},n.Data.Query.prototype.distance=function(e,t,n){var i={operator:r.DISTANCE,arguments:[h(e),h(t)],alias:n?n:""};return this.query.fields.push(i),this},n.Data.Query.prototype.equal=function(e,t){var n={operator:r.EQUAL,arguments:[a(e,1),a(t,2)]};return this.query.filters.push(n),this},n.Data.Query.prototype.notEqueal=function(e,t){var n={operator:r.NOT_EQUAL,arguments:[a(e,1),a(t,2)]};return this.query.filters.push(n),this},n.Data.Query.prototype.less=function(e,t){var n={operator:r.LESS,arguments:[a(e,1),a(t,2)]};return this.query.filters.push(n),this},n.Data.Query.prototype.lessOrEqual=function(e,t){var n={operator:r.LESS_OR_EQUAL,arguments:[a(e,1),a(t,2)]};return this.query.filters.push(n),this},n.Data.Query.prototype.greater=function(e,t){var n={operator:r.GREATER,arguments:[a(e,1),a(t,2)]};return this.query.filters.push(n),this},n.Data.Query.prototype.greaterOrEqual=function(e,t){var n={operator:r.GREATER_OR_EQUAL,arguments:[a(e,1),a(t,2)]};return this.query.filters.push(n),this},n.Data.Query.prototype.like=function(e,t){var i,s=a(e,1),o=a(t,2);if(p(s)&&p(o))throw new n.Data.SyntaxException("Operator "+r.LIKE+" requires exactly one field and one literal argument.");return!p(s)&&!p(o)?i={operator:r.LIKE,arguments:[f(e,1),c(t,2)]}:p(s)?i={operator:r.LIKE,arguments:[a(e,1),c(t,2)]}:i={operator:r.LIKE,arguments:[a(t,2),c(e,1)]},this.query.filters.push(i),this},n.Data.Query.prototype.distanceEqual=function(e,t,n){var i={operator:r.DISTANCE,arguments:[h(e),h(t),r.EQUAL,l(n)]};return this.query.filters.push(i),this},n.Data.Query.prototype.distanceLessOrEqual=function(e,t,n){var i={operator:r.DISTANCE,arguments:[h(e),h(t),r.LESS_OR_EQUAL,l(n)]};return this.query.filters.push(i),this},n.Data.Query.prototype.distanceLess=function(e,t,n){var i={operator:r.DISTANCE,arguments:[h(e),h(t),r.LESS,l(n)]};return this.query.filters.push(i),this},n.Data.Query.prototype.distanceGreaterOrEqual=function(e,t,n){var i={operator:r.DISTANCE,arguments:[h(e),h(t),r.GREATER_OR_EQUAL,l(n)]};return this.query.filters.push(i),this},n.Data.Query.prototype.distanceGreater=function(e,t,n){var i={operator:r.DISTANCE,arguments:[h(e),h(t),r.GREATER,l(n)]};return this.query.filters.push(i),this},n.Data.Query.prototype.areaEqual=function(e,t){var n={operator:r.AREA,arguments:[h(e),r.EQUAL,l(t)]};return this.query.filters.push(n),this},n.Data.Query.prototype.areaLessOrEqual=function(e,t){var n={operator:r.AREA,arguments:[h(e),r.LESS_OR_EQUAL,l(t)]};return this.query.filters.push(n),this},n.Data.Query.prototype.areaLess=function(e,t){var n={operator:r.AREA,arguments:[h(e),r.LESS,l(t)]};return this.query.filters.push(n),this},n.Data.Query.prototype.areaGreaterOrEqual=function(e,t){var n={operator:r.AREA,arguments:[h(e),r.GREATER_OR_EQUAL,l(t)]};return this.query.filters.push(n),this},n.Data.Query.prototype.areaGreater=function(e,t){var n={operator:r.AREA,arguments:[h(e),r.GREATER,l(t)]};return this.query.filters.push(n),this},n.Data.Query.prototype.contains=function(e,t){var n={operator:r.CONTAINS,arguments:[h(e),h(t)]};return this.query.filters.push(n),this},n.Data.Query.prototype.intersects=function(e,t){var n={operator:r.INTERSECTS,arguments:[h(e),h(t)]};return this.query.filters.push(n),this},n.Data.Query.prototype.orderBy=function(e,t,r){var i,s={name:"",desc:!1};switch(typeof e){case"object":if(!e.hasOwnProperty("name"))throw new n.Data.SyntaxException("Sorting field name is not defined.");s.name=e.name,e.hasOwnProperty("resource")&&(s.resource=u(e.resource)),e.hasOwnProperty("desc")&&typeof e.desc=="boolean"&&(s.desc=e.desc);break;case"string":switch(typeof t){case"undefined":s.name=e;break;case"string":s.name=t,s.resource=u(e);break;case"boolean":s.name=e,s.desc=t;break;default:throw new n.Data.SyntaxException("Sorting field name is malformed.")}typeof r=="boolean"&&(s.desc=r);var o=!1;if(s.resource){for(i in this.query.resources)if(this.query.resources[i].name===s.resource||this.query.resources[i].alias===s.resource){o=!0;break}if(!o)throw new n.Data.SyntaxException("Resource "+s.resource+" is does not exist.")}this.query.sort.push(s)}return this},n.Data.Query.prototype.setSuccess=function(e){return typeof e=="function"&&(this.callbacks.success=e),this},n.Data.Query.prototype.setFailure=function(e){return typeof e=="function"&&(this.callbacks.failure=e),this},n.Data.Query.prototype.setComplete=function(e){return typeof e=="function"&&(this.callbacks.complete=e),this},n.Data.Query.prototype.reset=function(){return this.request={queue:[],files:null,format:n.Data.Format.GeoJSON},this.queue(),this},n.Data.Query.prototype.queue=function(){return this.request.queue.push({resources:[],fields:[],filters:[],sort:[],offset:0,limit:-1}),this.query=this.request.queue[this.request.queue.length-1],this},n.Data.Query.prototype.format=function(e){for(var t in n.Data.Format)if(n.Data.Format[t]===e)return this.request.format=e,this;throw new n.Data.SyntaxException("Format is not supported.")},n.Data.Query.prototype.crs=function(e){var t=e.split(":");if(t.length!=2||t[0]!="EPSG")throw new n.Data.SyntaxException("CRS is not supported.");for(var r in n.Data.CRS)if(n.Data.CRS[r]===e)return this.request.crs=e,this;throw new n.Data.SyntaxException("CRS is not supported.")},n.Data.Query.prototype.execute=function(t){t=t||{},t.success=t.success||this.callbacks.success,t.failure=t.failure||this.callbacks.failure,t.complete=t.complete||this.callbacks.complete;var n={size:null,start:(new Date).getTime(),end:null};return e.ajax({type:"POST",url:this.endpoint+"api/query",context:this,contentType:"application/json; charset=utf-8",dataType:"json",data:JSON.stringify(this.request)}).done(function(e,r,i){n.end=(new Date).getTime();var s=i.getResponseHeader("Content-Length");s&&(n.size=s/1024),typeof t.success=="function"&&t.success.call(t.context||this,e,n)}).fail(function(e,r,i){n.end=(new Date).getTime(),typeof t.failure=="function"&&t.failure.call(t.context||this,i?i:r,n)}).always(function(e,n,r){typeof t.complete=="function"&&t.complete.call(t.context||this)}),this},n.Data.Query.prototype.export=function(t){t=t||{},t.success=t.success||this.callbacks.success,t.failure=t.failure||this.callbacks.failure,t.complete=t.complete||this.callbacks.complete,t.files=t.files||null;if(t.files){if(t.files.length!=this.request.queue.length)throw new n.Data.SyntaxException("Filenames and queries arrays must be of the same length.");this.request.files=t.files}var r={size:null,start:(new Date).getTime(),end:null};return e.ajax({type:"POST",url:this.endpoint+"api/export",context:this,contentType:"application/json; charset=utf-8",dataType:"json",data:JSON.stringify(this.request)}).done(function(e,n,i){r.end=(new Date).getTime();var s=i.getResponseHeader("Content-Length");s&&(r.size=s/1024),typeof t.success=="function"&&t.success.call(t.context||this,e,r)}).fail(function(e,n,i){r.end=(new Date).getTime(),typeof t.failure=="function"&&t.failure.call(t.context||this,i?i:n,r)}).always(function(e,n,r){typeof t.complete=="function"&&t.complete.call(t.context||this)}),this},n.Data.Query.prototype.take=function(e){if(isNaN(e))throw new n.Data.SyntaxException("Invalid number.");return this.query.limit=e,this},n.Data.Query.prototype.skip=function(e){if(isNaN(e))throw new n.Data.SyntaxException("Invalid number.");return this.query.offset=e,this},n.Data.Query.prototype.getResources=function(t){t=t||{},t.success=t.success||this.callbacks.success,t.failure=t.failure||this.callbacks.failure,t.complete=t.complete||this.callbacks.complete;var n={size:null,start:(new Date).getTime(),end:null};return e.ajax({url:this.endpoint+"api/resource_show",context:this}).done(function(e,r,s){n.end=(new Date).getTime();var o=s.getResponseHeader("Content-Length");o&&(n.size=o/1024);if(e.success&&e.resources&&i.alias)for(var u in e.resources)for(var a in i.alias)i.alias[a]==u&&(e.resources[u].alias=a);typeof t.success=="function"&&t.success.call(t.context||this,e,n)}).fail(function(e,r,i){n.end=(new Date).getTime(),typeof t.failure=="function"&&t.failure.call(t.context||this,i?i:r,n)}).always(function(e,n,r){typeof t.complete=="function"&&t.complete.call(t.context||this)}),this},n.Data.Query.prototype.describeResource=function(t){t.success=t.success||this.callbacks.success,t.failure=t.failure||this.callbacks.failure,t.complete=t.complete||this.callbacks.complete;var n={size:null,start:(new Date).getTime(),end:null};return e.ajax({url:this.endpoint+"api/resource_describe/"+(t.id?t.id:""),context:this}).done(function(e,r,i){n.end=(new Date).getTime();var s=i.getResponseHeader("Content-Length");s&&(n.size=s/1024),typeof t.success=="function"&&t.success.call(t.context||this,e,n)}).fail(function(e,r,i){n.end=(new Date).getTime(),typeof t.failure=="function"&&t.failure.call(t.context||this,i?i:r,n)}).always(function(e,n,r){typeof t.complete=="function"&&t.complete.call(t.context||this)}),this},n};typeof define!="undefined"&&define.amd?define(["jquery"],e):(typeof PublicaMundi=="undefined"&&(PublicaMundi={__namespace:"PublicaMundi"}),e($,PublicaMundi))})();