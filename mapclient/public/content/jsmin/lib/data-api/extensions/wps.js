(function(){var e=function(e,t,n){"use strict";typeof e.Data.WPS=="undefined"&&(e.Data.WPS={__namespace:"PublicaMundi.Data.WPS"});var r={},i=function(e){return e.ExecuteResponse.ProcessOutputs?e.ExecuteResponse.ProcessOutputs.Output.Reference._href:null},s=function(e){return e.ExecuteResponse&&e.ExecuteResponse.Status&&e.ExecuteResponse.Status.ProcessFailed?e.ExecuteResponse.Status.ProcessFailed.ExceptionReport.Exception.ExceptionText.__text:null};e.Data.WPS.configure=function(t){console.log(t),e.Data.configure({wps:{endpoint:t.endpoint,corsEnabled:t.corsEnabled,proxy:t.proxy,delay:t.delay||2e3}});var n=t.mappings||{};for(var i in r)e.Data.Query.prototype.hasOwnProperty("process"+i)&&delete e.Data.Query.prototype["process"+i];r=n;for(var i in r)(function(t,n,r){e.Data.Query.prototype[n]=function(){if(this.request.queue.length>1)throw new e.Data.SyntaxException("WPS operations can be applied only to requests with a single query.");this.request.processes||(this.request.processes=[]);if(r.params&&r.params.length-1!=arguments.length)throw new e.Data.SyntaxException("Function "+n+" expects "+(r.params.length-1)+" parameter(s). Only "+arguments.length+" specified.");return this.request.processes.push({name:t,id:r.id,args:arguments}),this}})(i,"process"+i,r[i])};var o=e.Data.Query.prototype.queue;return e.Data.Query.prototype.queue=function(){if(this.request.processes&&this.request.processes.length>0&&this.request.queue.length>0)throw new e.Data.SyntaxException("WPS operations can be applied only to requests with a single query.");return o.call(this)},e.Data.Query.prototype.wps=function(n){if(!this.request.processes||this.request.processes.length==0)return this.execute(n);var o=e.Data.getConfiguration(),u=o.debug;n=n||{},n.success=n.success||this.callbacks.success,n.failure=n.failure||this.callbacks.failure,n.complete=n.complete||this.callbacks.complete;var a={size:null,start:(new Date).getTime(),end:null},f=[].concat(this.request.processes).reverse(),l=0,c=o.wps.corsEnabled?o.wps.endpoint:o.wps.proxy+o.wps.endpoint,h=new t({url:c,delay:o.wps.delay?o.wps.delay:2e3}),p=function(e,t){if(e.success){var r=this.endpoint+"api/download/"+e.code;u?$.ajax({method:"GET",url:r}).done(d).fail(function(){t.end=(new Date).getTime(),typeof n.failure=="function"&&n.failure.call(n.context||this,"Failed to download file from ["+r+"].",t),typeof n.complete=="function"&&n.complete.call(n.context||this)}):d(r)}else t.end=(new Date).getTime(),typeof n.success=="function"&&n.success.call(n.context||this,e,t),typeof n.complete=="function"&&n.complete.call(n.context||this)},d=function(t){var i=f.pop();l++;var o=[],c=[],p=r[i.name];$.isXMLDoc(t)&&(t=(new XMLSerializer).serializeToString(t));if(u){var d='<?xml version="1.0" encoding="utf-8" ?>';t=t.substr(d.length)}for(var g=0;g<p.params.length;g++){var y={identifier:p.params[g].name};switch(p.params[g].type){case"complex":u?y.value=g==0?t:i.args[g-1]:g==0?y.href=t:y.value=i.args[g-1];break;case"literal":y.value=g==0?t:i.args[g-1];break;default:throw new e.Data.SyntaxException("Parameter type ["+p.params[g].type+"] is not supported.")}p.params[g].mimeType&&(y.mimeType=p.params[g].mimeType),o.push(y)}f.length==0?c.push({identifier:p.result,mimeType:"application/json",type:"raw"}):c.push({identifier:p.result,mimeType:"application/json",asReference:!0}),u&&(console.log(o),console.log(c)),h.execute({identifier:i.id,dataInputs:o,dataOutputs:c,type:"POST",success:f.length==0?m:v,error:function(e){var t=s(e)||"Unhandled exception has occured. Execution of process ["+i.id+"] has failed. Process index is ["+l+"]";a.end=(new Date).getTime(),typeof n.failure=="function"?n.failure.call(n.context||this,t,a):u&&console.log(t),typeof n.complete=="function"&&n.complete.call(n.context||this)}})},v=function(t){var o=f.pop();l++;var c=[],p=[],d=r[o.name],g=i(t);if(!g){var y=s(t)||"Can not execute process ["+o.id+"]. Failed to get response from previous process. Process index is ["+l+"]";a.end=(new Date).getTime(),typeof n.failure=="function"?n.failure.call(n.context||this,y,a):u&&console.log(y),typeof n.complete=="function"&&n.complete.call(n.context||this);return}var b={identifier:d.params[0].name,href:g,mimeType:"application/json"};d.params.mimeType&&(b.mimeType=d.params.mimeType),c.push(b);for(var w=1;w<d.params.length;w++){var b={identifier:d.params[w].name};switch(d.params[w].type){case"complex":b.value=o.args[w-1];break;case"literal":b.value=o.args[w-1];break;default:throw new e.Data.SyntaxException("Parameter type ["+d.params[w].type+"] is not supported.")}d.params[w].mimeType&&(b.mimeType=d.params[w].mimeType),c.push(b)}f.length==0?p.push({identifier:d.result,mimeType:"application/json",type:"raw"}):p.push({identifier:d.result,mimeType:"application/json",asReference:!0}),u&&(console.log(c),console.log(p)),h.execute({identifier:o.id,dataInputs:c,dataOutputs:p,type:"POST",success:f.length==0?m:v,error:function(e){var t=s(e)||"Unhandled exception has occured. Execution of process ["+o.id+"] has failed. Process index is ["+l+"]";a.end=(new Date).getTime(),typeof n.failure=="function"?n.failure.call(n.context||this,t,a):u&&console.log(t),typeof n.complete=="function"&&n.complete.call(n.context||this)}})},m=function(e){a.end=(new Date).getTime(),typeof n.success=="function"&&n.success.call(n.context||this,{success:!0,data:[e],message:null},a),typeof n.complete=="function"&&n.complete.call(n.context||this)};return $.ajax({type:"POST",url:this.endpoint+"api/wps",context:this,contentType:"application/json; charset=utf-8",dataType:"json",data:JSON.stringify(this.request)}).done(function(e,t,r){a.end=(new Date).getTime(),p.call(n.context||this,e,a)}).fail(function(e,t,r){a.end=(new Date).getTime(),typeof n.failure=="function"&&n.failure.call(n.context||this,r?r:t,a),typeof n.complete=="function"&&n.complete.call(n.context||this)}),this},e.Data.Query.prototype.getProcesses=function(n){var r=e.Data.getConfiguration(),i=r.wps.corsEnabled?r.wps.endpoint:r.wps.proxy+r.wps.endpoint,s=new t({url:i,delay:r.wps.delay?r.wps.delay:2e3});return s.getCapabilities({type:"POST",success:function(e){typeof n.success=="function"&&n.success.call(n.context||this,e),typeof n.complete=="function"&&n.complete.call(n.context||this)},error:function(e){typeof n.failure=="function"&&n.failure.call(n.context||this,e),typeof n.complete=="function"&&n.complete.call(n.context||this)}}),this},e.Data.Query.prototype.describeProcess=function(n){var r=e.Data.getConfiguration(),i=r.wps.corsEnabled?r.wps.endpoint:r.wps.proxy+r.wps.endpoint,s=new t({url:i,delay:r.wps.delay?r.wps.delay:2e3});s.describeProcess({type:"POST",identifier:n.id||"all",success:function(e){typeof n.success=="function"&&n.success.call(n.context||this,e),typeof n.complete=="function"&&n.complete.call(n.context||this)},error:function(e){typeof n.failure=="function"&&n.failure.call(n.context||this,e),typeof n.complete=="function"&&n.complete.call(n.context||this)}})},e};define&&define.amd?define(["data_api","zoo","wpsPayload"],e):e(PublicaMundi,ZooProcess,wpsPayload)})();