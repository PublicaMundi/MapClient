/* Copyright 2013 William Summers, metaTribal LLC
 * adapted from https://developer.mozilla.org/en-US/docs/JXON
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

var xmlToJSON=function(){this.version="1.3";var e={mergeCDATA:!0,grokAttr:!0,grokText:!0,normalize:!0,xmlns:!0,namespaceKey:"_ns",textKey:"_text",valueKey:"_value",attrKey:"_attr",cdataKey:"_cdata",attrsAsObject:!0,stripAttrPrefix:!0,stripElemPrefix:!0,childrenAsArray:!0},t=new RegExp(/(?!xmlns)^.*:/),n=new RegExp(/^\s+|\s+$/g);return this.grokType=function(e){return/^\s*$/.test(e)?null:/^(?:true|false)$/i.test(e)?e.toLowerCase()==="true":isFinite(e)?parseFloat(e):e},this.parseString=function(e,t){return this.parseXML(this.stringToXML(e),t)},this.parseXML=function(r,i){for(var s in i)e[s]=i[s];var o={},u=0,a="";e.xmlns&&r.namespaceURI&&(o[e.namespaceKey]=r.namespaceURI);if(r.attributes&&r.attributes.length>0){var f={};for(u;u<r.attributes.length;u++){var l=r.attributes.item(u);d={};var c="";e.stripAttrPrefix?c=l.name.replace(t,""):c=l.name,e.grokAttr?d[e.valueKey]=this.grokType(l.value.replace(n,"")):d[e.valueKey]=l.value.replace(n,""),e.xmlns&&l.namespaceURI&&(d[e.namespaceKey]=l.namespaceURI),e.attrsAsObject?f[c]=d:o[e.attrKey+c]=d}e.attrsAsObject&&(o[e.attrKey]=f)}if(r.hasChildNodes())for(var h,p,d,v=0;v<r.childNodes.length;v++)h=r.childNodes.item(v),h.nodeType===4?e.mergeCDATA?a+=h.nodeValue:o.hasOwnProperty(e.cdataKey)?(o[e.cdataKey].constructor!==Array&&(o[e.cdataKey]=[o[e.cdataKey]]),o[e.cdataKey].push(h.nodeValue)):e.childrenAsArray?(o[e.cdataKey]=[],o[e.cdataKey].push(h.nodeValue)):o[e.cdataKey]=h.nodeValue:h.nodeType===3?a+=h.nodeValue:h.nodeType===1&&(u===0&&(o={}),e.stripElemPrefix?p=h.nodeName.replace(t,""):p=h.nodeName,d=xmlToJSON.parseXML(h),o.hasOwnProperty(p)?(o[p].constructor!==Array&&(o[p]=[o[p]]),o[p].push(d)):(e.childrenAsArray?(o[p]=[],o[p].push(d)):o[p]=d,u++));else a||(e.childrenAsArray?(o[e.textKey]=[],o[e.textKey].push(null)):o[e.textKey]=null);if(a)if(e.grokText){var m=this.grokType(a.replace(n,""));m!==null&&m!==undefined&&(o[e.textKey]=m)}else e.normalize?o[e.textKey]=a.replace(n,"").replace(/\s+/g," "):o[e.textKey]=a.replace(n,"");return o},this.xmlToString=function(e){try{var t=e.xml?e.xml:(new XMLSerializer).serializeToString(e);return t}catch(n){return null}},this.stringToXML=function(e){try{var t=null;if(window.DOMParser){var n=new DOMParser;return t=n.parseFromString(e,"text/xml"),t}return t=new ActiveXObject("Microsoft.XMLDOM"),t.async=!1,t.loadXML(e),t}catch(r){return null}},this}();typeof module!="undefined"&&module!==null&&module.exports?module.exports=xmlToJSON:typeof define=="function"&&define.amd&&define(function(){return xmlToJSON}),function(){var e=function(e,t){"use strict";var n=null,r=null,i=[],s=null;t.LayerType={WMS:"WMS",WFS:"WFS",TILE:"Tile",GeoJSON:"GeoJSON",KML:"KML",GML:"GML",GPX:"GPX",CSV:"CSV",WCS:"WCS",WCPS:"WCPS"},t.version="0.0.1",t.define=function(e){if(!e)return;var t=e.split(".");for(var n=window,r=0;r<t.length;r++){if(!t[r])continue;typeof n[t[r]]=="undefined"&&(n[t[r]]={__namespace:t.slice(0,r+1).join(".")}),n=n[t[r]]}};var o=function(e,t){if(t)for(var n in t)t.hasOwnProperty(n)&&t[n]!==undefined&&(e[n]=t[n]);return e};t.Class=function(){var e=arguments,t=function(){typeof this.initialize=="function"&&this.initialize.apply(this,arguments)},n={},r,i,s=function(){};for(var u=0,a=arguments.length;u<a;++u)typeof arguments[u]=="function"?(u===0&&a>1&&(i=arguments[u].prototype.initialize,arguments[u].prototype.initialize=s(),n=new arguments[u],n.constructor=t,i===undefined?delete arguments[u].prototype.initialize:arguments[u].prototype.initialize=i),r=arguments[u].prototype):r=arguments[u],o(n,r);return t.prototype=n,t.prototype.constructor=t,t};var u={};return t.registerFrameworkResolver=function(e,t){return u.hasOwnProperty(e)?(console.log("Resolver for framework "+e+" already registered."),!1):(u[e]=t,!0)},t.resolveFramework=function(){for(var e in u)if(u[e]())return e;return null},t.isDefined=function(e){return typeof e!="undefined"},t.isFunction=function(e){return typeof e=="function"},t.isObject=function(e){return typeof e=="object"},t.isEmpty=function(e){if(e===null)return!0;if(e.length>0)return!1;if(e.length===0)return!0;for(var t in e)if(hasOwnProperty.call(e,t))return!1;return!0},t.isClass=function(e){var t=e.split(".");for(var n=window,r=0;r<t.length;r++){if(!t[r]||typeof n[t[r]]=="undefined")return!1;if(r===t.length-1&&typeof n[t[r]]!="function")return!1;n=n[t[r]]}return!0},t.isArray=function(e){return Array.isArray?Array.isArray(e):Object.prototype.toString.call(e)==="[object Array]"},t.getQueryStringParameters=function(e){var t={};return e.replace(new RegExp("([^?=&]+)(=([^&#]*))?","g"),function(e,n,r,i){t[n]=i}),t},t.locator={_dependencies:[],_factories:[],register:function(e,t){var n=this._dependencies.indexOf(e);return n<0?(this._dependencies.push(e),this._factories.push(t)):this._factories[n]=t,t},unregister:function(e){var t=this._dependencies.indexOf(e);t>=0&&(this._dependencies.splice(t,1),this._factories.splice(t,1))},resolve:function(e){var t=this._dependencies.indexOf(e);return t<0?null:this._factories[t]},create:function(e,t){var n=this.resolve(e);return n?new n(t):null}},t.registry={_LayerTypeRegistry:[],registerLayerType:function(e){var n=null;for(var r=0;r<this._LayerTypeRegistry.length;r++)if(this._LayerTypeRegistry[r].layer===e.layer&&this._LayerTypeRegistry[r].framework===e.framework){n=this._LayerTypeRegistry[r];break}n?n.type=e.type:(n={layer:e.layer,framework:e.framework,type:e.type},this._LayerTypeRegistry.push(n)),t.locator.register(e.type,e.factory)},resolveLayerType:function(e){var n=null,r=t.resolveFramework();for(var i=0;i<this._LayerTypeRegistry.length;i++)if(this._LayerTypeRegistry[i].layer===e&&this._LayerTypeRegistry[i].framework===r){n=this._LayerTypeRegistry[i];break}return n?n.type:null},createLayer:function(e){var n=this.resolveLayerType(e.type);return n?t.locator.create(n,e):null},getFactories:function(){return this._LayerTypeRegistry.map(function(e){return t.locator.resolve(e.type)})}},t._PM=window.PM,t.noConflict=function(){return window.PM===t&&(typeof this._PM!="undefined"?window.PM=this._PM:delete window.PM),this},n=jQuery("script").last().attr("src"),n=n.substring(0,n.lastIndexOf("/")+1),r=jQuery("script").last().data("library"),r||(r="ol"),t.ready=function(o){if(!t.isFunction(o)){console.log("Argument for ready() is not a function.");return}t.resolveFramework()||(e("<link/>",{rel:"stylesheet",type:"text/css",href:n+"lib/"+r+"/"+r+".css"}).appendTo("head"),i.push(n+"lib/"+r+"/"+r+".js"),i.push(n+"publicamundi."+r+".js"));if(i.length===0)o();else{var u=function(){s&&(s=null),i.length>0?(s=i[0],i.shift(),e.ajax({url:s,dataType:"script",success:u,cache:!0})):o()};u()}},t};typeof define!="undefined"&&define.amd?define(["jquery","shared"],e):(typeof PublicaMundi=="undefined"&&(PublicaMundi={__namespace:"PublicaMundi"}),e($,PublicaMundi))}(),function(e,t){"use strict";if(typeof t=="undefined")return;t.Map=t.Class({initialize:function(e){this._map=null,this._layers=[],this._control=null,this._viewbox="0,0,0,0",this._popup=null,this._highlight=null,this._featureOverlay=null,this._layerHighlight=null,this._featureHighlight=null,e=e||{},e.target=t.isDefined(e.target)?e.target:null,e.projection=t.isDefined(e.projection)?e.projection:"EPSG:3857",e.center=t.isDefined(e.center)?e.center:[0,0],e.zoom=t.isDefined(e.zoom)?e.zoom:2},setExtent:function(e){return this},_setViewBox:function(){return this},_getViewBox:function(){return this._viewbox},setLayerControl:function(e){return this},getLayerControl:function(){return this._control},getMap:function(){return this._map},getOverlay:function(){return this._popup},getFeatureOverlay:function(){return this._featureOverlay},setCenter:function(e,t){return this},getCenter:function(){return null},setZoom:function(e){return this},getZoom:function(){return null},getProjection:function(){return null},getTarget:function(){return null},getLayers:function(){return this._layers},_listen:function(){return null},createLayer:function(e){var n=null;switch(typeof e){case"string":var r=[".gson",".geojson"];r.some(function(t){return e.indexOf(t,e.length-t.length)})&&this.createLayer({type:t.LayerType.GeoJSON,url:e,projection:this.getProjection()});break;case"object":var i=t.registry.getFactories();for(var s=0;s<i.length;s++)if(e instanceof i[s]){n=e;break}n||(t.isDefined(e.projection)||(e.projection=this.getProjection()),n=t.registry.createLayer(e),n.setMap(this)),n?this.addLayer(n):console.log("Layer of type "+e.type+" is not supported.")}return n&&this._layers.push(n),n},addLayer:function(e){},removeLayer:function(e){}}),t.locator.register("PublicaMundi.Map",t.Map),t.map=function(e){return t.locator.create("PublicaMundi.Map",e)},t.configure=function(e,n,r){var i=typeof e=="string"?t.map({target:e}):t.map(e);return jQuery.getJSON(n,function(e){e.center&&i.setCenter(e.center),e.zoom&&i.setZoom(e.zoom);if(t.isArray(e.layers))for(var n=0;n<e.layers.length;n++)i.addLayer(e.layers[n]);t.isFunction(r)&&r.call(this,e)}),i}}(window,window.PublicaMundi),function(e,t){if(typeof t=="undefined")return;t.define("PublicaMundi"),t.Helpers=t.Class({initialize:function(e){}}),t.locator.register("PublicaMundi.Helpers",t.Helpers)}(window,PublicaMundi),function(e,t){if(typeof t=="undefined")return;t.define("PublicaMundi"),t.Parser=t.Class({initialize:function(e){},parseWMS:function(e){var t={},n;try{n=xmlToJSON.parseXML(e,{childrenAsArray:!1})}catch(r){return console.log(r),t.success=!1,t.error_msg="Server response is not a valid XML document. Cannot display",t}if(n.ServiceExceptionReport)return t.success=!1,t.error_msg="Service Exception Report. Please try again.",t;var i=null;if(n.WMS_Capabilities)i=n.WMS_Capabilities;else if(n.WMT_MS_Capabilities){i=n.WMT_MS_Capabilities;if(i instanceof Array)for(var s in i){var o=i[s];o.Capability&&(i=o)}}if(!i._attr)return t.success=!1,t.error_msg="WMS Capabilities Load Exception. Please try again.",t;t.version=i._attr.version._value;var u=[];if(!i.Capability.Layer)return t.success=!1,t.error_msg="No WMS Layers found in provided endpoint.",t;i.Capability.Layer.Layer?u=i.Capability.Layer.Layer:i.Capability.Layer&&(u=i.Capability.Layer),u instanceof Array||(u=[u]);for(var s in u){var a=u[s];a.Name=a.Name._text,a.Title=a.Title._text,a.Abstract=a.Abstract._text,a.CRS=a.CRS._text;var f=a.EX_GeographicBoundingBox,l=null;if(f){var c=f.eastBoundLongitude._text,h=f.westBoundLongitude._text,p=f.northBoundLatitude._text,d=f.southBoundLatitude._text;l=[h,d,c,p],a.EX_GeographicBoundingBox=l}}return t.Layer=u,t.success=!0,t},parseWFS:function(e){var t={},n;try{n=xmlToJSON.parseXML(e,{childrenAsArray:!1})}catch(r){return console.log(r),t.success=!1,t.error_msg="Server response is not a valid XML document. Cannot display",t}var i=null;if(!n.WFS_Capabilities)return console.log("unexpected version"),console.log(s),t.success=!1,t.error_msg="WFS Capabilities error. Could not load layers.",t;i=n.WFS_Capabilities;var s=null;i._attr&&(s=i._attr.version._value),t=i,t.version=s;var o=[];if(i.FeatureTypeList)o=i.FeatureTypeList.FeatureType;else{if(!i["wfs:FeatureTypeList"])return t.success=!1,t.error_msg="No WFS Features provided in selected endpoint.",t;o=i["wfs:FeatureTypeList"]["wfs:FeatureType"]}for(var u in o){var a=o[u];a.Name=a.Name._text,a.Title=a.Title._text,a.Abstract=a.Abstract._text;var f=[];for(var l in a.Keywords.Keyword){var c=a.Keywords.Keyword[l];f.push(c._text)}a.Keywords=f;var h=a.WGS84BoundingBox,p=null;if(h){var d=h.LowerCorner._text.split(" "),v=h.UpperCorner._text.split(" ");p=[parseFloat(d[0]),parseFloat(d[1]),parseFloat(v[0]),parseFloat(v[1])],a.WGS84BoundingBox=p}var m=null;if(a.DefaultCRS){var g=a.DefaultCRS._text,y=g.split(":");m=y[y.length-3]+":"+y[y.length-1],a.DefaultCRS=m}}t.Layer=o;var b=null;return i.OperationsMetadata&&(b=i.OperationsMetadata.Operation),t.Format=b,t.success=!0,t}}),t.locator.register("PublicaMundi.Parser",t.Parser),t.parser=function(e){return t.locator.create("PublicaMundi.Parser",e)}}(window,PublicaMundi),function(e,t){if(typeof t=="undefined")return;t.define("PublicaMundi"),t.Layer=t.Class({initialize:function(e){this._map=null,this._type=null,this._layer=null,this._style={normal:{color:"#3399CC",radius:6,weight:1.25,opacity:1,fillColor:"#FFFFFF",fillOpacity:.4},highlight:{}},this._extent=e.bbox||null,this._options=e||{}},setMap:function(e){this._map=e},getMap:function(){return this._map},getType:function(){return this._type},getLayer:function(){return this._layer},getStyle:function(){return this._style},fitToMap:function(){return this._extent},onLayerLoad:function(){return this._layer},getOptions:function(){return this._options},addToControl:function(){return null},update:function(){return null},_transformStyle:function(){return null}}),t.locator.register("PublicaMundi.Layer",t.Layer)}(window,PublicaMundi);