PublicaMundi.noConflict(),PublicaMundi.ready(function(){var e,t,n={endpoint:"../",alias:config.api.alias};PublicaMundi.Data.configure(n);var n={target:"map",center:[2658716,46e5],zoom:9,layers:[{title:"Open Street Maps",type:PublicaMundi.LayerType.WMS,url:config.servers.mapproxy,params:{layers:config.layers.osm}}]};e=PublicaMundi.map(n),t=e.addOverlay($("#popup").get()[0]);var r=null,i=function(){$("#location-filter-text").val(""),r&&r.layer.city&&e.removeLayer(r.layer.city),r&&r.layer.flags&&e.removeLayer(r.layer.flags),r={layer:{city:null,flags:null},selection:null,result:null}};$("#location-filter-remove").click(function(){i()}),i(),$("#map").click(function(){$("#popup").data("bs.popover")&&$("#popup").popover("hide")});var s=function(e){return e.label},o=function(e){var t=[];return t.push('<div style="white-space: nowrap;">'+e.WATERNAME+" "),e.distance>1e3?t.push((e.distance/1e3).toFixed(2)+" km"):t.push(e.distance.toFixed(2)+" m"),t.push("</div>"),t.join("")},u=function(n,r){var i=null;n&&(i=n[0]),e.setOverlayPosition(t,r);var u=i.hasOwnProperty("label")?s(i):o(i);$("#popup").data("bs.popover")?$("#popup").data("bs.popover").options.content=u:$("#popup").popover({placement:"top",animation:!0,html:!0,content:u}),$("#popup").popover("show")},a=new PublicaMundi.Data.Query,f=function(t){r.result=t,r.layer.city&&e.removeLayer(r.layer.city),r.layer.flags&&e.removeLayer(r.layer.flags),r.result.success&&(r.layer.city=e.geoJSON({data:r.selection,click:u,style:{normal:{color:"#252525",opacity:1,fillColor:"#F1EEE8",fillOpacity:1,weight:3,radius:6}}}),r.layer.flags=e.geoJSON({data:r.result.data[0],click:u,style:{normal:{color:"black",opacity:1,fillColor:"#00ff00",fillOpacity:1,weight:2,radius:6}}}),e.setCenter(r.selection.geometry.coordinates),e.setZoom(12),l(r.result.data[0]))},l=function(e){if(e.features.length==0){$("#results").hide();return}var t=[];t.push('<table class="table">'),t.push("<thead>"),t.push("<tr>"),t.push("<th>#</th>"),t.push("<th>Name</th>"),t.push("<th>Description</th>"),t.push("<th>Distance</th>"),t.push("</tr>"),t.push("</thead>"),t.push("<tbody>");for(var n=0;n<e.features.length;n++){var r=e.features[n].properties;t.push("<tr>"),t.push('<th scope="row">'+(n+1)+"</th>"),t.push("<td>"+r.WATERNAME+"</td>"),t.push("<td>"+r.DESCRIPT+"</td>");var i="-";r.distance>1e3?i=(r.distance/1e3).toFixed(2)+" km":i=r.distance.toFixed(2)+" m",t.push('<td style="white-space: nowrap;">'+i+"</td>"),t.push("</tr>")}t.push("</tbody>"),t.push("</table>"),$("#results").draggable().html(t.join("")).fadeIn(400)},c=function(e){},h=function(){a.reset().resource("flags").field("the_geom").field("PROVINCE").field("DESCRIPT").field("WATERNAME").distance({name:"the_geom"},r.selection.geometry,"distance").distanceLessOrEqual({name:"the_geom"},r.selection.geometry,5e3).orderBy("distance",!1).take(20).setSuccess(f).setFailure(c).execute()};$("#location-filter-text").autocomplete({source:function(e,t){var n=function(e){e.success?t(e.data[0].features.map(function(e,t,n){return{label:e.properties.label,value:e.properties.label,record:e}})):t([])},r=function(e){t([])};a.reset().resource("cities").resource("flags").field("cities","the_geom").field("cities","NAME_OIK","label").like({name:"NAME_OIK"},e.term).distanceLessOrEqual({resource:"cities",name:"the_geom"},{resource:"flags",name:"the_geom"},5e3).orderBy("label").take(10).setSuccess(n).setFailure(r).execute()},select:function(e,t){r.selection=t.item.record,h()},minLength:3,_renderItem:function(e,t){return $("<li>").attr("data-value",t.value).append(t.label).appendTo(e)}}),$("#location-filter-text").focus()});