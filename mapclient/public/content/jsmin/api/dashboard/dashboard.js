define(["module","jquery","ol","URIjs/URI","data_api","shared"],function(module,$,ol,URI,API,PublicaMundi){"use strict";var properties={resources:null,layer:null,map:{query:null,layer:null},schema:{}},queryIndex=0,QueryMode={JSON:"json",FLUENT:"fluent",WPS:"wps"},index=window.location.href.indexOf("api/dashboard"),relativePath=window.location.href.substr(0,index),options={debug:module.config().debug,endpoint:relativePath,alias:module.config().api.alias};API.Data.configure(options);var wpsOptions={endpoint:module.config().api.wps,corsEnabled:!1,proxy:relativePath+"proxy/proxy_resource?url=",delay:2e3,mappings:{Buffer:{id:"ogr.Buffer",params:[{name:"InputPolygon",type:"complex",mimeType:"text/xml"},{name:"BufferDistance",type:"literal"}],result:"Result"},Voronoi:{id:"cgal.Voronoi",params:[{name:"InputPoints",type:"complex",mimeType:"text/xml"}],result:"Result"},Centroid:{id:"ogr.Centroid",params:[{name:"InputPolygon",type:"complex",mimeType:"text/xml"}],result:"Result"},Boundary:{id:"ogr.Boundary",params:[{name:"InputPolygon",type:"complex",mimeType:"text/xml"}],result:"Result"},ConvexHull:{id:"ogr.ConvexHull",params:[{name:"InputPolygon",type:"complex",mimeType:"text/xml"}],result:"Result"}}};API.Data.WPS.configure(wpsOptions);var suspendActionUI=function(){$(".action-img-button").addClass("action-img-button-disabled").removeClass("action-img-button")},resumeActionUI=function(){$(".action-img-button-disabled").addClass("action-img-button").removeClass("action-img-button-disabled")},isBusy=function(){return $(".progress-loader").is(":visible")},createOSM=function(){return module.config().servers.osm.length>0?new ol.layer.Tile({source:new ol.source.XYZ({attributions:[ol.source.OSM.ATTRIBUTION],urls:module.config().servers.osm}),opacity:$("#base-layer-opacity").val()/100}):module.config().servers.mapproxy.length>0?new ol.layer.Tile({source:new ol.source.TileWMS({attributions:[ol.source.OSM.ATTRIBUTION],url:module.config().servers.mapproxy,params:{SERVICE:"WMS",VERSION:"1.1.1",LAYERS:module.config().layers.osm}}),opacity:$("#base-layer-opacity").val()/100}):new ol.layer.Tile({source:new ol.source.OSM({attributions:[ol.source.OSM.ATTRIBUTION]}),opacity:$("#base-layer-opacity").val()/100})};properties.map.layer=new ol.Map({layers:[createOSM()],target:"map-layer",view:new ol.View({center:[2448716,46e5],zoom:9})});var queryEditor=CodeMirror.fromTextArea(document.getElementById("query"),{lineNumbers:!0,mode:{name:"javascript",globalVars:!0},matchBrackets:!0,lineWrapping:!0,tabSize:8,extraKeys:{"Ctrl-Space":"autocomplete"}});queryEditor.on("keyup",function(e,t){t.key==="."&&queryEditor.showHint(t)});var outputEditor=CodeMirror.fromTextArea(document.getElementById("output"),{lineNumbers:!0,mode:"application/json",matchBrackets:!0,lineWrapping:!0,tabSize:8,readOnly:!0}),jsonSyntaxEditor=CodeMirror.fromTextArea(document.getElementById("json-syntax"),{lineNumbers:!0,mode:"application/json",matchBrackets:!0,lineWrapping:!0,tabSize:8,readOnly:!0});$("img.action-button").tooltip(),$.widget("custom.iconselectmenu",$.ui.selectmenu,{_renderItem:function(e,t){var n=$("<li>",{text:t.label});return t.disabled&&n.addClass("ui-state-disabled"),$("<span>",{style:t.element.attr("data-style"),"class":"ui-icon "+t.element.attr("data-class")}).appendTo(n),n.appendTo(e)}}),$("#resource_id").selectmenu().selectmenu("disable"),$("#resource_id-menu").css({"max-height":"200px","min-width":"350px"}),$("#process_id").selectmenu().selectmenu("disable"),$("#process_id-menu").css({"max-height":"200px","min-width":"350px"});var vectorSource=new ol.source.Vector({projection:"EPSG:3857",format:new ol.format.GeoJSON});$("#process_show").click(function(){$("#query_size, #query_time").hide(),$(".progress-loader").show();var e=new API.Data.Query;e.getProcesses({success:function(e){$("#output").val(JSON.stringify(e,null," ")),$("#examples-tabs").tabs("option","active",1),outputEditor.setValue($("#output").val());var t=e.Capabilities.ProcessOfferings.Process;$("#process_id").find("option").remove();for(var n=0;n<t.length;n++)$("#process_id").append($("<option>",{value:t[n].Identifier.__text,text:t[n].Identifier.__text}));if($("#process_id").find("option").size()===0)$("#process_id").selectmenu().selectmenu("disable");else{$("#process_id").selectmenu().selectmenu("enable");var r=$("#process_id").find("option").eq(0).val();$("#process_id").val(r),$("#process_id").selectmenu("refresh")}},complete:function(){$(".progress-loader").hide()}})});var describe_resource=function(e){if(properties.schema.hasOwnProperty(e))displaySchema(e,properties.schema[e]);else{var t=new API.Data.Query;t.describeResource({id:e,context:this,success:function(t){properties.schema[e]=t.resource,displaySchema(e,t.resource)}})}},displaySchema=function(e,t){var n=[],r=t.fields;n.push('<table class="schema-table">');for(var i in r)n.push('<tr class="field-row"><td class="field-name">'+r[i].name+"</td>"),r[i].name===t.geometry_column?n.push('<td class="field-type field-geometry">'+r[i].type+"</td></tr>"):n.push('<td class="field-type">'+r[i].type+"</td></tr>");n.push("</table>"),$("#schema-table").html(n.join("")),$("#schema-dialog").is(":ui-dialog")?($("#schema-dialog").dialog("option","title","Schema : "+e),$("#schema-dialog").dialog("isOpen")||$("#schema-dialog").dialog("open")):$("#schema-dialog").dialog({title:"Schema : "+e,width:350,height:400,position:{my:"left bottom",at:"left bottom",of:$("#page-resources")},open:function(){}})};$("#process_describe").click(function(){$("#query_size, #query_time").hide(),$(".progress-loader").show();var e=new API.Data.Query;e.describeProcess({id:$("#process_id").val(),success:function(e){$("#output").val(JSON.stringify(e,null," ")),$("#examples-tabs").tabs("option","active",1),outputEditor.setValue($("#output").val())},complete:function(){$(".progress-loader").hide()}})});var resourceShow=function(e,t){$("#output").val(JSON.stringify(e,null," ")),$("#examples-tabs").tabs("option","active",1),outputEditor.setValue($("#output").val()),renderExecutionStats(t),$("#resource_id").find("option").remove();for(var n in e.resources)$("#resource_id").append($("<option>",{value:n,text:n}));if($("#resource_id").find("option").size()===0)$("#resource_id").selectmenu().selectmenu("disable");else{$("#resource_id").selectmenu().selectmenu("enable");var r=$("#resource_id").find("option").eq(0).val();$("#resource_id").val(r),$("#resource_id").selectmenu("refresh")}};$("#resource_show").click(function(){$("#query_size, #query_time").hide(),$(".progress-loader").show();var e=new API.Data.Query;e.getResources({context:this,success:resourceShow,complete:function(){$(".progress-loader").hide()}})});var describeResource=function(e,t){renderExecutionStats(t),$("#output").val(JSON.stringify(e,null," ")),$("#examples-tabs").tabs("option","active",1),outputEditor.setValue($("#output").val())};$("#resource_describe").click(function(){$("#query_size, #query_time").hide(),$(".progress-loader").show();var e=new API.Data.Query;e.describeResource({id:$("#resource_id").val(),context:this,success:describeResource,complete:function(){$(".progress-loader").hide()}})});var renderExecutionStats=function(e){e&&(e.size&&$("#query_size").html(e.size.toFixed(2)+" Kbs").show(),e.start&&e.end&&$("#query_time").html(((e.end-e.start)/1e3).toFixed(2)+" secs").show())},downloadFile=function(e,t){$("#output").val(JSON.stringify(e,null," ")),outputEditor.setValue($("#output").val()),renderExecutionStats(t),vectorSource.clear(),e.success?(jQuery("#export-download-frame").remove(),jQuery("body").append('<div id="export-download-frame" style="display: none"><iframe src="'+relativePath+"api/download/"+e.code+'"></iframe></div>')):$("#examples-tabs").tabs("option","active",1)},onSuccess=function(e,t){$(".progress-loader").hide(),$("#output").val(JSON.stringify(e,null," ")),outputEditor.setValue($("#output").val()),renderExecutionStats(t);if("success"in e&&!e.success){$("#examples-tabs").tabs("option","active",1);return}if(Array.isArray(e.data[0]))$("#examples-tabs").tabs("option","active",1);else{var n=new ol.format.GeoJSON,r=n.readFeatures(e.data[0],{dataProjection:"EPSG:3857",featureProjection:"EPSG:3857"});vectorSource.clear(),vectorSource.addFeatures(r),properties.map.query.getView().fitExtent(vectorSource.getExtent(),properties.map.query.getSize()),$("#examples-tabs").tabs("option","active",0)}},onFailure=function(e,t){renderExecutionStats(t),$("#dialog-message-text").html(e),$("#dialog-message").dialog({modal:!0})},onComplete=function(){$(".progress-loader").hide(),resumeActionUI()},initializeExecution=function(){return vectorSource.clear(),select.getFeatures().clear(),$("#query_size, #query_time").hide(),{size:null,start:(new Date).getTime(),end:null}},executeQuery=function(action){var execution=initializeExecution(),mode=$(".query-mode-option-selected").data("mode");switch(mode){case QueryMode.JSON:var query=new API.Data.Query;query.parse(queryEditor.getValue(" "));switch(action){case"execute":query.execute({context:this,success:onSuccess,failure:onFailure,complete:onComplete});break;case"export":query.format(API.Data.Format.ESRI).export({context:this,success:downloadFile,failure:onFailure,complete:onComplete})}break;case QueryMode.FLUENT:if(typeof PublicaMundi.queries[queryIndex].method=="function")try{var dynamicFunction=null,dynamicFunctionBody=queryEditor.getValue();dynamicFunctionBody=dynamicFunctionBody.split("PublicaMundi.Data").join("API.Data"),eval("dynamicFunction = function(onSuccess, onFailure, onComplete) { "+dynamicFunctionBody+"};"),typeof dynamicFunction=="function"&&dynamicFunction.call(this,onSuccess,onFailure,onComplete)}catch(e){console.log(e.toString())}break;case QueryMode.WPS:if(typeof PublicaMundi.queries[queryIndex].process=="function")try{var dynamicFunction=null,dynamicFunctionBody=queryEditor.getValue();dynamicFunctionBody=dynamicFunctionBody.split("PublicaMundi.Data").join("API.Data"),eval("dynamicFunction = function(onSuccess, onFailure, onComplete) { "+dynamicFunctionBody+"};"),typeof dynamicFunction=="function"&&dynamicFunction.call(this,onSuccess,onFailure,onComplete)}catch(e){console.log(e.toString())}}},setQuery=function(e){var t=$(".query-mode-option-selected").data("mode");$("#query_size, #query_time").hide(),e===0?$("#query_prev").removeClass("query-button-enabled").addClass("query-button-disabled"):$("#query_prev").hasClass("query-button-enabled")||$("#query_prev").addClass("query-button-enabled"),e===PublicaMundi.queries.length-1?$("#query_next").removeClass("query-button-enabled").addClass("query-button-disabled"):$("#query_next").hasClass("query-button-enabled")||$("#query_next").addClass("query-button-enabled"),$("#query_index").html(e+1),$("#query-notes").html(PublicaMundi.queries[e].description);switch(t){case QueryMode.JSON:var n=JSON.stringify(PublicaMundi.queries[e].query,null,"  "),r=API.Data.getConfiguration();if(r.alias)for(var i in r.alias)n=n.split('"'+i+'"').join('"'+r.alias[i]+'"');$("#query").val(n);break;case QueryMode.FLUENT:$("#query").val(PublicaMundi.queries[e].method.toString());break;case QueryMode.WPS:$("#query").val(PublicaMundi.queries[e].process.toString())}queryEditor.setValue($("#query").val()),queryEditor.refresh();if(t===QueryMode.FLUENT||t===QueryMode.WPS)queryEditor.execCommand("goDocEnd"),queryEditor.execCommand("deleteLine"),queryEditor.execCommand("goDocStart"),queryEditor.execCommand("deleteLine"),queryEditor.refresh()};setQuery(queryIndex),$("#query_prev").click(function(e){queryIndex>0&&(queryIndex--,setQuery(queryIndex))}),$("#query_next").click(function(e){queryIndex<PublicaMundi.queries.length-1&&(queryIndex++,setQuery(queryIndex))}),$("#query_exec").click(function(e){if(isBusy())return;suspendActionUI();var t=$(".query-mode-option-selected").data("mode");t==QueryMode.WPS&&$(".query-mode-option[data-mode=json]").click(),$(".progress-loader").show(),executeQuery("execute")}),$("#query_export").click(function(e){if(isBusy())return;suspendActionUI();var t=$(".query-mode-option-selected").data("mode");t!=QueryMode.JSON&&$(".query-mode-option[data-mode=json]").click(),$(".progress-loader").show(),executeQuery("export")}),$("#query_wps").click(function(e){if(isBusy())return;suspendActionUI();var t=$(".query-mode-option-selected").data("mode");t!=QueryMode.WPS&&$(".query-mode-option[data-mode=wps]").click(),$(".progress-loader").show(),executeQuery("process")}),$(".query-mode-option").click(function(e){if($(this).hasClass("query-mode-option-selected"))return;$(".query-mode-option").removeClass("query-mode-option-selected"),$(this).addClass("query-mode-option-selected");switch($(this).data("mode")){case QueryMode.JSON:setQuery(queryIndex);break;case QueryMode.FLUENT:setQuery(queryIndex);break;case QueryMode.WPS:setQuery(queryIndex)}});var timeout=null,toggleResourceTiles=function(){timeout&&(clearTimeout(timeout),timeout=null),timeout=setTimeout(function(){var e=$("#resource-filter").val();e?$(".resource-title").each(function(t,n){$(this).html().indexOf(e)==-1?$(this).parents(".resource-tile").hide():$(this).parents(".resource-tile").show()}):$(".resource-tile").show()},250)};$("#resource-filter").on("keydown",function(e){toggleResourceTiles()});var vectorLayer=new ol.layer.Vector({source:vectorSource}),select=new ol.interaction.Select({condition:ol.events.condition.click});select.getFeatures().on("change:length",function(e){if(e.target.getArray().length===0)$("#feature-dialog").hasClass("ui-dialog-content")&&$("#feature-dialog").dialog("close");else{var t=e.target,n=t.getArray()[0],r=[];r.push('<table class="feature-table">');var i=n.getKeys();for(var s=0;s<i.length;s++)i[s]!=n.getGeometryName()&&r.push('<tr class="feature-row"><td class="feature-prop-key">'+i[s]+'</td><td class="feature-prop-value">'+n.get(i[s])+"</td></tr>");r.push("</table>"),$("#feature-dialog .feature-dialog-content").html(r.join("\n")),$("#feature-dialog").is(":visible")||$("#feature-dialog").dialog({width:400,position:{my:"right-15 top+15",at:"right top",of:"#map"}})}}),properties.map.query=new ol.Map({layers:[createOSM(),new ol.layer.Vector({source:vectorSource})],target:"map",view:new ol.View({center:[2748716,46e5],zoom:7})}),properties.map.query.addInteraction(select),$("#examples-accordion").accordion({heightStyle:"fill"}),$("body").on("focus",".resource-tile-table",function(){$(this).select()}),$("#examples-tabs").tabs({heightStyle:"fill",activate:function(e,t){switch(t.newTab.index()){case 1:outputEditor.refresh();break;case 2:jsonSyntaxEditor.refresh()}}}),$("button.action").button();var loadResourcesFromCatalog=function(e){(!properties.resources||e)&&$.ajax({url:"../metadata/load",context:this,dataType:"json"}).done(function(e,t,n){var r=[],i=module.config().catalog;properties.resources=e;for(var s=0;s<e.packages.length;s++){var o=e.packages[s];for(var u=0;u<o.resources.length;u++){var a=o.resources[u];if(a.queryable){r.push('<div class="resource-tile" id="'+a.id+'">'),r.push('<div class="clearfix resource-label">Title</div>'),r.push('<div class="clearfix resource-title resource-value">'+o.title.en+"</div>"),r.push('<div class="clearfix resource-label">Resource Id</div>'),r.push('<div class="clearfix resource-value">'),r.push('<div class="clearfix resource-tile-map"><img src="../content/images/api/dashboard/layers.svg" data-package="'+o.id+'" data-resource="'+a.id+'" /></span></div>'),r.push('<div class="clearfix resource-value-text"><input value="'+a.queryable.resource+'" class="resource-tile-table" /></div>'),r.push("</div>"),r.push('<div class="clearfix resource-label">SRID</div>'),r.push('<div class="clearfix resource-value">'+a.queryable.srid+"</div>");var f="../?package="+o.id+"&resource="+a.id,l=i+"dataset/"+o.id;r.push('<div class="clearfix">'),r.push('<a class="resource-tile-link" href="'+l+'" target="_blank">View in catalog</a>'),r.push('<a class="resource-tile-link" href="'+f+'" target="_blank">View in maps</a>'),r.push('<a class="resource-tile-link resource-schema-link" href="#" data-resource="'+a.id+'">View schema</a>'),r.push("</div>"),r.push("</div>")}}}$("#resource-catalog-content").html(r.join("")),toggleResourceTiles(),$(".resource-schema-link").click(function(e){e.preventDefault(),describe_resource($(this).data("resource"))}),$("#resource-catalog-header").show(),$("#resource-catalog-content").fadeIn(250)})},viewResource=function(e,t){var n=properties.resources;if(!n)return;var r=null,i=null;for(var s=0;s<n.packages.length;s++)if(n.packages[s].id==e){r=n.packages[s];break}if(r)for(var s=0;s<r.resources.length;s++)if(r.resources[s].id==t){i=r.resources[s];break}if(!i||!i.wms_server||!i.wms_layer)return;var o=[1948226,4024868,4008846,5208724];if(r.spatial){var u=new ol.format.GeoJSON,a=u.readFeatures({type:"FeatureCollection",crs:{type:"name",properties:{name:"EPSG:4326"}},features:[{type:"Feature",geometry:r.spatial}]},{dataProjection:"EPSG:4326",featureProjection:"EPSG:3857"});o=a[0].getGeometry().getExtent()}properties.layer&&properties.map.layer.removeLayer(properties.layer),properties.layer=new ol.layer.Tile({source:new ol.source.TileWMS({url:i.wms_server,params:{VERSION:"1.3.0",LAYERS:i.wms_layer,projection:ol.proj.get("EPSG:900913")}})}),properties.map.layer.addLayer(properties.layer);if($("#map-dialog").is(":ui-dialog")){$("#map-dialog").dialog("isOpen")||$("#map-dialog").dialog("open");var f=properties.map.layer.getView(),l=properties.map.layer.getSize();f.fitExtent(o,l)}else $("#map-dialog").dialog({title:"Layer Preview",width:400,height:400,position:{my:"right bottom",at:"right bottom",of:$("#page-resources")},open:function(){$("#map-layer").height($("#map-dialog").height()-5).width($("#map-dialog").width()-2),properties.map.layer.updateSize();var e=properties.map.layer.getView(),t=properties.map.layer.getSize();e.fitExtent(o,t)},resize:function(){$("#map-layer").height($("#map-dialog").height()-5).width($("#map-dialog").width()-2),properties.map.layer.updateSize()}})};$("body").on("click",".resource-tile-map img",function(){var e=$(this).data("package"),t=$(this).data("resource");viewResource(e,t)}),$(".section").click(function(e){if($(this).hasClass("section-selected"))return;suspendPageUI();var t=$(this).data("page"),n=$(".section-selected").data("page");$(".section-selected").removeClass("section-selected"),$(this).addClass("section-selected"),$("#"+n).hide(),$("#"+t).show();switch(t){case"page-resources":loadResourcesFromCatalog()}$("#schema-dialog").is(":ui-dialog")&&$("#schema-dialog").dialog("close"),$("#map-dialog").is(":ui-dialog")&&$("#map-dialog").dialog("close"),$("#feature-dialog").is(":ui-dialog")&&$("#feature-dialog").dialog("close"),resize(),resumePageUI()});var suspendPageUI=function(){$("#page-overlay").show()},resumePageUI=function(){$("#page-overlay").fadeOut(400)},resize=function(){var e=$(".section-selected").data("page"),t=$("#"+e);$(".page").height($(window).height()-75).width($(window).width()-20);switch(e){case"page-docs":$("#docs-frame").height($(t).height()).width($(t).width());case"page-syntax":$("#page-syntax .CodeMirror").height($(t).height()).width($(t).width()),jsonSyntaxEditor.refresh();break;case"page-resources":$("#resource-catalog-content").height($(window).height()-115).width($(window).width()-20);break;case"page-examples":$("#examples-accordion-container").height($(window).height()-90),$("#examples-accordion").accordion("refresh"),$("#query-container .CodeMirror").height($(window).height()-291),queryEditor.refresh(),$("#examples-tabs-container").height($(window).height()-91).width($(window).width()-470),$("#examples-tabs").tabs("refresh"),$("#map").height($(window).height()-150).width($(window).width()-485),properties.map.query.updateSize(),$("#examples-tabs-2 .CodeMirror").height($(window).height()-150).width($(window).width()-482),outputEditor.refresh()}};return $(function(){$(window).resize(resize),resize(),$.ajax({url:"../content/js/api/dashboard/json-syntax.js",context:this,dataType:"text"}).done(function(e,t,n){$("#json-syntax").val(e),jsonSyntaxEditor.setValue($("#json-syntax").val()),$("#block-ui").fadeOut(500,function(){$("#docs-frame").attr("src","../content/js/lib/data-api/docs/index.html"),$("#page-docs").fadeIn(200),jsonSyntaxEditor.refresh()})})}),PublicaMundi});