define(["jquery","URIjs/URI","shared"],function(e,t,n){"use strict";n.define("Maps.CKAN"),n.Maps.CKAN.Metadata=n.Class(n.Maps.Observable,{initialize:function(e){this.values.path=null,this.values.endpoint=null,typeof n.Maps.Observable.prototype.initialize=="function"&&n.Maps.Observable.prototype.initialize.apply(this,arguments),this.values.catalog={groups:[],organizations:[],packages:[],nodes:[]},this.values.search={packages:[]},this.values.xhr=null},isPreloadingEnabled:function(){return this.values.metadata&&(this.values.metadata.path||this.values.metadata.database)?!0:!1},preload:function(){if(!this.isPreloadingEnabled())return;var n=this,r;return this.values.metadata.database?(r=new t,n.values.path==="/"?r.segment(["metadata","load"]):r.segment([n.values.path,"metadata","load"])):(r=new t(this.values.metadata.path),this.values.metadata.version&&r.addQuery({v:this.values.metadata.version})),new Promise(function(t,i){e.ajax({url:r.toString().replace(/\/\//g,"/").replace(/:\//g,"://"),context:n}).done(function(e){var r;n.values.catalog.nodes=e.nodes||[],n.values.catalog.organizations=e.organizations,n.values.catalog.groups=e.groups,n.values.catalog.packages=e.packages;for(r=0;r<n.values.catalog.organizations.length;r++)n.values.catalog.organizations[r].loaded=!0;for(r=0;r<n.values.catalog.groups.length;r++)n.values.catalog.groups[r].loaded=!0;t(e)}).fail(function(e,t,n){console.log("Failed to load CKAN organizations : "+r.toString()),i(n)})})},getNodeById:function(e){return this.values.catalog.nodes.hasOwnProperty(e)?this.values.catalog.nodes[e]:null},isNodeEmpty:function(e){var t=this.getNodeById(e);if(t.hasOwnProperty("isEmpty"))return t.isEmpty;if(t.resources.length>0)return t.isEmpty=!1,t.isEmpty;if(t.children.length===0)return t.isEmpty=!0,t.isEmpty;t.isEmpty=!0;for(var n=0;n<t.children.length;n++){var r=this.isNodeEmpty(t.children[n]);if(!r)return t.isEmpty=!1,t.isEmpty}return t.isEmpty},filterNode:function(e,t,n){var r=this.getNodeById(e);if(!r)return!0;for(var i=0;i<r.resources.length;i++){var s=this.getResourceById(r.resources[i]);if(s.name[n].indexOf(t)>-1)return!1}if(r.children.length>0)for(var o=0;o<r.children.length;o++){var u=this.filterNode(r.children[o],t,n);if(!u)return!1}return!0},getNodes:function(){return this.values.catalog.nodes},getNodeCount:function(){return Object.keys(this.values.catalog.nodes).length},getNodeChidlren:function(e){var t=[];if(!e&&e!==0)for(var n in this.values.catalog.nodes)!this.values.catalog.nodes[n].parent&&this.values.catalog.nodes[n].parent!==0&&t.push(this.values.catalog.nodes[n]);else{var r=this.getNodeById(e);for(var i in r.children)t.push(this.getNodeById(r.children[i]))}return t},loadOrganizations:function(){this.values.catalog.organizations=[];var n=this,r=new t(this.values.endpoint);return r.segment(["api","3","action","organization_list"]),r.addQuery({all_fields:!0}),new Promise(function(t,i){e.ajax({url:r.toString(),dataType:"jsonp",context:n}).done(function(e){var r=[];e.success&&e.result&&(n.values.catalog.organizations=e.result.map(function(e,t,n){return{id:e.id,name:e.name,caption:{el:e.display_name,en:e.display_name},title:{el:e.title,en:e.title},description:{el:e.description,en:e.description},image:e.image_display_url,loaded:!1}})),t(n.values.catalog.organizations)}).fail(function(e,t,n){console.log("Failed to load CKAN organizations : "+r.toString()),i(n)})})},getOrganizations:function(){return this.values.catalog.organizations},loadGroups:function(){this.values.catalog.groups=[];var n=this,r=new t(this.values.endpoint);return r.segment(["api","3","action","group_list"]),r.addQuery({all_fields:!0}),new Promise(function(t,i){e.ajax({url:r.toString(),dataType:"jsonp",context:n}).done(function(e){var r=[];e.success&&e.result&&(n.values.catalog.groups=e.result.map(function(e,t,n){return{id:e.id,name:e.name,caption:{el:e.display_name,en:e.display_name},title:{el:e.title,en:e.title},description:{el:e.description,en:e.description},image:e.image_display_url,loaded:!1}})),t(n.values.catalog.groups)}).fail(function(e,t,n){console.log("Failed to load CKAN groups : "+r.toString()),i(n)})})},getGroups:function(){return this.values.catalog.groups},isGroupEmpty:function(t){var n=this.getPackages();for(var r=0;r<n.length;r++)if(e.inArray(t,n[r].groups)!==-1)return!1;return!0},isOrganizationEmpty:function(e){var t=this.getPackages();for(var n=0;n<t.length;n++)if(e===t[n].organization)return!1;return!0},filterOrganization:function(e,t,n){var r=this.getPackages();for(var i=0;i<r.length;i++)if(e===r[i].organization)for(var s=0;s<r[i].resources.length;s++)if(r[i].resources[s].name[n].indexOf(t)>-1)return!1;return!0},loadPackages:function(){this.values.catalog.packages=[];var n=this,r=new t(this.values.endpoint);return r.segment(["api","3","action","current_package_list_with_resources"]),this.values.xhr&&this.values.xhr.readyState!==4&&(this.values.xhr.abort(),this.values.xhr=null),new Promise(function(t,i){n.values.xhr=e.ajax({url:r.toString(),context:n}).done(function(e){n.values.xhr=null;var r,i,s,o,u,a;if(e.success&&e.result){var f=e.result;for(i=0;i<f.length;i++){r={id:f[i].id,name:f[i].name,title:{el:f[i].title,en:f[i].title},notes:{el:f[i].notes,en:f[i].notes},organization:f[i].organization.id,groups:[],resources:[],spatial:null};for(u=0;u<f[i].groups.length;u++)r.groups.push(f[i].groups[u].id);for(a=0;a<f[i].extras.length;a++)if(f[i].extras[a].key==="spatial"){r.spatial=f[i].extras[a].value;break}for(o=0;o<f[i].resources.length;o++)s=f[i].resources[o],s.format==="wms"&&(s.package=r.id,s.name={el:s.name,en:s.name},s.description={el:s.description,en:s.description},r.resources.push(s));r.resources.length>0&&n.values.catalog.packages.push(r)}}t(n.values.catalog.packages)}).fail(function(e,t,n){console.log("Failed to load packages from CKAN catalog : "+r.toString()),i(n)})})},getPackages:function(){return this.values.catalog.packages},search:function(n,r){this.values.search.packages=[];var i=this,s=new t(this.values.endpoint);s.segment(["api","3","action","package_search"]);var o={};return n&&(o.q=n),r&&(o.extras={ext_bbox:r.join(",")}),this.values.xhr&&this.values.xhr.readyState!==4&&(this.values.xhr.abort(),this.values.xhr=null),new Promise(function(t,u){i.values.xhr=e.ajax({url:s.toString(),context:this,type:"POST",contentType:"application/json; charset=utf-8",dataType:"json",data:JSON.stringify(o)}).done(function(e){i.values.xhr=null;var s,o,u,a,f;if(e.success&&e.result){var l=e.result.results;for(o=0;o<l.length;o++){s={id:l[o].id,name:l[o].name,title:{el:l[o].title,en:l[o].title},notes:{el:l[o].notes,en:l[o].notes},organization:l[o].organization.id,groups:[],resources:[],spatial:l[o].spatial};if(r&&!s.spatial)continue;for(f=0;f<l[o].groups.length;f++)s.groups.push(l[o].groups[f].id);for(a=0;a<l[o].resources.length;a++)u=l[o].resources[a],u.format==="wms"&&(u.package=s.id,u.name={el:u.name,en:u.name},u.description={el:u.description,en:u.description},s.resources.push(u));s.resources.length>0&&i.values.search.packages.push(s)}}t({text:n,packages:i.values.search.packages})}).fail(function(e,t,n){console.log("Failed to search CKAN catalog : "+s.toString()),u(n)})})},getFilteredPackages:function(){return this.values.search.packages},getIndexOfOrganization:function(e){for(var t=0,n=this.values.catalog.organizations.length;t<n;t++)if(this.values.catalog.organizations[t].id===e)return t;return-1},getIndexOfGroup:function(e){for(var t=0,n=this.values.catalog.groups.length;t<n;t++)if(this.values.catalog.groups[t].id===e)return t;return-1},getIndexOfPackage:function(e){for(var t=0,n=this.values.catalog.packages.length;t<n;t++)if(this.values.catalog.packages[t].id===e)return t;return-1},loadOrganizationById:function(n){var r=this,i=new t(this.values.endpoint);return i.segment(["api","3","action","organization_show"]),i.addQuery({id:n,include_datasets:!0}),new Promise(function(t,s){var o=r.getIndexOfOrganization(n);if(o>=0&&r.values.catalog.organizations[o].loaded===!0){t(r.values.catalog.organizations[o]);return}e.ajax({url:i.toString(),dataType:"jsonp",context:r}).done(function(e){var n=null,i;if(e.success&&e.result){n={id:e.result.id,name:e.result.name,caption:{el:e.result.display_name,en:e.result.display_name},title:{el:e.result.title,en:e.result.title},description:{el:e.result.description,en:e.result.description},image:e.result.image_display_url,loaded:!0};var s,o,u,a,f,l,c=e.result.packages;for(o=0;o<c.length;o++){s={id:c[o].id,name:c[o].name,title:{el:c[o].title,en:c[o].title},notes:{el:c[o].notes,en:c[o].notes},organization:c[o].organization.id,groups:[],resources:[],spatial:c[o].spatial};for(f=0;f<c[o].groups.length;f++)s.groups.push(c[o].groups[f].id);for(a=0;a<c[o].resources.length;a++)u=c[o].resources[a],u.format==="wms"&&(u.package=s.id,u.name={el:u.name,en:u.name},u.description={el:u.description,en:u.description},s.resources.push(u));s.resources.length>0&&(i=r.getIndexOfPackage(s.id),i<0&&r.values.catalog.packages.push(s))}i=r.getIndexOfOrganization(n.id),i<0?r.values.catalog.organizations.push(n):r.values.catalog.organizations[i].loaded=!0}t(n)}).fail(function(e,t,n){console.log("Failed to load CKAN organization : "+i.toString()),s(n)})})},getOrganizationById:function(e){for(var t=0;t<this.values.catalog.organizations.length;t++)if(this.values.catalog.organizations[t].id===e)return this.values.catalog.organizations[t];return null},loadGroupById:function(n){var r=this,i=new t(this.values.endpoint);return i.segment(["api","3","action","group_show"]),i.addQuery({id:n}),new Promise(function(t,s){var o=r.getIndexOfGroup(n);if(o>=0&&r.values.catalog.groups[o].loaded===!0){t(r.values.catalog.groups[o]);return}e.ajax({url:i.toString(),dataType:"jsonp",context:r}).done(function(e){var n=null,i;if(e.success&&e.result){n={id:e.result.id,name:e.result.name,caption:{el:e.result.display_name,en:e.result.display_name},title:{el:e.result.title,en:e.result.title},description:{el:e.result.description,en:e.result.description},image:e.result.image_display_url,loaded:!0};var s,o,u,a,f,l,c=e.result.packages;for(o=0;o<c.length;o++){s={id:c[o].id,name:c[o].name,title:{el:c[o].title,en:c[o].title},notes:{el:c[o].notes,en:c[o].notes},organization:c[o].organization.id,groups:[],resources:[],spatial:c[o].spatial};for(f=0;f<c[o].groups.length;f++)s.groups.push(c[o].groups[f].id);for(a=0;a<c[o].resources.length;a++)u=c[o].resources[a],u.format==="wms"&&(u.package=s.id,u.name={el:u.name,en:u.name},u.description={el:u.description,en:u.description},s.resources.push(u));s.resources.length>0&&(i=r.getIndexOfPackage(s.id),i<0&&r.values.catalog.packages.push(s))}i=r.getIndexOfGroup(n.id),i<0?r.values.catalog.groups.push(n):r.values.catalog.groups[i].loaded=!0}t(n)}).fail(function(e,t,n){console.log("Failed to load CKAN organization : "+i.toString()),s(n)})})},getGroupById:function(e){for(var t=0;t<this.values.catalog.groups.length;t++)if(this.values.catalog.groups[t].id===e)return this.values.catalog.groups[t];return null},loadPackageById:function(n){var r=this,i=new t(this.values.endpoint);return i.segment(["api","3","action","package_show"]),i.addQuery({id:n}),new Promise(function(t,s){var o=r.getIndexOfPackage(n);if(o>=0){t(r.values.catalog.packages[o]);return}e.ajax({url:i.toString(),dataType:"jsonp",context:r}).done(function(e){var n=null,i;if(e.success&&e.result){n={id:e.result.id,name:e.result.name,title:e.result.title,notes:e.result.notes,organization:e.result.organization.id,groups:[],resources:[],spatial:e.result.spatial};for(var s=0;s<e.result.groups.length;s++)n.groups.push(e.result.groups[s].id);for(var o=0;o<e.result.resources.length;o++)i=e.result.resources[o],i.format==="wms"&&(i.package=n.id,n.resources.push(i));n.resources.length>0&&r.values.catalog.packages.push(n)}t(n)}).fail(function(e,t,n){console.log("Failed to load CKAN package : "+i.toString()),s(n)})})},getPackageById:function(e){var t;if(this.values.catalog.packages)for(t=0;t<this.values.catalog.packages.length;t++)if(this.values.catalog.packages[t].id===e)return this.values.catalog.packages[t];if(this.values.search.packages)for(t=0;t<this.values.search.packages.length;t++)if(this.values.search.packages[t].id===e)return this.values.search.packages[t];return null},getResourceById:function(e){var t,n,r;if(this.values.catalog.packages)for(t=0;t<this.values.catalog.packages.length;t++){r=this.values.catalog.packages[t];if(r.resources)for(n=0;n<r.resources.length;n++)if(r.resources[n].id===e)return r.resources[n]}if(this.values.search.packages)for(t=0;t<this.values.search.packages.length;t++){r=this.values.search.packages[t];if(r.resources)for(n=0;n<r.resources.length;n++)if(r.resources[n].id===e)return r.resources[n]}return null},getObjectTitle:function(e,t){switch(e){case"group":return this.getGroupById(t).caption;case"organization":return this.getOrganizationById(t).caption;case"package":return this.getPackageById(t).title;default:return""}},getObjectDescription:function(n,r){var i=this;return new Promise(function(s,o){var u={};switch(n){case"group":u={title:i.getGroupById(r).caption,description:i.getGroupById(r).description};break;case"organization":u={title:i.getOrganizationById(r).caption,description:i.getOrganizationById(r).description};break;case"package":u={title:i.getPackageById(r).title,description:i.getPackageById(r).notes};break;default:s({});return}if(u.description)s(u);else{var a=new t;i.values.path==="/"?a.segment(["metadata",n,r]):a.segment([i.values.path,"metadata",n,r]),e.ajax({url:a.toString().replace(/\/\//g,"/").replace(/:\//g,"://"),context:i}).done(function(e){if(e.success){switch(n){case"group":i.getGroupById(r).description=e.text;break;case"organization":i.getOrganizationById(r).description=e.text;break;case"package":i.getPackageById(r).notes=e.text}u.description=e.text,s(u)}else o(null)}).fail(function(e,t,n){console.log("Failed to object description : "+a.toString()),o(n)})}})}})});