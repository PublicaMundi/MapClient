define(["jquery","ol","URIjs/URI","shared"],function(e,t,n,r){r.Maps.Resources.Types.WMS=r.Maps.Resources.Types.WMS||"WMS";var i=function(e){for(var t=0;t<e.length;t++)if(!isFinite(e[t]))return!1;return!0},s=function(e,n,s,o){if(e)return e;var u=n.extent,a,f;switch(n.crs){case r.Maps.CRS.Mercator:case r.Maps.CRS.Google:return n.extent;case r.Maps.CRS.WGS84:a=t.proj.transform([u[1],u[0]],r.Maps.CRS.WGS84,r.Maps.CRS.Mercator),f=t.proj.transform([u[3],u[2]],r.Maps.CRS.WGS84,r.Maps.CRS.Mercator),u=[a[0],a[1],f[0],f[1]];if(i(u))return u;break;case r.Maps.CRS.CRS84:a=t.proj.transform([u[0],u[1]],r.Maps.CRS.WGS84,r.Maps.CRS.Mercator),f=t.proj.transform([u[2],u[3]],r.Maps.CRS.WGS84,r.Maps.CRS.Mercator),u=[a[0],a[1],f[0],f[1]];if(i(u))return u}return null};return r.Maps.Resources.WmsMetadataReader=r.Class(r.Maps.Resources.ResourceMetadataReader,{initialize:function(e){typeof r.Maps.Resources.ResourceMetadataReader.prototype.initialize=="function"&&r.Maps.Resources.ResourceMetadataReader.prototype.initialize.apply(this,arguments),this.values.cache={}},getMetadata:function(i){i=i||{url:null};var o=this;if(!i.url)throw"Parameter url is required.";if(!this.values.proxy&&r.isProxyRequired(window.location.href,i.url))throw"Parameter proxy is not set.";var u={service:"WMS",version:"1.3.0"},a={request:"GetCapabilities",service:"WMS"},f=[],l=n.parse(i.url)||{},c=l.query?n.parseQuery(l.query):{};for(var h in c)h.toLowerCase()==="version"&&c[h]&&(u[h]=c[h],a[h]=c[h]),h.toLowerCase()==="map"&&c[h]&&(u[h]=c[h],a[h]=c[h]),h.toLowerCase()==="layers"&&c[h]&&(u[h]=c[h]);var p=n.build({protocol:l.protocol?l.protocol:"http",hostname:l.hostname,port:l.port==="80"?"":l.port,path:l.path}),d={type:r.Maps.Resources.Types.WMS,key:p,endpoint:p,parameters:u,layers:[],title:null},v=n.build({protocol:l.protocol?l.protocol:"http",hostname:l.hostname,port:l.port==="80"?"":l.port,path:l.path,query:n.buildQuery(a)});return r.isProxyRequired(window.location.href,v)&&(v=this.values.proxy+encodeURIComponent(v)),new Promise(function(n,r){if(o.values.cache[d.key]){n(o.values.cache[d.key]);return}e.ajax({url:v,context:o,headers:{Accept:"text/xml; charset=utf-8","Content-Type":"text/xml; charset=utf-8"}}).done(function(r){var i=new t.format.WMSCapabilities,u=i.read(r);d.title=u.Service.Title,d.parameters.version=u.version||d.parameters.version;var a=[];typeof u.Capability!="undefined"&&typeof u.Capability.Layer!="undefined"&&(typeof u.Capability.Layer.Layer!="undefined"&&e.isArray(u.Capability.Layer.Layer)?a=u.Capability.Layer.Layer:a.push(u.Capability.Layer));for(var f=0;f<a.length;f++){var l={key:a[f].Name,name:a[f].Name,title:a[f].Title,bbox:a[f].BoundingBox.reduce(s,null),queryable:a[f].queryable,legend:null};a[f].Style&&a[f].Style.length>0&&a[f].Style[0].LegendURL&&a[f].Style[0].LegendURL.length>0&&(l.legend=a[f].Style[0].LegendURL[0].OnlineResource),d.layers.push(l)}o.values.cache[d.key]=d,n(d)}).fail(function(e){console.log("Failed to execute request : "+v),r({status:e.status,statusText:e.statusText})})})}}),r.Maps.Resources.WmsCkanResourceMetadataReaderAdapter=r.Class(r.Maps.Resources.CkanResourceMetadataReaderAdapter,{initialize:function(e){r.extend(this.values,e)},setOptions:function(e){e.metadata=null;if(e.format&&e.format.toUpperCase()==="WMS"){var t=e.wms_server||e.url||"",i=e.wms_layer||"";if(t){if(!i){var s=n.parse(t)||{},o=s.query?n.parseQuery(s.query):{};for(var u in o)u.toLowerCase()==="layers"&&o[u]&&(i=o[u])}e.metadata={type:r.Maps.Resources.Types.WMS,parameters:{url:t},extras:{layer:i}}}}return e}}),r.Maps.Resources.WmsLayerFactory=r.Class(r.Maps.Resources.LayerFactory,{initialize:function(e){typeof r.Maps.Resources.LayerFactory.prototype.initialize=="function"&&r.Maps.Resources.LayerFactory.prototype.initialize.apply(this,arguments)},create:function(e,n,i,s){var o={LAYERS:i,tiled:!0};for(var u in n.parameters)u.toLowerCase()==="map"&&n.parameters[u]&&(o.MAP=n.parameters[u]),u.toLowerCase()==="version"&&n.parameters[u]&&(o.VERSION=n.parameters[u]);var a=new t.layer.Tile({title:s,source:new t.source.TileWMS({url:n.endpoint,params:o,projection:r.Maps.CRS.Mercator})});return a}}),r.Maps.Resources.registerResourceType(r.Maps.Resources.Types.WMS,"WMS",r.Maps.Resources.WmsMetadataReader,r.Maps.Resources.WmsLayerFactory),r.Maps.Resources.registerResourceTypeAdapter("WMS",r.Maps.Resources.Types.WMS,r.Maps.Resources.WmsCkanResourceMetadataReaderAdapter),r});