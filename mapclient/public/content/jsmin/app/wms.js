define(["jquery","ol","URIjs/URI","shared"],function(e,t,n,r){r.Maps.Resources.Types.WMS=r.Maps.Resources.Types.WMS||"WMS";var i=function(e){for(var t=0;t<e.length;t++)if(!isFinite(e[t]))return!1;return!0},s=function(e){var n,s;return n=t.proj.transform([e[0],e[1]],r.Maps.CRS.WGS84,r.Maps.CRS.Mercator),s=t.proj.transform([e[2],e[3]],r.Maps.CRS.WGS84,r.Maps.CRS.Mercator),e=[n[0],n[1],s[0],s[1]],i(e)?e:null},o=function(e,n,s,o){if(e)return e;var u=n.extent,a,f;switch(n.crs){case r.Maps.CRS.Mercator:case r.Maps.CRS.Google:return n.extent;case r.Maps.CRS.WGS84:a=t.proj.transform([u[1],u[0]],r.Maps.CRS.WGS84,r.Maps.CRS.Mercator),f=t.proj.transform([u[3],u[2]],r.Maps.CRS.WGS84,r.Maps.CRS.Mercator),u=[a[0],a[1],f[0],f[1]];if(i(u))return u;break;case r.Maps.CRS.CRS84:a=t.proj.transform([u[0],u[1]],r.Maps.CRS.WGS84,r.Maps.CRS.Mercator),f=t.proj.transform([u[2],u[3]],r.Maps.CRS.WGS84,r.Maps.CRS.Mercator),u=[a[0],a[1],f[0],f[1]];if(i(u))return u}return null};return r.Maps.Resources.WmsMetadataReader=r.Class(r.Maps.Resources.ResourceMetadataReader,{initialize:function(e){typeof r.Maps.Resources.ResourceMetadataReader.prototype.initialize=="function"&&r.Maps.Resources.ResourceMetadataReader.prototype.initialize.apply(this,arguments),this.values.cache={}},getMetadata:function(i){i=i||{url:null};var o=this;if(!i.url)throw"Parameter url is required.";if(!this.values.proxy&&r.isProxyRequired(window.location.href,i.url))throw"Parameter proxy is not set.";var u={service:"WMS",version:"1.3.0"},a={request:"GetCapabilities",service:"WMS"},f=[],l=n.parse(i.url)||{},c=l.query?n.parseQuery(l.query):{};for(var h in c)h.toLowerCase()==="version"&&c[h]&&(u[h]=c[h],a[h]=c[h]),h.toLowerCase()==="map"&&c[h]&&(u[h]=c[h],a[h]=c[h]),h.toLowerCase()==="layers"&&c[h]&&(u[h]=c[h]);var p=n.build({protocol:l.protocol?l.protocol:"http",hostname:l.hostname,port:l.port==="80"?"":l.port,path:l.path}),d={type:r.Maps.Resources.Types.WMS,key:p,endpoint:p,parameters:u,layers:[],title:null},v=n.build({protocol:l.protocol?l.protocol:"http",hostname:l.hostname,port:l.port==="80"?"":l.port,path:l.path,query:n.buildQuery(a)});return r.isProxyRequired(window.location.href,v)&&(v=this.values.proxy+encodeURIComponent(v)),new Promise(function(n,r){if(o.values.cache[d.key]){n(o.values.cache[d.key]);return}var i=e.ajax({url:window.location.href+"api/describe_layergroups",context:o,headers:{Accept:"text/xml; charset=utf-8","Content-Type":"text/xml; charset=utf-8"}}),u=e.ajax({url:v,context:o,headers:{Accept:"text/xml; charset=utf-8","Content-Type":"text/xml; charset=utf-8"}});e.when(i,u).done(function(r,i){var u=JSON.parse(r[0]);console.log(u.layergroups["topp:gps-nea-peramos"][2]);var a=new t.format.WMSCapabilities,f=a.read(i[0]);d.title=f.Service.Title,d.parameters.version=f.version||d.parameters.version;var l=[];typeof f.Capability!="undefined"&&typeof f.Capability.Layer!="undefined"&&(typeof f.Capability.Layer.Layer!="undefined"&&e.isArray(f.Capability.Layer.Layer)?l=f.Capability.Layer.Layer:l.push(f.Capability.Layer));var c=Object.keys(u.layergroups);for(var h=0;h<l.length;h++){var p={key:l[h].Name,name:l[h].Name,title:l[h].Title,bbox:s(l[h].EX_GeographicBoundingBox),queryable:l[h].queryable,legend:null};if(l[h].Style&&l[h].Style.length>0&&l[h].Style[0].LegendURL&&l[h].Style[0].LegendURL.length>0)p.legend=l[h].Style[0].LegendURL[0].OnlineResource;else if(c.indexOf(l[h].Name)>=0){p.legend="content/images/app/legend.png",layerComponents=u.layergroups[l[h].Name],p.layerGroupLegend=[];for(var v=0;v<l.length;v++)layerComponents.indexOf(l[v].Name)>=0&&p.layerGroupLegend.push({title:l[v].Title,legend:l[v].Style[0].LegendURL[0].OnlineResource})}d.layers.push(p)}o.values.cache[d.key]=d,n(d)}).fail(function(e){console.log("Failed to execute request : "+v),r({status:e.status,statusText:e.statusText})})})}}),r.Maps.Resources.WmsCkanResourceMetadataReaderAdapter=r.Class(r.Maps.Resources.CkanResourceMetadataReaderAdapter,{initialize:function(e){r.extend(this.values,e)},setOptions:function(e){e.metadata=null;if(e.format&&e.format.toUpperCase()==="WMS"){var t=e.wms_server||e.url||"",i=e.wms_layer||"";if(t){if(!i){var s=n.parse(t)||{},o=s.query?n.parseQuery(s.query):{};for(var u in o)u.toLowerCase()==="layers"&&o[u]&&(i=o[u])}e.metadata={type:r.Maps.Resources.Types.WMS,parameters:{url:t},extras:{layer:i}}}}return e}}),r.Maps.Resources.WmsLayerFactory=r.Class(r.Maps.Resources.LayerFactory,{initialize:function(e){typeof r.Maps.Resources.LayerFactory.prototype.initialize=="function"&&r.Maps.Resources.LayerFactory.prototype.initialize.apply(this,arguments)},create:function(e,n,i,s){var o={LAYERS:i,tiled:!0};for(var u in n.parameters)u.toLowerCase()==="map"&&n.parameters[u]&&(o.MAP=n.parameters[u]),u.toLowerCase()==="version"&&n.parameters[u]&&(o.VERSION=n.parameters[u]);var a=new t.layer.Tile({title:s,source:new t.source.TileWMS({url:n.endpoint,params:o,projection:r.Maps.CRS.Mercator})});return a}}),r.Maps.Resources.registerResourceType(r.Maps.Resources.Types.WMS,"WMS",r.Maps.Resources.WmsMetadataReader,r.Maps.Resources.WmsLayerFactory),r.Maps.Resources.registerResourceTypeAdapter("WMS",r.Maps.Resources.Types.WMS,r.Maps.Resources.WmsCkanResourceMetadataReaderAdapter),r});