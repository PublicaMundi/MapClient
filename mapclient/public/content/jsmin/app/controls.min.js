define(["module","jquery","ol","URIjs/URI","data_api","shared"],function(e,t,n,r,i,s){"use strict";var o=function(e,t){return t?function(n,r){return n[e][t]<r[e][t]?-1:n[e][t]>r[e][t]?1:0}:function(t,n){return t[e]<n[e]?-1:t[e]>n[e]?1:0}};s.Maps.Component=s.Class(s.Maps.Observable,{initialize:function(e){this.values.element=null,this.values.visible=!0,"function"==typeof s.Maps.Observable.prototype.initialize&&s.Maps.Observable.prototype.initialize.apply(this,arguments),this.event("render"),this.event("hide"),this.event("show"),this.values.visible?this.show():this.hide()},render:function(){this.trigger("render")},refresh:function(){this.render()},show:function(){t("#"+this.values.element).show(),this.trigger("show")},hide:function(){t("#"+this.values.element).hide(),this.trigger("hide")},localizeUI:function(e){},clear:function(){}}),s.Maps.LayerTreeViewMode={ByGroup:1,ByOrganization:2,ByFilter:3},s.Maps.LayerTree=s.Class(s.Maps.Component,{initialize:function(e){var r=this;s.extend(this.values,{map:null,ckan:null,resources:null,mode:s.Maps.LayerTreeViewMode.ByGroup}),"function"==typeof s.Maps.Component.prototype.initialize&&s.Maps.Component.prototype.initialize.apply(this,arguments);var i=this.values.ckan.isPreloadingEnabled();this.values.contentElement=this.values.element+"-result",this.values.filter={term:null},this.values.bbox={overlay:null,interaction:null,feature:null},this.values.mode===s.Maps.LayerTreeViewMode.ByFilter&&(this.values.bbox.overlay=new n.FeatureOverlay({style:[new n.style.Style({fill:new n.style.Fill({color:[255,255,255,.4]}),stroke:new n.style.Stroke({color:"#27AE60",width:2})})]}),this.values.bbox.overlay.setMap(this.values.map),this.values.bbox.interaction=new n.interaction.DragBox({style:new n.style.Style({fill:new n.style.Fill({color:[255,255,255,.4]}),stroke:new n.style.Stroke({color:"#27AE60",width:2})})}),this.values.bbox.interaction.on("boxstart",function(e){r.values.bbox.overlay.getFeatures().clear()}),this.values.bbox.interaction.on("boxend",function(e){var t=r.values.bbox.interaction.getGeometry(),i=new n.Feature({name:r.values.element+"-bbox",geometry:t});r.values.bbox.overlay.getFeatures().clear(),r.values.bbox.overlay.addFeature(i)}),this.values.map.addInteraction(this.values.bbox.interaction),this.values.bbox.interaction.setActive(!1)),this.event("layer:added"),this.event("layer:removed"),this.event("bbox:draw"),this.event("bbox:remove"),this.event("bbox:apply"),this.event("bbox:cancel"),this.event("catalog:search"),this.event("catalog:info-loading"),this.event("catalog:info-loaded"),this.values.rootTreeNode={id:null,children:[]},this.values.getTreeNodeById=function(e,t){if(!e)return null;t=t||r.values.rootTreeNode;for(var n=null,i=0;i<t.children.length;i++){if(t.children[i].id==e)return t.children[i];if(n=r.values.getTreeNodeById(e,t.children[i]))return n}return null},this.values.createTreeNodeElement=function(e,n,r){var i=[];n.isLeaf?i.push('<li id="node-'+this.values.element+"-"+n.id+'" class="tree-node tree-node-checkbox">'):i.push('<li id="node-'+this.values.element+"-"+n.id+'" class="tree-node">'),i.push('<div class="clearfix node-container">'),n.isLeaf?i.push('<div class="node-left"><img src="'+n.image+'" class="node-select img-30"/></div>'):i.push('<div class="node-left"><img src="'+n.image+'" class="tree-toggle img-25"/></div>'),n.hasInformation&&i.push('<div class="node-right tree-info"><img src="content/images/app/info.svg" class="img-16" /></div>'),n.i18n?i.push('<div class="tree-text" data-i18n-id="'+n.i18n+'">'+n.caption+"</div>"):i.push('<div class="tree-text">'+n.caption+"</div>"),i.push("</div></li>");var s=t(i.join(""));return s.data(r),e.children.push({id:n.id,element:s,children:[],caption:n.caption}),s},this.values.renderTreeNodeElements=function(e){var n,r,i,u,a,f=this.values.getTreeNodeById(e)||this.values.rootTreeNode,l=f.element||t("#"+this.values.contentElement),c=this.values.ckan.getNodeById(e);if(c){var h=t('<ul class="tree-node" style="display: none;"></ul>');t(l).append(h),l=h}else t(l).html("");var p=this.values.ckan.getNodeChidlren(e);for(p.sort(o("index")),n=0;n<p.length;n++)this.values.ckan.isNodeEmpty(p[n].id)||(r=s.i18n.getResource("node."+p[n].id,p[n].caption[s.i18n.getLocale()]),i={id:p[n].id,expanded:!1,loaded:!1,type:"node",parent:p[n].parent,caption:r,i18n:"node."+p[n].id},u={id:p[n].id,image:"content/images/app/show.svg",isLeaf:!1,caption:r,hasInformation:!1,i18n:"node."+p[n].id},a=this.values.createTreeNodeElement.call(this,f,u,i),t(l).append(a));if(c&&c.resources.length>0){var d=[];for(n=0;n<c.resources.length;n++)d.push(this.values.ckan.getResourceById(c.resources[n]));for(d.sort(o("node_index")),n=0;n<d.length;n++){var v=d[n],m=this.values.ckan.getPackageById(v["package"]);if(this.values.resources.setCatalogResourceMetadataOptions(v),v.metadata.extras.layer){var g=v.id+"_"+v.metadata.extras.layer,y=this.values.resources.isLayerSelected(g);r=v.name[s.i18n.getLocale()],i={id:g.replace(/[^\w\s]/gi,""),expanded:!1,loaded:!1,type:"layer",layer:g,selected:y,info:{type:"package",id:m.id},caption:r,i18n:"node.resource."+v.id},u={id:g.replace(/[^\w\s]/gi,""),image:y?"content/images/app/checkbox-checked.svg":"content/images/app/checkbox-empty.svg",isLeaf:!0,caption:r,hasInformation:1===m.resources.length,i18n:"node.resource."+v.id}}else r=v.name[s.i18n.getLocale()],i={id:v.id,expanded:!1,loaded:!1,type:"resource",info:{type:"package",id:m.id},caption:r,i18n:"node.resource."+v.id},u={id:v.id,image:"content/images/app/show.svg",isLeaf:!1,caption:r,hasInformation:1===m.resources.length,i18n:"node.resource."+v.id};a=this.values.createTreeNodeElement.call(this,f,u,i),t(l).append(a)}}},this.values.renderGroups=function(){var e;t("#"+this.values.contentElement).html("");var n=this.values.ckan.getGroups(),r=[];if(this.values.mode===s.Maps.LayerTreeViewMode.ByFilter){var u=this.values.ckan.getFilteredPackages();for(e=0;e<n.length;e++)for(var a=0;a<u.length;a++)if(-1!==t.inArray(n[e].id,u[a].groups)){r.push(n[e]);break}}else r=n;for(r.sort(o("caption",s.i18n.getLocale())),this.values.mode===s.Maps.LayerTreeViewMode.ByFilter&&0===r.length?t("#"+this.values.element+"-result").hide():t("#"+this.values.element+"-result").show(),e=0;e<r.length;e++)if(!i||!this.values.ckan.isGroupEmpty(r[e].id)){var f=s.i18n.getResource("group."+r[e].id,r[e].caption[s.i18n.getLocale()]),l={id:r[e].id,expanded:!1,loaded:!1,type:"group",info:{type:"group",id:r[e].id},caption:f,i18n:"group."+r[e].id},c={id:r[e].id,image:"content/images/app/show.svg",isLeaf:!1,caption:f,hasInformation:r[e].info||r[e].description&&r[e].caption[s.i18n.getLocale()]!=r[e].description[s.i18n.getLocale()],i18n:"group."+r[e].id},h=this.values.createTreeNodeElement.call(this,this.values.rootTreeNode,c,l);t("#"+this.values.contentElement).append(h)}},this.values.renderOrganizations=function(){t("#"+this.values.contentElement).html("");var e,n,r=this.values.ckan.getOrganizations(),u=[];if(this.values.mode===s.Maps.LayerTreeViewMode.ByFilter){var a=this.values.ckan.getFilteredPackages();for(e=0;e<r.length;e++)for(n=0;n<a.length;n++)if(r[e].id===a[n].organization){u.push(r[e]);break}}else u=r;for(u.sort(o("caption",s.i18n.getLocale())),e=0;e<u.length;e++)if(!i||!this.values.ckan.isOrganizationEmpty(u[e].id)){var f=s.i18n.getResource("organization."+u[e].id,u[e].caption[s.i18n.getLocale()]),l={id:u[e].id,expanded:!1,loaded:!1,type:"organization",info:{type:"organization",id:u[e].id},caption:f,i18n:"organization."+u[e].id},c={id:u[e].id,image:"content/images/app/show.svg",isLeaf:!1,caption:f,hasInformation:u[e].info||u[e].description&&u[e].caption[s.i18n.getLocale()]!=u[e].description[s.i18n.getLocale()],i18n:"organization."+u[e].id},h=this.values.createTreeNodeElement.call(this,this.values.rootTreeNode,c,l);t("#"+this.values.contentElement).append(h)}};var u=function(e,n){var r=this.values.getTreeNodeById(n),i=t("#node-"+this.values.element+"-"+n),u=this.values.ckan.getOrganizations(),a=[],f=[],l=[];l=this.values.mode===s.Maps.LayerTreeViewMode.ByFilter?this.values.ckan.getFilteredPackages():this.values.ckan.getPackages();for(var c=0;c<l.length;c++)if(-1!==t.inArray(n,l[c].groups)&&(f.push(l[c]),l[c].organization)){var h=this.values.ckan.getIndexOfOrganization(l[c].organization),p=!1;if(-1!==h){for(var d=0;d<a.length;d++)if(a[d].id===l[c].organization){p=!0;break}p||a.push(u[h])}}if(a.sort(o("caption",s.i18n.getLocale())),0===f.length){var v=t(i).find("img.tree-toggle").first();t(v).addClass("disabled"),t(v).attr("src","content/images/app/empty.svg"),t(i).find(".tree-text").first().addClass("tree-text-disabled")}else{var m=t('<ul class="tree-node" style="display: none;"></ul>');t(i).append(m);for(var g=0;g<a.length;g++){var y=s.i18n.getResource("organization."+a[g].id,a[g].caption[s.i18n.getLocale()]),w={id:a[g].id,expanded:!1,loaded:!1,type:"organization",info:{type:"organization",id:a[g].id},caption:y,i18n:"organization."+a[g].id},E={id:a[g].id,image:"content/images/app/show.svg",isLeaf:!1,caption:y,hasInformation:a[g].info||a[g].description&&a[g].caption[s.i18n.getLocale()]!=a[g].description[s.i18n.getLocale()],i18n:"organization."+a[g].id},S=this.values.createTreeNodeElement.call(this,r,E,w);t(m).append(S)}}},a=function(e,n){var i,u,a,f,l,c,h,p=t("#node-"+this.values.element+"-"+n),d=this.values.getTreeNodeById(n),v=[],m=[];v=this.values.mode===s.Maps.LayerTreeViewMode.ByFilter?this.values.ckan.getFilteredPackages():this.values.ckan.getPackages();for(var g=0;g<v.length;g++)v[g].organization===n&&m.push(v[g]);if(m.sort(o("title",s.i18n.getLocale())),0===m.length){var y=t(p).find("img.tree-toggle").first();t(y).addClass("disabled"),t(y).attr("src","content/images/app/empty.svg"),t(p).find(".tree-text").first().addClass("tree-text-disabled")}else{var w=t('<ul class="tree-node" style="display: none;"></ul>');for(t(p).append(w),i=0;i<m.length;i++)if(m[i].resources.length>0){for(u=0;u<m[i].resources.length;u++)this.values.resources.setCatalogResourceMetadataOptions(m[i].resources[u]);if(1===m[i].resources.length&&m[i].resources[0].metadata&&m[i].resources[0].metadata.extras.layer){a=m[i].resources[0].id;var E=a+"_"+m[i].resources[0].metadata.extras.layer,S=this.values.resources.isLayerSelected(E);f=m[i].resources[0].name[s.i18n.getLocale()],l={id:E.replace(/[^\w\s]/gi,""),expanded:!1,loaded:!1,type:"layer",layer:E,selected:S,info:{type:"package",id:m[i].id},caption:f,i18n:"node.resource."+a},c={id:E.replace(/[^\w\s]/gi,""),image:S?"content/images/app/checkbox-checked.svg":"content/images/app/checkbox-empty.svg",isLeaf:!0,caption:f,hasInformation:m[i].info||!!m[i].notes,i18n:"node.resource."+a},h=this.values.createTreeNodeElement.call(this,d,c,l),t(w).append(h)}else 1===m[i].resources.length?(a=m[i].resources[0].id,f=m[i].resources[0].name[s.i18n.getLocale()],l={id:a,expanded:!1,loaded:!1,type:"resource",info:{type:"package",id:m[i].id},caption:f,i18n:"node.resource."+a},c={id:a,image:"content/images/app/show.svg",isLeaf:!1,caption:f,hasInformation:m[i].info||!!m[i].notes,i18n:"node.resource."+a},h=this.values.createTreeNodeElement.call(this,d,c,l),t(w).append(h)):(f=m[i].title[s.i18n.getLocale()],l={id:m[i].id,expanded:!1,loaded:!1,type:"package",info:{type:"package",id:m[i].id},caption:f},c={id:m[i].id,image:"content/images/app/show.svg",isLeaf:!1,caption:f,hasInformation:m[i].info||!!m[i].notes},h=this.values.createTreeNodeElement.call(this,d,c,l),t(w).append(h))}}r.setFilter(r.getFilter(),0)},f=function(e,n){var i,u,a,f,l,c=t("#node-"+this.values.element+"-"+n),h=this.values.getTreeNodeById(n),p=[];p=this.values.mode===s.Maps.LayerTreeViewMode.ByFilter?this.values.ckan.getFilteredPackages():this.values.ckan.getPackages();var d=0,v=t('<ul class="tree-node" style="display: none;"></ul>');t(c).append(v);for(var m=0;m<p.length;m++)if(p[m].organization===n){var g=p[m].resources;g.sort(o("node_index"));for(var y=0;y<g.length;y++){if(d++,this.values.resources.setCatalogResourceMetadataOptions(g[y]),i=g[y].id,u=g[y].name[s.i18n.getLocale()],this.values.mode===s.Maps.LayerTreeViewMode.ByFilter&&1==p[m].resources.length){var w=this.values.ckan.getResourceById(i);u=w?w.name[s.i18n.getLocale()]:p[m].title[s.i18n.getLocale()]}if(g[y].metadata&&g[y].metadata.extras.layer){var E=i+"_"+g[y].metadata.extras.layer,S=this.values.resources.isLayerSelected(E);a={id:E.replace(/[^\w\s]/gi,""),expanded:!1,loaded:!1,type:"layer",layer:E,selected:S,info:{type:"package",id:p[m].id},caption:u,i18n:"node.resource."+i},f={id:E.replace(/[^\w\s]/gi,""),image:S?"content/images/app/checkbox-checked.svg":"content/images/app/checkbox-empty.svg",isLeaf:!0,caption:u,hasInformation:!!p[m].info&&1==p[m].resources.length,i18n:"node.resource."+i},l=this.values.createTreeNodeElement.call(this,h,f,a),t(v).append(l)}else a={id:i,expanded:!1,loaded:!1,type:"resource",info:{type:"package",id:p[m].id},caption:u,i18n:"node.resource."+i},f={id:i,image:"content/images/app/show.svg",isLeaf:!1,caption:u,hasInformation:!!p[m].info&&1==p[m].resources.length,i18n:"node.resource."+i},l=this.values.createTreeNodeElement.call(this,h,f,a),t(v).append(l)}}if(0===d){var x=t(c).find("img.tree-toggle").first();t(x).addClass("disabled"),t(x).attr("src","content/images/app/empty.svg"),t(c).find(".tree-text").first().addClass("tree-text-disabled")}r.setFilter(r.getFilter(),0)},l=function(e,n){var r,i,u,a,f=t("#node-"+this.values.element+"-"+n),l=this.values.getTreeNodeById(n),c=this.values.ckan.getPackageById(n);c.resources.sort(o("name",s.i18n.getLocale()));var h=t('<ul class="tree-node" style="display: none;"></ul>');t(f).append(h);for(var p=0;p<c.resources.length;p++){var d=c.resources[p];if(d.metadata.extras.layer){var v=d.id+"_"+d.metadata.extras.layer,m=this.values.resources.isLayerSelected(v);r=d.name[s.i18n.getLocale()],i={id:v.replace(/[^\w\s]/gi,""),expanded:!1,loaded:!1,type:"layer",layer:v,selected:m,caption:r,i18n:"node.resource."+d.id},u={id:v.replace(/[^\w\s]/gi,""),image:m?"content/images/app/checkbox-checked.svg":"content/images/app/checkbox-empty.svg",isLeaf:!0,caption:r,hasInformation:!1,i18n:"node.resource."+d.id}}else r=d.name[s.i18n.getLocale()],i={id:d.id,expanded:!1,loaded:!1,type:"resource",caption:r,i18n:"node.resource."+d.id},u={id:d.id,image:"content/images/app/show.svg",isLeaf:!1,caption:r,hasInformation:!1,i18n:"node.resource."+d.id};a=this.values.createTreeNodeElement.call(this,l,u,i),t(h).append(a)}},c=function(e,n,i){var s=t("#node-"+this.values.element+"-"+n),u=this.values.getTreeNodeById(n),a=(this.values.ckan.getResourceById(n),t('<ul class="tree-node" style="display: none;"></ul>'));t(s).append(a),i.sort(o("title"));for(var f=0;f<i.length;f++){var l=n+"_"+i[f].name,c=this.values.resources.isLayerSelected(l),h=i[f].title,p={id:l.replace(/[^\w\s]/gi,""),expanded:!1,loaded:!1,type:"layer",layer:l,selected:c,caption:h},d={id:l.replace(/[^\w\s]/gi,""),image:c?"content/images/app/checkbox-checked.svg":"content/images/app/checkbox-empty.svg",isLeaf:!0,caption:h,hasInformation:!1},v=this.values.createTreeNodeElement.call(this,u,d,p);t(a).append(v)}r.setFilter(r.getFilter(),0)};t("#"+this.values.element).on("click."+this.values.contentElement,".tree-text",function(){var e=t(this).parent().find(".tree-toggle");e.size()>0?e.click():(e=t(this).parent().find(".node-select"),e.size()>0&&e.click())}),t("#"+this.values.element).on("click."+this.values.contentElement,".tree-toggle",function(){var e=this,n=t(this).closest("li"),i=t(n).data(),s=i.id,o=i.type;if(!t(n).hasClass("disabled")){if(i.expanded)i.expanded=!1,t(this).removeClass("tree-node-collapse"),t(n).find("ul").first().fadeOut(250);else if(!i.loading)if(i.loaded)i.expanded=!0,t(this).removeClass("tree-node-collapse"),t(n).find("ul").first().fadeIn(250);else if("node"===o)r.values.renderTreeNodeElements.call(r,s),i.loaded=!0,i.expanded=!0,t(e).addClass("tree-node-collapse"),t(n).find("ul").first().fadeIn(250);else if("group"===o)r.values.ckan.loadGroupById(s).then(function(o){u.call(r,n,s),i.loaded=!0,i.expanded=!0,t(e).addClass("tree-node-collapse"),t(n).find("ul").first().fadeIn(250)});else if("organization"===o)r.values.ckan.loadOrganizationById(s).then(function(o){r.values.ckan.getNodeCount()>0?f.call(r,n,s):a.call(r,n,s),i.loaded=!0,i.expanded=!0,t(e).addClass("tree-node-collapse"),t(n).find("ul").first().fadeIn(250)});else if("package"===o)l.call(r,n,s),i.loaded=!0,i.expanded=!0,t(e).addClass("tree-node-collapse"),t(n).find("ul").first().fadeIn(250);else if("resource"===o){var h=r.values.ckan.getResourceById(i.id);t(this).attr("src","content/images/app/ajax-loader.gif"),t(this).addClass("tree-node-ajax-loader"),i.loading=!0,r.values.resources.setCatalogResourceMetadataOptions(h),r.values.resources.getResourceMetadata(h.metadata.type,h.metadata.parameters).then(function(o){t(e).attr("src","content/images/app/show.svg"),t(e).removeClass("tree-node-ajax-loader"),c.call(r,n,s,o.layers),i.loaded=!0,i.expanded=!0,i.loading=!1,t(e).addClass("tree-node-collapse"),t(n).find("ul").first().fadeIn(250)},function(n){t(e).attr("src","content/images/app/show.svg"),t(e).removeClass("tree-node-ajax-loader"),i.loading=!1})}r.setFilter(r.getFilter(),0)}}),t("#"+this.values.element).on("click."+this.values.contentElement,".node-select",function(){var e=t(this).closest("li"),n=t(e).data();n.selected?r.remove(n.layer):r.add(n.layer)}),t("#"+this.values.element).on("click."+this.values.contentElement,".tree-info",function(){var e=t(this).closest("li"),n=t(e).data();n.info&&(r.trigger("catalog:info-loading",{sender:r,type:n.info.type,id:n.info.id,title:r.values.ckan.getObjectTitle(n.info.type,n.info.id)}),r.values.ckan.getObjectDescription(n.info.type,n.info.id).then(function(e){r.trigger("catalog:info-loaded",{sender:r,type:n.info.type,id:n.info.id,data:e})}))}),this.values.mode===s.Maps.LayerTreeViewMode.ByFilter&&(t("#"+this.values.element).on("click."+this.values.element,"#"+this.values.element+"-box-draw-btn",function(e){return e.preventDefault(),e.stopPropagation(),r.values.bbox.interaction.setActive(!0),t("#"+r.values.element+"-search").hide(),t("#"+r.values.element+"-box-draw").hide(),t("#"+r.values.element+"-box-remove").hide(),t("#"+r.values.element+"-box-apply").show(),t("#"+r.values.element+"-box-cancel").show(),r.trigger("bbox:draw",{}),!1}),t("#"+this.values.element).on("click."+this.values.element,"#"+this.values.element+"-box-remove-btn",function(e){return e.preventDefault(),e.stopPropagation(),r.values.bbox.overlay.getFeatures().clear(),r.values.bbox.feature=null,t("#"+r.values.element+"-box-remove").hide(),t("#"+r.values.element+"-box-draw").show(),t("#"+r.values.element+"-search").show(),r.setQueryBoundingBox(null),r.trigger("bbox:remove",{}),!1}),t("#"+this.values.element).on("click."+this.values.element,"#"+this.values.element+"-box-apply-btn",function(e){return e.preventDefault(),e.stopPropagation(),r.setQueryBoundingBox(r.values.bbox.overlay.getFeatures().item(0)),r.values.bbox.interaction.setActive(!1),t("#"+r.values.element+"-box-apply").hide(),t("#"+r.values.element+"-box-cancel").hide(),t("#"+r.values.element+"-box-draw").show(),t("#"+r.values.element+"-box-remove").show(),t("#"+r.values.element+"-search").show(),r.trigger("bbox:apply",{}),!1}),t("#"+this.values.element).on("click."+this.values.element,"#"+this.values.element+"-box-cancel-btn",function(e){e.preventDefault(),e.stopPropagation(),r.values.bbox.overlay.getFeatures().clear(),r.values.bbox.interaction.setActive(!1);var n=r.getQueryBoundingBox();return n?(r.values.bbox.overlay.addFeature(n),r.values.bbox.feature=n):r.values.bbox.feature=null,t("#"+r.values.element+"-box-apply").hide(),t("#"+r.values.element+"-box-cancel").hide(),t("#"+r.values.element+"-box-draw").show(),r.values.bbox.feature?t("#"+r.values.element+"-box-remove").show():t("#"+r.values.element+"-box-remove").hide(),t("#"+r.values.element+"-search").show(),r.trigger("bbox:cancel",{}),!1}),t("#"+this.values.element).on("click."+this.values.element,"#"+this.values.element+"-search-btn",function(e){e.preventDefault(),e.stopPropagation();var n=null;if(r.values.bbox.feature){var i=r.values.bbox.feature.getGeometry().clone();i.transform("EPSG:3857","EPSG:4326"),n=i.getExtent()}var o=t("#"+r.values.element+"-text").val();if(n||o)t("#"+r.values.element+"-result").html(""),r.values.ckan.search(o,n).then(function(e){r.refresh(),r.trigger("catalog:search",{packages:e})});else{var u=[];u.push('<div class="clearfix message-warning" data-i18n-id="control.tree.search.no-criteria">'),u.push(s.i18n.getResource("control.tree.search.no-criteria")),u.push("</div>"),t("#"+r.values.element+"-result").html(u.join(""))}return!1}),t("#"+this.values.element).on("keydown."+this.values.element,"#"+this.values.element+"-text",function(e){13==e.keyCode&&(e.preventDefault(),e.stopPropagation(),t("#"+r.values.element+"-search-btn").trigger("click"))})),this.refresh()},setQueryBoundingBox:function(e){e?this.values.bbox.feature=e:(this.values.bbox.feature=null,t("#"+this.values.element+"-box-remove").hide())},getQueryBoundingBox:function(){return this.values.bbox.feature},add:function(e,n){var r=this,i=e.split("_"),o="#node-"+this.values.element+"-"+e.replace(/[^\w\s]/gi,""),u=t(o);if(0!==t(u).size()){var a=t(u).data(),f=t(u).find("img.node-select").first();if(i.length>1&&!a.loading){var l=r.values.ckan.getResourceById(i[0]);(this.values.resources.isLayerSelected(e)||this.values.resources.getLayerCount()<this.values.resources.getMaxLayerCount())&&(a.loading=!0,t(f).attr("src","content/images/app/ajax-loader.gif").addClass("tree-node-ajax-loader"),this.values.resources.setCatalogResourceMetadataOptions(l),this.values.resources.getResourceMetadata(l.metadata.type,l.metadata.parameters).then(function(i){if(a.loading=!1,a.selected=!0,t(f).removeClass("tree-node-ajax-loader").attr("src","content/images/app/checkbox-checked.svg"),!r.values.resources.isLayerSelected(e)){var o=s.i18n.getResource(a.i18n,a.caption);r.values.resources.createLayer(r.values.map,i,e,o)}n!==!1&&r.trigger("layer:added",{sender:r,id:e})},function(e){a.loading=!1,t(f).removeClass("tree-node-ajax-loader").attr("src","content/images/app/checkbox-empty.svg")}))}}},remove:function(e,n){var r,i,s=e.split("_"),o="#node-"+this.values.element+"-"+e.replace(/[^\w\s]/gi,""),u=t(o),a=t(u).size()>0;if(a&&(r=t(u).data(),i=t(u).find("img.node-select").first()),s.length>1){if(r){if(r.loading||!r.selected)return;r.selected=!1,t(i).attr("src","content/images/app/checkbox-empty.svg")}this.values.resources.destroyLayer(this.values.map,e)&&n!==!1&&this.trigger("layer:removed",{sender:this,id:e})}},render:function(){var e=this;this.values.rootTreeNode={id:null,children:[]};var n=[];this.values.mode===s.Maps.LayerTreeViewMode.ByFilter?1===t("#"+this.values.element+"-result").size()?t("#"+this.values.element+"-result").html(""):(t("#"+this.values.element).html(""),n.push('<div id="'+this.values.element+'-form" class="clearfix layer-tree-search-form">'),n.push('<div class="clearfix" style="padding: 6px 4px 6px 0px; display: block;">'),n.push('<div class="input-group" style="float: left; width: 100%;">'),n.push('<input id="'+this.values.element+'-text" placeholder="'+s.i18n.getResource("control.tree.search.prompt")+'" data-i18n-id="control.tree.search.prompt" data-i18n-type="attribute" data-i18n-name="placeholder" class="form-control input-md" type="text">'),n.push('<span class="input-group-btn">'),n.push('<button type="button" class="btn btn-default" id="'+this.values.element+'-text-clear">'),n.push('<span class="glyphicon glyphicon-trash"></span>'),n.push("</button>"),n.push("</span>"),n.push("</div>"),n.push("</div>"),n.push('<div class="clearfix">'),n.push('<div style="float: left; padding-right: 10px;"  id="'+this.values.element+'-box-draw">'),n.push('<a id="'+this.values.element+'-box-draw-btn" class="btn btn-primary" data-placement="bottom" data-i18n-id="control.tree.search.button.draw" data-i18n-type="title" title="'+s.i18n.getResource("control.tree.search.button.draw")+'"><img src="content/images/app/draw-square-w.svg" class="img-20" /></a>'),n.push("</div>"),n.push('<div style="float: left; padding-right: 10px; display: none;" id="'+this.values.element+'-box-remove">'),n.push('<a id="'+this.values.element+'-box-remove-btn" class="btn btn-danger" data-placement="bottom" data-i18n-id="control.tree.search.button.remove" data-i18n-type="title" title="'+s.i18n.getResource("control.tree.search.button.remove")+'"><img src="content/images/app/reject-w.svg" class="img-20" /></a>'),n.push("</div>"),n.push('<div style="float: left; padding-right: 10px; display: none;" id="'+this.values.element+'-box-apply">'),n.push('<a id="'+this.values.element+'-box-apply-btn" class="btn btn-success" data-placement="bottom" data-i18n-id="control.tree.search.button.apply" data-i18n-type="title" title="'+s.i18n.getResource("control.tree.search.button.apply")+'"><img src="content/images/app/accept-w.svg" class="img-20" /></a>'),n.push("</div>"),n.push('<div style="float: left; padding-right: 10px; display: none;" id="'+this.values.element+'-box-cancel">'),n.push('<a id="'+this.values.element+'-box-cancel-btn" class="btn btn-danger" data-placement="bottom" data-i18n-id="control.tree.search.button.discard" data-i18n-type="title" title="'+s.i18n.getResource("control.tree.search.button.discard")+'"><img src="content/images/app/reject-w.svg" class="img-20" /></a>'),n.push("</div>"),n.push('<div style="float: left; padding-right: 10px;" id="'+this.values.element+'-search">'),n.push('<a id="'+this.values.element+'-search-btn" class="btn btn-primary" data-placement="bottom" data-i18n-id="control.tree.search.button.search" data-i18n-type="title" title="'+s.i18n.getResource("control.tree.search.button.search")+'"><img src="content/images/app/search-w.svg" class="img-20" /></a>'),n.push("</div>"),n.push("</div>"),n.push("</div>"),n.push('<div id="'+this.values.element+'-result-container" class="clearfix layer-tree-search-result-container">'),n.push('<div id="'+this.values.element+'-result" class="clearfix layer-tree-search-result">'),n.push("</div>"),n.push("</div>"),t("#"+this.values.element).html(n.join("")),t("#"+this.values.element).find("a").tooltip()):(t("#"+this.values.element).html(""),n.push('<div style="overflow-y: auto;" id="'+this.values.element+'-result-container"><div class="clearfix" id="'+this.values.element+'-result" style="padding: 0px 2px 0px 0px;">'),n.push("</div></div>"),t("#"+this.values.element).html(n.join(""))),t("#"+this.values.element+"-text-clear").click(function(){t("#"+e.values.element+"-text").val("")}),this.values.mode===s.Maps.LayerTreeViewMode.ByGroup?this.values.ckan.getNodeCount()>0?this.values.renderTreeNodeElements.call(this):this.values.renderGroups.call(this):this.values.mode===s.Maps.LayerTreeViewMode.ByOrganization?this.values.renderOrganizations.call(this):this.values.renderOrganizations.call(this)},show:function(){s.Maps.Component.prototype.show.apply(this),this.values.mode===s.Maps.LayerTreeViewMode.ByFilter&&t("#"+this.values.element+"-text").focus()},getFilter:function(){return this.values.filter.term},clearFilter:function(){t("li.tree-node").removeClass("node-filtered"),this.values.filter={term:null}},setFilter:function(e,n){var r=this;this.values.timeout&&(clearTimeout(this.values.timeout),this.values.timeout=null),0!==n&&(n=n||500);var i=s.i18n.getLocale(),o=function(){if(e){r.values.filter.term=e;for(var n=function(e,i,o){var u=t(e.element).data(),a=!0;if(e.children.length>0)for(var f=0;f<e.children.length;f++)a=n(e.children[f],i,o)&&a;else switch(u.type){case"organization":a=r.values.ckan.filterOrganization(e.id,i,o);break;case"node":a=r.values.ckan.filterNode(e.id,i,o);break;default:var l=s.i18n.getResource(u.i18n,u.caption);a=l.indexOf(i)>-1?!1:!0}return a?t(e.element).addClass("node-filtered"):t(e.element).removeClass("node-filtered"),a},o=0;o<r.values.rootTreeNode.children.length;o++)n(r.values.rootTreeNode.children[o],e,i)}else r.clearFilter()};n>0?this.values.timeout=setTimeout(o,n):o()},expand:function(e){if(this.values.ckan.isPreloadingEnabled()){var n,r,i,o,u=[],a=this.values.ckan.getResourceById(e);if(a){switch(this.values.mode){case s.Maps.LayerTreeViewMode.ByGroup:for(n=this.values.ckan.getNodeById(a.node_id);n;)u.push(n.id),n=this.values.ckan.getNodeById(n.parent);break;case s.Maps.LayerTreeViewMode.ByOrganization:var f=this.values.ckan.getPackageById(a["package"]);u.push(f.organization)}for(u=u.reverse(),o=0;o<u.length;o++)i="#node-"+this.values.element+"-"+u[o],r=t(i).data(),r.expanded||t(i).find(".tree-text").first().click()}}},localizeUI:function(e){switch(this.values.mode){case s.Maps.LayerTreeViewMode.ByGroup:break;case s.Maps.LayerTreeViewMode.ByOrganization:break;case s.Maps.LayerTreeViewMode.ByFilter:}}});var u=function(e,n,r){var i=this,o=this.values.resources.getLayerById(e);if(o){n.text.hasOwnProperty([s.i18n.getLocale()])?n.text=n.text[s.i18n.getLocale()]:n.hasOwnProperty("el")&&(n.text=n.text.el);var u=[],a=e.replace(/[^\w\s]/gi,"");u.push('<div data-id="'+e+'" class="clearfix selected-layer">'),u.push('<div class="legend-container">'),r?u.push('<img id="'+a+'-legend-img" src="'+r+'" alt=" " class="legend" />'):u.push("&nbsp;"),u.push("</div>"),u.push('<div style="margin-left: 25px;">'),u.push('<div class="clearfix" style="padding-bottom: 3px;">'),u.push('<div class="selected-layer-close"><img src="content/images/app/close.svg" class="action img-16" data-action="remove"  /></div>'),u.push('<div class="selected-layer-up"><img src="content/images/app/move-up.svg" class="action img-16 action-disabled" data-action="up"  /></div>'),u.push('<div class="selected-layer-text" data-i18n-id="'+n.i18n+'">'+n.text+"</div>"),u.push("</div>"),u.push('<div class="clearfix">'),u.push('<div class="selected-layer-opacity-label" data-i18n-id="index.title.layer-opacity" data-i18n-type="title" title="'+s.i18n.getResource("index.title.layer-opacity")+'" ><img src="content/images/app/opacity.svg" class="img-16" /></div>'),u.push('<div class="selected-layer-opacity-slider"><input type="range" min="0" max="100" value="'+(100*o.getOpacity()).toFixed(0)+'"></div>'),u.push('<div class="selected-layer-down"><img src="content/images/app/move-down.svg" class="action img-16 action-disabled" data-action="down"  /></div>'),u.push("</div>"),u.push("</div>"),u.push("</div>"),t("#"+this.values.element).prepend(u.join("")),t("#"+a+"-legend-img").load(function(){var e=t(this).prop("naturalWidth"),r=t(this).width(),s=t(this).prop("naturalHeight"),o=t(this).height(),u=t(this).parent().height();(e>r||s>o||s>u)&&(t(this).css("cursor","pointer"),t(this).on("click",function(e){t("#"+i.values.element+"-dialog-legend-img").attr("src",t(this).attr("src")),i.values.dialog.setTitle(n),i.values.dialog.show()}))}),t(".selected-layer-opacity-label").tooltip(),this.values.updateActions(),this.trigger("layer:added",{id:e})}},a=function(e,t){return e.metadata.extras.layer?{i18n:"node.resource."+e.id,text:e.name}:{i18n:"",text:t}};s.Maps.LayerSelection=s.Class(s.Maps.Component,{initialize:function(e){var n=this;s.extend(this.values,{map:null,ckan:null,resources:null}),"function"==typeof s.Maps.Component.prototype.initialize&&s.Maps.Component.prototype.initialize.apply(this,arguments),this.event("layer:added"),this.event("layer:removed"),this.event("layer:up"),this.event("layer:down"),this.event("layer:opacity:changed"),this.values.updateActions=function(){var e=t("#"+n.values.element).find(".selected-layer"),r=e.size();e.each(function(e,n){0===e?(t(n).find('[data-action="up"]').addClass("action-disabled"),1==r?t(n).find('[data-action="down"]').addClass("action-disabled"):t(n).find('[data-action="down"]').removeClass("action-disabled")):e==r-1?(1==r?t(n).find('[data-action="up"]').addClass("action-disabled"):t(n).find('[data-action="up"]').removeClass("action-disabled"),t(n).find('[data-action="down"]').addClass("action-disabled")):(t(n).find('[data-action="up"]').removeClass("action-disabled"),t(n).find('[data-action="down"]').removeClass("action-disabled"))})},t("#"+this.values.element).on("click."+this.values.element,".action",function(){var e=t(this).closest(".selected-layer"),r=e.data("id"),i=t(this).data("action");switch(i){case"remove":n.remove(r);break;case"up":n.values.resources.moveLayerUp(n.values.map,r)&&(e.prevAll().first().insertAfter(e),n.values.updateActions(),n.trigger("layer:up"));break;case"down":n.values.resources.moveLayerDown(n.values.map,r)&&(e.nextAll().first().insertBefore(e),n.values.updateActions(),n.trigger("layer:down"))}}),t("#"+this.values.element).on("change."+this.values.element,'[type="range"]',function(){var e=t(this).closest(".selected-layer").data("id");n.values.resources.setLayerOpacity(e,t(this).val()),n.trigger("layer:opacity:changed",{id:e,opacity:t(this).val()})}),this.values.dialog=new s.Maps.Dialog({title:"",element:this.values.element+"-dialog-legend",visible:!1,width:430,height:400,autofit:!0,buttons:{close:{text:"button.close",style:"primary"}},renderContent:function(){var e=[];return e.push('<div class="clearfix" style="max-height: 350px; overflow: auto;">'),e.push('<img id="'+n.values.element+'-dialog-legend-img" src="" alt="" />'),e.push("</div>"),e}}),this.values.dialog.on("dialog:action",function(e){switch(e.action){case"close":this.hide()}})},render:function(){t("#"+this.values.element).html("")},add:function(e,t){if(this.values.resources.getLayerCount()>this.values.resources.getMaxLayerCount())return!1;var n,r=this,i=e.split("_"),s=i.splice(1).join("_");if(n=this.values.ckan.getResourceById(i[0]))return this.values.resources.setCatalogResourceMetadataOptions(n),this.values.resources.getResourceMetadata(n.metadata.type,n.metadata.parameters).then(function(t){for(var i,o,f=0;f<t.layers.length;f++)if(t.layers[f].key==s){i=t.layers[f].title,o=t.layers[f].legend;break}return u.call(r,e,a(n,i),o),!0},function(e){return!1}),!0;if(t)for(var o=0,f=t.layers.length;f>o;o++)if(t.layers[o].key==s)return u.call(r,e,{i18n:"",text:t.layers[o].title},t.layers[o].legend),!0;return!1},remove:function(e){t("#"+this.values.element).find('[data-id="'+e+'"]').remove(),this.values.updateActions(),this.values.resources.getLayerById(e)&&this.trigger("layer:removed",{id:e})}}),s.Maps.Tool=s.Class(s.Maps.Component,{initialize:function(e){s.extend(this.values,{name:null,active:!1,enabled:!0,images:{enabled:"",diabled:""},title:null}),"function"==typeof s.Maps.Component.prototype.initialize&&s.Maps.Component.prototype.initialize.apply(this,arguments),this.values.actions=[],this.event("tool:toggle"),this.render()},getName:function(){return this.values.name},getActive:function(){return this.values.active&&this.values.enabled},hasActions:function(){return this.values.actions.length>0},setActive:function(e){var n;if(this.values.active=e&&this.values.enabled,this.values.element)if(this.values.active)for(t("#"+this.values.element).find("a").addClass("tool-toggle-selected").removeClass("btn-default").addClass("btn-primary").find("img").attr("src",this.values.images.enabled),n=0;n<this.values.actions.length;n++)this.values.actions[n].show();else for(t("#"+this.values.element).find("a").removeClass("tool-toggle-selected").removeClass("btn-primary").addClass("btn-default").find("img").attr("src",this.values.images.disabled),n=0;n<this.values.actions.length;n++)this.values.actions[n].hide()},getEnabled:function(){return this.values.enabled},setEnabled:function(e){this.values.enabled=e,this.values.enabled||this.setActive(!1)},render:function(){var e=this;if(this.values.element){var n=[];n.push('<a data-action="'+this.values.name+'" class="tool-toggle btn btn-default" data-i18n-id="'+this.values.title+'" data-i18n-type="title" title="'+(s.i18n.getResource(this.values.title)||"")+'">'),n.push('<img class="img-20" src="'+(this.values.active?this.values.images.enabled:this.values.images.disabled)+'">'),n.push("</a>"),t("#"+this.values.element).html(n.join("")),t("#"+this.values.element).find("a").tooltip(),t("#"+this.values.element).find("a").click(function(){e.setActive(!e.values.active),e.trigger("tool:toggle",{sender:e,active:e.getActive()})}),this.values.visible||t("#"+this.values.element).hide()}}}),s.Maps.MeasureToolType={Length:1,Area:2},s.Maps.MeasureTool=s.Class(s.Maps.Tool,{initialize:function(e){var t=this;this.values.map=null,this.values.overlay=null,this.values.interaction=null,this.values.type=s.Maps.MeasureToolType.Length,"function"==typeof s.Maps.Tool.prototype.initialize&&s.Maps.Tool.prototype.initialize.apply(this,arguments),this.values.feature=null,this.event("measure:end");var r=function(){var e,r,i;if(!t.values.feature)return null;var o=new n.Sphere(6378137),u=t.values.feature.getGeometry().clone().transform("EPSG:3857","EPSG:4326");if(t.values.type===s.Maps.MeasureToolType.Length){i=u.getCoordinates(),e=0;for(var a=0,f=i.length-1;f>a;++a){var l=i[a],c=i[a+1];e+=o.haversineDistance(l,c)}return e=Math.round(100*e)/100,r=e>100?Math.round(e/1e3*100)/100+" km":Math.round(100*e)/100+" m"}i=u.getLinearRing(0).getCoordinates();var h=Math.abs(o.geodesicArea(i));return r=h>1e6?Math.round(h/1e6*1e3)/1e3+" km<sup>2</sup>":Math.round(100*h)/100+" m<sup>2</sup>"};this.values.reset=function(){t.values.overlay.getFeatures().clear(),t.values.tooltipElement&&t.values.tooltipElement.parentNode&&t.values.tooltipElement.parentNode.removeChild(t.values.tooltipElement),t.values.tooltip&&t.values.map.removeOverlay(t.values.tooltip)},this.values.handler=function(e){if(!e.dragging){var n=e.coordinate;if(t.values.feature){var i=t.values.feature.getGeometry(),o=r(i);n=t.values.type===s.Maps.MeasureToolType.Area?i.getInteriorPoint().getCoordinates():i.getLastCoordinate(),t.values.tooltipElement.innerHTML=o,t.values.tooltip.setPosition(n)}}},this.values.overlay=new n.FeatureOverlay({style:[new n.style.Style({fill:new n.style.Fill({color:[255,255,255,.4]}),stroke:new n.style.Stroke({color:"#7f8c8d",width:2})})]}),this.values.overlay.setMap(this.values.map);var i=this.values.type===s.Maps.MeasureToolType.Length?"LineString":"Polygon";this.values.interaction=new n.interaction.Draw({features:this.values.overlay.getFeatures(),type:i,style:[new n.style.Style({fill:new n.style.Fill({color:[255,255,255,.4]}),stroke:new n.style.Stroke({color:"#7f8c8d",lineDash:[10,10],width:2})}),new n.style.Style({image:new n.style.Circle({radius:6,fill:new n.style.Fill({color:[255,255,255,.4]}),stroke:new n.style.Stroke({color:"#7f8c8d",width:2})}),zIndex:1/0})]}),this.values.interaction.on("change:active",function(e){this.getActive()?t.values.overlay.setMap(t.values.map):t.values.overlay.setMap(null)}),this.values.interaction.on("drawstart",function(e){t.clear(),t.values.feature=e.feature}),this.values.interaction.on("drawend",function(e){e.feature?t.values.feature=e.feature:t.values.feature=null,t.values.tooltipElement.className="mt-tooltip mt-tooltip-static",t.values.feature=null,t.values.tooltipElement=null,t.trigger("measure:end",{feature:e.feature})}),this.values.map.addInteraction(this.values.interaction),this.values.interaction.setActive(!1),this.render()},setActive:function(e){s.Maps.Tool.prototype.setActive.apply(this,[e]),this.values.active?this.values.interaction&&(this.values.interaction.setActive(!0),this.values.map.on("pointermove",this.values.handler)):this.values.interaction&&(this.values.interaction.setActive(!1),this.values.map.un("pointermove",this.values.handler),this.values.reset())},getType:function(){return this.values.type},getFeature:function(){return this.values.feature},getMeasurement:function(){return this.values.measurement},createTooltip:function(){this.values.reset(),this.values.tooltipElement=document.createElement("div"),this.values.tooltipElement.className="mt-tooltip mt-tooltip-measure",this.values.tooltip=new n.Overlay({element:this.values.tooltipElement,offset:[0,-15],positioning:"bottom-center"}),this.values.map.addOverlay(this.values.tooltip)},clear:function(){this.createTooltip(),this.values.overlay.getFeatures().clear()}});var f=function(e){this.values.action.isBusy()||(t("#"+this.values.element+"-error").html(""),this.values.dialog.show(),this.values.dialog.moveToCenter())},l=function(e){var r,i,o=this;if(this.values.action.isBusy())return void this.values.dialog.hide();var u=this.getFeature();if(u){var a=new n.format.GeoJSON,f=JSON.parse(a.writeGeometry(u.getGeometry())),l=this.values.resources.getSelectedLayers(),h=this.values.resources.getQueryableResources(),p=[];for(r=0;r<l.length;r++)for(i=0;i<h.length;i++)if(l[r].resource_id==h[i].wms){p.push({table:h[i].table,title:l[r].title});break}if(0===p.length)t("#"+this.values.element+"-error").html('<div class="alert alert-danger" role="alert" data-i18n-id="action.export.no-resource-selected">'+s.i18n.getResource("action.export.no-resource-selected")+"</div>");else{this.values.dialog.hide(),this.values.action.suspendUI();var d=this.values.query;d.reset().crs(t("#"+this.values.element+"-crs").val()).format(t("#"+this.values.element+"-format").val());var v=[];for(r=0;r<p.length;r++)v.push(p[r].title),d.resource(p[r].table).contains(f,{resource:p[r].table,name:"the_geom"}),r<p.length-1&&d.queue();d["export"]({context:this,success:c,failure:function(){o.values.action.resumeUI()},files:v})}}},c=function(e,t){this.values.action.resumeUI(),e.success&&(jQuery("#export-download-frame").remove(),jQuery("body").append('<div id="export-download-frame" style="display: none"><iframe src="'+this.values.endpoint+"api/download/"+e.code+'"></iframe></div>'))};s.Maps.ExportTool=s.Class(s.Maps.Tool,{initialize:function(e){var r=this;this.values.map=null,this.values.disabledFormats=[],"function"==typeof s.Maps.Tool.prototype.initialize&&s.Maps.Tool.prototype.initialize.apply(this,arguments),this.event("feature:change"),this.values.overlay=null,this.values.interaction=null,this.values.feature=null,this.values.crs=s.Maps.CRS.Mercator,this.values.query=new i.Data.Query(this.values.endpoint),this.values.formats=[{value:"ESRI Shapefile",text:"ESRI Shapefile",selected:!0},{value:"GML",text:"GML"},{value:"KML",text:"KML"},{value:"GPKG",text:"Geo Package"},{value:"DXF",text:"AutoCAD DXF"},{value:"CSV",text:"Comma Separated Value"},{value:"GeoJSON",text:"GeoJSON"},{value:"PDF",text:"Geospatial PDF"}],this.values.action&&(this.values.actions.push(this.values.action),this.values.action.on("action:execute",f,this)),this.values.dialog=new s.Maps.Dialog({title:"control.export.dialog.title",element:this.values.element+"dialog",visible:!1,width:430,height:200,autofit:!0,buttons:{"export":{text:"control.export.dialog.button.export",style:"primary"},close:{text:"control.export.dialog.button.cancel",style:"default"}},renderContent:function(){var e=[];e.push('<div class="clearfix" style="padding-bottom: 10px;">'),e.push('<label for="'+r.values.element+'-crs" style="padding-right: 10px; width: 145px;" data-i18n-id="control.export.dialog.label.crs">'+s.i18n.getResource("control.export.dialog.label.crs")+"</label>"),e.push('<select name="'+r.values.element+'-crs" id="'+r.values.element+'-crs" class="selectpicker" data-width="160px">'),e.push('<option value="EPSG:3857">Web Mercator</option>'),e.push('<option value="EPSG:4326">WGS84</option>'),e.push('<option value="EPSG:2100" selected="selected">ΕΓΣΑ87</option>'),e.push('<option value="EPSG:4258">ETRS89</option>'),e.push("</select>"),e.push("</div>"),e.push('<div class="clearfix">'),e.push('<label for="'+r.values.element+'-format" style="padding-right: 10px; width: 145px;" data-i18n-id="control.export.dialog.label.format">'+s.i18n.getResource("control.export.dialog.label.format")+"</label>"),e.push('<select name="'+r.values.element+'-format" id="'+r.values.element+'-format" class="selectpicker" data-width="250px">');for(var t=0,n=r.values.formats.length;n>t;t++){var i=r.values.formats[t];r.values.disabledFormats.indexOf(i.value)<0&&(i.selected?e.push('<option value="'+i.value+'" selected="selected">'+i.text+"</option>"):e.push('<option value="'+i.value+'">'+i.text+"</option>"))}return e.push("</select>"),e.push("</div>"),e.push('<div class="clearfix"  id="'+r.values.element+'-error" style="margin: 10px 4px 0 0;"></div>'),e}}),t("#"+this.values.element+"-crs").selectpicker().change(function(){t('[data-id="'+r.values.element+'-crs"]').blur()}),t("#"+this.values.element+"-format").selectpicker().change(function(){t('[data-id="'+r.values.element+'-format"]').blur()}),this.values.dialog.on("dialog:action",function(e){switch(e.action){case"close":this.hide();break;case"export":l.apply(r)}}),this.values.overlay=new n.FeatureOverlay({style:[new n.style.Style({fill:new n.style.Fill({color:[255,255,255,.4]}),stroke:new n.style.Stroke({color:"#3399CC",width:2})})]}),this.values.overlay.setMap(this.values.map),this.values.interaction=new n.interaction.Draw({features:this.values.overlay.getFeatures(),type:"Polygon",style:[new n.style.Style({fill:new n.style.Fill({color:[255,255,255,.4]}),stroke:new n.style.Stroke({color:"#3399CC",width:1})}),new n.style.Style({image:new n.style.Circle({radius:6,fill:new n.style.Fill({color:[255,255,255,.4]}),stroke:new n.style.Stroke({color:"#3399CC",width:1})}),zIndex:1/0})]}),this.values.interaction.on("change:active",function(e){this.getActive()?r.values.overlay.setMap(r.values.map):r.values.overlay.setMap(null)}),this.values.interaction.on("drawstart",function(e){r.values.overlay.getFeatures().clear(),r.values.feature=null}),this.values.interaction.on("drawend",function(e){e.feature?r.values.feature=e.feature:r.values.feature=null,r.trigger("feature:change",{feature:e.feature})}),this.values.map.addInteraction(this.values.interaction),this.values.interaction.setActive(!1),this.render()},setActive:function(e){s.Maps.Tool.prototype.setActive.apply(this,[e]),this.values.active?this.values.interaction&&this.values.interaction.setActive(!0):this.values.interaction&&this.values.interaction.setActive(!1)},getFeature:function(){return this.values.feature},clear:function(){this.values.overlay.getFeatures().clear(),this.values.feature=null}});var h=function(e){if(!this.isBusy()&&this.getActive()){var t,r,o=1;this.clearSelection();var u=[];this.values.map.forEachFeatureAtPixel(e.pixel,function(e,r){r&&r instanceof n.layer.Vector&&(e=e.clone(),e.id=o,u.push(e),t++)},this);var a=this.values.resources.getSelectedLayers(),f=this.values.resources.getQueryableResources(),l=[],c=[];for(t=0;t<a.length;t++)for(r=0;r<f.length;r++)if(a[t].resource_id==f[r].wms){c.push(f[r].table),l.push(f[r].template);break}var h={type:"Point",coordinates:e.coordinate};if(c.length>0){this.suspendUI();var p=this.values.query;for(p.reset().format(i.Data.Format.GeoJSON),t=0;t<c.length;t++)p.resource(c[t]).distanceLessOrEqual(h,{resource:c[t],name:"the_geom"},this.values.map.getView().getResolution()*this.values.buffer),t<c.length-1&&p.queue();p.execute({success:function(e){if(e.success){for(var t=new n.format.GeoJSON,r=0;r<e.data.length;r++)if(e.data[r].features.length>0){for(var i=0;i<e.data[r].features.length;i++)e.data[r].features[i].id=o,o++,e.data[r].features[i].properties.__template__=l[r];var a=t.readFeatures(e.data[r],{dataProjection:s.Maps.CRS.Mercator,featureProjection:s.Maps.CRS.Mercator});this.values.features.extend(a)}u.length>0&&this.values.features.extend(u),this.values.overlay.setFeatures(this.values.features),this.setFeatureFocus(0),this.trigger("selection:changed",{sender:this,features:this.getFeatures()})}this.resumeUI()},context:this})}else u.length>0&&(this.values.features.extend(u),this.values.overlay.setFeatures(this.values.features),this.setFeatureFocus(0),this.trigger("selection:changed",{sender:this,features:this.getFeatures()}))}};s.Maps.SelectTool=s.Class(s.Maps.Tool,{initialize:function(e){s.extend(this.values,{map:null,resources:null,endpoint:null,buffer:3,centerOnSelection:!1}),"function"==typeof s.Maps.Tool.prototype.initialize&&s.Maps.Tool.prototype.initialize.apply(this,arguments),this.values.element=this.values.name,this.event("selection:changed"),this.values.query=new i.Data.Query(this.values.endpoint),this.values.features=new n.Collection,this.values.focus=null,this.values.buffer<0&&(this.values.buffer=2),this.values.tooltip=null,this.values.styles={select:[new n.style.Style({fill:new n.style.Fill({color:[255,255,255,.4]}),stroke:new n.style.Stroke({color:"#F39C12",width:3})}),new n.style.Style({image:new n.style.Circle({radius:6,fill:new n.style.Fill({color:[255,255,255,.7]}),stroke:new n.style.Stroke({color:"#F39C12",width:2})}),zIndex:1/0})],focus:[new n.style.Style({fill:new n.style.Fill({color:[255,255,255,.4]}),stroke:new n.style.Stroke({color:"#C0392B",width:3})}),new n.style.Style({image:new n.style.Circle({radius:6,fill:new n.style.Fill({color:[255,255,255,.7]}),stroke:new n.style.Stroke({color:"#C0392B",width:2})}),zIndex:1/0})]},this.values.overlay=new n.FeatureOverlay({style:this.values.styles.select}),this.render()},setActive:function(e){s.Maps.Tool.prototype.setActive.apply(this,[e]),this.values.active?(this.values.map.on("click",h,this),this.values.overlay.setMap(this.values.map)):(this.values.map.un("click",h,this),this.values.overlay.setMap(null),this.values.tooltip&&this.values.map.removeOverlay(this.values.tooltip),this.values.overlay.getFeatures().clear())},getFeatures:function(){return this.values.features.getArray()},isBusy:function(){return t("#"+this.values.element).hasClass("busy")},suspendUI:function(){t("#"+this.values.element).hasClass("busy")||t("#"+this.values.element).addClass("tool-wapper-action busy").append('<div class="action-executing"><img style="" src="content/images/app/ajax-loader.gif"></div>')},resumeUI:function(){t("#"+this.values.element).find(".action-executing").remove(),t("#"+this.values.element).removeClass("tool-wapper-action busy")},clearFeatureFocus:function(){this.values.focus&&(this.values.focus.feature.setStyle(this.values.styles.select),this.values.focus=null,this.values.tooltip&&this.values.map.removeOverlay(this.values.tooltip))},setFeatureFocus:function(e){var r,i=this;if(this.values.focus){if(this.values.focus.index==e)return!0;this.clearFeatureFocus()}var o=this.getFeatures();if(0===o.length)return!1;0>e&&(e=0),e>=o.length&&(e=o.length-1);var u=o[e],a=u.getGeometry();this.values.focus={feature:u,index:e},u.setStyle(this.values.styles.focus);var f=[];f.push('<div id="'+this.values.element+'-popup" class="popover top feature-popup" tabIndex="1">'),f.push('<div class="arrow"></div>'),f.push('<div class="clearfix popover-title" id="popover-top">'),f.push('<div  id="'+this.values.element+'-popup-close" style="width: 18px; 1px 4px 0px 0px; float: left;">'),f.push('<span class="glyphicon glyphicon-remove icon-alert" style="cursor: pointer;"></span>'),f.push("</div>"),f.push('<div style="float: left;" data-i18n-id="tool.select.dialog.title">'+s.i18n.getResource("tool.select.dialog.title")+"</div>"),o.length>1&&(f.push('<div style="float: right;"><img id="'+this.values.element+'-next" class="img-20" src="content/images/app/next.svg"></div>'),f.push('<div style="float: right; font-size: 0.9em; padding-top: 2px;">'+(e+1)+"</div>"),f.push('<div style="float: right;"><img id="'+this.values.element+'-prev" class="img-20" src="content/images/app/previous.svg"></div>')),f.push("</div>"),f.push('<div class="popover-content">'),f.push('<div style="max-height: 190px; overflow: auto;">');var l=u.getKeys();if(-1!==t.inArray("__template__",l)&&u.get("__template__")){var c=u.get("__template__");for(r=0;r<l.length;r++){var h=new RegExp("%\\("+l[r]+"\\)s","g");c=c.replace(h,u.get(l[r])?u.get(l[r]):"")}f.push(c)}else{for(f.push('<div class="feature-table"><table style="width: 100%;">'),r=0;r<l.length;r++)l[r]!=u.getGeometryName()&&"__template__"!=l[r]&&f.push('<tr class="feature-row"><td class="feature-prop-key">'+l[r]+'</td><td class="feature-prop-value">'+(u.get(l[r])?u.get(l[r]):"")+"</td></tr>");f.push("</table></div>")}f.push("</div>"),f.push("</div>"),f.push("</div>"),t("body").append(f.join("")),o.length>1&&(t("#"+this.values.element+"-prev").click(function(){return i.setFeatureFocusPrevious()}),t("#"+this.values.element+"-next").click(function(){return i.setFeatureFocusNext()})),t("#"+this.values.element+"-popup-close").click(function(){i.clearSelection()});var d=t("#"+this.values.element+"-popup");this.values.tooltip=new n.Overlay({element:d[0],offset:[-d.outerWidth()/2,-d.outerHeight()],positioning:"bottom-center"}),this.values.map.addOverlay(this.values.tooltip);var v=p(a);return v&&(this.values.tooltip.setPosition(v),this.values.centerOnSelection&&this.values.map.getView().setCenter(v)),t("#"+this.values.element+"-popup").on("keydown",function(e){27==e.keyCode&&i.clearSelection()}),t("#"+this.values.element+"-popup").focus(),!0},setFeatureFocusPrevious:function(){this.values.focus&&this.values.focus.index>0?this.setFeatureFocus(this.values.focus.index-1):this.setFeatureFocus(0)},setFeatureFocusNext:function(){var e=this.getFeatures();return 0===e.length?!1:this.values.focus&&this.values.focus.index<e.length-2?this.setFeatureFocus(this.values.focus.index+1):this.setFeatureFocus(e.length-1)},clearSelection:function(){this.clearFeatureFocus(),this.values.overlay.getFeatures().clear(),this.values.features=new n.Collection},clear:function(){this.clearSelection()}});var p=function(e){var t,r,i,s;if(e instanceof n.geom.Polygon)i=e.getInteriorPoint().getCoordinates();else if(e instanceof n.geom.MultiPolygon){for(var o=e.getPolygons(),u=o[0],a=1;a<o.length;a++)u.getArea()<o[a].getArea()&&(u=o[a]);i=u.getInteriorPoint().getCoordinates()}else if(e instanceof n.geom.Point)i=e.getCoordinates();else{var f=e;e instanceof n.geom.MultiLineString&&(s=Math.floor(e.getLineStrings().length/2),f=e.getLineString(s),extent=e.getExtent());var l=f.getCoordinates();s=Math.floor(l.length/2),i=[0,0],t=l[s-1],r=l[s],i[0]=(r[0]+t[0])/2,i[1]=(r[1]+t[1])/2}return i};s.Maps.TextSearch=s.Class(s.Maps.Component,{initialize:function(e){var r=this;s.extend(this.values,{map:null,endpoint:null}),"function"==typeof s.Maps.Component.prototype.initialize&&s.Maps.Component.prototype.initialize.apply(this,arguments),this.event("selection:changed"),this.values.selection=null,this.values.feature=null,this.values.tooltip=null,this.values.overlay=new n.FeatureOverlay({style:[new n.style.Style({fill:new n.style.Fill({color:[255,255,255,.4]}),stroke:new n.style.Stroke({color:"#3399CC",width:2})}),new n.style.Style({image:new n.style.Circle({radius:6,fill:new n.style.Fill({color:[255,255,255,.4]}),stroke:new n.style.Stroke({color:"#3399CC",width:1})}),zIndex:1/0})]}),this.values.overlay.setMap(this.values.map);var i=new Bloodhound({datumTokenizer:Bloodhound.tokenizers.obj.whitespace("name"),queryTokenizer:Bloodhound.tokenizers.whitespace,remote:{url:this.values.endpoint+"search/query?term=%QUERY&limit=10",replace:function(){for(var e=r.values.endpoint+"search/query?term="+t("#"+r.values.element).val()+"&limit=10",n=r.values.resources.getSelectedLayers(),i=r.values.resources.getQueryableResources(),s=[],o=0;o<n.length;o++)for(var u=0;u<i.length;u++)if(n[o].resource_id==i[u].wms){s.push(n[o].resource_id);break}return e=e+"&resources="+s.join(",")},transform:function(e){return t.map(e,function(e){return{name:e.properties.dd_default_field,object:e}})}}}),o=function(e){if(r.removeTooltip(),e&&e.geometry){r.values.selection=e;var i=new n.format.GeoJSON,o=i.readGeometry(e.geometry,{dataProjection:s.Maps.CRS.Mercator,featureProjection:s.Maps.CRS.Mercator});r.values.feature=new n.Feature({name:"selection",geometry:o});var u=p(o),a=!1,f=null;o instanceof n.geom.Point||(a=!0,f=o.getExtent()),a&&r.values.overlay.addFeature(r.values.feature);var l=[];l.push('<div id="'+r.values.element+'-popup" class="popover top text-search '+(a?"tooltip-popup-inactive":"tooltip-popup")+'" tabIndex="1">'),l.push('<div class="arrow"></div>'),l.push('<div class="popover-content">'),l.push('<div style="max-height: 190px; overflow: auto;"><div class="feature-table">'),l.push('<table style="width: 100%;"><tr class=""><td class="text-search tooltip-prop-value">'+e.properties.dd_default_suggest+"</td>"),l.push('<td id="'+r.values.element+'-popup-close" style="width: 18px; vertical-align: top; padding-left: 6px;">'),l.push('<span class="glyphicon glyphicon-remove icon-alert" style="cursor: pointer;"></span></td>'),l.push("</tr></table>"),l.push("</div></div>"),l.push("</div>"),l.push("</div>"),t("body").append(l.join("")),t("#"+r.values.element+"-popup-close").click(function(){r.removeTooltip()}),t("#"+r.values.element+"-popup").on("keydown",function(e){27==e.keyCode&&r.removeTooltip()});var c=t("#"+r.values.element+"-popup");if(r.values.tooltip=new n.Overlay({element:c[0],offset:[-c.outerWidth()/2,-c.outerHeight()],positioning:"bottom-center"}),r.values.map.addOverlay(r.values.tooltip),r.values.tooltip.setPosition(u),f){var h=r.values.map.getView(),d=r.values.map.getSize();h.fitExtent(f,d)}else r.values.map.getView().setCenter(u),r.values.map.getView().setZoom(17);t("#"+r.values.element+"-popup").focus()}},u=function(e,n){r.removeTooltip(),t("#"+r.values.element).val(""),n&&(o(n.object),r.trigger("selection:changed",{selection:n.object})),t("#"+r.values.element).typeahead("val","")};t("#"+this.values.element).typeahead({hint:!0,highlight:!0,minLength:3},{name:"location-search",source:i,display:function(e){return e.object.properties.dd_default_text},templates:{suggestion:function(e){return"<div>"+e.object.properties.dd_default_suggest+"</div>"}}}).bind("typeahead:select",u),this.render()},getFeature:function(){return this.values.feature},removeTooltip:function(){this.values.overlay&&this.values.overlay.getFeatures().clear(),this.values.tooltip&&this.values.map.removeOverlay(this.values.tooltip),this.values.selection=null,this.values.feature=null,this.values.tooltip=null},clear:function(){this.removeTooltip()}}),s.Maps.Action=s.Class(s.Maps.Component,{initialize:function(e){s.extend(this.values,{name:null,image:"",title:null,visible:!1,"class":"btn-primary"}),"function"==typeof s.Maps.Component.prototype.initialize&&s.Maps.Component.prototype.initialize.apply(this,arguments),this.event("action:execute"),this.render()},render:function(){var e=this,n=[];n.push('<a data-action="'+this.values.name+'" class="tool-action btn '+this.values["class"]+'" data-i18n-id="'+this.values.title+'" data-i18n-type="title" title="'+(s.i18n.getResource(this.values.title)||"")+'">'),n.push('<img class="img-20" src="'+this.values.image+'">'),n.push("</a>"),t("#"+this.values.element).addClass("tool-wapper-action").html(n.join("")),t("#"+this.values.element).find("a").tooltip(),t("#"+this.values.element).find("a").click(function(){"function"==typeof e.execute&&e.execute(),e.trigger("action:execute",{name:e.values.name})}),this.values.visible||t("#"+this.values.element).hide()},isBusy:function(){return t("#"+this.values.element).hasClass("busy")},suspendUI:function(){t("#"+this.values.element).hasClass("busy")||t("#"+this.values.element).addClass("busy").append('<div class="action-executing"><img style="" src="content/images/app/ajax-loader.gif"></div>')},resumeUI:function(){t("#"+this.values.element).removeClass("busy"),t("#"+this.values.element).find(".action-executing").remove()}});var d=2100;s.Maps.Dialog=s.Class(s.Maps.Component,{initialize:function(e){s.extend(this.values,{image:"",title:null,visible:!1,width:600,height:400,buttons:{},closeOnEscape:!0,autofit:!1}),"function"==typeof s.Maps.Component.prototype.initialize&&s.Maps.Component.prototype.initialize.apply(this,arguments),this.values.positionInitialized=!1,this.event("dialog:close"),this.event("dialog:action"),this.event("dialog:show"),this.render()},render:function(){var e=this;t("#"+this.values.element).remove();var n=[];if(d++,n.push('<div id="'+this.values.element+'" class="modal-dialog" style="z-index: '+d+"; width: "+(this.values.width||600)+'px; outline: none; position: absolute;" tabIndex="1">'),n.push('<div class="modal-content">'),n.push('<div class="modal-header">'),n.push('<button id="'+this.values.element+'-close" type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>'),n.push('<h4 class="modal-title" data-i18n-id="'+this.values.title+'">'+s.i18n.getResource(this.values.title)+"</h4>"),n.push("</div>"),n.push('<div class="modal-body" style="text-align: justify; max-height: '+(this.values.height||400)+"px; overflow: "+(this.values.autofit?"unset":"auto")+'" >'),"function"==typeof this.values.renderContent&&(n=n.concat(this.values.renderContent())),n.push("</div>"),n.push('<div class="modal-footer">'),"function"==typeof this.values.renderFooter&&(n=n.concat(this.values.renderFooter())),this.values.buttons)for(var r in this.values.buttons)this.values.buttons[r].style=this.values.buttons[r].style||"default",n.push('<button type="button" class="btn btn-'+this.values.buttons[r].style+'" data-i18n-id="'+this.values.buttons[r].text+'" data-action="'+r+'">'+s.i18n.getResource(this.values.buttons[r].text)+"</button>");n.push("</div>"),n.push("</div>"),n.push("</div>"),n.push("</div>");var i=t(".dialog-container").first();if(0===i.length)throw"Dialog container does not exist.";i.append(n.join("")),t("#"+this.values.element).draggable({handle:".modal-header",containment:"parent"}),t("#"+this.values.element).on("click."+this.values.element,"button",function(){e.trigger("dialog:action",{sender:e,action:t(this).data("action")})}),t("#"+this.values.element+"-close").click(function(t){e.hide(),e.trigger("dialog:close",{sender:e})}),this.values.visible?this.show():this.hide(),t("#"+this.values.element).on("keydown",function(t){e.values.closeOnEscape&&27==t.keyCode&&(e.hide(),e.trigger("dialog:close",{sender:e}))})},moveToFront:function(){var e=t("#"+this.values.element),n=e.zIndex(),r=null,i=n;t(".modal-dialog").each(function(e,n){var s=t(n).zIndex();s>i&&(i=s,r=n)}),r&&(t(r).zIndex(n),t(e).zIndex(i))},show:function(){s.Maps.Component.prototype.show.apply(this,arguments),this.values.positionInitialized||(this.values.positionInitialized=!0,this.moveToCenter()),this.moveToFront(),this.trigger("dialog:show",{sender:this}),t("#"+this.values.element).focus()},moveTo:function(e,n){t("#"+this.values.element).offset({top:n,left:e})},moveToCenter:function(){t("#"+this.values.element).offset({top:(t(window).height()-t("#"+this.values.element).height())/2,left:(t(window).width()-t("#"+this.values.element).width())/2})},setTitle:function(e){t("#"+this.values.element).find(".modal-title").html(e)},setContent:function(e){t("#"+this.values.element).find(".modal-body").html(e)}});var v=function(e){if(e.success){this.values.page.data=e.data[0].records;var t,n,r=this.values.page.data,i=[];if(i.push('<div class="clearfix" style="overflow: scroll; max-height: '+(this.values.height-100)+'px;"><table class="table table-striped data-table">'),r.length>0){i.push("<thead>"),i.push("<tr>");for(t in r[0])t!==this.values.geometryName&&i.push("<th>"+t+"</th>");i.push("</tr>"),i.push("</thead>"),i.push("<tbody>");var s=this.values.page.size;for(s>r.length&&(s=r.length),n=0;s>n;n++){i.push("<tr>");for(t in r[n])t!==this.values.geometryName&&i.push("<td>"+(r[n][t]?r[n][t]:"")+"</td>");i.push("</tr>")}i.push("</tbody>")}i.push("</table><div>"),this.setContent(i.join("")),this.show()}},m=function(){var e=this.values.query;e.reset(),e.resource(this.values.table).format(i.Data.Format.JSON).skip(this.values.page.index*this.values.page.size).take(this.values.page.size+1).execute(v,this)};s.Maps.DialogTableBrowser=s.Class(s.Maps.Dialog,{initialize:function(e){s.extend(this.values,{table:null,endpoint:null}),"function"==typeof s.Maps.Dialog.prototype.initialize&&s.Maps.Dialog.prototype.initialize.apply(this,arguments),this.values.query=new i.Data.Query(this.values.endpoint),this.values.page={index:0,size:10,data:null},this.values.geometryName="the_geom",this.event("page:next"),this.event("page:previous"),this.event("page:refresh"),this.event("row:changed"),this.render()},render:function(){s.Maps.Dialog.prototype.render.apply(this)},getNextPage:function(){this.values.page.index=this.values.page.index+1,m.apply(this)},getPrevPage:function(){this.values.page.index>0&&(this.values.page.index=this.values.page.index-1),m.apply(this)},getPage:function(e){0>e?this.values.page.index=0:this.values.page.index=e,m.apply(this)},setTable:function(e){this.values.page.index=0,this.values.table=e},getGeometryName:function(){return this.values.geometryName},getPageIndex:function(){return this.values.page.index}}),s.Maps.ImportWmsTool=s.Class(s.Maps.Action,{initialize:function(e){var n=this;"function"==typeof s.Maps.Action.prototype.initialize&&s.Maps.Action.prototype.initialize.apply(this,arguments),this.event("metadata:loaded"),this.event("layer:added"),this.values.dialog=new s.Maps.Dialog({title:"action.import-wms.title",element:this.values.element+"-dialog",visible:!1,width:430,height:280,autofit:!1,buttons:{close:{text:"button.close",style:"primary"}},renderContent:function(){var e=[];return e.push('<div class="clearfix" style="padding-bottom: 10px;">'),e.push('<div class="input-group">'),e.push('<span class="input-group-addon">'),e.push('<span class="glyphicon glyphicon-link"></span>'),e.push("</span>"),e.push('<input id="'+n.values.element+'-endpoint" value="" type="text" class="form-control" data-i18n-id="action.import-wms.url.placeholder" data-i18n-type="attribute" data-i18n-name="placeholder" placeholder="Διεύθυνση WMS ...">'),e.push('<span class="input-group-btn">'),e.push('<button id="'+n.values.element+'-btn-metadata" class="btn btn-default" type="button">'),e.push('<span class="glyphicon glyphicon-search"></span>'),e.push("</button>"),e.push("</span>"),e.push("</div>"),e.push("</div>"),e.push('<div class="clearfix" style="max-height: 200px; overflow: auto;">'),e.push('<div id="'+n.values.element+'-layers" class="clearfix" style="padding: 0 4px 0 0;"></div>'),e.push("</div>"),e.push('<div class="clearfix"  id="'+n.values.element+'-error"></div>'),e}}),t("#"+this.values.element+"-layers").on("click."+this.values.element,".list-group-item-button",function(){var e=t(this).data("index"),r=n.values.metadata.key+"_"+n.values.metadata.layers[e].key;n.trigger("layer:added",{metadata:n.values.metadata,id:r})}),t("#"+this.values.element+"-btn-metadata").click(function(){n.values.metadata=null,t("#"+n.values.element+"-layers").html(""),t("#"+n.values.element+"-error").html(""),n.values.resources.getResourceMetadata(s.Maps.Resources.Types.WMS,{url:t("#"+n.values.element+"-endpoint").val()}).then(function(e){n.values.metadata=e;var r=[];if(e&&e.layers.length>0){r.push('<ul class="list-group">');for(var i=0,s=e.layers.length;s>i;i++)r.push('<li class="list-group-item">'+e.layers[i].title+'<span class="list-group-item-button" data-index="'+i+'"><span class="glyphicon glyphicon-plus"></span><span></span></span></li>');r.push("</ul>")}t("#"+n.values.element+"-layers").html(r.join("")),n.trigger("metadata:loaded",{metadata:e})},function(e){t("#"+n.values.element+"-error").append('<div class="alert alert-danger" role="alert" data-i18n-id="action.import-wms.error.metadata">'+s.i18n.getResource("action.import-wms.error.metadata")+"</div>")})}),this.values.dialog.on("dialog:action",function(e){switch(e.action){case"close":this.hide()}}),this.render()},execute:function(){this.values.dialog.show()}}),s.Maps.UploadFileTool=s.Class(s.Maps.Action,{initialize:function(e){var n=this;"function"==typeof s.Maps.Action.prototype.initialize&&s.Maps.Action.prototype.initialize.apply(this,arguments),this.event("resource:loaded"),this.values.dialog=new s.Maps.Dialog({title:"action.upload-resource.title",element:this.values.element+"-dialog",visible:!1,width:430,height:280,autofit:!0,buttons:{close:{text:"button.close",style:"primary"}},renderContent:function(){var e=[];return e.push('<div class="clearfix form-inline" style="padding-bottom: 10px;">'),e.push('<label for="'+n.values.element+'-title" style="padding-right: 10px; width: 145px;" data-i18n-id="control.upload.dialog.label.title">'+s.i18n.getResource("control.upload.dialog.label.title")+"</label>"),e.push('<input id="'+n.values.element+'-title" class="form-control input-md" type="text" style="width: 250px;" value="'+s.i18n.getResource("control.upload.dialog.default.title")+'">'),e.push("</div>"),e.push('<div class="clearfix" style="padding-bottom: 10px;">'),e.push('<label for="'+n.values.element+'-format" style="padding-right: 10px; width: 145px;" data-i18n-id="control.upload.dialog.label.format">'+s.i18n.getResource("control.upload.dialog.label.format")+"</label>"),e.push('<select name="'+n.values.element+'-format" id="'+n.values.element+'-format" autocomplete="off" class="selectpicker" data-width="250px">'),e.push('<option value="GML">GML</option>'),e.push('<option value="KML" selected>KML</option>'),e.push('<option value="ESRI Shapefile">ESRI Shapefile (compressed file)</option>'),e.push('<option value="GeoJSON">GeoJSON</option>'),e.push('<option value="DXF">AutoCAD DXF</option>'),e.push('<option value="CSV">Comma Separated Values</option>'),e.push("</select>"),e.push("</div>"),e.push('<div id="'+n.values.element+'-info" class="clearfix alert alert-info" role="alert" style="margin: 0px 4px 11px 0px; padding: 7px !important; display: none">'),e.push('<span data-i18n-id="control.upload.dialog.info">'+s.i18n.getResource("control.upload.dialog.info")+"</label>"),e.push("</div>"),e.push('<div class="clearfix" style="padding-bottom: 10px;">'),e.push('<label for="'+n.values.element+'-crs" style="padding-right: 10px; width: 145px;" data-i18n-id="control.upload.dialog.label.crs">'+s.i18n.getResource("control.upload.dialog.label.crs")+"</label>"),e.push('<select name="'+n.values.element+'-crs" id="'+n.values.element+'-crs" class="selectpicker" data-width="160px" disabled>'),e.push('<option value="EPSG:3857">Web Mercator</option>'),e.push('<option value="EPSG:4326" selected>WGS84</option>'),e.push('<option value="EPSG:2100">ΕΓΣΑ87</option>'),e.push('<option value="EPSG:4258">ETRS89</option>'),e.push("</select>"),e.push("</div>"),e.push('<div class="clearfix"  id="'+n.values.element+'-error"></div>'),e},renderFooter:function(){var e=[];return e.push('<span class="btn btn-success fileinput-button">'),e.push('<i class="glyphicon glyphicon-upload"></i>'),e.push('<span data-i18n-id="action.upload-resource.select-file" style="padding-left: 10px;">'+s.i18n.getResource("action.upload-resource.select-file")+"</span>"),e.push('<input id="'+n.values.element+'-fileupload" type="file" name="files[]" multiple>'),e.push("</span>"),e}}),t("#"+this.values.element+"-format").selectpicker().change(function(){t('[data-id="'+n.values.element+'-format"]').blur();var e=t("#"+n.values.element+"-format").val();t("#"+n.values.element+"-info").hide(),"KML"==e?t("#"+n.values.element+"-crs").val("EPSG:4326").prop("disabled",!0).selectpicker("refresh"):"CSV"==e?t("#"+n.values.element+"-info").show():t("#"+n.values.element+"-crs").prop("disabled",!1).selectpicker("refresh")}),t("#"+this.values.element+"-crs").selectpicker().change(function(){t('[data-id="'+n.values.element+'-crs"]').blur(),"KML"==t("#"+n.values.element+"-format").val()&&"EPSG:4326"!=t("#"+n.values.element+"-crs").val()&&t("#"+n.values.element+"-crs").val("EPSG:4326").selectpicker("refresh")}),t("#"+this.values.element+"-fileupload").fileupload({url:this.values.endpoint+"upload/upload_resource",dataType:"json",done:function(e,r){t.each(r.result.files,function(e,r){if(r.error)switch(r.error){case"minFileSize":case"maxFileSize":case"acceptFileTypes":case"invalidContent":case"conversionFailed":case"crsNotSupported":case"acceptFileFormats":t("#"+n.values.element+"-error").html("").append('<div class="alert alert-danger" role="alert" data-i18n-id="action.upload-resource.error.'+r.error+'">'+s.i18n.getResource("action.upload-resource.error."+r.error)+"</div>");break;default:t("#"+n.values.element+"-error").html("").append('<div class="alert alert-danger" role="alert" data-i18n-id="action.upload-resource.error.unknown">'+s.i18n.getResource("action.upload-resource.error.unknown")+"</div>")}else{var i=t("#"+n.values.element+"-format").val();("ESRI Shapefile"==i||"DXF"==i||"CSV"==i)&&(i="geojson"),n.trigger("resource:loaded",{id:"remote_"+r.url,title:t("#"+n.values.element+"-title").val()||r.name.split(".")[0],format:i,name:r.name,type:r.type,text:null,url:r.url,projection:t("#"+n.values.element+"-crs").val()})}})},submit:function(e,r){r.formData={format:t("#"+n.values.element+"-format").val(),crs:t("#"+n.values.element+"-crs").val()}},add:function(e,r){t("#"+n.values.element+"-error").html("");var i=/(\.|\/)(gml|kml|geojson|json|zip|dxf|csv)$/i,o=/(\.|\/)(gml|kml|geojson|json)$/i,u=!0;t("#"+n.values.element+"-format").val(),t.each(r.files,function(e,r){r.name.split(".").pop();if(i.test(r.name)){if(window.File&&window.FileReader&&o.test(r.name)){var a=new FileReader,f=t("#"+n.values.element+"-format").val();("ESRI Shapefile"==f||"DXF"==f||"CSV"==f)&&(f="geojson"),a.onload=function(e){n.trigger("resource:loaded",{id:"local_"+r.name,title:t("#"+n.values.element+"-title").val()||r.name.split(".")[0],format:f,name:r.name,type:r.type,text:a.result,url:null,projection:t("#"+n.values.element+"-crs").val()})},a.readAsText(r),u=!1}}else t("#"+n.values.element+"-error").html("").append('<div class="alert alert-danger" role="alert" data-i18n-id="action.upload-resource.error.acceptFileTypes">'+s.i18n.getResource("action.upload-resource.error.acceptFileTypes")+"</div>"),u=!1}),u&&r.submit()},fail:function(e,r){t("#"+n.values.element+"-error").html("").append('<div class="alert alert-danger" role="alert" data-i18n-id="action.upload-resource.error.unknown">'+s.i18n.getResource("action.upload-resource.error.unknown")+"</div>")}}),this.values.dialog.on("dialog:action",function(e){switch(e.action){case"close":this.hide()}}),this.render()},execute:function(){this.values.dialog.show(),t("#"+this.values.element+"-title").focus().select()}}),s.Maps.PositionTool=s.Class(s.Maps.Action,{initialize:function(e){var r=this;"function"==typeof s.Maps.Action.prototype.initialize&&s.Maps.Action.prototype.initialize.apply(this,arguments),this.event("position:changed"),this.values.dialog=new s.Maps.Dialog({title:"action.set-position.title",element:this.values.element+"-dialog",visible:!1,width:350,height:280,autofit:!0,buttons:{update:{text:"control.set-position.dialog.button.move",style:"primary"},close:{text:"button.close",style:"default"}},renderContent:function(){var e=[];return e.push('<div class="clearfix form-inline" style="padding-bottom: 10px;">'),e.push('<label for="'+r.values.element+'-crs" style="padding-right: 10px; width: 150px;" data-i18n-id="control.set-position.dialog.label.crs">'+s.i18n.getResource("control.set-position.dialog.label.crs")+"</label>"),e.push('<span id="'+r.values.element+'-crs" style="padding-right: 10px; width: 130px;">'+r.projectionToString()+"</span>"),e.push("</div>"),e.push('<div class="clearfix form-inline" style="padding-bottom: 10px;">'),e.push('<label for="'+r.values.element+'-x" style="padding-right: 10px; width: 150px;" data-i18n-id="control.set-position.dialog.label.x">'+s.i18n.getResource("control.set-position.dialog.label.x")+"</label>"),e.push('<input id="'+r.values.element+'-x" class="form-control input-md" type="text" style="width: 150px;">'),e.push("</div>"),e.push('<div class="clearfix form-inline" style="padding-bottom: 10px;">'),e.push('<label for="'+r.values.element+'-y" style="padding-right: 10px; width: 150px;" data-i18n-id="control.set-position.dialog.label.y">'+s.i18n.getResource("control.set-position.dialog.label.y")+"</label>"),e.push('<input id="'+r.values.element+'-y" class="form-control input-md" type="text" style="width: 150px;">'),e.push("</div>"),e.push('<div class="clearfix"  id="'+r.values.element+'-error"></div>'),e}}),t("#"+this.values.element+"-x, #"+this.values.element+"-y").change(function(){var e=parseFloat(this.value);isNaN(e)?this.value="":this.value=e.toFixed(4)});var i=function(e,t){return e.getGeometry(),[new n.style.Style({zIndex:1/0,image:new n.style.Icon({anchor:[15,28],anchorXUnits:"pixels",anchorYUnits:"pixels",src:"content/images/app/map-pin.svg"}),text:new n.style.Text({textAlign:"center",font:"10pt Tahoma,Arial Normal",text:e.get("label")||"",fill:new n.style.Fill({color:"black"}),offsetX:0,offsetY:20})})]};this.values.overlay=new n.FeatureOverlay({style:i}),this.values.overlay.setMap(this.values.map),this.values.dialog.on("dialog:show",function(e){var i=r.values.map.getView().getCenter();i=n.proj.transform(i,"EPSG:3857",r.values.projection),t("#"+r.values.element+"-x").val(i[0].toFixed(4)),t("#"+r.values.element+"-y").val(i[1].toFixed(4))}),this.values.dialog.on("dialog:action",function(e){switch(e.action){case"update":var t=r.getPosition();t&&(r.addPinToPosition(),t=n.proj.transform(t,r.values.projection,s.Maps.CRS.Mercator),r.values.map.getView().setCenter(t));break;case"close":this.hide()}}),this.render()},execute:function(){this.values.dialog.show(),this.values.dialog.moveTo(310,65)},getPosition:function(){if(this.values.projection){var e=parseFloat(parseFloat(t("#"+this.values.element+"-x").val()).toFixed(4)),n=parseFloat(parseFloat(t("#"+this.values.element+"-y").val()).toFixed(4));if(!isNaN(e)&&!isNaN(n))return[e,n]}return null},setPosition:function(e){e&&(t("#"+this.values.element+"-x").val(e[0].toFixed(4)),t("#"+this.values.element+"-y").val(e[1].toFixed(4)))},projectionToString:function(){var e=this.values.projection.getCode();switch(e){case"EPSG:3857":return"Web Mercator";case"EPSG:4326":return"WGS84";case"EPSG:2100":return"ΕΓΣΑ87";case"EPSG:4258":return"ETRS89"}return e},setProjection:function(e){var r=this.getPosition();r&&(r=n.proj.transform(r,this.values.projection,e),this.values.projection=e,this.setPosition(r)),t("#"+this.values.element+"-crs").html(this.projectionToString())},clear:function(){this.values.overlay.getFeatures().clear()},addPinToPosition:function(){var e=this.getPosition(),t=[e[0],e[1]];this.values.projection.getCode()!=s.Maps.CRS.Mercator&&(t=n.proj.transform(e,this.values.projection,s.Maps.CRS.Mercator));var r=new n.geom.Point(t),i="",o=new n.Feature({name:"point-"+this.values.overlay.getFeatures().getLength(),label:i,geometry:r});this.values.overlay.getFeatures().insertAt(0,o)}}),s.Maps.PermalinkTool=s.Class(s.Maps.Action,{initialize:function(e){var n=this;e.mode=e.mode||s.Maps.PermalinkTool.Mode.Link,"function"==typeof s.Maps.Action.prototype.initialize&&s.Maps.Action.prototype.initialize.apply(this,arguments),this.values.dialog=new s.Maps.Dialog({title:e.mode==s.Maps.PermalinkTool.Mode.Link?"action.create-link.title":"action.create-link-embed.title",element:this.values.element+"-dialog",visible:!1,width:500,height:280,autofit:!0,buttons:{close:{text:"button.close",style:"default"}},renderContent:function(){var e=[];switch(n.values.mode){case s.Maps.PermalinkTool.Mode.Link:e.push('<div class="clearfix" style="padding-bottom: 10px;">'),e.push('<div class="input-group">'),e.push('<input readonly id="'+n.values.element+'-link" value="" type="text" class="form-control" data-i18n-id="action.create-link.link.placeholder" data-i18n-type="attribute" data-i18n-name="placeholder" placeholder="" style="background: white;">'),e.push('<span class="input-group-btn">'),e.push('<button id="'+n.values.element+'-btn-copy" class="btn btn-default" type="button">'),e.push('<span class="glyphicon glyphicon-copy"></span>'),e.push("</button>"),e.push("</span>"),e.push("</div>"),e.push("</div>"),e.push('<div class="clearfix" style="max-height: 200px; overflow: auto;">'),e.push('<div id="'+n.values.element+'-layers" class="clearfix" style="padding: 0 4px 0 0;"></div>'),e.push("</div>"),e.push('<div class="clearfix" style="background: #fff5c1; border-radius: 4px; padding: 4px;" id="'+n.values.element+'-error"></div>');break;case s.Maps.PermalinkTool.Mode.Embed:e.push('<div class="clearfix" style="padding-bottom: 10px;">'),e.push('<label for="'+n.values.element+'-lib" style="padding-right: 10px; width: 115px;" data-i18n-id="action.create-link-embed.label.lib">'+s.i18n.getResource("action.create-link-embed.label.lib")+"</label>"),e.push('<select name="'+n.values.element+'-lib" id="'+n.values.element+'-lib" class="selectpicker" data-width="160px">'),e.push('<option value="leaflet" selected>LeafLet</option>'),e.push('<option value="ol">OpenLayers 3</option>'),e.push("</select>"),e.push("</div>"),e.push('<div class="clearfix" style="padding-bottom: 10px;">'),e.push('<label for="'+n.values.element+'-iframe" style="padding-right: 10px; width: 115px; float: left;" data-i18n-id="action.create-link-embed.label.code">'+s.i18n.getResource("action.create-link-embed.label.code")+"</label>"),e.push('<textarea name="'+n.values.element+'-iframe" id="'+n.values.element+'-iframe" class="form-control" rows="3" style="resize: none; width: 340px; float: left;"></textarea>'),e.push("</div>")}return e}}),t("#"+this.values.element+"-lib").selectpicker().change(function(){t('[data-id="'+n.values.element+'-lib"]').blur(),n.execute()}),t("#"+this.values.element+"-btn-copy").click(function(){t("#"+n.values.element+"-link").focus().select();var e=!1;try{e=document.execCommand("copy")}catch(r){}}),this.values.dialog.on("dialog:action",function(e){switch(e.action){case"close":this.hide()}}),this.render()},exportToJSON:function(){var e=this.values.map.get("base_layer_properties"),n=this.values.map.getLayers().getArray()[e.exists?2:1],r={zoom:this.values.map.getView().getZoom(),center:this.values.map.getView().getCenter(),base:{type:e.type,set:e.set,opacity:100*n.getOpacity()},layers:[],lib:null};this.values.mode==s.Maps.PermalinkTool.Mode.Embed&&(r.lib=t("#"+this.values.element+"-lib").val());for(var i=this.values.resources.getSelectedLayers(),o=0;o<i.length;o++){var u=i[o],a=this.values.ckan.getResourceById(u.resource_id);a&&r.layers.push({title:u.title,"package":a["package"],resource:a.id,layer:u.layer_id,opacity:u.opacity,endpoint:u.endpoint,key:u.key})}return r},execute:function(){var e=this,n=this.exportToJSON();return e.values.mode==s.Maps.PermalinkTool.Mode.Embed&&(n.lib=t("#"+e.values.element+"-lib").val()),new Promise(function(i,o){var u=new r;"/"===e.values.endpoint?u.segment(["config","save"]):u.segment([e.values.endpoint,"config","save"]);var a=null;switch(e.values.mode){case s.Maps.PermalinkTool.Mode.Link:a=function(n){if(t("#"+e.values.element+"-error").hide(),n.success){var s=new r(window.location.origin);"/"!=e.values.endpoint&&s.segment([e.values.endpoint]),s.addQuery({config:n.url}),t("#"+e.values.element+"-link").val(s.toString()),e.values.dialog.show(),t("#"+e.values.element+"-link").focus().select()}i(n)};break;case s.Maps.PermalinkTool.Mode.Embed:a=function(n){if(t("#"+e.values.element+"-error").hide(),n.success){var s=new r(window.location.origin);"/"===window.location.pathname?s.segment(["config","embed",n.url]):s.segment([window.location.pathname,"config","embed",n.url]);var o=[];o.push('<iframe style="border: none 0; padding: 0; margin: 0; width: 600px; height: 600px;" src="'),o.push(s.toString().replace(/\/\//g,"/").replace(/:\//g,"://")),o.push('" frameborder="0" scrolling="hidden"></iframe>'),t("#"+e.values.element+"-iframe").val(o.join(""))}e.values.dialog.show(),t("#"+e.values.element+"-iframe").focus(),t("#"+e.values.element+"-iframe").select(),i(n)}}t.ajax({type:"POST",url:u.toString().replace(/\/\//g,"/").replace(/:\//g,"://"),context:e,contentType:"application/json; charset=utf-8",dataType:"json",data:JSON.stringify(n)}).done(a).fail(function(e,t,r){console.log("Failed to save configuration : "+JSON.stringify(n)),o(r)})})}}),s.Maps.PermalinkTool.Mode={Link:1,Embed:2};var g=function(e,t,r){var i,o,u=[],a=[];switch(r=r||"",t){case".":i=/\s|,/;break;case",":i=/\s/}var f,l=r.split(i),c=[];for(o=0;o<l.length;o++)l[o]&&(","==t&&(l[o]=l[o].replace(",",".")),f=parseFloat(l[o]),isFinite(f)&&c.push(f));for(o=0;o<c.length;o+=2)c[o+1]&&(u.push([c[o],c[o+1]]),a.push([c[o],c[o+1]]));if(u.length>1&&(u[0][0]!=u[u.length-1][0]||u[0][1]!=u[u.length-1][1])&&(u.push([c[0],c[1]]),a.push([c[0],c[1]])),e!=s.Maps.CRS.Mercator)for(var h=0;h<a.length;h++)a[h]=n.proj.transform(a[h],e,s.Maps.CRS.Mercator);return{initial:u,transformed:a}};return s.Maps.CoordinateParser=s.Class(s.Maps.Action,{initialize:function(e){var r=this;this.values.map=null,"function"==typeof s.Maps.Action.prototype.initialize&&s.Maps.Action.prototype.initialize.apply(this,arguments),this.event("parse:completed");var i=function(e,t){return e.getGeometry(),[new n.style.Style({fill:new n.style.Fill({color:[40,96,144,.4]}),stroke:new n.style.Stroke({color:"#286090",width:2})}),new n.style.Style({zIndex:1/0,image:new n.style.Icon({anchor:[15,28],anchorXUnits:"pixels",anchorYUnits:"pixels",src:"content/images/app/map-pin-filled.svg"}),text:new n.style.Text({textAlign:"center",font:"10pt Tahoma,Arial Normal",text:e.get("label")||"",fill:new n.style.Fill({color:"black"}),stroke:new n.style.Stroke({color:"white",width:2}),offsetX:0,offsetY:20})})]};this.values.overlay=new n.FeatureOverlay({style:i}),this.values.overlay.setMap(this.values.map),this.values.dialog=new s.Maps.Dialog({title:"control.parse.dialog.title",element:this.values.element+"-dialog",visible:!1,width:520,height:250,autofit:!0,buttons:{parse:{text:"control.parse.dialog.button.parse",style:"primary"},clear:{text:"control.parse.dialog.button.clear",style:"default"},close:{text:"control.parse.dialog.button.cancel",style:"default"}},renderContent:function(){var e=[];return e.push('<div class="clearfix" style="padding-bottom: 10px;">'),e.push('<label for="'+r.values.element+'-crs" style="padding-right: 10px; width: 145px;" data-i18n-id="control.parse.dialog.label.crs">'+s.i18n.getResource("control.parse.dialog.label.crs")+"</label>"),e.push('<select name="'+r.values.element+'-crs" id="'+r.values.element+'-crs" class="selectpicker" data-width="120px">'),e.push('<option value="EPSG:4326">WGS84</option>'),e.push('<option value="EPSG:2100" selected="selected">ΕΓΣΑ87</option>'),e.push("</select>"),e.push('<label for="'+r.values.element+'-delimiter" style="padding: 0px 10px;" data-i18n-id="control.parse.dialog.label.delimiter">'+s.i18n.getResource("control.parse.dialog.label.delimiter")+"</label>"),e.push('<select name="'+r.values.element+'-delimiter" id="'+r.values.element+'-delimiter" class="selectpicker" data-width="50px">'),e.push('<option value="." selected="selected">.</option>'),e.push('<option value=",">,</option>'),e.push("</select>"),e.push("</div>"),e.push('<div class="clearfix" style="padding-bottom: 10px;">'),e.push('<label for="'+r.values.element+'-text" style="padding-right: 10px; width: 145px; float: left;" data-i18n-id="control.parse.dialog.label.text">'+s.i18n.getResource("control.parse.dialog.label.text")+"</label>"),e.push('<textarea name="'+r.values.element+'-text" id="'+r.values.element+'-text" class="form-control" rows="3" style="resize: none; width: 330px; float: left;"></textarea>'),e.push("</div>"),e.push('<div class="clearfix alert alert-info" role="alert" style="margin: 0 !important; padding: 7px !important; width: 475px;">'),e.push('<span data-i18n-id="control.parse.dialog.info">'+s.i18n.getResource("control.parse.dialog.info")+"</label>"),e.push("</div>"),e}}),this.values.dialog.on("dialog:close",function(e){r.values.overlay.getFeatures().clear()}),t("#"+this.values.element+"-crs").selectpicker().change(function(){t('[data-id="'+r.values.element+'-crs"]').blur()}),t("#"+this.values.element+"-delimiter").selectpicker().change(function(){t('[data-id="'+r.values.element+'-delimiter"]').blur()}),t("#"+this.values.element+"-type").selectpicker().change(function(){t('[data-id="'+r.values.element+'-type"]').blur()}),this.values.dialog.on("dialog:action",function(e){switch(e.action){case"clear":r.clear();break;case"close":this.hide();break;case"parse":var i,s,o=g(t("#"+r.values.element+"-crs").val(),t("#"+r.values.element+"-delimiter").val(),t("#"+r.values.element+"-text").val()),u=o.initial,a=o.transformed;if(u.length>0){var f=null;if(a.length>1)for(f=[a[0][0],a[0][1],a[0][0],a[0][1]],i=1;i<a.length;i++)f[0]=Math.min(f[0],a[i][0]),f[1]=Math.min(f[1],a[i][1]),f[2]=Math.max(f[2],a[i][0]),f[3]=Math.max(f[3],a[i][1]);r.values.overlay.getFeatures().clear(),r.values.features=new n.Collection;var l=[];for(i=0;i<a.length-1;i++){l.push(a[i]);var c=new n.geom.Point(a[i]),h=u[i][0].toFixed(4)+" , "+u[i][1].toFixed(4);s=new n.Feature({name:"point-"+(i+1),label:h,geometry:c}),r.values.features.push(s)}var p=new n.geom.Polygon([l]);switch(s=new n.Feature({name:"polygo-",label:"",geometry:p}),r.values.features.insertAt(0,s),r.values.overlay.setFeatures(r.values.features),a.length){case 0:break;case 1:r.values.map.getView().setCenter(a[0]),r.values.map.getView().setZoom(17);break;default:var d=r.values.map.getView(),v=r.values.map.getSize();d.fitExtent(f,v)}}r.trigger("parse:completed",{sender:r,coordinates:o})}}),this.render()},execute:function(){this.values.dialog.show()},clear:function(){this.values.overlay.getFeatures().clear()}}),s});