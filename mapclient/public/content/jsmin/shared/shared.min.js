var global=this;define(["module","jquery","ol","proj4","URIjs/URI"],function(e,t,n,r,i){"use strict";var s={__namespace:"PublicaMundi"};s.define=function(e,t){if(e){if("undefined"==typeof t&&(t=this),!t.hasOwnProperty("__namespace"))throw"Property __namespace does not exist.";for(var n=e.split("."),r=this,i=0;i<n.length;i++)n[i]&&("undefined"==typeof r[n[i]]&&(r[n[i]]={__namespace:this.__namespace+"."+n.slice(0,i+1).join(".")}),r=r[n[i]])}},s.define("Maps.UI"),s.define("Maps.CRS"),s.define("Maps.Resources"),s.Maps.CRS.Google="EPSG:900913",s.Maps.CRS.Mercator="EPSG:3857",s.Maps.CRS.WGS84="EPSG:4326",s.Maps.CRS.CRS84="CRS:84",s.Maps.CRS.GGRS87="EPSG:2100",s.Maps.CRS.ETRS89="EPSG:4258","undefined"==typeof r.defs["EPSG:4258"]&&r.defs("EPSG:4258","+proj=longlat +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +no_defs"),"undefined"==typeof r.defs["EPSG:2100"]&&r.defs("EPSG:2100","+proj=tmerc +lat_0=0 +lon_0=24 +k=0.9996 +x_0=500000 +y_0=0 +ellps=GRS80 +towgs84=-199.87,74.79,246.62,0,0,0,0 +units=m +no_defs"),global.proj4=r,s.Maps.Resources.Types={};var o=function(e,t){function n(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);n.prototype=t.prototype,e.prototype=new n};s.extend=function(e,t,n){var r=["values"];if(e=e||{},n=n||!1,t)for(var i in t)r.indexOf(i)<0&&t.hasOwnProperty(i)&&(n&&"object"==typeof t[i]&&t[i]?("object"!=typeof e[i]&&(e[i]={}),s.extend(e[i],t[i])):e[i]=t[i]);return e},s.Class=function(e,t){var n=!0;if("function"!=typeof e&&(t=e,n=!1),!t)throw"Parameter options is required.";if("object"!=typeof t)throw"Parameter options must be an object.";return n?function(e){var n=function(){this.values={},"function"==typeof this.initialize&&this.initialize.apply(this,arguments)};return o(n,e),s.extend(n.prototype,t),n}(e):function(){var e=function(){this.values={},"function"==typeof this.initialize&&this.initialize.apply(this,arguments)};return s.extend(e.prototype,t),e}()},s.operationNotImplemented=function(){throw"Function not implemented."},s.getProxyUrl=function(e,t){var n=e,r=t;if("object"==typeof e&&(n=e.path,r=e.param),!n)return null;var s,o;return o=i.parse(n),o.protocol?(s=-1===n.indexOf("?")?n+"?":n,r&&(s+=(-1===n.indexOf("&")?"":"&")+r+"=")):(o=i.parse(window.location.href),s=i.build({protocol:o.protocol?o.protocol:"http",hostname:o.hostname,port:"80"===o.port?"":o.port,path:n,query:r?r+"=":""})),s},s.isProxyRequired=function(e,t){if(e){var n=i.parse(e),r=i.parse(t);return n.protocol!==r.protocol||n.hostname!==r.hostname||n.port!==r.port}return!1},s.Maps.Observable=s.Class({initialize:function(e){this.values.events={},s.extend(this.values,e)},event:function(e){"undefined"==typeof this.values.events[e]&&(this.values.events[e]={name:e,listeners:[]})},on:function(e,t,n){if("undefined"==typeof this.values.events[e])throw"Event ["+e+"] not supported.";this.values.events[e].listeners.push({callback:t,context:n})},off:function(e){for(var t in this.values.events)for(var n=0;n<this.values.events[t].listenters;n++)if(this.values.events[t].listeners[n].callback===e)return void this.values.events[t].listeners.splice(n,1)},trigger:function(e,t){if("undefined"==typeof this.values.events[e])throw"Event ["+e+"] not supported.";for(var n=this.values.events[e].listeners,r=0;r<n.length;r++)n[r].callback.call(n[r].context?n[r].context:this,t)}});var u={resources:{},adapters:{}};s.Maps.Resources.ResourceMetadataReader=s.Class({initialize:function(e){s.extend(this.values,e)},getMetadata:function(e){s.operationNotImplemented()}}),s.Maps.Resources.CkanResourceMetadataReaderAdapter=s.Class({initialize:function(e){s.extend(this.values,e)},setOptions:function(e){s.operationNotImplemented()}}),s.Maps.Resources.registerResourceType=function(e,t,n,r){if(!e)throw"Parameter type is not set.";if(!t)throw"Parameter title is not set.";if("function"!=typeof n)throw"Parameter reader is not a function.";if("function"!=typeof r)throw"Parameter factory is not a function.";u.resources[e]={title:t,reader:n,factory:r}},s.Maps.Resources.registerResourceTypeAdapter=function(e,t,n){if(!e)throw"Parameter format is not set.";if(!t||!s.Maps.Resources.Types.hasOwnProperty(t))throw"Parameter type is invalid.";if("function"!=typeof n)throw"Parameter adapter is not a function.";u.adapters[e]={type:t,adapter:n}},s.Maps.Resources.LayerFactory=s.Class({initialize:function(e){s.extend(this.values,e)},create:function(e,t,n){s.operationNotImplemented()},destroy:function(e,t,n){s.operationNotImplemented()},createStyle:function(e){e.fill=e.fill||[255,255,255,.4],e.color=e.color||"#3399CC",e.width=e.width||1;var t=new n.style.Fill({color:e.fill}),r=new n.style.Stroke({color:e.color,width:e.width}),i=[new n.style.Style({image:new n.style.Circle({fill:t,stroke:r,radius:5}),fill:t,stroke:r})];return i}}),s.Maps.ResourceManager=s.Class(s.Maps.Observable,{initialize:function(e){"function"==typeof s.Maps.Observable.prototype.initialize&&s.Maps.Observable.prototype.initialize.apply(this,arguments),this.values.readers={},this.values.layers=[],this.values.layerCounter=0,this.values.maxLayerCount=this.values.maxLayerCount||5,this.values.queryable=[],this.event("layer:created")},setCatalogResourceMetadataOptions:function(e){if(!e)throw"Resource is missing.";if("object"!=typeof u.adapters[e.format.toUpperCase()])throw"Resource type "+e.format.toUpperCase()+" is not registered.";if(e.hasOwnProperty("metadata"))return e;var t=new(u.adapters[e.format.toUpperCase()].adapter);return t.setOptions(e),e},getResourceMetadata:function(e,t){if("undefined"==typeof e)throw"Resource type is missing.";if("object"!=typeof u.resources[e])throw"Resource type is not supported.";return"object"!=typeof this.values.readers[e]&&(this.values.readers[e]=new u.resources[e].reader({proxy:this.values.proxy})),this.values.readers[e].getMetadata(t)},addResourceFromCatalog:function(e,t,n,r){var i=this;if(this.values.layerCounter>=this.values.maxLayerCount)return null;if(0!==n&&(n=n||100),0>n?n=0:n>100&&(n=100),!t)throw"Resource is missing.";return"object"!=typeof u.adapters[t.format.toUpperCase()]?null:(t=this.setCatalogResourceMetadataOptions(t),this.getResourceMetadata(t.metadata.type,t.metadata.parameters).then(function(s){for(var o=null,u=0;u<s.layers.length;u++)if(s.layers[u].key==r||s.layers[u].key==t.metadata.extras.layer){o=s.layers[u];break}if(o){var a=i.createLayer(e,s,t.id+"_"+o.key);a&&a.setOpacity(n/100)}},function(e){console.log("Failed to add resource ["+t.id+"] from the catalog")}))},getResourceTypes:function(){var e=[];for(var t in u.resources)e.push({type:t,title:u.resources[t].title});return e},setQueryableResources:function(e){this.values.queryable=e},updateQueryableResources:function(){var e=this,n=this.values.path+"api/resource_show";return new Promise(function(r,i){t.ajax({url:n,context:this}).done(function(t,n,i){if(e.values.queryable=[],t&&t.success)for(var s in t.resources)t.resources[s].wms_layer&&t.resources[s].wms_server&&e.values.queryable.push(t.resources[s]);r(e.values.queryable)}).fail(function(e,t,r){console.log("Failed to load DATA API resource metadata: "+n),i(r)})})},getQueryableResources:function(){return this.values.queryable},createLayer:function(e,t,n){if(this.values.layerCounter>=this.values.maxLayerCount)return null;var r,i=!1,s=null,o=null,a=n.split("_"),f=(a[0],a.splice(1).join("_"));for(r=0;r<t.layers.length;r++)if(t.layers[r].key==f){s=t.layers[r].title,o=t.layers[r].bbox,i=!0;break}if(!i)return null;var l=null;for(r=0;r<this.values.layers.length;r++)if(this.values.layers[r].id==n){l=this.values.layers[r].layer;break}if(!l){var c=new u.resources[t.type].factory({proxy:this.values.proxy});if(l=c.create(e,t,f,s),e.getLayers().insertAt(e.getLayers().getLength(),l),this.values.layers.push({id:n,layer:l,title:s,endpoint:t.endpoint,key:f}),o){this.values.extent&&(o[0]<this.values.extent[0]&&(o[0]=this.values.extent[0]),o[1]<this.values.extent[1]&&(o[1]=this.values.extent[1]),o[2]>this.values.extent[2]&&(o[2]=this.values.extent[2]),o[3]>this.values.extent[3]&&(o[3]=this.values.extent[3]));var h=e.getView(),p=e.getSize();h.fitExtent(o,p)}return this.values.layerCounter++,this.trigger("layer:created",{id:n}),l}return null},destroyLayer:function(e,t){for(var n=-1,r=null,i=0;i<this.values.layers.length;i++)if(this.values.layers[i].id==t){n=i,r=this.values.layers[i].layer;break}return r?(e.removeLayer(r),this.values.layers.splice(n,1),this.values.layerCounter--,!0):!1},getLayerById:function(e){for(var t=0;t<this.values.layers.length;t++)if(this.values.layers[t].id==e)return this.values.layers[t].layer;return null},getLayerCount:function(){return this.values.layerCounter},getSelectedLayers:function(){return this.values.layers.map(function(e,t,n){var r=e.id.split("_");return{resource_id:r[0],layer_id:r[1],title:e.title,opacity:100*e.layer.getOpacity(),endpoint:e.endpoint,key:e.key}})},isLayerSelected:function(e){for(var t=0;t<this.values.layers.length;t++)if(e===this.values.layers[t].id)return!0;return!1},setLayerOpacity:function(e,t){for(var n=null,r=0;r<this.values.layers.length;r++)if(this.values.layers[r].id==e){n=this.values.layers[r].layer;break}n&&n.setOpacity(t/100)},moveLayerUp:function(e,t){var n,r,i=null;for(n=0;n<this.values.layers.length;n++)if(this.values.layers[n].id==t){i=this.values.layers[n].layer,r=n;break}var s=e.getLayers().getArray(),o=-1,u=e.get("base_layer_properties"),a=u.exists?3:2;for(n=a;n<s.length;n++)if(s[n]===i){o=n;break}if(i&&o+1<s.length){var f=e.getLayers().removeAt(o);return e.getLayers().insertAt(o+1,f),this.values.layers.splice(r+1,0,this.values.layers.splice(r,1)[0]),!0}return!1},moveLayerDown:function(e,t){var n,r,i=null;for(r=0;r<this.values.layers.length;r++)if(this.values.layers[r].id==t){i=this.values.layers[r].layer,n=r;break}var s=e.getLayers().getArray(),o=-1,u=e.get("base_layer_properties"),a=u.exists?3:2;for(r=a;r<s.length;r++)if(s[r]===i){o=r;break}if(i&&o-1>a-1){var f=e.getLayers().removeAt(o);return e.getLayers().insertAt(o-1,f),this.values.layers.splice(n-1,0,this.values.layers.splice(n,1)[0]),!0}return!1},getMaxLayerCount:function(){return this.values.maxLayerCount}});var a=s.Class(s.Maps.Observable,{initialize:function(e){"function"==typeof s.Maps.Observable.prototype.initialize&&s.Maps.Observable.prototype.initialize.apply(this,arguments),this.event("locale:load"),this.event("locale:change"),this.values.i18n={locale:"el",strings:{},loaded:{el:!1,en:!1}}},setLocale:function(e){var t=this;return this.values.i18n.loaded.hasOwnProperty(e)?this.values.i18n.locale=e:this.values.i18n.locale="el",this.loadResources().then(function(){t.trigger("locale:change",e)})},getLocale:function(){return this.values.i18n.locale},getAllResources:function(){return this.values.i18n.strings[this.values.i18n.locale]},getResource:function(e,t){return this.values.i18n.strings[this.values.i18n.locale][e]||t||""},loadResources:function(){var e=this,n=new i;return n.segment(["/"===this.values.path?"":this.values.path,"content","js","i18n",this.values.i18n.locale,"strings.js"]),n.addQuery({v:(new Date).getTime()}),new Promise(function(r,i){return e.values.i18n.loaded[e.values.i18n.locale]?(e.trigger("locale:load",e.values.i18n.locale),void r(e.values.i18n.strings[e.values.i18n.locale])):void t.ajax({url:n.toString(),contentType:"application/json; charset=utf-8",dataType:"json",context:e}).done(function(t){e.values.i18n.loaded[e.values.i18n.locale]=!0,e.values.i18n.strings[e.values.i18n.locale]=t,e.trigger("locale:load",e.values.i18n.locale),r(e.values.i18n.strings[e.values.i18n.locale])}).fail(function(e,t,r){console.log("Failed to load resources : "+n.toString()),i(r)})})},setResource:function(e,t,n){this.values.i18n.strings[e][t]=n}});return s.i18n=new a({path:e.config().path}),s});