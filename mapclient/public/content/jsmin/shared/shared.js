var global=this;define(["module","jquery","ol","proj4","URIjs/URI"],function(e,t,n,r,i){"use strict";var s={__namespace:"PublicaMundi"};s.define=function(e,t){if(!e)return;typeof t=="undefined"&&(t=this);if(!t.hasOwnProperty("__namespace"))throw"Property __namespace does not exist.";var n=e.split(".");for(var r=this,i=0;i<n.length;i++){if(!n[i])continue;typeof r[n[i]]=="undefined"&&(r[n[i]]={__namespace:this.__namespace+"."+n.slice(0,i+1).join(".")}),r=r[n[i]]}},s.define("Maps.UI"),s.define("Maps.CRS"),s.define("Maps.Resources"),s.Maps.CRS.Google="EPSG:900913",s.Maps.CRS.Mercator="EPSG:3857",s.Maps.CRS.WGS84="EPSG:4326",s.Maps.CRS.CRS84="CRS:84",s.Maps.CRS.GGRS87="EPSG:2100",s.Maps.CRS.ETRS89="EPSG:4258",typeof r.defs["EPSG:4258"]=="undefined"&&r.defs("EPSG:4258","+proj=longlat +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +no_defs"),typeof r.defs["EPSG:2100"]=="undefined"&&r.defs("EPSG:2100","+proj=tmerc +lat_0=0 +lon_0=24 +k=0.9996 +x_0=500000 +y_0=0 +ellps=GRS80 +towgs84=-199.87,74.79,246.62,0,0,0,0 +units=m +no_defs"),global.proj4=r,s.Maps.Resources.Types={};var o=function(e,t){function n(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);n.prototype=t.prototype,e.prototype=new n};s.extend=function(e,t,n){var r=["values"];e=e||{},n=n||!1;if(t)for(var i in t)r.indexOf(i)<0&&t.hasOwnProperty(i)&&(n&&typeof t[i]=="object"&&t[i]?(typeof e[i]!="object"&&(e[i]={}),s.extend(e[i],t[i])):e[i]=t[i]);return e},s.Class=function(e,t){var n=!0;typeof e!="function"&&(t=e,n=!1);if(!t)throw"Parameter options is required.";if(typeof t!="object")throw"Parameter options must be an object.";return n?function(e){var n=function(){this.values={},typeof this.initialize=="function"&&this.initialize.apply(this,arguments)};return o(n,e),s.extend(n.prototype,t),n}(e):function(){var e=function(){this.values={},typeof this.initialize=="function"&&this.initialize.apply(this,arguments)};return s.extend(e.prototype,t),e}()},s.operationNotImplemented=function(){throw"Function not implemented."},s.getProxyUrl=function(e,t){var n=e,r=t;typeof e=="object"&&(n=e.path,r=e.param);if(!n)return null;var s,o,u;return o=i.parse(n),o.protocol?(s=n.indexOf("?")===-1?n+"?":n,r&&(s+=(n.indexOf("&")===-1?"":"&")+r+"=")):(o=i.parse(window.location.href),s=i.build({protocol:o.protocol?o.protocol:"http",hostname:o.hostname,port:o.port==="80"?"":o.port,path:n,query:r?r+"=":""})),s},s.isProxyRequired=function(e,t){if(e){var n=i.parse(e),r=i.parse(t);return n.protocol!==r.protocol||n.hostname!==r.hostname||n.port!==r.port}return!1},s.Maps.Observable=s.Class({initialize:function(e){this.values.events={},s.extend(this.values,e)},event:function(e){typeof this.values.events[e]=="undefined"&&(this.values.events[e]={name:e,listeners:[]})},on:function(e,t,n){if(typeof this.values.events[e]=="undefined")throw"Event ["+e+"] not supported.";var r=this.values.events[e].listeners.push({callback:t,context:n})},off:function(e){for(var t in this.values.events)for(var n=0;n<this.values.events[t].listenters;n++)if(this.values.events[t].listeners[n].callback===e){this.values.events[t].listeners.splice(n,1);return}},trigger:function(e,t){if(typeof this.values.events[e]=="undefined")throw"Event ["+e+"] not supported.";var n=this.values.events[e].listeners;for(var r=0;r<n.length;r++)n[r].callback.call(n[r].context?n[r].context:this,t)}});var u={resources:{},adapters:{}};s.Maps.Resources.ResourceMetadataReader=s.Class({initialize:function(e){s.extend(this.values,e)},getMetadata:function(e){s.operationNotImplemented()}}),s.Maps.Resources.CkanResourceMetadataReaderAdapter=s.Class({initialize:function(e){s.extend(this.values,e)},setOptions:function(e){s.operationNotImplemented()}}),s.Maps.Resources.registerResourceType=function(e,t,n,r){if(!e)throw"Parameter type is not set.";if(!t)throw"Parameter title is not set.";if(typeof n!="function")throw"Parameter reader is not a function.";if(typeof r!="function")throw"Parameter factory is not a function.";u.resources[e]={title:t,reader:n,factory:r}},s.Maps.Resources.registerResourceTypeAdapter=function(e,t,n){if(!e)throw"Parameter format is not set.";if(!t||!s.Maps.Resources.Types.hasOwnProperty(t))throw"Parameter type is invalid.";if(typeof n!="function")throw"Parameter adapter is not a function.";u.adapters[e]={type:t,adapter:n}},s.Maps.Resources.LayerFactory=s.Class({initialize:function(e){s.extend(this.values,e)},create:function(e,t,n){s.operationNotImplemented()},destroy:function(e,t,n){s.operationNotImplemented()},createStyle:function(e){e.fill=e.fill||[255,255,255,.4],e.color=e.color||"#3399CC",e.width=e.width||1;var t=new n.style.Fill({color:e.fill}),r=new n.style.Stroke({color:e.color,width:e.width}),i=[new n.style.Style({image:new n.style.Circle({fill:t,stroke:r,radius:5}),fill:t,stroke:r})];return i}}),s.Maps.ResourceManager=s.Class(s.Maps.Observable,{initialize:function(e){typeof s.Maps.Observable.prototype.initialize=="function"&&s.Maps.Observable.prototype.initialize.apply(this,arguments),this.values.readers={},this.values.layers=[],this.values.layerCounter=0,this.values.maxLayerCount=this.values.maxLayerCount||5,this.values.queryable=[],this.event("layer:created")},setCatalogResourceMetadataOptions:function(e){if(!e)throw"Resource is missing.";if(typeof u.adapters[e.format.toUpperCase()]!="object")throw"Resource type "+e.format.toUpperCase()+" is not registered.";if(e.hasOwnProperty("metadata"))return e;var t=new(u.adapters[e.format.toUpperCase()].adapter);return t.setOptions(e),e},getResourceMetadata:function(e,t){if(typeof e=="undefined")throw"Resource type is missing.";if(typeof u.resources[e]!="object")throw"Resource type is not supported.";return typeof this.values.readers[e]!="object"&&(this.values.readers[e]=new u.resources[e].reader({proxy:this.values.proxy})),this.values.readers[e].getMetadata(t)},addResourceFromCatalog:function(e,t,n,r){var i=this;if(this.values.layerCounter>=this.values.maxLayerCount)return null;n!==0&&(n=n||100),n<0?n=0:n>100&&(n=100);if(!t)throw"Resource is missing.";return typeof u.adapters[t.format.toUpperCase()]!="object"?null:(t=this.setCatalogResourceMetadataOptions(t),this.getResourceMetadata(t.metadata.type,t.metadata.parameters).then(function(s){var o=null;for(var u=0;u<s.layers.length;u++)if(s.layers[u].key==r||s.layers[u].key==t.metadata.extras.layer){o=s.layers[u];break}if(o){var a=i.createLayer(e,s,t.id+"_"+o.key);a&&a.setOpacity(n/100)}},function(e){console.log("Failed to add resource ["+t.id+"] from the catalog")}))},getResourceTypes:function(){var e=[];for(var t in u.resources)e.push({type:t,title:u.resources[t].title});return e},setQueryableResources:function(e){this.values.queryable=e},updateQueryableResources:function(){var e=this,n=this.values.path+"api/resource_show";return new Promise(function(r,i){t.ajax({url:n,context:this}).done(function(t,n,i){e.values.queryable=[];if(t&&t.success)for(var s in t.resources)t.resources[s].wms_layer&&t.resources[s].wms_server&&e.values.queryable.push(t.resources[s]);r(e.values.queryable)}).fail(function(e,t,r){console.log("Failed to load DATA API resource metadata: "+n),i(r)})})},getQueryableResources:function(){return this.values.queryable},createLayer:function(e,t,n){if(this.values.layerCounter>=this.values.maxLayerCount)return null;var r,i=!1,s=null,o=null,a=n.split("_"),f=a[0],l=a.splice(1).join("_");for(r=0;r<t.layers.length;r++)if(t.layers[r].key==l){s=t.layers[r].title,o=t.layers[r].bbox,i=!0;break}if(!i)return null;var c=null;for(r=0;r<this.values.layers.length;r++)if(this.values.layers[r].id==n){c=this.values.layers[r].layer;break}if(!c){var h=new u.resources[t.type].factory({proxy:this.values.proxy});c=h.create(e,t,l,s),e.getLayers().insertAt(e.getLayers().getLength(),c),this.values.layers.push({id:n,layer:c,title:s,endpoint:t.endpoint,key:l});if(o){this.values.extent&&(o[0]<this.values.extent[0]&&(o[0]=this.values.extent[0]),o[1]<this.values.extent[1]&&(o[1]=this.values.extent[1]),o[2]>this.values.extent[2]&&(o[2]=this.values.extent[2]),o[3]>this.values.extent[3]&&(o[3]=this.values.extent[3]));var p=e.getView(),d=e.getSize();p.fitExtent(o,d)}return this.values.layerCounter++,this.trigger("layer:created",{id:n}),c}return null},destroyLayer:function(e,t){var n=-1,r=null;for(var i=0;i<this.values.layers.length;i++)if(this.values.layers[i].id==t){n=i,r=this.values.layers[i].layer;break}return r?(e.removeLayer(r),this.values.layers.splice(n,1),this.values.layerCounter--,!0):!1},getLayerById:function(e){for(var t=0;t<this.values.layers.length;t++)if(this.values.layers[t].id==e)return this.values.layers[t].layer;return null},getLayerCount:function(){return this.values.layerCounter},getSelectedLayers:function(){return this.values.layers.map(function(e,t,n){var r=e.id.split("_");return{resource_id:r[0],layer_id:r[1],title:e.title,opacity:e.layer.getOpacity()*100,endpoint:e.endpoint,key:e.key}})},isLayerSelected:function(e){for(var t=0;t<this.values.layers.length;t++)if(e===this.values.layers[t].id)return!0;return!1},setLayerOpacity:function(e,t){var n=null;for(var r=0;r<this.values.layers.length;r++)if(this.values.layers[r].id==e){n=this.values.layers[r].layer;break}n&&n.setOpacity(t/100)},moveLayerUp:function(e,t){var n=null,r,i;for(r=0;r<this.values.layers.length;r++)if(this.values.layers[r].id==t){n=this.values.layers[r].layer,i=r;break}var s=e.getLayers().getArray(),o=-1,u=e.get("base_layer_properties"),a=u.exists?3:2;for(r=a;r<s.length;r++)if(s[r]===n){o=r;break}if(n&&o+1<s.length){var f=e.getLayers().removeAt(o);return e.getLayers().insertAt(o+1,f),this.values.layers.splice(i+1,0,this.values.layers.splice(i,1)[0]),!0}return!1},moveLayerDown:function(e,t){var n=null,r,i;for(i=0;i<this.values.layers.length;i++)if(this.values.layers[i].id==t){n=this.values.layers[i].layer,r=i;break}var s=e.getLayers().getArray(),o=-1,u=e.get("base_layer_properties"),a=u.exists?3:2;for(i=a;i<s.length;i++)if(s[i]===n){o=i;break}if(n&&o-1>a-1){var f=e.getLayers().removeAt(o);return e.getLayers().insertAt(o-1,f),this.values.layers.splice(r-1,0,this.values.layers.splice(r,1)[0]),!0}return!1},getMaxLayerCount:function(){return this.values.maxLayerCount}});var a=s.Class(s.Maps.Observable,{initialize:function(e){typeof s.Maps.Observable.prototype.initialize=="function"&&s.Maps.Observable.prototype.initialize.apply(this,arguments),this.event("locale:load"),this.event("locale:change"),this.values.i18n={locale:"el",strings:{},loaded:{el:!1,en:!1}}},setLocale:function(e){var t=this;return this.values.i18n.loaded.hasOwnProperty(e)?this.values.i18n.locale=e:this.values.i18n.locale="el",this.loadResources().then(function(){t.trigger("locale:change",e)})},getLocale:function(){return this.values.i18n.locale},getAllResources:function(){return this.values.i18n.strings[this.values.i18n.locale]},getResource:function(e,t){return this.values.i18n.strings[this.values.i18n.locale][e]||t||""},loadResources:function(){var e=this,n=new i;return n.segment([this.values.path==="/"?"":this.values.path,"content","js","i18n",this.values.i18n.locale,"strings.js"]),n.addQuery({v:(new Date).getTime()}),new Promise(function(r,i){if(e.values.i18n.loaded[e.values.i18n.locale]){e.trigger("locale:load",e.values.i18n.locale),r(e.values.i18n.strings[e.values.i18n.locale]);return}t.ajax({url:n.toString(),contentType:"application/json; charset=utf-8",dataType:"json",context:e}).done(function(t){e.values.i18n.loaded[e.values.i18n.locale]=!0,e.values.i18n.strings[e.values.i18n.locale]=t,e.trigger("locale:load",e.values.i18n.locale),r(e.values.i18n.strings[e.values.i18n.locale])}).fail(function(e,t,r){console.log("Failed to load resources : "+n.toString()),i(r)})})},setResource:function(e,t,n){this.values.i18n.strings[e][t]=n}});return s.i18n=new a({path:e.config().path}),s});