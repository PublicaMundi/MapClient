/* PublicaMundi Mapping API version 0.1.0 2015-09-30 */

function xmlToJson(a){var b={};if(1==a.nodeType){if(a.attributes.length>0){b["@attributes"]={};for(var c=0;c<a.attributes.length;c++){var d=a.attributes.item(c);b["@attributes"][d.nodeName]=d.nodeValue}}}else 3==a.nodeType&&(b=a.nodeValue);if(a.hasChildNodes())for(var e=0;e<a.childNodes.length;e++){var f=a.childNodes.item(e),g=f.nodeName;if("undefined"==typeof b[g])b[g]=xmlToJson(f);else{if("undefined"==typeof b[g].push){var h=b[g];b[g]=[],b[g].push(h)}b[g].push(xmlToJson(f))}}return b}!function(a,b){"use strict";"undefined"!=typeof b&&(b.define("PublicaMundi.OpenLayers"),b.OpenLayers.Framework="ol",b.registerFrameworkResolver(b.OpenLayers.Framework,function(){return b.isObject(ol)&&b.isFunction(ol.Map)?!0:!1}))}(window,PublicaMundi),ol.control.LayerSwitcher=function(a){var b=a||{};this.mapListeners=[],this.hiddenClassName="ol-unselectable ol-control layer-switcher",this.shownClassName=this.hiddenClassName+" shown";var c=document.createElement("div");c.className=this.hiddenClassName;var d=document.createElement("button");c.appendChild(d),this.panel=document.createElement("div"),this.panel.className="panel",c.appendChild(this.panel);var e=this;c.onmouseover=function(a){e.showPanel()},d.onclick=function(a){e.showPanel()},c.onmouseout=function(a){a=a||window.event,c.contains(a.toElement)||e.hidePanel()},ol.control.Control.call(this,{element:c,target:b.target})},ol.inherits(ol.control.LayerSwitcher,ol.control.Control),ol.control.LayerSwitcher.prototype.showPanel=function(){this.element.className!=this.shownClassName&&(this.element.className=this.shownClassName,this.render())},ol.control.LayerSwitcher.prototype.hidePanel=function(){this.element.className!=this.hiddenClassName&&(this.element.className=this.hiddenClassName)},ol.control.LayerSwitcher.prototype.render=function(){for(;this.panel.firstChild;)this.panel.removeChild(this.panel.firstChild);var a=document.createElement("ul");this.panel.appendChild(a),this.renderLayers_(this.getMap(),a)},ol.control.LayerSwitcher.prototype.setMap=function(a){for(var b=0;b<this.mapListeners.length;b++)this.getMap().unByKey(this.mapListeners[b]);this.mapListeners.length=0,ol.control.Control.prototype.setMap.call(this,a);var c=this;this.mapListeners.push(a.on("pointerdown",function(){c.hidePanel()})),this.render()},ol.control.LayerSwitcher.prototype.toggleLayer_=function(a){var b=this.getMap();a.setVisible(!a.getVisible()),"base"===a.get("type")&&ol.control.LayerSwitcher.forEachRecursive(b,function(b,c,d){"base"===b.get("type")&&b!=a&&b.setVisible(!1)})},ol.control.LayerSwitcher.prototype.renderLayer_=function(a,b){var c=this,d=document.createElement("li"),e=a.get("title"),f=a.get("title").replace(" ","-")+"_"+b,g=document.createElement("label");if(a.getLayers){d.className="group",g.innerHTML=e,d.appendChild(g);var h=document.createElement("ul");d.appendChild(h),this.renderLayers_(a,h)}else{var i=document.createElement("input");"base"===a.get("type")?(i.type="radio",i.name="base"):i.type="checkbox",i.id=f,i.checked=a.get("visible"),i.onchange=function(){c.toggleLayer_(a)},d.appendChild(i),g.htmlFor=f,g.innerHTML=e,d.appendChild(g)}return d},ol.control.LayerSwitcher.prototype.renderLayers_=function(a,b){for(var c,d=a.getLayers().getArray().slice().reverse(),e=0;e<d.length;e++)c=d[e],c.get("title")&&b.appendChild(this.renderLayer_(c,e))},ol.control.LayerSwitcher.forEachRecursive=function(a,b){a.getLayers().forEach(function(a,c,d){b(a,c,d),a.getLayers&&ol.control.LayerSwitcher.forEachRecursive(a,b)})},function(a,b,c){"undefined"!=typeof b&&"undefined"!=typeof c&&(b.define("PublicaMundi.OpenLayers"),b.OpenLayers.Map=b.Class(b.Map,{addOverlay:function(a){return popup=new c.Overlay({element:a}),this._map.addOverlay(popup),popup},setOverlayPosition:function(a,b){a.setPosition(b)},setExtent:function(a,b){if(null!==a){var d;"EPSG:4326"==b?(a[0]<-180&&(a[0]=-179),a[1]<-90&&(a[1]=-89),a[2]>180&&(a[2]=179),a[3]>90&&(a[3]=89),d=c.proj.transformExtent(a,"EPSG:4326","EPSG:3857")):d="EPSG:3857"==b?a:null,this._map.getView().fitExtent(d,this._map.getSize())}},initialize:function(a){if(b.Map.prototype.initialize.call(this,a),b.isClass("ol.Map")&&a instanceof c.Map?this._map=a:this._map=new c.Map({target:a.target,view:new c.View({projection:a.projection,center:a.center,zoom:a.zoom,maxZoom:a.maxZoom,minZoom:a.minZoom}),controls:c.control.defaults({rotate:!1}).extend([]),ol3Logo:!1}),this._listen(),this._clickHandlerMap=null,this._clickHandlerLayer=[],this._clickHandlerRegisteredLayers=[],this._map.on("click",function(a){}),"undefined"!=typeof a.layers&&b.isArray(a.layers))for(var d=0;d<a.layers.length;d++)this.createLayer(a.layers[d])},setCenter:function(a,c){b.isArray(a)?this._map.getView().setCenter(a):this._map.getView().setCenter([a,c])},getCenter:function(){return this._map.getView().getCenter()},setZoom:function(a){this._map.getView().setZoom(a)},getZoom:function(){return this._map.getView().getZoom()},getProjection:function(){return this._map.getView().getProjection().getCode()},getTarget:function(){return this._map.getTarget()},addLayer:function(a){if(this._map.addLayer(a.getLayer()),b.isFunction(a.getOptions().click)){this._clickHandlerRegisteredLayers.push(a),this._clickHandlerLayer.push(a.getOptions().click);var d=new c.FeatureOverlay({map:this._map,style:new c.style.Style({stroke:new c.style.Stroke({color:"rgba(51,153,204, 1)",width:3}),image:new c.style.Circle({radius:6,stroke:new c.style.Stroke({color:"rgba(51,153,204, 1)",width:2})})})});if(!b.isFunction(this._clickHandlerMap)){var e=this._clickHandlerRegisteredLayers,f=this._clickHandlerLayer,g=this._map;this._clickHandlerMap=function(a){var b=this._map.getEventPixel(a.originalEvent),c=[];g._highlight&&(d.removeFeature(g._highlight),g._highlight=void 0);for(var h=function(a,b){if(b===e[i].getLayer()&&b.get("visible")===!0){g._highlight?g._highlight!==a&&(d.removeFeature(g._highlight),g._highlight=a,d.addFeature(a)):(g._highlight=a,d.addFeature(a));for(var f={},h=a.getKeys(),j=a.getGeometryName(),k=0;k<h.length;k++)h[k]!==j&&(f[h[k]]=a.get(h[k]));c.push(f)}},i=0;i<e.length;i++)c=[],this._map.forEachFeatureAtPixel(b,h),c.length>0&&f[i](e[i],c,a.coordinate)},this._map.on("singleclick",this._clickHandlerMap,this)}}},setLayerControl:function(){return this._control=new c.control.LayerSwitcher,this._map.getControls().extend([this._control]),this._control},_setViewBox:function(){var a=this.getExtent()[0]+","+this.getExtent()[1]+","+this.getExtent()[2]+","+this.getExtent()[3];this._viewbox=a},getExtent:function(){return this._map.getView().calculateExtent(this._map.getSize())},_listen:function(){var a=this;this._map.on("moveend",function(){a._setViewBox()})}}),b.locator.register("PublicaMundi.Map",b.OpenLayers.Map))}(window,window.PublicaMundi,ol),function(a,b,c){if("undefined"!=typeof b&&"undefined"!=typeof c){var d=function(a){var b=null;return $.each(a,function(a,c){"EPSG:4326"==c.crs?b=[c.extent[1],c.extent[0],c.extent[3],c.extent[2]]:"CRS:84"==c.crs&&(b=[c.extent[0],c.extent[1],c.extent[2],c.extent[3]])}),b};b.define("PublicaMundi.OpenLayers.Layer"),b.OpenLayers.Layer.WMS=b.Class(b.Layer,{initialize:function(a){b.Layer.prototype.initialize.call(this,a),this._map=null,this._type=null,this._layer=new c.layer.Tile({title:a.title,visible:a.visible,source:new c.source.TileWMS({url:a.url,params:a.params})})},fitToMap:function(){var a=this,b=this._options;if("undefined"==typeof b.bbox){console.log("Getting Capabilities...");var e=new c.format.WMSCapabilities;$.ajax(b.url+"?service=WMS&request=GetCapabilities").then(function(c){c=e.read(c);var f=c.Capability.Layer.Layer;$.each(f,function(c,e){return e.Name==b.params.layers?(bbox=d(e.BoundingBox),a._extent=bbox,a._layer.once("postcompose",function(){a.getMap().setExtent(a._extent,"EPSG:4326")}),!1):void 0})})}else console.log("Bbox option found"),this._layer.once("postcompose",function(){a.getMap().setExtent(a._extent,"EPSG:4326")})}}),b.registry.registerLayerType({layer:b.LayerType.WMS,framework:b.OpenLayers.Framework,type:"PublicaMundi.Layer.WMS",factory:b.OpenLayers.Layer.WMS})}}(window,window.PublicaMundi,ol),function(a,b,c){"undefined"!=typeof b&&"undefined"!=typeof c&&(b.define("PublicaMundi.OpenLayers.Layer"),b.OpenLayers.Layer.WFS=b.Class(b.Layer,{update:function(){},initialize:function(a){b.Layer.prototype.initialize.call(this,a),this._map=null,this._type=null;var d,e=a.params.version?"&version="+a.params.version:"",f=a.params.maxFeatures?"&maxFeatures="+a.params.maxFeatures:"",g=a.params.format?a.params.format:"json";"gml"==g&&(g="gml2"),"json"==g?d=new c.format.GeoJSON:"gml32"==g||"gml31"==g||"gml3"==g?d=new c.format.WFS({gmlFormat:new c.format.GML3,extractAttributes:!0,resFactor:1}):"gml2"==g&&(d=new c.format.WFS({gmlFormat:new c.format.GML2}));var h=a.params.projection?a.params.projection:"EPSG:3857";"EPSG:900913"==h?h="EPSG:3857":"EPSG:26713"==h&&(h="EPSG:3857");var i=a.params.layers,j=new c.source.ServerVector({format:d,projection:h,strategy:c.loadingstrategy.createTile(new c.tilegrid.XYZ({})),loader:function(b,c,d){$.ajax({type:"GET",url:a.url+"?service=WFS&request=GetFeature&typename="+i+"&srsname="+h+"&outputFormat="+g+"&bbox="+b.join(",")+",EPSG:3857"+f+e,success:function(a){k(a)},failure:function(a){console.log(a)}})}}),k=function(a){j.addFeatures(d.readFeatures(a))};this._layer=new c.layer.Vector({title:a.title,source:j,visible:a.visible,projection:h})},fitToMap:function(){var a=this,b=this._options;"undefined"==typeof b.bbox?(console.log("Getting Capabilities..."),$.ajax(b.url+"?service=WFS&request=GetCapabilities").then(function(c){c=xmlToJson(c);var d=c["wfs:WFS_Capabilities"].FeatureTypeList.FeatureType;$.each(d,function(c,d){if(d.Name&&d.Name["#text"]&&d.Name["#text"]==b.params.layers){var e=d.WGS84BoundingBox,f=null,g=null;return"undefined"==typeof e?(e=d["ows:WGS84BoundingBox"],f=e["ows:LowerCorner"]["#text"],g=e["ows:UpperCorner"]["#text"]):(f=e.LowerCorner["#text"],g=e.UpperCorner["#text"]),"undefined"!=typeof e&&(f=f.split(" "),g=g.split(" "),bboxfloat=[parseFloat(f[0]),parseFloat(f[1]),parseFloat(g[0]),parseFloat(g[1])]),a._extent=bboxfloat,a._layer.once("postcompose",function(){a.getMap().setExtent(a._extent,"EPSG:4326")}),!1}})})):(console.log("Bbox option found"),this._layer.once("postcompose",function(){a.getMap().setExtent(a._extent,"EPSG:4326")}))}}),b.registry.registerLayerType({layer:b.LayerType.WFS,framework:b.OpenLayers.Framework,type:"PublicaMundi.Layer.WFS",factory:b.OpenLayers.Layer.WFS}))}(window,window.PublicaMundi,ol),function(a,b,c){"undefined"!=typeof b&&"undefined"!=typeof c&&(b.define("PublicaMundi.OpenLayers.Layer"),b.OpenLayers.Layer.Tile=b.Class(b.Layer,{initialize:function(a){b.Layer.prototype.initialize.call(this,a),this._layer=new c.layer.Tile({title:a.title,type:"base",source:new c.source.XYZ({url:a.url})});var d=[];if(a.url.indexOf("{s}")<0)d.push(a.url);else{var e=a.subdomains||"abc";b.isArray(e)||(e=e.split(""));for(var f=0;f<e.length;f++)d.push(a.url.replace("{s}",e[f]))}this._layer.getSource().setUrls(d)}}),b.registry.registerLayerType({layer:b.LayerType.TILE,framework:b.OpenLayers.Framework,type:"PublicaMundi.Layer.Tile",factory:b.OpenLayers.Layer.Tile}))}(window,window.PublicaMundi,ol),function(a,b,c){"undefined"!=typeof b&&"undefined"!=typeof c&&(b.define("PublicaMundi.OpenLayers.Layer"),b.OpenLayers.Layer.KML=b.Class(b.Layer,{initialize:function(a){b.Layer.prototype.initialize.call(this,a),this._layer=new c.layer.Vector({title:a.title,source:new c.source.KML({extractStyles:!1,projection:a.projection,url:a.url})})},fitToMap:function(){var a=this;this._layer.once("postcompose",function(){a._extent=this.getSource().getExtent(),a.getMap().setExtent(a._extent,"EPSG:3857")})}}),b.registry.registerLayerType({layer:b.LayerType.KML,framework:b.OpenLayers.Framework,type:"PublicaMundi.Layer.KML",factory:b.OpenLayers.Layer.KML}),b.isDefined(b.Map)&&(b.Map.prototype.KML=function(a){a.type=a.type||b.LayerType.KML,this.createLayer(a)}))}(window,window.PublicaMundi,ol),function(a,b,c){"undefined"!=typeof b&&"undefined"!=typeof c&&(b.define("PublicaMundi.OpenLayers.Layer"),b.OpenLayers.Layer.GeoJson=b.Class(b.Layer,{initialize:function(a){b.Layer.prototype.initialize.call(this,a),this._layer=new c.layer.Vector({title:a.title,source:new c.source.GeoJSON({projection:a.projection,url:a.url})})},fitToMap:function(){var a=this;this._layer.once("postcompose",function(){a._extent=this.getSource().getExtent(),a.getMap().setExtent(a._extent,"EPSG:3857")})}}),b.registry.registerLayerType({layer:b.LayerType.GeoJSON,framework:b.OpenLayers.Framework,type:"PublicaMundi.Layer.GeoJson",factory:b.OpenLayers.Layer.GeoJson}),b.isDefined(b.Map)&&(b.Map.prototype.geoJSON=function(a){a.type=a.type||b.LayerType.GeoJSON,this.createLayer(a)}))}(window,window.PublicaMundi,ol);
//# sourceMappingURL=publicamundi.ol.js.map