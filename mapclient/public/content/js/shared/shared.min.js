/* PublicaMundi Map Client version 1.0.0 2016-02-18 */

var global=this;define(["module","jquery","ol","proj4","URIjs/URI"],function(a,b,c,d,e){"use strict";var f={__namespace:"PublicaMundi"};f.define=function(a,b){if(a){if("undefined"==typeof b&&(b=this),!b.hasOwnProperty("__namespace"))throw"Property __namespace does not exist.";for(var c=a.split("."),d=this,e=0;e<c.length;e++)c[e]&&("undefined"==typeof d[c[e]]&&(d[c[e]]={__namespace:this.__namespace+"."+c.slice(0,e+1).join(".")}),d=d[c[e]])}},f.define("Maps.UI"),f.define("Maps.CRS"),f.define("Maps.Resources"),f.Maps.CRS.Google="EPSG:900913",f.Maps.CRS.Mercator="EPSG:3857",f.Maps.CRS.WGS84="EPSG:4326",f.Maps.CRS.CRS84="CRS:84",f.Maps.CRS.GGRS87="EPSG:2100",f.Maps.CRS.ETRS89="EPSG:4258","undefined"==typeof d.defs["EPSG:4258"]&&d.defs("EPSG:4258","+proj=longlat +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +no_defs"),"undefined"==typeof d.defs["EPSG:2100"]&&d.defs("EPSG:2100","+proj=tmerc +lat_0=0 +lon_0=24 +k=0.9996 +x_0=500000 +y_0=0 +ellps=GRS80 +towgs84=-199.87,74.79,246.62,0,0,0,0 +units=m +no_defs"),global.proj4=d,f.Maps.Resources.Types={};var g=function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c};f.extend=function(a,b,c){var d=["values"];if(a=a||{},c=c||!1,b)for(var e in b)d.indexOf(e)<0&&b.hasOwnProperty(e)&&(c&&"object"==typeof b[e]&&b[e]?("object"!=typeof a[e]&&(a[e]={}),f.extend(a[e],b[e])):a[e]=b[e]);return a},f.Class=function(a,b){var c=!0;if("function"!=typeof a&&(b=a,c=!1),!b)throw"Parameter options is required.";if("object"!=typeof b)throw"Parameter options must be an object.";return c?function(a){var c=function(){this.values={},"function"==typeof this.initialize&&this.initialize.apply(this,arguments)};return g(c,a),f.extend(c.prototype,b),c}(a):function(){var a=function(){this.values={},"function"==typeof this.initialize&&this.initialize.apply(this,arguments)};return f.extend(a.prototype,b),a}()},f.operationNotImplemented=function(){throw"Function not implemented."},f.getProxyUrl=function(a,b){var c=a,d=b;if("object"==typeof a&&(c=a.path,d=a.param),!c)return null;var f,g;return g=e.parse(c),g.protocol?(f=-1===c.indexOf("?")?c+"?":c,d&&(f+=(-1===c.indexOf("&")?"":"&")+d+"=")):(g=e.parse(window.location.href),f=e.build({protocol:g.protocol?g.protocol:"http",hostname:g.hostname,port:"80"===g.port?"":g.port,path:c,query:d?d+"=":""})),f},f.isProxyRequired=function(a,b){if(a){var c=e.parse(a),d=e.parse(b);return c.protocol!==d.protocol||c.hostname!==d.hostname||c.port!==d.port}return!1},f.Maps.Observable=f.Class({initialize:function(a){this.values.events={},f.extend(this.values,a)},event:function(a){"undefined"==typeof this.values.events[a]&&(this.values.events[a]={name:a,listeners:[]})},on:function(a,b,c){if("undefined"==typeof this.values.events[a])throw"Event ["+a+"] not supported.";this.values.events[a].listeners.push({callback:b,context:c})},off:function(a){for(var b in this.values.events)for(var c=0;c<this.values.events[b].listenters;c++)if(this.values.events[b].listeners[c].callback===a)return void this.values.events[b].listeners.splice(c,1)},trigger:function(a,b){if("undefined"==typeof this.values.events[a])throw"Event ["+a+"] not supported.";for(var c=this.values.events[a].listeners,d=0;d<c.length;d++)c[d].callback.call(c[d].context?c[d].context:this,b)}});var h={resources:{},adapters:{}};f.Maps.Resources.ResourceMetadataReader=f.Class({initialize:function(a){f.extend(this.values,a)},getMetadata:function(a){f.operationNotImplemented()}}),f.Maps.Resources.CkanResourceMetadataReaderAdapter=f.Class({initialize:function(a){f.extend(this.values,a)},setOptions:function(a){f.operationNotImplemented()}}),f.Maps.Resources.registerResourceType=function(a,b,c,d){if(!a)throw"Parameter type is not set.";if(!b)throw"Parameter title is not set.";if("function"!=typeof c)throw"Parameter reader is not a function.";if("function"!=typeof d)throw"Parameter factory is not a function.";h.resources[a]={title:b,reader:c,factory:d}},f.Maps.Resources.registerResourceTypeAdapter=function(a,b,c){if(!a)throw"Parameter format is not set.";if(!b||!f.Maps.Resources.Types.hasOwnProperty(b))throw"Parameter type is invalid.";if("function"!=typeof c)throw"Parameter adapter is not a function.";h.adapters[a]={type:b,adapter:c}},f.Maps.Resources.LayerFactory=f.Class({initialize:function(a){f.extend(this.values,a)},create:function(a,b,c){f.operationNotImplemented()},destroy:function(a,b,c){f.operationNotImplemented()},createStyle:function(a){a.fill=a.fill||[255,255,255,.4],a.color=a.color||"#3399CC",a.width=a.width||1;var b=new c.style.Fill({color:a.fill}),d=new c.style.Stroke({color:a.color,width:a.width}),e=[new c.style.Style({image:new c.style.Circle({fill:b,stroke:d,radius:5}),fill:b,stroke:d})];return e}}),f.Maps.ResourceManager=f.Class(f.Maps.Observable,{initialize:function(a){"function"==typeof f.Maps.Observable.prototype.initialize&&f.Maps.Observable.prototype.initialize.apply(this,arguments),this.values.readers={},this.values.layers=[],this.values.layerCounter=0,this.values.maxLayerCount=this.values.maxLayerCount||5,this.values.queryable=[],this.event("layer:created")},setCatalogResourceMetadataOptions:function(a){if(!a)throw"Resource is missing.";if("object"!=typeof h.adapters[a.format.toUpperCase()])throw"Resource type "+a.format.toUpperCase()+" is not registered.";if(a.hasOwnProperty("metadata"))return a;var b=new(h.adapters[a.format.toUpperCase()].adapter);return b.setOptions(a),a},getResourceMetadata:function(a,b){if("undefined"==typeof a)throw"Resource type is missing.";if("object"!=typeof h.resources[a])throw"Resource type is not supported.";return"object"!=typeof this.values.readers[a]&&(this.values.readers[a]=new h.resources[a].reader({proxy:this.values.proxy})),this.values.readers[a].getMetadata(b)},addResourceFromCatalog:function(a,b,c,d){var e=this;if(this.values.layerCounter>=this.values.maxLayerCount)return null;if(0!==c&&(c=c||100),0>c?c=0:c>100&&(c=100),!b)throw"Resource is missing.";return"object"!=typeof h.adapters[b.format.toUpperCase()]?null:(b=this.setCatalogResourceMetadataOptions(b),this.getResourceMetadata(b.metadata.type,b.metadata.parameters).then(function(f){for(var g=null,h=0;h<f.layers.length;h++)if(f.layers[h].key==d||f.layers[h].key==b.metadata.extras.layer){g=f.layers[h];break}if(g){var i=e.createLayer(a,f,b.id+"_"+g.key);i&&i.setOpacity(c/100)}},function(a){console.log("Failed to add resource ["+b.id+"] from the catalog")}))},getResourceTypes:function(){var a=[];for(var b in h.resources)a.push({type:b,title:h.resources[b].title});return a},setQueryableResources:function(a){this.values.queryable=a},updateQueryableResources:function(){var a=this,c=this.values.path+"api/resource_show";return new Promise(function(d,e){b.ajax({url:c,context:this}).done(function(b,c,e){if(a.values.queryable=[],b&&b.success)for(var f in b.resources)b.resources[f].wms_layer&&b.resources[f].wms_server&&a.values.queryable.push(b.resources[f]);d(a.values.queryable)}).fail(function(a,b,d){console.log("Failed to load DATA API resource metadata: "+c),e(d)})})},getQueryableResources:function(){return this.values.queryable},createLayer:function(a,b,c){if(this.values.layerCounter>=this.values.maxLayerCount)return null;var d,e=!1,f=null,g=null,i=c.split("_"),j=(i[0],i.splice(1).join("_"));for(d=0;d<b.layers.length;d++)if(b.layers[d].key==j){f=b.layers[d].title,g=b.layers[d].bbox,e=!0;break}if(!e)return null;var k=null;for(d=0;d<this.values.layers.length;d++)if(this.values.layers[d].id==c){k=this.values.layers[d].layer;break}if(!k){var l=new h.resources[b.type].factory({proxy:this.values.proxy});if(k=l.create(a,b,j,f),a.getLayers().insertAt(a.getLayers().getLength(),k),this.values.layers.push({id:c,layer:k,title:f,endpoint:b.endpoint,key:j}),g){this.values.extent&&(g[0]<this.values.extent[0]&&(g[0]=this.values.extent[0]),g[1]<this.values.extent[1]&&(g[1]=this.values.extent[1]),g[2]>this.values.extent[2]&&(g[2]=this.values.extent[2]),g[3]>this.values.extent[3]&&(g[3]=this.values.extent[3]));var m=a.getView(),n=a.getSize();m.fitExtent(g,n)}return this.values.layerCounter++,this.trigger("layer:created",{id:c}),k}return null},destroyLayer:function(a,b){for(var c=-1,d=null,e=0;e<this.values.layers.length;e++)if(this.values.layers[e].id==b){c=e,d=this.values.layers[e].layer;break}return d?(a.removeLayer(d),this.values.layers.splice(c,1),this.values.layerCounter--,!0):!1},getLayerById:function(a){for(var b=0;b<this.values.layers.length;b++)if(this.values.layers[b].id==a)return this.values.layers[b].layer;return null},getLayerCount:function(){return this.values.layerCounter},getSelectedLayers:function(){return this.values.layers.map(function(a,b,c){var d=a.id.split("_");return{resource_id:d[0],layer_id:d[1],title:a.title,opacity:100*a.layer.getOpacity(),endpoint:a.endpoint,key:a.key}})},isLayerSelected:function(a){for(var b=0;b<this.values.layers.length;b++)if(a===this.values.layers[b].id)return!0;return!1},setLayerOpacity:function(a,b){for(var c=null,d=0;d<this.values.layers.length;d++)if(this.values.layers[d].id==a){c=this.values.layers[d].layer;break}c&&c.setOpacity(b/100)},moveLayerUp:function(a,b){var c,d,e=null;for(c=0;c<this.values.layers.length;c++)if(this.values.layers[c].id==b){e=this.values.layers[c].layer,d=c;break}var f=a.getLayers().getArray(),g=-1,h=a.get("base_layer_properties"),i=h.exists?3:2;for(c=i;c<f.length;c++)if(f[c]===e){g=c;break}if(e&&g+1<f.length){var j=a.getLayers().removeAt(g);return a.getLayers().insertAt(g+1,j),this.values.layers.splice(d+1,0,this.values.layers.splice(d,1)[0]),!0}return!1},moveLayerDown:function(a,b){var c,d,e=null;for(d=0;d<this.values.layers.length;d++)if(this.values.layers[d].id==b){e=this.values.layers[d].layer,c=d;break}var f=a.getLayers().getArray(),g=-1,h=a.get("base_layer_properties"),i=h.exists?3:2;for(d=i;d<f.length;d++)if(f[d]===e){g=d;break}if(e&&g-1>i-1){var j=a.getLayers().removeAt(g);return a.getLayers().insertAt(g-1,j),this.values.layers.splice(c-1,0,this.values.layers.splice(c,1)[0]),!0}return!1},getMaxLayerCount:function(){return this.values.maxLayerCount}});var i=f.Class(f.Maps.Observable,{initialize:function(a){"function"==typeof f.Maps.Observable.prototype.initialize&&f.Maps.Observable.prototype.initialize.apply(this,arguments),this.event("locale:load"),this.event("locale:change"),this.values.i18n={locale:"el",strings:{},loaded:{el:!1,en:!1}}},setLocale:function(a){var b=this;return this.values.i18n.loaded.hasOwnProperty(a)?this.values.i18n.locale=a:this.values.i18n.locale="el",this.loadResources().then(function(){b.trigger("locale:change",a)})},getLocale:function(){return this.values.i18n.locale},getAllResources:function(){return this.values.i18n.strings[this.values.i18n.locale]},getResource:function(a,b){return this.values.i18n.strings[this.values.i18n.locale][a]||b||""},loadResources:function(){var a=this,c=new e;return c.segment(["/"===this.values.path?"":this.values.path,"content","js","i18n",this.values.i18n.locale,"strings.js"]),c.addQuery({v:(new Date).getTime()}),new Promise(function(d,e){return a.values.i18n.loaded[a.values.i18n.locale]?(a.trigger("locale:load",a.values.i18n.locale),void d(a.values.i18n.strings[a.values.i18n.locale])):void b.ajax({url:c.toString(),contentType:"application/json; charset=utf-8",dataType:"json",context:a}).done(function(b){a.values.i18n.loaded[a.values.i18n.locale]=!0,a.values.i18n.strings[a.values.i18n.locale]=b,a.trigger("locale:load",a.values.i18n.locale),d(a.values.i18n.strings[a.values.i18n.locale])}).fail(function(a,b,d){console.log("Failed to load resources : "+c.toString()),e(d)})})},setResource:function(a,b,c){this.values.i18n.strings[a][b]=c}});return f.i18n=new i({path:a.config().path}),f});
//# sourceMappingURL=shared.min.js.map