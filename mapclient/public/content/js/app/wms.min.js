/* PublicaMundi Map Client version 1.0.0 2016-02-18 */

define(["module","jquery","ol","URIjs/URI","data_api","shared"],function(a,b,c,d,e,f){"use strict";var g={ui:{section:"group"},config:a.config(),ckan:null,resources:null,map:{config:null,control:null,google:null},interactions:{},tools:{},actions:{},preview:null,locale:null};g.config.path=g.config.path||"/",e.Data.configure({debug:g.config.debug,endpoint:g.config.path});var h=function(){g.config.geolocation=!0,g.config.map.minZoom=g.config.map.minZoom||7,g.config.map.maxZoom=g.config.map.maxZoom||19;var a=d.parse(window.location.href).query;if(a){var b=d.parseQuery(a);b.config&&(g.map.config=b.config),b.bbox?g.config.map.bbox=b.bbox.split(",").map(Number):g.config.map.bbox=null,b.center&&(g.config.map.center=b.center.split(",").map(Number)),b.zoom&&(g.config.map.zoom=b.zoom),"off"===b.geolocation&&(g.config.geolocation=!1),b.locale&&(g.locale=b.locale),!b.config&&b["package"]&&b.resource&&(g.preview={"package":b["package"],resource:b.resource})}},i=function(){return g.config.servers.osm.length>0?new c.layer.Tile({extent:[2137334.22323,4117771.96011,3332905.55435,5150499.54408],source:new c.source.XYZ({attributions:[c.source.OSM.ATTRIBUTION],urls:g.config.servers.osm}),opacity:b("#base-layer-opacity").val()/100}):g.config.servers.mapproxy.length>0?new c.layer.Tile({extent:[2137334.22323,4117771.96011,3332905.55435,5150499.54408],source:new c.source.TileWMS({attributions:[c.source.OSM.ATTRIBUTION],url:g.config.servers.mapproxy,params:{SERVICE:"WMS",VERSION:"1.1.1",LAYERS:g.config.layers.osm}}),opacity:b("#base-layer-opacity").val()/100}):new c.layer.Tile({extent:[2137334.22323,4117771.96011,3332905.55435,5150499.54408],source:new c.source.OSM({attributions:[c.source.OSM.ATTRIBUTION]}),opacity:b("#base-layer-opacity").val()/100})},j=function(){var a,b;if(g.config.servers.tilecache.length>0){var e=new c.tilegrid.TileGrid({origin:[1948226,4024868],extent:[1948226,4024868,4008846,5208724],tileSize:512,resolutions:[156543.0339,78271.51695,39135.758475,19567.8792375,9783.93961875,4891.969809375,2445.9849046875,1222.99245234375,611.496226171875,305.7481130859375,152.87405654296876,76.43702827148438,38.21851413574219,19.109257067871095,9.554628533935547,4.777314266967774,2.388657133483887,1.1943285667419434,.5971642833709717,.29858214168548586,.14929107084274293,.07464553542137146,.03732276771068573,.018661383855342866]});return a=new c.source.TileWMS({urls:g.config.servers.tilecache,params:{VERSION:"1.1.0",LAYERS:g.config.layers.ktimatologio,TRANSPARENT:!0},projection:"EPSG:900913",attributions:[new c.Attribution({html:'<a href="'+f.i18n.getResource("attribution.ktimatologio.url")+'" data-i18n-id="attribution.ktimatologio.url" data-i18n-type="attribute" data-i18n-name="href"><img src="content/images/app/ktimatologio-logo.png"/></a>'})],tileGrid:e}),b=a.tileUrlFunction,a.tileUrlFunction=function(a,c,e){var f=b(a,c,e),g=d.parse(f)||{},h=g.query?d.parseQuery(g.query):{};h.SRS="EPSG:900913";var i=d.build({protocol:g.protocol?g.protocol:"http",hostname:g.hostname,port:"80"===g.port?"":g.port,path:g.path,query:d.buildQuery(h)});return i},new c.layer.Tile({extent:[2137334.22323,4117771.96011,3332905.55435,5150499.54408],source:a})}if(g.config.servers.mapproxy.length>0)return new c.layer.Tile({extent:[2137334.22323,4117771.96011,3332905.55435,5150499.54408],source:new c.source.TileWMS({projection:"EPSG:900913",attributions:[new c.Attribution({html:'<a href="'+f.i18n.getResource("attribution.ktimatologio.url")+'" data-i18n-id="attribution.ktimatologio.url" data-i18n-type="attribute" data-i18n-name="href"><img src="content/images/app/ktimatologio-logo.png"/></a>'})],url:g.config.servers.mapproxy,params:{SERVICE:"WMS",VERSION:"1.1.0",LAYERS:"ktimatologio"}})});var h={SERVICE:"WMS",VERSION:"1.1.0",LAYERS:"KTBASEMAP"};return a=new c.source.TileWMS({url:"http://gis.ktimanet.gr/wms/wmsopen/wmsserver.aspx",params:h,projection:"EPSG:900913",attributions:[new c.Attribution({html:'<a href="'+f.i18n.getResource("attribution.ktimatologio.url")+'" data-i18n-id="attribution.ktimatologio.url" data-i18n-type="attribute" data-i18n-name="href"><img src="content/images/app/ktimatologio-logo.png"/></a>'})]}),b=a.tileUrlFunction,a.tileUrlFunction=function(a,c,e){var f=b(a,c,e),g=d.parse(f)||{},h=g.query?d.parseQuery(g.query):{};h.SRS="EPSG:900913";var i=d.build({protocol:g.protocol?g.protocol:"http",hostname:g.hostname,port:"80"===g.port?"":g.port,path:g.path,query:d.buildQuery(h)});return i},new c.layer.Tile({extent:[2137334.22323,4117771.96011,3332905.55435,5150499.54408],source:a})},k=function(){var a=function(a,c,d,e,f){var h=document.createElement("canvas"),i=h.getContext("2d"),j=e[0],k=e[1];h.setAttribute("width",j),h.setAttribute("height",k);var l=g.map.control,m=l.getView().calculateExtent(l.getSize()),n=l.getPixelFromCoordinate([m[0],m[3]]),o=l.getPixelFromCoordinate([a[0],a[3]]),p=[n[0]-o[0],n[1]-o[1]],q=b("#grid-tiles")[0],r=i.createPattern(q,"repeat");i.rect(o[0],o[1],j-o[0],k-o[1]),i.fillStyle=r,i.fill();var s=[2137334.22323,4117771.96011,3332905.55435,5150499.54408],t=l.getPixelFromCoordinate([s[0],s[3]]),u=l.getPixelFromCoordinate([s[2],s[1]]);return i.clearRect((t[0]+p[0])*d,(t[1]+p[1])*d,(u[0]-t[0])*d,(u[1]-t[1])*d),h};return new c.layer.Image({source:new c.source.ImageCanvas({canvasFunction:a,projection:"EPSG:3857"})})},l=function(){var a=g.map.control.getView(),b=c.proj.transform(a.getCenter(),"EPSG:3857","EPSG:4326");g.map.google.setCenter(new google.maps.LatLng(b[1],b[0]))},m=function(){var a=g.map.control.getView();g.map.google.setZoom(a.getZoom())},n=function(a){g.map.google||(g.map.google=new google.maps.Map(document.getElementById("gmap"),{mapTypeId:google.maps.MapTypeId.SATELLITE,disableDefaultUI:!0,keyboardShortcuts:!1,draggable:!1,disableDoubleClickZoom:!0,scrollwheel:!1,streetViewControl:!1}));var c=g.map.control.getView();c.on("change:center",l),c.on("change:resolution",m);var d=b("#"+g.config.map.target);d.remove(),c.setCenter(c.getCenter()),c.setZoom(c.getZoom()),g.map.google.controls[google.maps.ControlPosition.TOP_LEFT].push(d[0]),b("#"+g.config.google.target).show(),b(".ol-attribution").addClass("ol-attribution-google"),p(!0)},o=function(){var a=b("#"+g.config.map.target);b("#"+g.config.google.target).hide(),g.map.google.controls[google.maps.ControlPosition.TOP_LEFT].pop(),b("#"+g.config.google.target).parent().append(a);var c=g.map.control.getView();c.un("change:center",l),c.un("change:resolution",m),b(".ol-attribution").removeClass("ol-attribution-google"),p(!1)},p=function(a){var b=0,d=g.map.control.getInteractions();d.forEach(function(e){e instanceof c.interaction.DragPan&&(a?d.setAt(b,new c.interaction.DragPan({kinetic:new c.Kinetic(-1,10,200)})):d.setAt(b,new c.interaction.DragPan({kinetic:new c.Kinetic(-.005,.05,100)}))),b++},this)},q=function(a,b){var d=null,e=null;switch(e=g.map.control.get("base_layer_properties"),g.map.control.set("base_layer_properties",{type:a,set:b,exists:"google"!=a}),a){case"bing":g.config.bing.key&&(d=new c.layer.Tile({extent:[2137334.22323,4117771.96011,3332905.55435,5150499.54408],source:new c.source.BingMaps({key:g.config.bing.key,imagerySet:b})}));break;case"stamen":d=new c.layer.Tile({extent:[2137334.22323,4117771.96011,3332905.55435,5150499.54408],source:new c.source.Stamen({layer:b})});break;case"mapquest":d=new c.layer.Tile({extent:[2137334.22323,4117771.96011,3332905.55435,5150499.54408],source:new c.source.MapQuest({layer:b})});break;case"ktimatologio":d=j();break;case"google":n(b);break;default:console.log("Base layer of type "+a+" is not supported.")}return e&&"google"==e.type&&o(),d},r=function(){var a=g.config.map.minZoom,b=g.config.map.maxZoom,c=g.config.map.zoom||g.config.map.minZoom;return(a>c||c>b)&&(c=a),c},s=function(){var a=new c.View({projection:f.Maps.CRS.Mercator,center:g.config.map.center||[0,0],zoom:r(),minZoom:g.config.map.minZoom,maxZoom:g.config.map.maxZoom,extent:[-20037508.3392,-20048966.1,20037508.3392,20048966.1]}),d=c.interaction.defaults();d.removeAt(d.getLength()-1),g.interactions.zoom=new c.interaction.DragZoom({condition:c.events.condition.shiftKeyOnly,style:new c.style.Style({fill:new c.style.Fill({color:[255,255,255,.4]}),stroke:new c.style.Stroke({color:"#3399CC",width:2})})}),d.push(g.interactions.zoom);var e=[];e.push(new c.control.Zoom({zoomInTipLabel:"",zoomOutTipLabel:""})),e.push(new c.control.ZoomSlider),e.push(new c.control.Attribution({tipLabel:"",collapsible:!1})),g.map.control=new c.Map({target:g.config.map.target,view:a,controls:e,interactions:d,ol3Logo:!1});var h,j=b("#base_layer option:selected");if(h=q(b(j).data("type"),b(j).data("set")),g.map.control.addLayer(h),h=i(),g.map.control.addLayer(h),h=k(),g.map.control.getLayers().insertAt(0,h),g.config.map.bbox){var l=g.map.control.getSize();a.fitExtent(g.config.map.bbox,l)}!g.map.config&&!g.preview&&navigator.geolocation&&g.config.geolocation&&navigator.geolocation.getCurrentPosition(function(b){var d=c.proj.transform([b.coords.longitude,b.coords.latitude],f.Maps.CRS.WGS84,f.Maps.CRS.Mercator);a.setCenter(d),a.setZoom(10)});var m=new c.control.MousePosition({coordinateFormat:function(a){return c.coordinate.format(a,"{x} , {y}",4)},projection:b("#pos_epsg option:selected").val(),className:"mouse-pos-text",target:b(".mouse-pos")[0]});g.map.control.addControl(m);var n=new c.control.ScaleLine({target:document.getElementById("scale-line")});g.map.control.addControl(n),b("#pos_epsg").selectpicker().change(function(){var a=c.proj.get(b("#pos_epsg option:selected").val());m.setProjection(a),g.actions.position.setProjection(a),b('[data-id="pos_epsg"]').blur()})},t=function(){b(".dialog-container").height(b(window).height()-50).width(b(window).width()-20);var a=b(window).width(),c=b(window).height(),d=b(".header").outerHeight(!0),e=b("#layer-tree-header").outerHeight(!0)+b("#layer-selection-header").outerHeight(!0),f=b("#layer-selection").outerHeight(!0),h=b(".footer").outerHeight(!0)+60;b("#layer-tree-group-result-container").height(c-e-f-h-b("#tree-filter").outerHeight(!0)),b("#layer-tree-organization-result-container").height(c-e-f-h-b("#tree-filter").outerHeight(!0)),b("#layer-tree-search-result").height(c-e-f-h-105),b("#layer-tree-search-result-container").height(c-e-f-h-105),b("#map").offset({top:d,left:0}).height(c-h+10),b(".resource-data-search").width(a-930+(b("#base-layer-label").is(":visible")?0:310)),b("#panel-left-splitter").is(":visible")&&b("#panel-left-splitter").css("left",b("#panel-left").width()),g.map.control.setSize([b("#map").width(),b("#map").height()])},u=function(a){if(b(".panel-left").hasClass("panel-left-hidden"))switch(a){case"group":b(".panel-left-label").css({bottom:f.i18n.getResource("index.topics.position")[1],right:f.i18n.getResource("index.topics.position")[0]}),b(".panel-left-label-image").attr("src","content/images/app/topics.svg"),b(".panel-left-label-text").html(f.i18n.getResource("index.topics")).css("padding","4px 0 0 7px");break;case"organization":b(".panel-left-label").css({bottom:f.i18n.getResource("index.organizations.position")[1],right:f.i18n.getResource("index.organizations.position")[0]}),b(".panel-left-label-image").attr("src","content/images/app/organization.svg"),b(".panel-left-label-text").html(f.i18n.getResource("index.organizations")).css("padding","4px 0 0 7px");break;case"search":b(".panel-left-label").css({bottom:f.i18n.getResource("index.search.position")[1],right:f.i18n.getResource("index.search.position")[0]}),b(".panel-left-label-image").attr("src","content/images/app/search.svg"),b(".panel-left-label-text").html(f.i18n.getResource("index.search")).css("padding","0px 0 0 7px")}},v=function(){g.ckan=new f.Maps.CKAN.Metadata({path:g.config.path,endpoint:g.config.ckan.endpoint,metadata:{database:g.config.ckan.metadata.database,path:g.config.ckan.metadata.path,version:g.config.ckan.metadata.version}}),g.resources=new f.Maps.ResourceManager({path:g.config.path,proxy:f.getProxyUrl(g.config.proxy),extent:g.config.map.extent,maxLayerCount:5}),g.components={},g.components.textSearch=new f.Maps.TextSearch({element:"location-search",map:g.map.control,endpoint:g.config.path,resources:g.resources}),g.components.layerTreeGroup=new f.Maps.LayerTree({element:"layer-tree-group",map:g.map.control,ckan:g.ckan,resources:g.resources,mode:f.Maps.LayerTreeViewMode.ByGroup,visible:!0}),g.components.layerTreeOrganization=new f.Maps.LayerTree({element:"layer-tree-organization",map:g.map.control,ckan:g.ckan,resources:g.resources,mode:f.Maps.LayerTreeViewMode.ByOrganization,visible:!1}),g.components.layerTreeSearch=new f.Maps.LayerTree({element:"layer-tree-search",map:g.map.control,ckan:g.ckan,resources:g.resources,mode:f.Maps.LayerTreeViewMode.ByFilter,visible:!1}),g.components.layerSelection=new f.Maps.LayerSelection({element:"layer-selection",map:g.map.control,ckan:g.ckan,resources:g.resources}),g.components.catalogInfoDialog=new f.Maps.Dialog({title:"",element:"dialog-1",visible:!1,width:400,height:200,buttons:{close:{text:"button.close",style:"primary"}}}),g.components.catalogInfoDialog.on("dialog:action",function(a){switch(a.action){case"close":this.hide()}}),g.components.tableBrowserDialog=new f.Maps.DialogTableBrowser({title:"Table Data",element:"dialog-2",visible:!1,width:800,height:400,buttons:{close:{text:"button.close",style:"primary"}}}),g.components.tableBrowserDialog.on("dialog:action",function(a){switch(a.action){case"close":this.hide()}}),g.components.layerGroupLegendDialog=new f.Maps.Dialog({title:"",element:"dialog-3",visible:!1,width:400,height:400,buttons:{close:{text:"button.close",style:"primary"}}}),g.components.layerGroupLegendDialog.on("dialog:action",function(a){switch(a.action){case"close":this.hide()}}),g.actions.restoreZoomLevel=new f.Maps.Action({element:"restore-zoom",name:"restore-zoom",image:"content/images/app/restore-zoom-w.svg",title:"index.resotre-zoom",visible:!0}),g.actions.restoreZoomLevel.on("action:execute",function(a){g.map.control.getView().setZoom(r())}),g.config.feedback&&b(".feedback-label").click(function(){window.open(g.config.feedback[f.i18n.getLocale()])}),g.actions["export"]=new f.Maps.Action({element:"action-export",name:"export",image:"content/images/app/download-w.svg",title:"action.export.title",visible:!1}),g.actions["import"]=new f.Maps.ImportWmsTool({element:"action-wms",name:"wms",image:"content/images/app/add-layer-w.svg",title:"action.import-wms.title",map:g.map.control,resources:g.resources}),g.actions["import"].on("layer:added",function(a){g.resources.createLayer(g.map.control,a.metadata,a.id)&&g.components.layerSelection.add(a.id,a.metadata)}),g.actions.upload=new f.Maps.UploadFileTool({element:"action-upload",name:"upload",image:"content/images/app/upload-w.svg",title:"action.upload-resource.title",map:g.map.control,resources:g.resources,endpoint:g.config.path}),g.actions.link=new f.Maps.PermalinkTool({element:"action-link",name:"link",image:"content/images/app/permalink-w.svg",title:"action.create-link.title",map:g.map.control,resources:g.resources,ckan:g.ckan,endpoint:g.config.path,mode:f.Maps.PermalinkTool.Mode.Link}),g.actions.embed=new f.Maps.PermalinkTool({element:"action-embed",name:"embed",image:"content/images/app/embed-map-w.svg",title:"action.create-link-embed.title",map:g.map.control,resources:g.resources,ckan:g.ckan,endpoint:g.config.path,mode:f.Maps.PermalinkTool.Mode.Embed}),g.actions.parse=new f.Maps.CoordinateParser({element:"action-parse",name:"parse",image:"content/images/app/coordinates-w.svg",title:"action.parse-coordinates.title",map:g.map.control,resources:g.resources}),g.actions.upload.on("resource:loaded",function(a){g.resources.getResourceMetadata(a.format.toUpperCase(),{url:a.url,text:a.text,filename:a.name,title:a.title,projection:a.projection}).then(function(b){g.resources.createLayer(g.map.control,b,a.id,a.title)&&g.components.layerSelection.add(a.id,b)})}),g.actions.position=new f.Maps.PositionTool({element:"action-position",name:"position",image:"content/images/app/map-location-w.svg",title:"action.set-position.title",map:g.map.control,projection:c.proj.get(b("#pos_epsg option:selected").val())}),g.actions.clear=new f.Maps.Action({element:"action-clear",name:"clear",image:"content/images/app/clear-w.svg",title:"action.clear.title",visible:!0,enabled:!0,"class":"btn-danger"}),g.actions.clear.on("action:execute",function(a){var b;for(b in g.tools)g.tools[b].clear();for(b in g.actions)g.actions[b].clear();for(b in g.components)g.components[b].clear()}),g.tools.length=new f.Maps.MeasureTool({element:"tool-length",name:"length",images:{enabled:"content/images/app/distance-w.svg",disabled:"content/images/app/distance.svg"},title:"tool.length.title",map:g.map.control,type:f.Maps.MeasureToolType.Length}),g.tools.area=new f.Maps.MeasureTool({element:"tool-area",name:"area",images:{enabled:"content/images/app/area-w.svg",disabled:"content/images/app/area.svg"},title:"tool.area.title",map:g.map.control,type:f.Maps.MeasureToolType.Area}),g.tools["export"]=new f.Maps.ExportTool({element:"tool-export",name:"export",images:{enabled:"content/images/app/draw-polygon-w.svg",disabled:"content/images/app/draw-polygon.svg"},title:"tool.export.title",map:g.map.control,resources:g.resources,action:g.actions["export"],disabledFormats:g.config["export"].disabledFormats,endpoint:g.config.path}),g.tools.select=new f.Maps.SelectTool({name:"select",active:!0,map:g.map.control,resources:g.resources}),g.tools.select.setActive(!0);var a=function(a){b(".tools-container").height("auto");var c=a.name;if(a.active){a.sender.hasActions()?b("#tool-actions-header").show():b("#tool-actions-header").hide(),c=a.sender.getName();for(var d in g.tools)c!=g.tools[d].getName()&&g.tools[d].setActive(!1)}else b("#tool-actions-header").hide(),g.tools.select.setActive(!0);t()};g.tools.length.on("tool:toggle",a),g.tools.area.on("tool:toggle",a),g.tools["export"].on("tool:toggle",a),g.resources.on("layer:created",function(a){g.components.layerSelection.add(a.id);var b=a.id.split("_"),c=b[0];g.components.layerTreeGroup.expand(c),g.components.layerTreeOrganization.expand(c)}),b("body").on("click",".panel-left-hidden",function(a){b(".panel-left-handler").trigger("click")}),b(".panel-left-handler").click(function(a){a.preventDefault(),a.stopPropagation(),b(".panel-left").hasClass("panel-left-hidden")?(b(".panel-left-label").hide(),b(".panel-left").removeClass("panel-left-hidden"),b(".panel-left-handler").removeClass("panel-left-handler-toggle"),b(".panel-left").find(".panel-content").removeClass("panel-content-hidden"),b(".panel-left-splitter").show(),b(".panel-left").width(b(".panel-left-splitter").position().left)):(b(".panel-left-splitter").hide(),b(".panel-left-label").show(),b(".panel-left").addClass("panel-left-hidden"),b(".panel-left-handler").addClass("panel-left-handler-toggle"),b(".panel-left").find(".panel-content").addClass("panel-content-hidden"),b(".panel-left").width(30),u(g.ui.section))}),b(".tools-container").draggable({handle:".tools-header",containment:"parent"}),b(".tools-header-handler").click(function(){b(".tools-container-placholder").fadeIn(400),b(".tools-container").effect("transfer",{to:b(".tools-container-placholder")},400,function(){b(".tools-container").fadeOut(200)})}),b(".tools-container-placholder").click(function(){b(".tools-container").fadeIn(400),b(".tools-container-placholder").effect("transfer",{to:b(".tools-container")},400,function(){b(".tools-container-placholder").fadeOut(200)})}),b("#organization, #group, #search").click(function(){if(!b(this).data("selected")){var a=b(this).attr("id");b(this).data("selected",!0).removeClass("active").addClass("inactive"),b("#"+g.ui.section).data("selected",!1).removeClass("inactive").addClass("active"),b("#"+g.ui.section+"-label").addClass("section-label-hidden"),b("#"+a+"-label").removeClass("section-label-hidden"),g.ui.section=a,"organization"===a?(b("#tree-filter").show(),g.components.layerTreeGroup.hide(),g.components.layerTreeSearch.hide(),g.components.layerTreeOrganization.show()):"group"===a&&(b("#tree-filter").show(),g.components.layerTreeOrganization.hide(),g.components.layerTreeSearch.hide(),g.components.layerTreeGroup.show()),"search"===a&&(b("#tree-filter").hide(),g.components.layerTreeGroup.hide(),g.components.layerTreeOrganization.hide(),g.components.layerTreeSearch.show()),t()}});var d=function(a){a.sender!=g.components.layerTreeGroup&&g.components.layerTreeGroup.remove(a.id,!1),a.sender!=g.components.layerTreeOrganization&&g.components.layerTreeOrganization.remove(a.id,!1),a.sender!=g.components.layerTreeSearch&&g.components.layerTreeSearch.remove(a.id,!1),g.components.layerSelection.remove(a.id),t()},e=function(a){a.data&&(g.components.catalogInfoDialog.setTitle(a.data.title[f.i18n.getLocale()]),g.components.catalogInfoDialog.setContent(a.data.description[f.i18n.getLocale()]),g.components.catalogInfoDialog.show())},h=function(a){a.title&&(g.components.catalogInfoDialog.setTitle(a.title[f.i18n.getLocale()]),g.components.catalogInfoDialog.setContent('<div style="width: 100%; text-align: center;"><img style="text-align: center;" src="content/images/app/ajax-loader-big.gif"></div>'),g.components.catalogInfoDialog.show())},i=function(a){if(a.title){g.components.layerGroupLegendDialog.setTitle(f.i18n.getResource("index.layer-group.legend.title")+" "+a.title);var b=[];b.push('<div class="layergroup-legend-container">'),b.push("<table>");for(var c=0;c<a.legend.length;c++)c%2===0&&b.push("<tr>"),b.push("<td>"),b.push("<img src='"+a.legend[c].legend+"'/>"),b.push("</td>"),b.push("<td>"),b.push(a.legend[c].title),b.push("</td>"),c%2===1?b.push("</tr>"):c===a.legend.length-1&&b.push("</td></tr>");b.push("</table>"),b.push("</div>"),g.components.layerGroupLegendDialog.setContent(b.join("")),g.components.layerGroupLegendDialog.show()}},j=function(a){a.sender!=g.components.layerTreeGroup&&g.components.layerTreeGroup.add(a.id,!1),a.sender!=g.components.layerTreeOrganization&&g.components.layerTreeOrganization.add(a.id,!1),a.sender!=g.components.layerTreeSearch&&g.components.layerTreeSearch.add(a.id,!1)};g.components.layerTreeGroup.on("layer:added",j),g.components.layerTreeGroup.on("layer:removed",d),g.components.layerTreeGroup.on("catalog:info-loading",h),g.components.layerTreeGroup.on("catalog:info-loaded",e),g.components.layerTreeOrganization.on("layer:added",j),g.components.layerTreeOrganization.on("layer:removed",d),g.components.layerTreeOrganization.on("catalog:info-loading",h),g.components.layerTreeOrganization.on("catalog:info-loaded",e),g.components.layerTreeSearch.on("layer:added",j),g.components.layerTreeSearch.on("layer:removed",d),g.components.layerTreeSearch.on("catalog:info-loading",h),g.components.layerTreeSearch.on("catalog:info-loaded",e),g.components.layerSelection.on("layer-group:legend-loaded",i),g.components.layerTreeSearch.on("bbox:draw",function(a){A(),C()}),g.components.layerTreeSearch.on("bbox:apply",function(a){C("zoom"),B("select")}),g.components.layerTreeSearch.on("bbox:cancel",function(a){C("zoom"),B("select")});var k=function(a){t()},l=function(a){g.components.layerTreeGroup.remove(a.id),g.components.layerTreeOrganization.remove(a.id),g.components.layerTreeSearch.remove(a.id),t()};g.components.layerSelection.on("layer:added",k),g.components.layerSelection.on("layer:removed",l),b("#locale_selection").val(f.i18n.getLocale()),b("#locale_selection").selectpicker().change(function(){f.i18n.setLocale(b("#locale_selection option:selected").val()),b('[data-id="locale_selection"]').blur();var a=b("#tree-filter-text").val();g.components.layerTreeGroup.setFilter(a),g.components.layerTreeOrganization.setFilter(a),b(".selectpicker, .img-text").tooltip(),b(".selectpicker").tooltip("disable")}),b("#tree-filter-text").keyup(function(){var a=b(this).val();g.components.layerTreeGroup.setFilter(a),g.components.layerTreeOrganization.setFilter(a)}),b("#tree-filter-remove").click(function(){b("#tree-filter-text").val(""),g.components.layerTreeGroup.setFilter(null),g.components.layerTreeOrganization.setFilter(null),b(this).blur()}),b("#panel-left-splitter").draggable({axis:"x",opacity:.5,handle:".panel-left-splitter-handler",start:function(a,c){b(this).addClass("panel-left-splitter-dragging")},stop:function(a,c){b("#panel-left").width(c.position.left),b(this).removeClass("panel-left-splitter-dragging")},drag:function(a,b){b.position.left=Math.max(280,b.position.left),b.position.left=Math.min(550,b.position.left)}}),b(".panel-left-splitter-handler").dblclick(function(a){}),b(".selectpicker, .img-text").tooltip(),b(".selectpicker").tooltip("disable"),b(window).resize(t)},w=function(){},x=function(){z()},y=function(a,c,d){d=0===d?d:d||100;var e=g.map.control.get("base_layer_properties"),f=e.exists?g.map.control.getLayers().item(1):null,h=g.map.control.getLayers().item(e.exists?2:1);h.setOpacity(d/100);var i=q(a,c);i&&g.map.control.getLayers().insertAt(e.exists?2:1,i),f&&setTimeout(function(){g.map.control.getLayers().remove(f)},500),b("#base-layer-opacity").val(d),b("#base_layer").val(a+"-"+c).selectpicker("refresh"),b(".selectpicker").tooltip().tooltip("disable")},z=function(){b("#base_layer").selectpicker().change(function(a){var c=b("#base_layer option:selected"),d=b("#base-layer-opacity").val();y(b(c).data("type"),b(c).data("set"),d),b('[data-id="base_layer"]').blur()}),b("#base-layer-opacity").change(function(){var a=g.map.control.get("base_layer_properties");g.map.control.getLayers().item(a.exists?2:1).setOpacity(b(this).val()/100)})},A=function(){for(var a in g.tools)g.tools[a]&&g.tools[a].setEnabled(!1)},B=function(a){for(var b in g.tools)g.tools[b]&&g.tools[b].setEnabled(!0);a&&g.tools.hasOwnProperty(a)&&g.tools[a].setActive(!0)},C=function(a){for(var b in g.interactions)g.interactions[b].setActive(!1);a&&D(a)},D=function(a){a&&g.interactions.hasOwnProperty(a)&&g.interactions[a].setActive(!0)},E=function(){return new Promise(function(a,c){var e=new d;"/"===g.config.path?e.segment(["config","load",g.map.config]):e.segment([g.config.path,"config","load",g.map.config]),b.ajax({url:e.toString().replace(/\/\//g,"/").replace(/:\//g,"://"),context:this,dataType:"json"}).done(function(b){if(b.success){var c=b.config;y(c.base.type,c.base.set,c.base.opacity);var d=0,e=function(){if(d<c.layers.length){var a=c.layers[d];d++,g.ckan.loadPackageById(a["package"]).then(function(b){var c=g.ckan.getResourceById(a.resource);c&&(c=g.resources.setCatalogResourceMetadataOptions(c),g.resources.addResourceFromCatalog(g.map.control,c,a.opacity,a.key).then(e))},function(b){console.log("Failed to load resource "+a.resource+" from package "+a["package"])})}else g.map.control.getView().setCenter(c.center),g.map.control.getView().setZoom(c.zoom)};e()}a(b)}).fail(function(a,b,d){console.log("Failed to save configuration : "+JSON.stringify(config)),c(d)})})},F=function(){g.preview&&g.ckan.loadPackageById(g.preview["package"]).then(function(a){var b=g.ckan.getResourceById(g.preview.resource);b&&g.resources.addResourceFromCatalog(g.map.control,b)},function(a){console.log("Failed to load resource "+g.preview.resource+" from package "+g.preview["package"])})},G=function(){var a=f.i18n.getLocale();b("[data-i18n-id]").each(function(a,c){var d=b(this).data("i18n-type");switch(d){case"title":b(this).attr("title",f.i18n.getResource(b(this).data("i18n-id")));break;case"attribute":b(this).attr(b(this).data("i18n-name"),f.i18n.getResource(b(this).data("i18n-id")));break;default:var e=f.i18n.getResource(b(this).data("i18n-id"));e&&b(this).html(e)}});for(var c in g.components)g.components[c].localizeUI(a);b("#base_layer").selectpicker("refresh"),b(".selectpicker").tooltip().tooltip("disable"),u(g.ui.section)},H=function(){var a=f.i18n.getLocale();if(g.ckan){for(var b=g.ckan.getOrganizations(),c=0;c<b.length;c++)f.i18n.setResource(a,"organization."+b[c].id,b[c].caption[a]);for(var d=g.ckan.getGroups(),e=0;e<d.length;e++)f.i18n.setResource(a,"group."+d[e].id,d[e].caption[a]);for(var h=g.ckan.getPackages(),i=0;i<h.length;i++)for(var j=0;j<h[i].resources.length;j++)f.i18n.setResource(a,"node.resource."+h[i].resources[j].id,h[i].resources[j].name[a]);var k=g.ckan.getNodes();for(var l in k)f.i18n.setResource(a,"node."+k[l].id,k[l].caption[a])}};return f.initialize=function(){h(),f.i18n.setLocale(g.locale||"el").then(function(a){f.i18n.on("locale:load",function(){H()}),f.i18n.on("locale:change",function(){G(),t()}),H(),s(),v(),w(),x(),b("#loading-text").html("Initializing Catalog ... 0%");var c=function(){g.components.layerTreeGroup.refresh(),g.components.layerTreeOrganization.refresh(),setTimeout(function(){b("#block-ui").fadeOut(500).hide(),b("body").css("overflow-y","auto"),b("#view-layers").hasClass("ui-panel-closed")&&b("#view-layers").panel("toggle"),b("#search").focus(),g.map.config?E():F()},500),t()},d=function(){G();var a=b("#tree-filter-text").val();if(g.components.layerTreeGroup.setFilter(a),g.components.layerTreeOrganization.setFilter(a),g.ckan.isPreloadingEnabled()){for(var d=[],e=g.ckan.getPackages(),f=0;f<e.length;f++)for(var h=0;h<e[f].resources.length;h++){var i=e[f].resources[h];i.queryable&&d.push({wms:i.id,table:i.queryable.resource,geometry_type:i.queryable.geometry,srid:i.queryable.srid,template:i.queryable.template})}g.resources.setQueryableResources(d),c()}else b("#loading-text").html("Loading Metadata ... 0%"),g.resources.updateQueryableResources().then(function(a){b("#loading-text").html("Loading Metadata ... 100%"),c()})};g.ckan.isPreloadingEnabled()?g.ckan.preload().then(d):g.ckan.loadGroups().then(function(a){b("#loading-text").html("Initializing Catalog ... 50%"),g.ckan.loadOrganizations().then(function(a){b("#loading-text").html("Initializing Catalog ... 100%"),d()})})})},window.PublicaMundi=f,f});
//# sourceMappingURL=wms.min.js.map