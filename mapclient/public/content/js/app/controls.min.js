/* PublicaMundi Map Client version 1.0.0 2015-11-27 */

define(["module","jquery","ol","URIjs/URI","data_api","shared"],function(a,b,c,d,e,f){"use strict";var g=function(a,b){return b?function(c,d){return c[a][b]<d[a][b]?-1:c[a][b]>d[a][b]?1:0}:function(b,c){return b[a]<c[a]?-1:b[a]>c[a]?1:0}};f.Maps.Component=f.Class(f.Maps.Observable,{initialize:function(a){this.values.element=null,this.values.visible=!0,"function"==typeof f.Maps.Observable.prototype.initialize&&f.Maps.Observable.prototype.initialize.apply(this,arguments),this.event("render"),this.event("hide"),this.event("show"),this.values.visible?this.show():this.hide()},render:function(){this.trigger("render")},refresh:function(){this.render()},show:function(){b("#"+this.values.element).show(),this.trigger("show")},hide:function(){b("#"+this.values.element).hide(),this.trigger("hide")},localizeUI:function(a){},clear:function(){}}),f.Maps.LayerTreeViewMode={ByGroup:1,ByOrganization:2,ByFilter:3},f.Maps.LayerTree=f.Class(f.Maps.Component,{initialize:function(a){var d=this;f.extend(this.values,{map:null,ckan:null,resources:null,mode:f.Maps.LayerTreeViewMode.ByGroup}),"function"==typeof f.Maps.Component.prototype.initialize&&f.Maps.Component.prototype.initialize.apply(this,arguments);var e=this.values.ckan.isPreloadingEnabled();this.values.contentElement=this.values.element+"-result",this.values.filter={term:null},this.values.bbox={overlay:null,interaction:null,feature:null},this.values.mode===f.Maps.LayerTreeViewMode.ByFilter&&(this.values.bbox.overlay=new c.FeatureOverlay({style:[new c.style.Style({fill:new c.style.Fill({color:[255,255,255,.4]}),stroke:new c.style.Stroke({color:"#27AE60",width:2})})]}),this.values.bbox.overlay.setMap(this.values.map),this.values.bbox.interaction=new c.interaction.DragBox({style:new c.style.Style({fill:new c.style.Fill({color:[255,255,255,.4]}),stroke:new c.style.Stroke({color:"#27AE60",width:2})})}),this.values.bbox.interaction.on("boxstart",function(a){d.values.bbox.overlay.getFeatures().clear()}),this.values.bbox.interaction.on("boxend",function(a){var b=d.values.bbox.interaction.getGeometry(),e=new c.Feature({name:d.values.element+"-bbox",geometry:b});d.values.bbox.overlay.getFeatures().clear(),d.values.bbox.overlay.addFeature(e)}),this.values.map.addInteraction(this.values.bbox.interaction),this.values.bbox.interaction.setActive(!1)),this.event("layer:added"),this.event("layer:removed"),this.event("bbox:draw"),this.event("bbox:remove"),this.event("bbox:apply"),this.event("bbox:cancel"),this.event("catalog:search"),this.event("catalog:info-loading"),this.event("catalog:info-loaded"),this.values.rootTreeNode={id:null,children:[]},this.values.getTreeNodeById=function(a,b){if(!a)return null;b=b||d.values.rootTreeNode;for(var c=null,e=0;e<b.children.length;e++){if(b.children[e].id==a)return b.children[e];if(c=d.values.getTreeNodeById(a,b.children[e]))return c}return null},this.values.createTreeNodeElement=function(a,c,d){var e=[];c.isLeaf?e.push('<li id="node-'+this.values.element+"-"+c.id+'" class="tree-node tree-node-checkbox">'):e.push('<li id="node-'+this.values.element+"-"+c.id+'" class="tree-node">'),e.push('<div class="clearfix node-container">'),c.isLeaf?e.push('<div class="node-left"><img src="'+c.image+'" class="node-select img-30"/></div>'):e.push('<div class="node-left"><img src="'+c.image+'" class="tree-toggle img-25"/></div>'),c.hasInformation&&e.push('<div class="node-right tree-info"><img src="content/images/app/info.svg" class="img-16" /></div>'),c.i18n?e.push('<div class="tree-text" data-i18n-id="'+c.i18n+'">'+c.caption+"</div>"):e.push('<div class="tree-text">'+c.caption+"</div>"),e.push("</div></li>");var f=b(e.join(""));return f.data(d),a.children.push({id:c.id,element:f,children:[],caption:c.caption}),f},this.values.renderTreeNodeElements=function(a){var c,d,e,h,i,j=this.values.getTreeNodeById(a)||this.values.rootTreeNode,k=j.element||b("#"+this.values.contentElement),l=this.values.ckan.getNodeById(a);if(l){var m=b('<ul class="tree-node" style="display: none;"></ul>');b(k).append(m),k=m}else b(k).html("");var n=this.values.ckan.getNodeChidlren(a);for(n.sort(g("index")),c=0;c<n.length;c++)this.values.ckan.isNodeEmpty(n[c].id)||(d=f.i18n.getResource("node."+n[c].id,n[c].caption[f.i18n.getLocale()]),e={id:n[c].id,expanded:!1,loaded:!1,type:"node",parent:n[c].parent,caption:d,i18n:"node."+n[c].id},h={id:n[c].id,image:"content/images/app/show.svg",isLeaf:!1,caption:d,hasInformation:!1,i18n:"node."+n[c].id},i=this.values.createTreeNodeElement.call(this,j,h,e),b(k).append(i));if(l&&l.resources.length>0){var o=[];for(c=0;c<l.resources.length;c++)o.push(this.values.ckan.getResourceById(l.resources[c]));for(o.sort(g("node_index")),c=0;c<o.length;c++){var p=o[c],q=this.values.ckan.getPackageById(p["package"]);if(this.values.resources.setCatalogResourceMetadataOptions(p),p.metadata.extras.layer){var r=p.id+"_"+p.metadata.extras.layer,s=this.values.resources.isLayerSelected(r);d=p.name[f.i18n.getLocale()],e={id:r.replace(/[^\w\s]/gi,""),expanded:!1,loaded:!1,type:"layer",layer:r,selected:s,info:{type:"package",id:q.id},caption:d,i18n:"node.resource."+p.id},h={id:r.replace(/[^\w\s]/gi,""),image:s?"content/images/app/checkbox-checked.svg":"content/images/app/checkbox-empty.svg",isLeaf:!0,caption:d,hasInformation:1===q.resources.length,i18n:"node.resource."+p.id}}else d=p.name[f.i18n.getLocale()],e={id:p.id,expanded:!1,loaded:!1,type:"resource",info:{type:"package",id:q.id},caption:d,i18n:"node.resource."+p.id},h={id:p.id,image:"content/images/app/show.svg",isLeaf:!1,caption:d,hasInformation:1===q.resources.length,i18n:"node.resource."+p.id};i=this.values.createTreeNodeElement.call(this,j,h,e),b(k).append(i)}}},this.values.renderGroups=function(){var a;b("#"+this.values.contentElement).html("");var c=this.values.ckan.getGroups(),d=[];if(this.values.mode===f.Maps.LayerTreeViewMode.ByFilter){var h=this.values.ckan.getFilteredPackages();for(a=0;a<c.length;a++)for(var i=0;i<h.length;i++)if(-1!==b.inArray(c[a].id,h[i].groups)){d.push(c[a]);break}}else d=c;for(d.sort(g("caption",f.i18n.getLocale())),this.values.mode===f.Maps.LayerTreeViewMode.ByFilter&&0===d.length?b("#"+this.values.element+"-result").hide():b("#"+this.values.element+"-result").show(),a=0;a<d.length;a++)if(!e||!this.values.ckan.isGroupEmpty(d[a].id)){var j=f.i18n.getResource("group."+d[a].id,d[a].caption[f.i18n.getLocale()]),k={id:d[a].id,expanded:!1,loaded:!1,type:"group",info:{type:"group",id:d[a].id},caption:j,i18n:"group."+d[a].id},l={id:d[a].id,image:"content/images/app/show.svg",isLeaf:!1,caption:j,hasInformation:d[a].info||d[a].description&&d[a].caption[f.i18n.getLocale()]!=d[a].description[f.i18n.getLocale()],i18n:"group."+d[a].id},m=this.values.createTreeNodeElement.call(this,this.values.rootTreeNode,l,k);b("#"+this.values.contentElement).append(m)}},this.values.renderOrganizations=function(){b("#"+this.values.contentElement).html("");var a,c,d=this.values.ckan.getOrganizations(),h=[];if(this.values.mode===f.Maps.LayerTreeViewMode.ByFilter){var i=this.values.ckan.getFilteredPackages();for(a=0;a<d.length;a++)for(c=0;c<i.length;c++)if(d[a].id===i[c].organization){h.push(d[a]);break}}else h=d;for(h.sort(g("caption",f.i18n.getLocale())),a=0;a<h.length;a++)if(!e||!this.values.ckan.isOrganizationEmpty(h[a].id)){var j=f.i18n.getResource("organization."+h[a].id,h[a].caption[f.i18n.getLocale()]),k={id:h[a].id,expanded:!1,loaded:!1,type:"organization",info:{type:"organization",id:h[a].id},caption:j,i18n:"organization."+h[a].id},l={id:h[a].id,image:"content/images/app/show.svg",isLeaf:!1,caption:j,hasInformation:h[a].info||h[a].description&&h[a].caption[f.i18n.getLocale()]!=h[a].description[f.i18n.getLocale()],i18n:"organization."+h[a].id},m=this.values.createTreeNodeElement.call(this,this.values.rootTreeNode,l,k);b("#"+this.values.contentElement).append(m)}};var h=function(a,c){var d=this.values.getTreeNodeById(c),e=b("#node-"+this.values.element+"-"+c),h=this.values.ckan.getOrganizations(),i=[],j=[],k=[];k=this.values.mode===f.Maps.LayerTreeViewMode.ByFilter?this.values.ckan.getFilteredPackages():this.values.ckan.getPackages();for(var l=0;l<k.length;l++)if(-1!==b.inArray(c,k[l].groups)&&(j.push(k[l]),k[l].organization)){var m=this.values.ckan.getIndexOfOrganization(k[l].organization),n=!1;if(-1!==m){for(var o=0;o<i.length;o++)if(i[o].id===k[l].organization){n=!0;break}n||i.push(h[m])}}if(i.sort(g("caption",f.i18n.getLocale())),0===j.length){var p=b(e).find("img.tree-toggle").first();b(p).addClass("disabled"),b(p).attr("src","content/images/app/empty.svg"),b(e).find(".tree-text").first().addClass("tree-text-disabled")}else{var q=b('<ul class="tree-node" style="display: none;"></ul>');b(e).append(q);for(var r=0;r<i.length;r++){var s=f.i18n.getResource("organization."+i[r].id,i[r].caption[f.i18n.getLocale()]),t={id:i[r].id,expanded:!1,loaded:!1,type:"organization",info:{type:"organization",id:i[r].id},caption:s,i18n:"organization."+i[r].id},u={id:i[r].id,image:"content/images/app/show.svg",isLeaf:!1,caption:s,hasInformation:i[r].info||i[r].description&&i[r].caption[f.i18n.getLocale()]!=i[r].description[f.i18n.getLocale()],i18n:"organization."+i[r].id},v=this.values.createTreeNodeElement.call(this,d,u,t);b(q).append(v)}}},i=function(a,c){var e,h,i,j,k,l,m,n=b("#node-"+this.values.element+"-"+c),o=this.values.getTreeNodeById(c),p=[],q=[];p=this.values.mode===f.Maps.LayerTreeViewMode.ByFilter?this.values.ckan.getFilteredPackages():this.values.ckan.getPackages();for(var r=0;r<p.length;r++)p[r].organization===c&&q.push(p[r]);if(q.sort(g("title",f.i18n.getLocale())),0===q.length){var s=b(n).find("img.tree-toggle").first();b(s).addClass("disabled"),b(s).attr("src","content/images/app/empty.svg"),b(n).find(".tree-text").first().addClass("tree-text-disabled")}else{var t=b('<ul class="tree-node" style="display: none;"></ul>');for(b(n).append(t),e=0;e<q.length;e++)if(q[e].resources.length>0){for(h=0;h<q[e].resources.length;h++)this.values.resources.setCatalogResourceMetadataOptions(q[e].resources[h]);if(1===q[e].resources.length&&q[e].resources[0].metadata&&q[e].resources[0].metadata.extras.layer){i=q[e].resources[0].id;var u=i+"_"+q[e].resources[0].metadata.extras.layer,v=this.values.resources.isLayerSelected(u);j=q[e].resources[0].name[f.i18n.getLocale()],k={id:u.replace(/[^\w\s]/gi,""),expanded:!1,loaded:!1,type:"layer",layer:u,selected:v,info:{type:"package",id:q[e].id},caption:j,i18n:"node.resource."+i},l={id:u.replace(/[^\w\s]/gi,""),image:v?"content/images/app/checkbox-checked.svg":"content/images/app/checkbox-empty.svg",isLeaf:!0,caption:j,hasInformation:q[e].info||!!q[e].notes,i18n:"node.resource."+i},m=this.values.createTreeNodeElement.call(this,o,l,k),b(t).append(m)}else 1===q[e].resources.length?(i=q[e].resources[0].id,j=q[e].resources[0].name[f.i18n.getLocale()],k={id:i,expanded:!1,loaded:!1,type:"resource",info:{type:"package",id:q[e].id},caption:j,i18n:"node.resource."+i},l={id:i,image:"content/images/app/show.svg",isLeaf:!1,caption:j,hasInformation:q[e].info||!!q[e].notes,i18n:"node.resource."+i},m=this.values.createTreeNodeElement.call(this,o,l,k),b(t).append(m)):(j=q[e].title[f.i18n.getLocale()],k={id:q[e].id,expanded:!1,loaded:!1,type:"package",info:{type:"package",id:q[e].id},caption:j},l={id:q[e].id,image:"content/images/app/show.svg",isLeaf:!1,caption:j,hasInformation:q[e].info||!!q[e].notes},m=this.values.createTreeNodeElement.call(this,o,l,k),b(t).append(m))}}d.setFilter(d.getFilter(),0)},j=function(a,c){var e,h,i,j,k,l=b("#node-"+this.values.element+"-"+c),m=this.values.getTreeNodeById(c),n=[];n=this.values.mode===f.Maps.LayerTreeViewMode.ByFilter?this.values.ckan.getFilteredPackages():this.values.ckan.getPackages();var o=0,p=b('<ul class="tree-node" style="display: none;"></ul>');b(l).append(p);for(var q=0;q<n.length;q++)if(n[q].organization===c){var r=n[q].resources;r.sort(g("node_index"));for(var s=0;s<r.length;s++){if(o++,this.values.resources.setCatalogResourceMetadataOptions(r[s]),e=r[s].id,h=r[s].name[f.i18n.getLocale()],this.values.mode===f.Maps.LayerTreeViewMode.ByFilter&&1==n[q].resources.length){var t=this.values.ckan.getResourceById(e);h=t?t.name[f.i18n.getLocale()]:n[q].title[f.i18n.getLocale()]}if(r[s].metadata&&r[s].metadata.extras.layer){var u=e+"_"+r[s].metadata.extras.layer,v=this.values.resources.isLayerSelected(u);i={id:u.replace(/[^\w\s]/gi,""),expanded:!1,loaded:!1,type:"layer",layer:u,selected:v,info:{type:"package",id:n[q].id},caption:h,i18n:"node.resource."+e},j={id:u.replace(/[^\w\s]/gi,""),image:v?"content/images/app/checkbox-checked.svg":"content/images/app/checkbox-empty.svg",isLeaf:!0,caption:h,hasInformation:!!n[q].info&&1==n[q].resources.length,i18n:"node.resource."+e},k=this.values.createTreeNodeElement.call(this,m,j,i),b(p).append(k)}else i={id:e,expanded:!1,loaded:!1,type:"resource",info:{type:"package",id:n[q].id},caption:h,i18n:"node.resource."+e},j={id:e,image:"content/images/app/show.svg",isLeaf:!1,caption:h,hasInformation:!!n[q].info&&1==n[q].resources.length,i18n:"node.resource."+e},k=this.values.createTreeNodeElement.call(this,m,j,i),b(p).append(k)}}if(0===o){var w=b(l).find("img.tree-toggle").first();b(w).addClass("disabled"),b(w).attr("src","content/images/app/empty.svg"),b(l).find(".tree-text").first().addClass("tree-text-disabled")}d.setFilter(d.getFilter(),0)},k=function(a,c){var d,e,h,i,j=b("#node-"+this.values.element+"-"+c),k=this.values.getTreeNodeById(c),l=this.values.ckan.getPackageById(c);l.resources.sort(g("name",f.i18n.getLocale()));var m=b('<ul class="tree-node" style="display: none;"></ul>');b(j).append(m);for(var n=0;n<l.resources.length;n++){var o=l.resources[n];if(o.metadata.extras.layer){var p=o.id+"_"+o.metadata.extras.layer,q=this.values.resources.isLayerSelected(p);d=o.name[f.i18n.getLocale()],e={id:p.replace(/[^\w\s]/gi,""),expanded:!1,loaded:!1,type:"layer",layer:p,selected:q,caption:d,i18n:"node.resource."+o.id},h={id:p.replace(/[^\w\s]/gi,""),image:q?"content/images/app/checkbox-checked.svg":"content/images/app/checkbox-empty.svg",isLeaf:!0,caption:d,hasInformation:!1,i18n:"node.resource."+o.id}}else d=o.name[f.i18n.getLocale()],e={id:o.id,expanded:!1,loaded:!1,type:"resource",caption:d,i18n:"node.resource."+o.id},h={id:o.id,image:"content/images/app/show.svg",isLeaf:!1,caption:d,hasInformation:!1,i18n:"node.resource."+o.id};i=this.values.createTreeNodeElement.call(this,k,h,e),b(m).append(i)}},l=function(a,c,e){var f=b("#node-"+this.values.element+"-"+c),h=this.values.getTreeNodeById(c),i=(this.values.ckan.getResourceById(c),b('<ul class="tree-node" style="display: none;"></ul>'));b(f).append(i),e.sort(g("title"));for(var j=0;j<e.length;j++){var k=c+"_"+e[j].name,l=this.values.resources.isLayerSelected(k),m=e[j].title,n={id:k.replace(/[^\w\s]/gi,""),expanded:!1,loaded:!1,type:"layer",layer:k,selected:l,caption:m},o={id:k.replace(/[^\w\s]/gi,""),image:l?"content/images/app/checkbox-checked.svg":"content/images/app/checkbox-empty.svg",isLeaf:!0,caption:m,hasInformation:!1},p=this.values.createTreeNodeElement.call(this,h,o,n);b(i).append(p)}d.setFilter(d.getFilter(),0)};b("#"+this.values.element).on("click."+this.values.contentElement,".tree-text",function(){var a=b(this).parent().find(".tree-toggle");a.size()>0?a.click():(a=b(this).parent().find(".node-select"),a.size()>0&&a.click())}),b("#"+this.values.element).on("click."+this.values.contentElement,".tree-toggle",function(){var a=this,c=b(this).closest("li"),e=b(c).data(),f=e.id,g=e.type;if(!b(c).hasClass("disabled")){if(e.expanded)e.expanded=!1,b(this).removeClass("tree-node-collapse"),b(c).find("ul").first().fadeOut(250);else if(!e.loading)if(e.loaded)e.expanded=!0,b(this).removeClass("tree-node-collapse"),b(c).find("ul").first().fadeIn(250);else if("node"===g)d.values.renderTreeNodeElements.call(d,f),e.loaded=!0,e.expanded=!0,b(a).addClass("tree-node-collapse"),b(c).find("ul").first().fadeIn(250);else if("group"===g)d.values.ckan.loadGroupById(f).then(function(g){h.call(d,c,f),e.loaded=!0,e.expanded=!0,b(a).addClass("tree-node-collapse"),b(c).find("ul").first().fadeIn(250)});else if("organization"===g)d.values.ckan.loadOrganizationById(f).then(function(g){d.values.ckan.getNodeCount()>0?j.call(d,c,f):i.call(d,c,f),e.loaded=!0,e.expanded=!0,b(a).addClass("tree-node-collapse"),b(c).find("ul").first().fadeIn(250)});else if("package"===g)k.call(d,c,f),e.loaded=!0,e.expanded=!0,b(a).addClass("tree-node-collapse"),b(c).find("ul").first().fadeIn(250);else if("resource"===g){var m=d.values.ckan.getResourceById(e.id);b(this).attr("src","content/images/app/ajax-loader.gif"),b(this).addClass("tree-node-ajax-loader"),e.loading=!0,d.values.resources.setCatalogResourceMetadataOptions(m),d.values.resources.getResourceMetadata(m.metadata.type,m.metadata.parameters).then(function(g){b(a).attr("src","content/images/app/show.svg"),b(a).removeClass("tree-node-ajax-loader"),l.call(d,c,f,g.layers),e.loaded=!0,e.expanded=!0,e.loading=!1,b(a).addClass("tree-node-collapse"),b(c).find("ul").first().fadeIn(250)},function(c){b(a).attr("src","content/images/app/show.svg"),b(a).removeClass("tree-node-ajax-loader"),e.loading=!1})}d.setFilter(d.getFilter(),0)}}),b("#"+this.values.element).on("click."+this.values.contentElement,".node-select",function(){var a=b(this).closest("li"),c=b(a).data();c.selected?d.remove(c.layer):d.add(c.layer)}),b("#"+this.values.element).on("click."+this.values.contentElement,".tree-info",function(){var a=b(this).closest("li"),c=b(a).data();c.info&&(d.trigger("catalog:info-loading",{sender:d,type:c.info.type,id:c.info.id,title:d.values.ckan.getObjectTitle(c.info.type,c.info.id)}),d.values.ckan.getObjectDescription(c.info.type,c.info.id).then(function(a){d.trigger("catalog:info-loaded",{sender:d,type:c.info.type,id:c.info.id,data:a})}))}),this.values.mode===f.Maps.LayerTreeViewMode.ByFilter&&(b("#"+this.values.element).on("click."+this.values.element,"#"+this.values.element+"-box-draw-btn",function(a){return a.preventDefault(),a.stopPropagation(),d.values.bbox.interaction.setActive(!0),b("#"+d.values.element+"-search").hide(),b("#"+d.values.element+"-box-draw").hide(),b("#"+d.values.element+"-box-remove").hide(),b("#"+d.values.element+"-box-apply").show(),b("#"+d.values.element+"-box-cancel").show(),d.trigger("bbox:draw",{}),!1}),b("#"+this.values.element).on("click."+this.values.element,"#"+this.values.element+"-box-remove-btn",function(a){return a.preventDefault(),a.stopPropagation(),d.values.bbox.overlay.getFeatures().clear(),d.values.bbox.feature=null,b("#"+d.values.element+"-box-remove").hide(),b("#"+d.values.element+"-box-draw").show(),b("#"+d.values.element+"-search").show(),d.setQueryBoundingBox(null),d.trigger("bbox:remove",{}),!1}),b("#"+this.values.element).on("click."+this.values.element,"#"+this.values.element+"-box-apply-btn",function(a){return a.preventDefault(),a.stopPropagation(),d.setQueryBoundingBox(d.values.bbox.overlay.getFeatures().item(0)),d.values.bbox.interaction.setActive(!1),b("#"+d.values.element+"-box-apply").hide(),b("#"+d.values.element+"-box-cancel").hide(),b("#"+d.values.element+"-box-draw").show(),b("#"+d.values.element+"-box-remove").show(),b("#"+d.values.element+"-search").show(),d.trigger("bbox:apply",{}),!1}),b("#"+this.values.element).on("click."+this.values.element,"#"+this.values.element+"-box-cancel-btn",function(a){a.preventDefault(),a.stopPropagation(),d.values.bbox.overlay.getFeatures().clear(),d.values.bbox.interaction.setActive(!1);var c=d.getQueryBoundingBox();return c?(d.values.bbox.overlay.addFeature(c),d.values.bbox.feature=c):d.values.bbox.feature=null,b("#"+d.values.element+"-box-apply").hide(),b("#"+d.values.element+"-box-cancel").hide(),b("#"+d.values.element+"-box-draw").show(),d.values.bbox.feature?b("#"+d.values.element+"-box-remove").show():b("#"+d.values.element+"-box-remove").hide(),b("#"+d.values.element+"-search").show(),d.trigger("bbox:cancel",{}),!1}),b("#"+this.values.element).on("click."+this.values.element,"#"+this.values.element+"-search-btn",function(a){a.preventDefault(),a.stopPropagation();var c=null;if(d.values.bbox.feature){var e=d.values.bbox.feature.getGeometry().clone();e.transform("EPSG:3857","EPSG:4326"),c=e.getExtent()}var g=b("#"+d.values.element+"-text").val();if(c||g)b("#"+d.values.element+"-result").html(""),d.values.ckan.search(g,c).then(function(a){d.refresh(),d.trigger("catalog:search",{packages:a})});else{var h=[];h.push('<div class="clearfix message-warning" data-i18n-id="control.tree.search.no-criteria">'),h.push(f.i18n.getResource("control.tree.search.no-criteria")),h.push("</div>"),b("#"+d.values.element+"-result").html(h.join(""))}return!1}),b("#"+this.values.element).on("keydown."+this.values.element,"#"+this.values.element+"-text",function(a){13==a.keyCode&&(a.preventDefault(),a.stopPropagation(),b("#"+d.values.element+"-search-btn").trigger("click"))})),this.refresh()},setQueryBoundingBox:function(a){a?this.values.bbox.feature=a:(this.values.bbox.feature=null,b("#"+this.values.element+"-box-remove").hide())},getQueryBoundingBox:function(){return this.values.bbox.feature},add:function(a,c){var d=this,e=a.split("_"),g="#node-"+this.values.element+"-"+a.replace(/[^\w\s]/gi,""),h=b(g);if(0!==b(h).size()){var i=b(h).data(),j=b(h).find("img.node-select").first();if(e.length>1&&!i.loading){var k=d.values.ckan.getResourceById(e[0]);(this.values.resources.isLayerSelected(a)||this.values.resources.getLayerCount()<this.values.resources.getMaxLayerCount())&&(i.loading=!0,b(j).attr("src","content/images/app/ajax-loader.gif").addClass("tree-node-ajax-loader"),this.values.resources.setCatalogResourceMetadataOptions(k),this.values.resources.getResourceMetadata(k.metadata.type,k.metadata.parameters).then(function(e){if(i.loading=!1,i.selected=!0,b(j).removeClass("tree-node-ajax-loader").attr("src","content/images/app/checkbox-checked.svg"),!d.values.resources.isLayerSelected(a)){var g=f.i18n.getResource(i.i18n,i.caption);d.values.resources.createLayer(d.values.map,e,a,g)}c!==!1&&d.trigger("layer:added",{sender:d,id:a})},function(a){i.loading=!1,b(j).removeClass("tree-node-ajax-loader").attr("src","content/images/app/checkbox-empty.svg")}))}}},remove:function(a,c){var d,e,f=a.split("_"),g="#node-"+this.values.element+"-"+a.replace(/[^\w\s]/gi,""),h=b(g),i=b(h).size()>0;if(i&&(d=b(h).data(),e=b(h).find("img.node-select").first()),f.length>1){if(d){if(d.loading||!d.selected)return;d.selected=!1,b(e).attr("src","content/images/app/checkbox-empty.svg")}this.values.resources.destroyLayer(this.values.map,a)&&c!==!1&&this.trigger("layer:removed",{sender:this,id:a})}},render:function(){var a=this;this.values.rootTreeNode={id:null,children:[]};var c=[];this.values.mode===f.Maps.LayerTreeViewMode.ByFilter?1===b("#"+this.values.element+"-result").size()?b("#"+this.values.element+"-result").html(""):(b("#"+this.values.element).html(""),c.push('<div id="'+this.values.element+'-form" class="clearfix layer-tree-search-form">'),c.push('<div class="clearfix" style="padding: 6px 4px 6px 0px; display: block;">'),c.push('<div class="input-group" style="float: left; width: 100%;">'),c.push('<input id="'+this.values.element+'-text" placeholder="'+f.i18n.getResource("control.tree.search.prompt")+'" data-i18n-id="control.tree.search.prompt" data-i18n-type="attribute" data-i18n-name="placeholder" class="form-control input-md" type="text">'),c.push('<span class="input-group-btn">'),c.push('<button type="button" class="btn btn-default" id="'+this.values.element+'-text-clear">'),c.push('<span class="glyphicon glyphicon-trash"></span>'),c.push("</button>"),c.push("</span>"),c.push("</div>"),c.push("</div>"),c.push('<div class="clearfix">'),c.push('<div style="float: left; padding-right: 10px;"  id="'+this.values.element+'-box-draw">'),c.push('<a id="'+this.values.element+'-box-draw-btn" class="btn btn-primary" data-placement="bottom" data-i18n-id="control.tree.search.button.draw" data-i18n-type="title" title="'+f.i18n.getResource("control.tree.search.button.draw")+'"><img src="content/images/app/draw-square-w.svg" class="img-20" /></a>'),c.push("</div>"),c.push('<div style="float: left; padding-right: 10px; display: none;" id="'+this.values.element+'-box-remove">'),c.push('<a id="'+this.values.element+'-box-remove-btn" class="btn btn-danger" data-placement="bottom" data-i18n-id="control.tree.search.button.remove" data-i18n-type="title" title="'+f.i18n.getResource("control.tree.search.button.remove")+'"><img src="content/images/app/reject-w.svg" class="img-20" /></a>'),c.push("</div>"),c.push('<div style="float: left; padding-right: 10px; display: none;" id="'+this.values.element+'-box-apply">'),c.push('<a id="'+this.values.element+'-box-apply-btn" class="btn btn-success" data-placement="bottom" data-i18n-id="control.tree.search.button.apply" data-i18n-type="title" title="'+f.i18n.getResource("control.tree.search.button.apply")+'"><img src="content/images/app/accept-w.svg" class="img-20" /></a>'),c.push("</div>"),c.push('<div style="float: left; padding-right: 10px; display: none;" id="'+this.values.element+'-box-cancel">'),c.push('<a id="'+this.values.element+'-box-cancel-btn" class="btn btn-danger" data-placement="bottom" data-i18n-id="control.tree.search.button.discard" data-i18n-type="title" title="'+f.i18n.getResource("control.tree.search.button.discard")+'"><img src="content/images/app/reject-w.svg" class="img-20" /></a>'),c.push("</div>"),c.push('<div style="float: left; padding-right: 10px;" id="'+this.values.element+'-search">'),c.push('<a id="'+this.values.element+'-search-btn" class="btn btn-primary" data-placement="bottom" data-i18n-id="control.tree.search.button.search" data-i18n-type="title" title="'+f.i18n.getResource("control.tree.search.button.search")+'"><img src="content/images/app/search-w.svg" class="img-20" /></a>'),c.push("</div>"),c.push("</div>"),c.push("</div>"),c.push('<div id="'+this.values.element+'-result-container" class="clearfix layer-tree-search-result-container">'),c.push('<div id="'+this.values.element+'-result" class="clearfix layer-tree-search-result">'),c.push("</div>"),c.push("</div>"),b("#"+this.values.element).html(c.join("")),b("#"+this.values.element).find("a").tooltip()):(b("#"+this.values.element).html(""),c.push('<div style="overflow-y: auto;" id="'+this.values.element+'-result-container"><div class="clearfix" id="'+this.values.element+'-result" style="padding: 0px 2px 0px 0px;">'),c.push("</div></div>"),b("#"+this.values.element).html(c.join(""))),b("#"+this.values.element+"-text-clear").click(function(){b("#"+a.values.element+"-text").val("")}),this.values.mode===f.Maps.LayerTreeViewMode.ByGroup?this.values.ckan.getNodeCount()>0?this.values.renderTreeNodeElements.call(this):this.values.renderGroups.call(this):this.values.mode===f.Maps.LayerTreeViewMode.ByOrganization?this.values.renderOrganizations.call(this):this.values.renderOrganizations.call(this)},show:function(){f.Maps.Component.prototype.show.apply(this),this.values.mode===f.Maps.LayerTreeViewMode.ByFilter&&b("#"+this.values.element+"-text").focus()},getFilter:function(){return this.values.filter.term},clearFilter:function(){b("li.tree-node").removeClass("node-filtered"),this.values.filter={term:null}},setFilter:function(a,c){var d=this;this.values.timeout&&(clearTimeout(this.values.timeout),this.values.timeout=null),0!==c&&(c=c||500);var e=f.i18n.getLocale(),g=function(){if(a){d.values.filter.term=a;for(var c=function(a,e,g){var h=b(a.element).data(),i=!0;if(a.children.length>0)for(var j=0;j<a.children.length;j++)i=c(a.children[j],e,g)&&i;else switch(h.type){case"organization":i=d.values.ckan.filterOrganization(a.id,e,g);break;case"node":i=d.values.ckan.filterNode(a.id,e,g);break;default:var k=f.i18n.getResource(h.i18n,h.caption);i=k.indexOf(e)>-1?!1:!0}return i?b(a.element).addClass("node-filtered"):b(a.element).removeClass("node-filtered"),i},g=0;g<d.values.rootTreeNode.children.length;g++)c(d.values.rootTreeNode.children[g],a,e)}else d.clearFilter()};c>0?this.values.timeout=setTimeout(g,c):g()},expand:function(a){if(this.values.ckan.isPreloadingEnabled()){var c,d,e,g,h=[],i=this.values.ckan.getResourceById(a);if(i){switch(this.values.mode){case f.Maps.LayerTreeViewMode.ByGroup:for(c=this.values.ckan.getNodeById(i.node_id);c;)h.push(c.id),c=this.values.ckan.getNodeById(c.parent);break;case f.Maps.LayerTreeViewMode.ByOrganization:var j=this.values.ckan.getPackageById(i["package"]);h.push(j.organization)}for(h=h.reverse(),g=0;g<h.length;g++)e="#node-"+this.values.element+"-"+h[g],d=b(e).data(),d.expanded||b(e).find(".tree-text").first().click()}}},localizeUI:function(a){switch(this.values.mode){case f.Maps.LayerTreeViewMode.ByGroup:break;case f.Maps.LayerTreeViewMode.ByOrganization:break;case f.Maps.LayerTreeViewMode.ByFilter:}}});var h=function(a,c,d){var e=this,g=this.values.resources.getLayerById(a);if(g){c.text.hasOwnProperty([f.i18n.getLocale()])?c.text=c.text[f.i18n.getLocale()]:c.hasOwnProperty("el")&&(c.text=c.text.el);var h=[],i=a.replace(/[^\w\s]/gi,"");h.push('<div data-id="'+a+'" class="clearfix selected-layer">'),h.push('<div class="legend-container">'),d?h.push('<img id="'+i+'-legend-img" src="'+d+'" alt=" " class="legend" />'):h.push("&nbsp;"),h.push("</div>"),h.push('<div style="margin-left: 25px;">'),h.push('<div class="clearfix" style="padding-bottom: 3px;">'),h.push('<div class="selected-layer-close"><img src="content/images/app/close.svg" class="action img-16" data-action="remove"  /></div>'),h.push('<div class="selected-layer-up"><img src="content/images/app/move-up.svg" class="action img-16 action-disabled" data-action="up"  /></div>'),h.push('<div class="selected-layer-text" data-i18n-id="'+c.i18n+'">'+c.text+"</div>"),h.push("</div>"),h.push('<div class="clearfix">'),h.push('<div class="selected-layer-opacity-label" data-i18n-id="index.title.layer-opacity" data-i18n-type="title" title="'+f.i18n.getResource("index.title.layer-opacity")+'" ><img src="content/images/app/opacity.svg" class="img-16" /></div>'),h.push('<div class="selected-layer-opacity-slider"><input type="range" min="0" max="100" value="'+(100*g.getOpacity()).toFixed(0)+'"></div>'),h.push('<div class="selected-layer-down"><img src="content/images/app/move-down.svg" class="action img-16 action-disabled" data-action="down"  /></div>'),h.push("</div>"),h.push("</div>"),h.push("</div>"),b("#"+this.values.element).prepend(h.join("")),b("#"+i+"-legend-img").load(function(){var a=b(this).prop("naturalWidth"),d=b(this).width(),f=b(this).prop("naturalHeight"),g=b(this).height(),h=b(this).parent().height();(a>d||f>g||f>h)&&(b(this).css("cursor","pointer"),b(this).on("click",function(a){b("#"+e.values.element+"-dialog-legend-img").attr("src",b(this).attr("src")),e.values.dialog.setTitle(c),e.values.dialog.show()}))}),b(".selected-layer-opacity-label").tooltip(),this.values.updateActions(),this.trigger("layer:added",{id:a})}},i=function(a,b){return a.metadata.extras.layer?{i18n:"node.resource."+a.id,text:a.name}:{i18n:"",text:b}};f.Maps.LayerSelection=f.Class(f.Maps.Component,{initialize:function(a){var c=this;f.extend(this.values,{map:null,ckan:null,resources:null}),"function"==typeof f.Maps.Component.prototype.initialize&&f.Maps.Component.prototype.initialize.apply(this,arguments),this.event("layer:added"),this.event("layer:removed"),this.event("layer:up"),this.event("layer:down"),this.event("layer:opacity:changed"),this.values.updateActions=function(){var a=b("#"+c.values.element).find(".selected-layer"),d=a.size();a.each(function(a,c){0===a?(b(c).find('[data-action="up"]').addClass("action-disabled"),1==d?b(c).find('[data-action="down"]').addClass("action-disabled"):b(c).find('[data-action="down"]').removeClass("action-disabled")):a==d-1?(1==d?b(c).find('[data-action="up"]').addClass("action-disabled"):b(c).find('[data-action="up"]').removeClass("action-disabled"),b(c).find('[data-action="down"]').addClass("action-disabled")):(b(c).find('[data-action="up"]').removeClass("action-disabled"),b(c).find('[data-action="down"]').removeClass("action-disabled"))})},b("#"+this.values.element).on("click."+this.values.element,".action",function(){
var a=b(this).closest(".selected-layer"),d=a.data("id"),e=b(this).data("action");switch(e){case"remove":c.remove(d);break;case"up":c.values.resources.moveLayerUp(c.values.map,d)&&(a.prevAll().first().insertAfter(a),c.values.updateActions(),c.trigger("layer:up"));break;case"down":c.values.resources.moveLayerDown(c.values.map,d)&&(a.nextAll().first().insertBefore(a),c.values.updateActions(),c.trigger("layer:down"))}}),b("#"+this.values.element).on("change."+this.values.element,'[type="range"]',function(){var a=b(this).closest(".selected-layer").data("id");c.values.resources.setLayerOpacity(a,b(this).val()),c.trigger("layer:opacity:changed",{id:a,opacity:b(this).val()})}),this.values.dialog=new f.Maps.Dialog({title:"",element:this.values.element+"-dialog-legend",visible:!1,width:430,height:400,autofit:!0,buttons:{close:{text:"button.close",style:"primary"}},renderContent:function(){var a=[];return a.push('<div class="clearfix" style="max-height: 350px; overflow: auto;">'),a.push('<img id="'+c.values.element+'-dialog-legend-img" src="" alt="" />'),a.push("</div>"),a}}),this.values.dialog.on("dialog:action",function(a){switch(a.action){case"close":this.hide()}})},render:function(){b("#"+this.values.element).html("")},add:function(a,b){if(this.values.resources.getLayerCount()>this.values.resources.getMaxLayerCount())return!1;var c,d=this,e=a.split("_"),f=e.splice(1).join("_");if(c=this.values.ckan.getResourceById(e[0]))return this.values.resources.setCatalogResourceMetadataOptions(c),this.values.resources.getResourceMetadata(c.metadata.type,c.metadata.parameters).then(function(b){for(var e,g,j=0;j<b.layers.length;j++)if(b.layers[j].key==f){e=b.layers[j].title,g=b.layers[j].legend;break}return h.call(d,a,i(c,e),g),!0},function(a){return!1}),!0;if(b)for(var g=0,j=b.layers.length;j>g;g++)if(b.layers[g].key==f)return h.call(d,a,{i18n:"",text:b.layers[g].title},b.layers[g].legend),!0;return!1},remove:function(a){b("#"+this.values.element).find('[data-id="'+a+'"]').remove(),this.values.updateActions(),this.values.resources.getLayerById(a)&&this.trigger("layer:removed",{id:a})}}),f.Maps.Tool=f.Class(f.Maps.Component,{initialize:function(a){f.extend(this.values,{name:null,active:!1,enabled:!0,images:{enabled:"",diabled:""},title:null}),"function"==typeof f.Maps.Component.prototype.initialize&&f.Maps.Component.prototype.initialize.apply(this,arguments),this.values.actions=[],this.event("tool:toggle"),this.render()},getName:function(){return this.values.name},getActive:function(){return this.values.active&&this.values.enabled},hasActions:function(){return this.values.actions.length>0},setActive:function(a){var c;if(this.values.active=a&&this.values.enabled,this.values.element)if(this.values.active)for(b("#"+this.values.element).find("a").addClass("tool-toggle-selected").removeClass("btn-default").addClass("btn-primary").find("img").attr("src",this.values.images.enabled),c=0;c<this.values.actions.length;c++)this.values.actions[c].show();else for(b("#"+this.values.element).find("a").removeClass("tool-toggle-selected").removeClass("btn-primary").addClass("btn-default").find("img").attr("src",this.values.images.disabled),c=0;c<this.values.actions.length;c++)this.values.actions[c].hide()},getEnabled:function(){return this.values.enabled},setEnabled:function(a){this.values.enabled=a,this.values.enabled||this.setActive(!1)},render:function(){var a=this;if(this.values.element){var c=[];c.push('<a data-action="'+this.values.name+'" class="tool-toggle btn btn-default" data-i18n-id="'+this.values.title+'" data-i18n-type="title" title="'+(f.i18n.getResource(this.values.title)||"")+'">'),c.push('<img class="img-20" src="'+(this.values.active?this.values.images.enabled:this.values.images.disabled)+'">'),c.push("</a>"),b("#"+this.values.element).html(c.join("")),b("#"+this.values.element).find("a").tooltip(),b("#"+this.values.element).find("a").click(function(){a.setActive(!a.values.active),a.trigger("tool:toggle",{sender:a,active:a.getActive()})}),this.values.visible||b("#"+this.values.element).hide()}}}),f.Maps.MeasureToolType={Length:1,Area:2},f.Maps.MeasureTool=f.Class(f.Maps.Tool,{initialize:function(a){var b=this;this.values.map=null,this.values.overlay=null,this.values.interaction=null,this.values.type=f.Maps.MeasureToolType.Length,"function"==typeof f.Maps.Tool.prototype.initialize&&f.Maps.Tool.prototype.initialize.apply(this,arguments),this.values.feature=null,this.event("measure:end");var d=function(){var a,d,e;if(!b.values.feature)return null;var g=new c.Sphere(6378137),h=b.values.feature.getGeometry().clone().transform("EPSG:3857","EPSG:4326");if(b.values.type===f.Maps.MeasureToolType.Length){e=h.getCoordinates(),a=0;for(var i=0,j=e.length-1;j>i;++i){var k=e[i],l=e[i+1];a+=g.haversineDistance(k,l)}return a=Math.round(100*a)/100,d=a>100?Math.round(a/1e3*100)/100+" km":Math.round(100*a)/100+" m"}e=h.getLinearRing(0).getCoordinates();var m=Math.abs(g.geodesicArea(e));return d=m>1e6?Math.round(m/1e6*1e3)/1e3+" km<sup>2</sup>":Math.round(100*m)/100+" m<sup>2</sup>"};this.values.reset=function(){b.values.overlay.getFeatures().clear(),b.values.tooltipElement&&b.values.tooltipElement.parentNode&&b.values.tooltipElement.parentNode.removeChild(b.values.tooltipElement),b.values.tooltip&&b.values.map.removeOverlay(b.values.tooltip)},this.values.handler=function(a){if(!a.dragging){var c=a.coordinate;if(b.values.feature){var e=b.values.feature.getGeometry(),g=d(e);c=b.values.type===f.Maps.MeasureToolType.Area?e.getInteriorPoint().getCoordinates():e.getLastCoordinate(),b.values.tooltipElement.innerHTML=g,b.values.tooltip.setPosition(c)}}},this.values.overlay=new c.FeatureOverlay({style:[new c.style.Style({fill:new c.style.Fill({color:[255,255,255,.4]}),stroke:new c.style.Stroke({color:"#7f8c8d",width:2})})]}),this.values.overlay.setMap(this.values.map);var e=this.values.type===f.Maps.MeasureToolType.Length?"LineString":"Polygon";this.values.interaction=new c.interaction.Draw({features:this.values.overlay.getFeatures(),type:e,style:[new c.style.Style({fill:new c.style.Fill({color:[255,255,255,.4]}),stroke:new c.style.Stroke({color:"#7f8c8d",lineDash:[10,10],width:2})}),new c.style.Style({image:new c.style.Circle({radius:6,fill:new c.style.Fill({color:[255,255,255,.4]}),stroke:new c.style.Stroke({color:"#7f8c8d",width:2})}),zIndex:1/0})]}),this.values.interaction.on("change:active",function(a){this.getActive()?b.values.overlay.setMap(b.values.map):b.values.overlay.setMap(null)}),this.values.interaction.on("drawstart",function(a){b.clear(),b.values.feature=a.feature}),this.values.interaction.on("drawend",function(a){a.feature?b.values.feature=a.feature:b.values.feature=null,b.values.tooltipElement.className="mt-tooltip mt-tooltip-static",b.values.feature=null,b.values.tooltipElement=null,b.trigger("measure:end",{feature:a.feature})}),this.values.map.addInteraction(this.values.interaction),this.values.interaction.setActive(!1),this.render()},setActive:function(a){f.Maps.Tool.prototype.setActive.apply(this,[a]),this.values.active?this.values.interaction&&(this.values.interaction.setActive(!0),this.values.map.on("pointermove",this.values.handler)):this.values.interaction&&(this.values.interaction.setActive(!1),this.values.map.un("pointermove",this.values.handler),this.values.reset())},getType:function(){return this.values.type},getFeature:function(){return this.values.feature},getMeasurement:function(){return this.values.measurement},createTooltip:function(){this.values.reset(),this.values.tooltipElement=document.createElement("div"),this.values.tooltipElement.className="mt-tooltip mt-tooltip-measure",this.values.tooltip=new c.Overlay({element:this.values.tooltipElement,offset:[0,-15],positioning:"bottom-center"}),this.values.map.addOverlay(this.values.tooltip)},clear:function(){this.createTooltip(),this.values.overlay.getFeatures().clear()}});var j=function(a){this.values.action.isBusy()||(b("#"+this.values.element+"-error").html(""),this.values.dialog.show(),this.values.dialog.moveToCenter())},k=function(a){var d,e,g=this;if(this.values.action.isBusy())return void this.values.dialog.hide();var h=this.getFeature();if(h){var i=new c.format.GeoJSON,j=JSON.parse(i.writeGeometry(h.getGeometry())),k=this.values.resources.getSelectedLayers(),m=this.values.resources.getQueryableResources(),n=[];for(d=0;d<k.length;d++)for(e=0;e<m.length;e++)if(k[d].resource_id==m[e].wms){n.push({table:m[e].table,title:k[d].title});break}if(0===n.length)b("#"+this.values.element+"-error").html('<div class="alert alert-danger" role="alert" data-i18n-id="action.export.no-resource-selected">'+f.i18n.getResource("action.export.no-resource-selected")+"</div>");else{this.values.dialog.hide(),this.values.action.suspendUI();var o=this.values.query;o.reset().crs(b("#"+this.values.element+"-crs").val()).format(b("#"+this.values.element+"-format").val());var p=[];for(d=0;d<n.length;d++)p.push(n[d].title),o.resource(n[d].table).contains(j,{resource:n[d].table,name:"the_geom"}),d<n.length-1&&o.queue();o["export"]({context:this,success:l,failure:function(){g.values.action.resumeUI()},files:p})}}},l=function(a,b){this.values.action.resumeUI(),a.success&&(jQuery("#export-download-frame").remove(),jQuery("body").append('<div id="export-download-frame" style="display: none"><iframe src="'+this.values.endpoint+"api/download/"+a.code+'"></iframe></div>'))};f.Maps.ExportTool=f.Class(f.Maps.Tool,{initialize:function(a){var d=this;this.values.map=null,this.values.disabledFormats=[],"function"==typeof f.Maps.Tool.prototype.initialize&&f.Maps.Tool.prototype.initialize.apply(this,arguments),this.event("feature:change"),this.values.overlay=null,this.values.interaction=null,this.values.feature=null,this.values.crs=f.Maps.CRS.Mercator,this.values.query=new e.Data.Query(this.values.endpoint),this.values.formats=[{value:"ESRI Shapefile",text:"ESRI Shapefile",selected:!0},{value:"GML",text:"GML"},{value:"KML",text:"KML"},{value:"GPKG",text:"Geo Package"},{value:"DXF",text:"AutoCAD DXF"},{value:"CSV",text:"Comma Separated Value"},{value:"GeoJSON",text:"GeoJSON"},{value:"PDF",text:"Geospatial PDF"}],this.values.action&&(this.values.actions.push(this.values.action),this.values.action.on("action:execute",j,this)),this.values.dialog=new f.Maps.Dialog({title:"control.export.dialog.title",element:this.values.element+"dialog",visible:!1,width:430,height:200,autofit:!0,buttons:{"export":{text:"control.export.dialog.button.export",style:"primary"},close:{text:"control.export.dialog.button.cancel",style:"default"}},renderContent:function(){var a=[];a.push('<div class="clearfix" style="padding-bottom: 10px;">'),a.push('<label for="'+d.values.element+'-crs" style="padding-right: 10px; width: 145px;" data-i18n-id="control.export.dialog.label.crs">'+f.i18n.getResource("control.export.dialog.label.crs")+"</label>"),a.push('<select name="'+d.values.element+'-crs" id="'+d.values.element+'-crs" class="selectpicker" data-width="160px">'),a.push('<option value="EPSG:3857">Web Mercator</option>'),a.push('<option value="EPSG:4326">WGS84</option>'),a.push('<option value="EPSG:2100" selected="selected">ΕΓΣΑ87</option>'),a.push('<option value="EPSG:4258">ETRS89</option>'),a.push("</select>"),a.push("</div>"),a.push('<div class="clearfix">'),a.push('<label for="'+d.values.element+'-format" style="padding-right: 10px; width: 145px;" data-i18n-id="control.export.dialog.label.format">'+f.i18n.getResource("control.export.dialog.label.format")+"</label>"),a.push('<select name="'+d.values.element+'-format" id="'+d.values.element+'-format" class="selectpicker" data-width="250px">');for(var b=0,c=d.values.formats.length;c>b;b++){var e=d.values.formats[b];d.values.disabledFormats.indexOf(e.value)<0&&(e.selected?a.push('<option value="'+e.value+'" selected="selected">'+e.text+"</option>"):a.push('<option value="'+e.value+'">'+e.text+"</option>"))}return a.push("</select>"),a.push("</div>"),a.push('<div class="clearfix"  id="'+d.values.element+'-error" style="margin: 10px 4px 0 0;"></div>'),a}}),b("#"+this.values.element+"-crs").selectpicker().change(function(){b('[data-id="'+d.values.element+'-crs"]').blur()}),b("#"+this.values.element+"-format").selectpicker().change(function(){b('[data-id="'+d.values.element+'-format"]').blur()}),this.values.dialog.on("dialog:action",function(a){switch(a.action){case"close":this.hide();break;case"export":k.apply(d)}}),this.values.overlay=new c.FeatureOverlay({style:[new c.style.Style({fill:new c.style.Fill({color:[255,255,255,.4]}),stroke:new c.style.Stroke({color:"#3399CC",width:2})})]}),this.values.overlay.setMap(this.values.map),this.values.interaction=new c.interaction.Draw({features:this.values.overlay.getFeatures(),type:"Polygon",style:[new c.style.Style({fill:new c.style.Fill({color:[255,255,255,.4]}),stroke:new c.style.Stroke({color:"#3399CC",width:1})}),new c.style.Style({image:new c.style.Circle({radius:6,fill:new c.style.Fill({color:[255,255,255,.4]}),stroke:new c.style.Stroke({color:"#3399CC",width:1})}),zIndex:1/0})]}),this.values.interaction.on("change:active",function(a){this.getActive()?d.values.overlay.setMap(d.values.map):d.values.overlay.setMap(null)}),this.values.interaction.on("drawstart",function(a){d.values.overlay.getFeatures().clear(),d.values.feature=null}),this.values.interaction.on("drawend",function(a){a.feature?d.values.feature=a.feature:d.values.feature=null,d.trigger("feature:change",{feature:a.feature})}),this.values.map.addInteraction(this.values.interaction),this.values.interaction.setActive(!1),this.render()},setActive:function(a){f.Maps.Tool.prototype.setActive.apply(this,[a]),this.values.active?this.values.interaction&&this.values.interaction.setActive(!0):this.values.interaction&&this.values.interaction.setActive(!1)},getFeature:function(){return this.values.feature},clear:function(){this.values.overlay.getFeatures().clear(),this.values.feature=null}});var m=function(a){if(!this.isBusy()&&this.getActive()){var b,d,g=1;this.clearSelection();var h=[];this.values.map.forEachFeatureAtPixel(a.pixel,function(a,d){d&&d instanceof c.layer.Vector&&(a=a.clone(),a.id=g,h.push(a),b++)},this);var i=this.values.resources.getSelectedLayers(),j=this.values.resources.getQueryableResources(),k=[],l=[];for(b=0;b<i.length;b++)for(d=0;d<j.length;d++)if(i[b].resource_id==j[d].wms){l.push(j[d].table),k.push(j[d].template);break}var m={type:"Point",coordinates:a.coordinate};if(l.length>0){this.suspendUI();var n=this.values.query;for(n.reset().format(e.Data.Format.GeoJSON),b=0;b<l.length;b++)n.resource(l[b]).distanceLessOrEqual(m,{resource:l[b],name:"the_geom"},this.values.map.getView().getResolution()*this.values.buffer),b<l.length-1&&n.queue();n.execute({success:function(a){if(a.success){for(var b=new c.format.GeoJSON,d=0;d<a.data.length;d++)if(a.data[d].features.length>0){for(var e=0;e<a.data[d].features.length;e++)a.data[d].features[e].id=g,g++,a.data[d].features[e].properties.__template__=k[d];var i=b.readFeatures(a.data[d],{dataProjection:f.Maps.CRS.Mercator,featureProjection:f.Maps.CRS.Mercator});this.values.features.extend(i)}h.length>0&&this.values.features.extend(h),this.values.overlay.setFeatures(this.values.features),this.setFeatureFocus(0),this.trigger("selection:changed",{sender:this,features:this.getFeatures()})}this.resumeUI()},context:this})}else h.length>0&&(this.values.features.extend(h),this.values.overlay.setFeatures(this.values.features),this.setFeatureFocus(0),this.trigger("selection:changed",{sender:this,features:this.getFeatures()}))}};f.Maps.SelectTool=f.Class(f.Maps.Tool,{initialize:function(a){f.extend(this.values,{map:null,resources:null,endpoint:null,buffer:3,centerOnSelection:!1}),"function"==typeof f.Maps.Tool.prototype.initialize&&f.Maps.Tool.prototype.initialize.apply(this,arguments),this.values.element=this.values.name,this.event("selection:changed"),this.values.query=new e.Data.Query(this.values.endpoint),this.values.features=new c.Collection,this.values.focus=null,this.values.buffer<0&&(this.values.buffer=2),this.values.tooltip=null,this.values.styles={select:[new c.style.Style({fill:new c.style.Fill({color:[255,255,255,.4]}),stroke:new c.style.Stroke({color:"#F39C12",width:3})}),new c.style.Style({image:new c.style.Circle({radius:6,fill:new c.style.Fill({color:[255,255,255,.7]}),stroke:new c.style.Stroke({color:"#F39C12",width:2})}),zIndex:1/0})],focus:[new c.style.Style({fill:new c.style.Fill({color:[255,255,255,.4]}),stroke:new c.style.Stroke({color:"#C0392B",width:3})}),new c.style.Style({image:new c.style.Circle({radius:6,fill:new c.style.Fill({color:[255,255,255,.7]}),stroke:new c.style.Stroke({color:"#C0392B",width:2})}),zIndex:1/0})]},this.values.overlay=new c.FeatureOverlay({style:this.values.styles.select}),this.render()},setActive:function(a){f.Maps.Tool.prototype.setActive.apply(this,[a]),this.values.active?(this.values.map.on("click",m,this),this.values.overlay.setMap(this.values.map)):(this.values.map.un("click",m,this),this.values.overlay.setMap(null),this.values.tooltip&&this.values.map.removeOverlay(this.values.tooltip),this.values.overlay.getFeatures().clear())},getFeatures:function(){return this.values.features.getArray()},isBusy:function(){return b("#"+this.values.element).hasClass("busy")},suspendUI:function(){b("#"+this.values.element).hasClass("busy")||b("#"+this.values.element).addClass("tool-wapper-action busy").append('<div class="action-executing"><img style="" src="content/images/app/ajax-loader.gif"></div>')},resumeUI:function(){b("#"+this.values.element).find(".action-executing").remove(),b("#"+this.values.element).removeClass("tool-wapper-action busy")},clearFeatureFocus:function(){this.values.focus&&(this.values.focus.feature.setStyle(this.values.styles.select),this.values.focus=null,this.values.tooltip&&this.values.map.removeOverlay(this.values.tooltip))},setFeatureFocus:function(a){var d,e=this;if(this.values.focus){if(this.values.focus.index==a)return!0;this.clearFeatureFocus()}var g=this.getFeatures();if(0===g.length)return!1;0>a&&(a=0),a>=g.length&&(a=g.length-1);var h=g[a],i=h.getGeometry();this.values.focus={feature:h,index:a},h.setStyle(this.values.styles.focus);var j=[];j.push('<div id="'+this.values.element+'-popup" class="popover top feature-popup" tabIndex="1">'),j.push('<div class="arrow"></div>'),j.push('<div class="clearfix popover-title" id="popover-top">'),j.push('<div  id="'+this.values.element+'-popup-close" style="width: 18px; 1px 4px 0px 0px; float: left;">'),j.push('<span class="glyphicon glyphicon-remove icon-alert" style="cursor: pointer;"></span>'),j.push("</div>"),j.push('<div style="float: left;" data-i18n-id="tool.select.dialog.title">'+f.i18n.getResource("tool.select.dialog.title")+"</div>"),g.length>1&&(j.push('<div style="float: right;"><img id="'+this.values.element+'-next" class="img-20" src="content/images/app/next.svg"></div>'),j.push('<div style="float: right; font-size: 0.9em; padding-top: 2px;">'+(a+1)+"</div>"),j.push('<div style="float: right;"><img id="'+this.values.element+'-prev" class="img-20" src="content/images/app/previous.svg"></div>')),j.push("</div>"),j.push('<div class="popover-content">'),j.push('<div style="max-height: 190px; overflow: auto;">');var k=h.getKeys();if(-1!==b.inArray("__template__",k)&&h.get("__template__")){var l=h.get("__template__");for(d=0;d<k.length;d++){var m=new RegExp("%\\("+k[d]+"\\)s","g");l=l.replace(m,h.get(k[d])?h.get(k[d]):"")}j.push(l)}else{for(j.push('<div class="feature-table"><table style="width: 100%;">'),d=0;d<k.length;d++)k[d]!=h.getGeometryName()&&"__template__"!=k[d]&&j.push('<tr class="feature-row"><td class="feature-prop-key">'+k[d]+'</td><td class="feature-prop-value">'+(h.get(k[d])?h.get(k[d]):"")+"</td></tr>");j.push("</table></div>")}j.push("</div>"),j.push("</div>"),j.push("</div>"),b("body").append(j.join("")),g.length>1&&(b("#"+this.values.element+"-prev").click(function(){return e.setFeatureFocusPrevious()}),b("#"+this.values.element+"-next").click(function(){return e.setFeatureFocusNext()})),b("#"+this.values.element+"-popup-close").click(function(){e.clearSelection()});var o=b("#"+this.values.element+"-popup");this.values.tooltip=new c.Overlay({element:o[0],offset:[-o.outerWidth()/2,-o.outerHeight()],positioning:"bottom-center"}),this.values.map.addOverlay(this.values.tooltip);var p=n(i);return p&&(this.values.tooltip.setPosition(p),this.values.centerOnSelection&&this.values.map.getView().setCenter(p)),b("#"+this.values.element+"-popup").on("keydown",function(a){27==a.keyCode&&e.clearSelection()}),b("#"+this.values.element+"-popup").focus(),!0},setFeatureFocusPrevious:function(){this.values.focus&&this.values.focus.index>0?this.setFeatureFocus(this.values.focus.index-1):this.setFeatureFocus(0)},setFeatureFocusNext:function(){var a=this.getFeatures();return 0===a.length?!1:this.values.focus&&this.values.focus.index<a.length-2?this.setFeatureFocus(this.values.focus.index+1):this.setFeatureFocus(a.length-1)},clearSelection:function(){this.clearFeatureFocus(),this.values.overlay.getFeatures().clear(),this.values.features=new c.Collection},clear:function(){this.clearSelection()}});var n=function(a){var b,d,e,f;if(a instanceof c.geom.Polygon)e=a.getInteriorPoint().getCoordinates();else if(a instanceof c.geom.MultiPolygon){for(var g=a.getPolygons(),h=g[0],i=1;i<g.length;i++)h.getArea()<g[i].getArea()&&(h=g[i]);e=h.getInteriorPoint().getCoordinates()}else if(a instanceof c.geom.Point)e=a.getCoordinates();else{var j=a;a instanceof c.geom.MultiLineString&&(f=Math.floor(a.getLineStrings().length/2),j=a.getLineString(f),extent=a.getExtent());var k=j.getCoordinates();f=Math.floor(k.length/2),e=[0,0],b=k[f-1],d=k[f],e[0]=(d[0]+b[0])/2,e[1]=(d[1]+b[1])/2}return e};f.Maps.TextSearch=f.Class(f.Maps.Component,{initialize:function(a){var d=this;f.extend(this.values,{map:null,endpoint:null}),"function"==typeof f.Maps.Component.prototype.initialize&&f.Maps.Component.prototype.initialize.apply(this,arguments),this.event("selection:changed"),this.values.selection=null,this.values.feature=null,this.values.tooltip=null,this.values.overlay=new c.FeatureOverlay({style:[new c.style.Style({fill:new c.style.Fill({color:[255,255,255,.4]}),stroke:new c.style.Stroke({color:"#3399CC",width:2})}),new c.style.Style({image:new c.style.Circle({radius:6,fill:new c.style.Fill({color:[255,255,255,.4]}),stroke:new c.style.Stroke({color:"#3399CC",width:1})}),zIndex:1/0})]}),this.values.overlay.setMap(this.values.map);var e=new Bloodhound({datumTokenizer:Bloodhound.tokenizers.obj.whitespace("name"),queryTokenizer:Bloodhound.tokenizers.whitespace,remote:{url:this.values.endpoint+"search/query?term=%QUERY&limit=10",replace:function(){for(var a=d.values.endpoint+"search/query?term="+b("#"+d.values.element).val()+"&limit=10",c=d.values.resources.getSelectedLayers(),e=d.values.resources.getQueryableResources(),f=[],g=0;g<c.length;g++)for(var h=0;h<e.length;h++)if(c[g].resource_id==e[h].wms){f.push(c[g].resource_id);break}return a=a+"&resources="+f.join(",")},transform:function(a){return b.map(a,function(a){return{name:a.properties.dd_default_field,object:a}})}}}),g=function(a){if(d.removeTooltip(),a&&a.geometry){d.values.selection=a;var e=new c.format.GeoJSON,g=e.readGeometry(a.geometry,{dataProjection:f.Maps.CRS.Mercator,featureProjection:f.Maps.CRS.Mercator});d.values.feature=new c.Feature({name:"selection",geometry:g});var h=n(g),i=!1,j=null;g instanceof c.geom.Point||(i=!0,j=g.getExtent()),i&&d.values.overlay.addFeature(d.values.feature);var k=[];k.push('<div id="'+d.values.element+'-popup" class="popover top text-search '+(i?"tooltip-popup-inactive":"tooltip-popup")+'" tabIndex="1">'),k.push('<div class="arrow"></div>'),k.push('<div class="popover-content">'),k.push('<div style="max-height: 190px; overflow: auto;"><div class="feature-table">'),k.push('<table style="width: 100%;"><tr class=""><td class="text-search tooltip-prop-value">'+a.properties.dd_default_suggest+"</td>"),k.push('<td id="'+d.values.element+'-popup-close" style="width: 18px; vertical-align: top; padding-left: 6px;">'),k.push('<span class="glyphicon glyphicon-remove icon-alert" style="cursor: pointer;"></span></td>'),k.push("</tr></table>"),k.push("</div></div>"),k.push("</div>"),k.push("</div>"),b("body").append(k.join("")),b("#"+d.values.element+"-popup-close").click(function(){d.removeTooltip()}),b("#"+d.values.element+"-popup").on("keydown",function(a){27==a.keyCode&&d.removeTooltip()});var l=b("#"+d.values.element+"-popup");if(d.values.tooltip=new c.Overlay({element:l[0],offset:[-l.outerWidth()/2,-l.outerHeight()],positioning:"bottom-center"}),d.values.map.addOverlay(d.values.tooltip),d.values.tooltip.setPosition(h),j){var m=d.values.map.getView(),o=d.values.map.getSize();m.fitExtent(j,o)}else d.values.map.getView().setCenter(h),d.values.map.getView().setZoom(17);b("#"+d.values.element+"-popup").focus()}},h=function(a,c){d.removeTooltip(),b("#"+d.values.element).val(""),c&&(g(c.object),d.trigger("selection:changed",{selection:c.object})),b("#"+d.values.element).typeahead("val","")};b("#"+this.values.element).typeahead({hint:!0,highlight:!0,minLength:3},{name:"location-search",source:e,display:function(a){return a.object.properties.dd_default_text},templates:{suggestion:function(a){return"<div>"+a.object.properties.dd_default_suggest+"</div>"}}}).bind("typeahead:select",h),this.render()},getFeature:function(){return this.values.feature},removeTooltip:function(){this.values.overlay&&this.values.overlay.getFeatures().clear(),this.values.tooltip&&this.values.map.removeOverlay(this.values.tooltip),this.values.selection=null,this.values.feature=null,this.values.tooltip=null},clear:function(){this.removeTooltip()}}),f.Maps.Action=f.Class(f.Maps.Component,{initialize:function(a){f.extend(this.values,{name:null,image:"",title:null,visible:!1,"class":"btn-primary"}),"function"==typeof f.Maps.Component.prototype.initialize&&f.Maps.Component.prototype.initialize.apply(this,arguments),this.event("action:execute"),this.render()},render:function(){var a=this,c=[];c.push('<a data-action="'+this.values.name+'" class="tool-action btn '+this.values["class"]+'" data-i18n-id="'+this.values.title+'" data-i18n-type="title" title="'+(f.i18n.getResource(this.values.title)||"")+'">'),c.push('<img class="img-20" src="'+this.values.image+'">'),c.push("</a>"),b("#"+this.values.element).addClass("tool-wapper-action").html(c.join("")),b("#"+this.values.element).find("a").tooltip(),b("#"+this.values.element).find("a").click(function(){"function"==typeof a.execute&&a.execute(),a.trigger("action:execute",{name:a.values.name})}),this.values.visible||b("#"+this.values.element).hide()},isBusy:function(){return b("#"+this.values.element).hasClass("busy")},suspendUI:function(){b("#"+this.values.element).hasClass("busy")||b("#"+this.values.element).addClass("busy").append('<div class="action-executing"><img style="" src="content/images/app/ajax-loader.gif"></div>')},resumeUI:function(){b("#"+this.values.element).removeClass("busy"),b("#"+this.values.element).find(".action-executing").remove()}});var o=2100;f.Maps.Dialog=f.Class(f.Maps.Component,{initialize:function(a){f.extend(this.values,{image:"",title:null,visible:!1,width:600,height:400,buttons:{},closeOnEscape:!0,autofit:!1}),"function"==typeof f.Maps.Component.prototype.initialize&&f.Maps.Component.prototype.initialize.apply(this,arguments),this.values.positionInitialized=!1,this.event("dialog:close"),this.event("dialog:action"),this.event("dialog:show"),this.render()},render:function(){var a=this;b("#"+this.values.element).remove();var c=[];if(o++,c.push('<div id="'+this.values.element+'" class="modal-dialog" style="z-index: '+o+"; width: "+(this.values.width||600)+'px; outline: none; position: absolute;" tabIndex="1">'),c.push('<div class="modal-content">'),c.push('<div class="modal-header">'),c.push('<button id="'+this.values.element+'-close" type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>'),c.push('<h4 class="modal-title" data-i18n-id="'+this.values.title+'">'+f.i18n.getResource(this.values.title)+"</h4>"),c.push("</div>"),c.push('<div class="modal-body" style="text-align: justify; max-height: '+(this.values.height||400)+"px; overflow: "+(this.values.autofit?"unset":"auto")+'" >'),"function"==typeof this.values.renderContent&&(c=c.concat(this.values.renderContent())),c.push("</div>"),c.push('<div class="modal-footer">'),"function"==typeof this.values.renderFooter&&(c=c.concat(this.values.renderFooter())),this.values.buttons)for(var d in this.values.buttons)this.values.buttons[d].style=this.values.buttons[d].style||"default",c.push('<button type="button" class="btn btn-'+this.values.buttons[d].style+'" data-i18n-id="'+this.values.buttons[d].text+'" data-action="'+d+'">'+f.i18n.getResource(this.values.buttons[d].text)+"</button>");c.push("</div>"),c.push("</div>"),c.push("</div>"),c.push("</div>");var e=b(".dialog-container").first();if(0===e.length)throw"Dialog container does not exist.";e.append(c.join("")),b("#"+this.values.element).draggable({handle:".modal-header",containment:"parent"}),b("#"+this.values.element).on("click."+this.values.element,"button",function(){a.trigger("dialog:action",{sender:a,action:b(this).data("action")})}),b("#"+this.values.element+"-close").click(function(b){a.hide(),a.trigger("dialog:close",{sender:a})}),this.values.visible?this.show():this.hide(),b("#"+this.values.element).on("keydown",function(b){a.values.closeOnEscape&&27==b.keyCode&&(a.hide(),a.trigger("dialog:close",{sender:a}))})},moveToFront:function(){var a=b("#"+this.values.element),c=a.zIndex(),d=null,e=c;b(".modal-dialog").each(function(a,c){var f=b(c).zIndex();f>e&&(e=f,d=c)}),d&&(b(d).zIndex(c),b(a).zIndex(e))},show:function(){f.Maps.Component.prototype.show.apply(this,arguments),this.values.positionInitialized||(this.values.positionInitialized=!0,this.moveToCenter()),this.moveToFront(),this.trigger("dialog:show",{sender:this}),b("#"+this.values.element).focus()},moveTo:function(a,c){b("#"+this.values.element).offset({top:c,left:a})},moveToCenter:function(){b("#"+this.values.element).offset({top:(b(window).height()-b("#"+this.values.element).height())/2,left:(b(window).width()-b("#"+this.values.element).width())/2})},setTitle:function(a){b("#"+this.values.element).find(".modal-title").html(a)},setContent:function(a){b("#"+this.values.element).find(".modal-body").html(a)}});var p=function(a){if(a.success){this.values.page.data=a.data[0].records;var b,c,d=this.values.page.data,e=[];if(e.push('<div class="clearfix" style="overflow: scroll; max-height: '+(this.values.height-100)+'px;"><table class="table table-striped data-table">'),d.length>0){e.push("<thead>"),e.push("<tr>");for(b in d[0])b!==this.values.geometryName&&e.push("<th>"+b+"</th>");e.push("</tr>"),e.push("</thead>"),e.push("<tbody>");var f=this.values.page.size;for(f>d.length&&(f=d.length),c=0;f>c;c++){e.push("<tr>");for(b in d[c])b!==this.values.geometryName&&e.push("<td>"+(d[c][b]?d[c][b]:"")+"</td>");e.push("</tr>")}e.push("</tbody>")}e.push("</table><div>"),this.setContent(e.join("")),this.show()}},q=function(){var a=this.values.query;a.reset(),a.resource(this.values.table).format(e.Data.Format.JSON).skip(this.values.page.index*this.values.page.size).take(this.values.page.size+1).execute(p,this)};f.Maps.DialogTableBrowser=f.Class(f.Maps.Dialog,{initialize:function(a){f.extend(this.values,{table:null,endpoint:null}),"function"==typeof f.Maps.Dialog.prototype.initialize&&f.Maps.Dialog.prototype.initialize.apply(this,arguments),this.values.query=new e.Data.Query(this.values.endpoint),this.values.page={index:0,size:10,data:null},this.values.geometryName="the_geom",this.event("page:next"),this.event("page:previous"),this.event("page:refresh"),this.event("row:changed"),this.render()},render:function(){f.Maps.Dialog.prototype.render.apply(this)},getNextPage:function(){this.values.page.index=this.values.page.index+1,q.apply(this)},getPrevPage:function(){this.values.page.index>0&&(this.values.page.index=this.values.page.index-1),q.apply(this)},getPage:function(a){
0>a?this.values.page.index=0:this.values.page.index=a,q.apply(this)},setTable:function(a){this.values.page.index=0,this.values.table=a},getGeometryName:function(){return this.values.geometryName},getPageIndex:function(){return this.values.page.index}}),f.Maps.ImportWmsTool=f.Class(f.Maps.Action,{initialize:function(a){var c=this;"function"==typeof f.Maps.Action.prototype.initialize&&f.Maps.Action.prototype.initialize.apply(this,arguments),this.event("metadata:loaded"),this.event("layer:added"),this.values.dialog=new f.Maps.Dialog({title:"action.import-wms.title",element:this.values.element+"-dialog",visible:!1,width:430,height:280,autofit:!1,buttons:{close:{text:"button.close",style:"primary"}},renderContent:function(){var a=[];return a.push('<div class="clearfix" style="padding-bottom: 10px;">'),a.push('<div class="input-group">'),a.push('<span class="input-group-addon">'),a.push('<span class="glyphicon glyphicon-link"></span>'),a.push("</span>"),a.push('<input id="'+c.values.element+'-endpoint" value="" type="text" class="form-control" data-i18n-id="action.import-wms.url.placeholder" data-i18n-type="attribute" data-i18n-name="placeholder" placeholder="Διεύθυνση WMS ...">'),a.push('<span class="input-group-btn">'),a.push('<button id="'+c.values.element+'-btn-metadata" class="btn btn-default" type="button">'),a.push('<span class="glyphicon glyphicon-search"></span>'),a.push("</button>"),a.push("</span>"),a.push("</div>"),a.push("</div>"),a.push('<div class="clearfix" style="max-height: 200px; overflow: auto;">'),a.push('<div id="'+c.values.element+'-layers" class="clearfix" style="padding: 0 4px 0 0;"></div>'),a.push("</div>"),a.push('<div class="clearfix"  id="'+c.values.element+'-error"></div>'),a}}),b("#"+this.values.element+"-layers").on("click."+this.values.element,".list-group-item-button",function(){var a=b(this).data("index"),d=c.values.metadata.key+"_"+c.values.metadata.layers[a].key;c.trigger("layer:added",{metadata:c.values.metadata,id:d})}),b("#"+this.values.element+"-btn-metadata").click(function(){c.values.metadata=null,b("#"+c.values.element+"-layers").html(""),b("#"+c.values.element+"-error").html(""),c.values.resources.getResourceMetadata(f.Maps.Resources.Types.WMS,{url:b("#"+c.values.element+"-endpoint").val()}).then(function(a){c.values.metadata=a;var d=[];if(a&&a.layers.length>0){d.push('<ul class="list-group">');for(var e=0,f=a.layers.length;f>e;e++)d.push('<li class="list-group-item">'+a.layers[e].title+'<span class="list-group-item-button" data-index="'+e+'"><span class="glyphicon glyphicon-plus"></span><span></span></span></li>');d.push("</ul>")}b("#"+c.values.element+"-layers").html(d.join("")),c.trigger("metadata:loaded",{metadata:a})},function(a){b("#"+c.values.element+"-error").append('<div class="alert alert-danger" role="alert" data-i18n-id="action.import-wms.error.metadata">'+f.i18n.getResource("action.import-wms.error.metadata")+"</div>")})}),this.values.dialog.on("dialog:action",function(a){switch(a.action){case"close":this.hide()}}),this.render()},execute:function(){this.values.dialog.show()}}),f.Maps.UploadFileTool=f.Class(f.Maps.Action,{initialize:function(a){var c=this;"function"==typeof f.Maps.Action.prototype.initialize&&f.Maps.Action.prototype.initialize.apply(this,arguments),this.event("resource:loaded"),this.values.dialog=new f.Maps.Dialog({title:"action.upload-resource.title",element:this.values.element+"-dialog",visible:!1,width:430,height:280,autofit:!0,buttons:{close:{text:"button.close",style:"primary"}},renderContent:function(){var a=[];return a.push('<div class="clearfix form-inline" style="padding-bottom: 10px;">'),a.push('<label for="'+c.values.element+'-title" style="padding-right: 10px; width: 145px;" data-i18n-id="control.upload.dialog.label.title">'+f.i18n.getResource("control.upload.dialog.label.title")+"</label>"),a.push('<input id="'+c.values.element+'-title" class="form-control input-md" type="text" style="width: 250px;" value="'+f.i18n.getResource("control.upload.dialog.default.title")+'">'),a.push("</div>"),a.push('<div class="clearfix" style="padding-bottom: 10px;">'),a.push('<label for="'+c.values.element+'-format" style="padding-right: 10px; width: 145px;" data-i18n-id="control.upload.dialog.label.format">'+f.i18n.getResource("control.upload.dialog.label.format")+"</label>"),a.push('<select name="'+c.values.element+'-format" id="'+c.values.element+'-format" autocomplete="off" class="selectpicker" data-width="250px">'),a.push('<option value="GML">GML</option>'),a.push('<option value="KML" selected>KML</option>'),a.push('<option value="ESRI Shapefile">ESRI Shapefile (compressed file)</option>'),a.push('<option value="GeoJSON">GeoJSON</option>'),a.push('<option value="DXF">AutoCAD DXF</option>'),a.push('<option value="CSV">Comma Separated Values</option>'),a.push("</select>"),a.push("</div>"),a.push('<div id="'+c.values.element+'-info" class="clearfix alert alert-info" role="alert" style="margin: 0px 4px 11px 0px; padding: 7px !important; display: none">'),a.push('<span data-i18n-id="control.upload.dialog.info">'+f.i18n.getResource("control.upload.dialog.info")+"</label>"),a.push("</div>"),a.push('<div class="clearfix" style="padding-bottom: 10px;">'),a.push('<label for="'+c.values.element+'-crs" style="padding-right: 10px; width: 145px;" data-i18n-id="control.upload.dialog.label.crs">'+f.i18n.getResource("control.upload.dialog.label.crs")+"</label>"),a.push('<select name="'+c.values.element+'-crs" id="'+c.values.element+'-crs" class="selectpicker" data-width="160px" disabled>'),a.push('<option value="EPSG:3857">Web Mercator</option>'),a.push('<option value="EPSG:4326" selected>WGS84</option>'),a.push('<option value="EPSG:2100">ΕΓΣΑ87</option>'),a.push('<option value="EPSG:4258">ETRS89</option>'),a.push("</select>"),a.push("</div>"),a.push('<div class="clearfix"  id="'+c.values.element+'-error"></div>'),a},renderFooter:function(){var a=[];return a.push('<span class="btn btn-success fileinput-button">'),a.push('<i class="glyphicon glyphicon-upload"></i>'),a.push('<span data-i18n-id="action.upload-resource.select-file" style="padding-left: 10px;">'+f.i18n.getResource("action.upload-resource.select-file")+"</span>"),a.push('<input id="'+c.values.element+'-fileupload" type="file" name="files[]" multiple>'),a.push("</span>"),a}}),b("#"+this.values.element+"-format").selectpicker().change(function(){b('[data-id="'+c.values.element+'-format"]').blur();var a=b("#"+c.values.element+"-format").val();b("#"+c.values.element+"-info").hide(),"KML"==a?b("#"+c.values.element+"-crs").val("EPSG:4326").prop("disabled",!0).selectpicker("refresh"):"CSV"==a?b("#"+c.values.element+"-info").show():b("#"+c.values.element+"-crs").prop("disabled",!1).selectpicker("refresh")}),b("#"+this.values.element+"-crs").selectpicker().change(function(){b('[data-id="'+c.values.element+'-crs"]').blur(),"KML"==b("#"+c.values.element+"-format").val()&&"EPSG:4326"!=b("#"+c.values.element+"-crs").val()&&b("#"+c.values.element+"-crs").val("EPSG:4326").selectpicker("refresh")}),b("#"+this.values.element+"-fileupload").fileupload({url:this.values.endpoint+"upload/upload_resource",dataType:"json",done:function(a,d){b.each(d.result.files,function(a,d){if(d.error)switch(d.error){case"minFileSize":case"maxFileSize":case"acceptFileTypes":case"invalidContent":case"conversionFailed":case"crsNotSupported":case"acceptFileFormats":b("#"+c.values.element+"-error").html("").append('<div class="alert alert-danger" role="alert" data-i18n-id="action.upload-resource.error.'+d.error+'">'+f.i18n.getResource("action.upload-resource.error."+d.error)+"</div>");break;default:b("#"+c.values.element+"-error").html("").append('<div class="alert alert-danger" role="alert" data-i18n-id="action.upload-resource.error.unknown">'+f.i18n.getResource("action.upload-resource.error.unknown")+"</div>")}else{var e=b("#"+c.values.element+"-format").val();("ESRI Shapefile"==e||"DXF"==e||"CSV"==e)&&(e="geojson"),c.trigger("resource:loaded",{id:"remote_"+d.url,title:b("#"+c.values.element+"-title").val()||d.name.split(".")[0],format:e,name:d.name,type:d.type,text:null,url:d.url,projection:b("#"+c.values.element+"-crs").val()})}})},submit:function(a,d){d.formData={format:b("#"+c.values.element+"-format").val(),crs:b("#"+c.values.element+"-crs").val()}},add:function(a,d){b("#"+c.values.element+"-error").html("");var e=/(\.|\/)(gml|kml|geojson|json|zip|dxf|csv)$/i,g=/(\.|\/)(gml|kml|geojson|json)$/i,h=!0;b("#"+c.values.element+"-format").val();b.each(d.files,function(a,d){d.name.split(".").pop();if(e.test(d.name)){if(window.File&&window.FileReader&&g.test(d.name)){var i=new FileReader,j=b("#"+c.values.element+"-format").val();("ESRI Shapefile"==j||"DXF"==j||"CSV"==j)&&(j="geojson"),i.onload=function(a){c.trigger("resource:loaded",{id:"local_"+d.name,title:b("#"+c.values.element+"-title").val()||d.name.split(".")[0],format:j,name:d.name,type:d.type,text:i.result,url:null,projection:b("#"+c.values.element+"-crs").val()})},i.readAsText(d),h=!1}}else b("#"+c.values.element+"-error").html("").append('<div class="alert alert-danger" role="alert" data-i18n-id="action.upload-resource.error.acceptFileTypes">'+f.i18n.getResource("action.upload-resource.error.acceptFileTypes")+"</div>"),h=!1}),h&&d.submit()},fail:function(a,d){b("#"+c.values.element+"-error").html("").append('<div class="alert alert-danger" role="alert" data-i18n-id="action.upload-resource.error.unknown">'+f.i18n.getResource("action.upload-resource.error.unknown")+"</div>")}}),this.values.dialog.on("dialog:action",function(a){switch(a.action){case"close":this.hide()}}),this.render()},execute:function(){this.values.dialog.show(),b("#"+this.values.element+"-title").focus().select()}}),f.Maps.PositionTool=f.Class(f.Maps.Action,{initialize:function(a){var d=this;"function"==typeof f.Maps.Action.prototype.initialize&&f.Maps.Action.prototype.initialize.apply(this,arguments),this.event("position:changed"),this.values.dialog=new f.Maps.Dialog({title:"action.set-position.title",element:this.values.element+"-dialog",visible:!1,width:350,height:280,autofit:!0,buttons:{update:{text:"control.set-position.dialog.button.move",style:"primary"},close:{text:"button.close",style:"default"}},renderContent:function(){var a=[];return a.push('<div class="clearfix form-inline" style="padding-bottom: 10px;">'),a.push('<label for="'+d.values.element+'-crs" style="padding-right: 10px; width: 150px;" data-i18n-id="control.set-position.dialog.label.crs">'+f.i18n.getResource("control.set-position.dialog.label.crs")+"</label>"),a.push('<span id="'+d.values.element+'-crs" style="padding-right: 10px; width: 130px;">'+d.projectionToString()+"</span>"),a.push("</div>"),a.push('<div class="clearfix form-inline" style="padding-bottom: 10px;">'),a.push('<label for="'+d.values.element+'-x" style="padding-right: 10px; width: 150px;" data-i18n-id="control.set-position.dialog.label.x">'+f.i18n.getResource("control.set-position.dialog.label.x")+"</label>"),a.push('<input id="'+d.values.element+'-x" class="form-control input-md" type="text" style="width: 150px;">'),a.push("</div>"),a.push('<div class="clearfix form-inline" style="padding-bottom: 10px;">'),a.push('<label for="'+d.values.element+'-y" style="padding-right: 10px; width: 150px;" data-i18n-id="control.set-position.dialog.label.y">'+f.i18n.getResource("control.set-position.dialog.label.y")+"</label>"),a.push('<input id="'+d.values.element+'-y" class="form-control input-md" type="text" style="width: 150px;">'),a.push("</div>"),a.push('<div class="clearfix"  id="'+d.values.element+'-error"></div>'),a}}),b("#"+this.values.element+"-x, #"+this.values.element+"-y").change(function(){var a=parseFloat(this.value);isNaN(a)?this.value="":this.value=a.toFixed(4)});var e=function(a,b){a.getGeometry();return[new c.style.Style({zIndex:1/0,image:new c.style.Icon({anchor:[15,28],anchorXUnits:"pixels",anchorYUnits:"pixels",src:"content/images/app/map-pin.svg"}),text:new c.style.Text({textAlign:"center",font:"10pt Tahoma,Arial Normal",text:a.get("label")||"",fill:new c.style.Fill({color:"black"}),offsetX:0,offsetY:20})})]};this.values.overlay=new c.FeatureOverlay({style:e}),this.values.overlay.setMap(this.values.map),this.values.dialog.on("dialog:show",function(a){var e=d.values.map.getView().getCenter();e=c.proj.transform(e,"EPSG:3857",d.values.projection),b("#"+d.values.element+"-x").val(e[0].toFixed(4)),b("#"+d.values.element+"-y").val(e[1].toFixed(4))}),this.values.dialog.on("dialog:action",function(a){switch(a.action){case"update":var b=d.getPosition();b&&(d.addPinToPosition(),b=c.proj.transform(b,d.values.projection,f.Maps.CRS.Mercator),d.values.map.getView().setCenter(b));break;case"close":this.hide()}}),this.render()},execute:function(){this.values.dialog.show(),this.values.dialog.moveTo(310,65)},getPosition:function(){if(this.values.projection){var a=parseFloat(parseFloat(b("#"+this.values.element+"-x").val()).toFixed(4)),c=parseFloat(parseFloat(b("#"+this.values.element+"-y").val()).toFixed(4));if(!isNaN(a)&&!isNaN(c))return[a,c]}return null},setPosition:function(a){a&&(b("#"+this.values.element+"-x").val(a[0].toFixed(4)),b("#"+this.values.element+"-y").val(a[1].toFixed(4)))},projectionToString:function(){var a=this.values.projection.getCode();switch(a){case"EPSG:3857":return"Web Mercator";case"EPSG:4326":return"WGS84";case"EPSG:2100":return"ΕΓΣΑ87";case"EPSG:4258":return"ETRS89"}return a},setProjection:function(a){var d=this.getPosition();d&&(d=c.proj.transform(d,this.values.projection,a),this.values.projection=a,this.setPosition(d)),b("#"+this.values.element+"-crs").html(this.projectionToString())},clear:function(){this.values.overlay.getFeatures().clear()},addPinToPosition:function(){var a=this.getPosition(),b=[a[0],a[1]];this.values.projection.getCode()!=f.Maps.CRS.Mercator&&(b=c.proj.transform(a,this.values.projection,f.Maps.CRS.Mercator));var d=new c.geom.Point(b),e="",g=new c.Feature({name:"point-"+this.values.overlay.getFeatures().getLength(),label:e,geometry:d});this.values.overlay.getFeatures().insertAt(0,g)}}),f.Maps.PermalinkTool=f.Class(f.Maps.Action,{initialize:function(a){var c=this;a.mode=a.mode||f.Maps.PermalinkTool.Mode.Link,"function"==typeof f.Maps.Action.prototype.initialize&&f.Maps.Action.prototype.initialize.apply(this,arguments),this.values.dialog=new f.Maps.Dialog({title:a.mode==f.Maps.PermalinkTool.Mode.Link?"action.create-link.title":"action.create-link-embed.title",element:this.values.element+"-dialog",visible:!1,width:500,height:280,autofit:!0,buttons:{close:{text:"button.close",style:"default"}},renderContent:function(){var a=[];switch(c.values.mode){case f.Maps.PermalinkTool.Mode.Link:a.push('<div class="clearfix" style="padding-bottom: 10px;">'),a.push('<div class="input-group">'),a.push('<input readonly id="'+c.values.element+'-link" value="" type="text" class="form-control" data-i18n-id="action.create-link.link.placeholder" data-i18n-type="attribute" data-i18n-name="placeholder" placeholder="" style="background: white;">'),a.push('<span class="input-group-btn">'),a.push('<button id="'+c.values.element+'-btn-copy" class="btn btn-default" type="button">'),a.push('<span class="glyphicon glyphicon-copy"></span>'),a.push("</button>"),a.push("</span>"),a.push("</div>"),a.push("</div>"),a.push('<div class="clearfix" style="max-height: 200px; overflow: auto;">'),a.push('<div id="'+c.values.element+'-layers" class="clearfix" style="padding: 0 4px 0 0;"></div>'),a.push("</div>"),a.push('<div class="clearfix" style="background: #fff5c1; border-radius: 4px; padding: 4px;" id="'+c.values.element+'-error"></div>');break;case f.Maps.PermalinkTool.Mode.Embed:a.push('<div class="clearfix" style="padding-bottom: 10px;">'),a.push('<label for="'+c.values.element+'-lib" style="padding-right: 10px; width: 115px;" data-i18n-id="action.create-link-embed.label.lib">'+f.i18n.getResource("action.create-link-embed.label.lib")+"</label>"),a.push('<select name="'+c.values.element+'-lib" id="'+c.values.element+'-lib" class="selectpicker" data-width="160px">'),a.push('<option value="leaflet" selected>LeafLet</option>'),a.push('<option value="ol">OpenLayers 3</option>'),a.push("</select>"),a.push("</div>"),a.push('<div class="clearfix" style="padding-bottom: 10px;">'),a.push('<label for="'+c.values.element+'-iframe" style="padding-right: 10px; width: 115px; float: left;" data-i18n-id="action.create-link-embed.label.code">'+f.i18n.getResource("action.create-link-embed.label.code")+"</label>"),a.push('<textarea name="'+c.values.element+'-iframe" id="'+c.values.element+'-iframe" class="form-control" rows="3" style="resize: none; width: 340px; float: left;"></textarea>'),a.push("</div>")}return a}}),b("#"+this.values.element+"-lib").selectpicker().change(function(){b('[data-id="'+c.values.element+'-lib"]').blur(),c.execute()}),b("#"+this.values.element+"-btn-copy").click(function(){b("#"+c.values.element+"-link").focus().select();var a=!1;try{a=document.execCommand("copy")}catch(d){}}),this.values.dialog.on("dialog:action",function(a){switch(a.action){case"close":this.hide()}}),this.render()},exportToJSON:function(){var a=this.values.map.get("base_layer_properties"),c=this.values.map.getLayers().getArray()[a.exists?2:1],d={zoom:this.values.map.getView().getZoom(),center:this.values.map.getView().getCenter(),base:{type:a.type,set:a.set,opacity:100*c.getOpacity()},layers:[],lib:null};this.values.mode==f.Maps.PermalinkTool.Mode.Embed&&(d.lib=b("#"+this.values.element+"-lib").val());for(var e=this.values.resources.getSelectedLayers(),g=0;g<e.length;g++){var h=e[g],i=this.values.ckan.getResourceById(h.resource_id);i&&d.layers.push({title:h.title,"package":i["package"],resource:i.id,layer:h.layer_id,opacity:h.opacity,endpoint:h.endpoint,key:h.key})}return d},execute:function(){var a=this,c=this.exportToJSON();return a.values.mode==f.Maps.PermalinkTool.Mode.Embed&&(c.lib=b("#"+a.values.element+"-lib").val()),new Promise(function(e,g){var h=new d;"/"===a.values.endpoint?h.segment(["config","save"]):h.segment([a.values.endpoint,"config","save"]);var i=null;switch(a.values.mode){case f.Maps.PermalinkTool.Mode.Link:i=function(c){if(b("#"+a.values.element+"-error").hide(),c.success){var f=new d(window.location.origin);"/"!=a.values.endpoint&&f.segment([a.values.endpoint]),f.addQuery({config:c.url}),b("#"+a.values.element+"-link").val(f.toString()),a.values.dialog.show(),b("#"+a.values.element+"-link").focus().select()}e(c)};break;case f.Maps.PermalinkTool.Mode.Embed:i=function(c){if(b("#"+a.values.element+"-error").hide(),c.success){var f=new d(window.location.origin);"/"===window.location.pathname?f.segment(["config","embed",c.url]):f.segment([window.location.pathname,"config","embed",c.url]);var g=[];g.push('<iframe style="border: none 0; padding: 0; margin: 0; width: 600px; height: 600px;" src="'),g.push(f.toString().replace(/\/\//g,"/").replace(/:\//g,"://")),g.push('" frameborder="0" scrolling="hidden"></iframe>'),b("#"+a.values.element+"-iframe").val(g.join(""))}a.values.dialog.show(),b("#"+a.values.element+"-iframe").focus(),b("#"+a.values.element+"-iframe").select(),e(c)}}b.ajax({type:"POST",url:h.toString().replace(/\/\//g,"/").replace(/:\//g,"://"),context:a,contentType:"application/json; charset=utf-8",dataType:"json",data:JSON.stringify(c)}).done(i).fail(function(a,b,d){console.log("Failed to save configuration : "+JSON.stringify(c)),g(d)})})}}),f.Maps.PermalinkTool.Mode={Link:1,Embed:2};var r=function(a,b,d){var e,g,h=[],i=[];switch(d=d||"",b){case".":e=/\s|,/;break;case",":e=/\s/}var j,k=d.split(e),l=[];for(g=0;g<k.length;g++)k[g]&&(","==b&&(k[g]=k[g].replace(",",".")),j=parseFloat(k[g]),isFinite(j)&&l.push(j));for(g=0;g<l.length;g+=2)l[g+1]&&(h.push([l[g],l[g+1]]),i.push([l[g],l[g+1]]));if(h.length>1&&(h[0][0]!=h[h.length-1][0]||h[0][1]!=h[h.length-1][1])&&(h.push([l[0],l[1]]),i.push([l[0],l[1]])),a!=f.Maps.CRS.Mercator)for(var m=0;m<i.length;m++)i[m]=c.proj.transform(i[m],a,f.Maps.CRS.Mercator);return{initial:h,transformed:i}};return f.Maps.CoordinateParser=f.Class(f.Maps.Action,{initialize:function(a){var d=this;this.values.map=null,"function"==typeof f.Maps.Action.prototype.initialize&&f.Maps.Action.prototype.initialize.apply(this,arguments),this.event("parse:completed");var e=function(a,b){a.getGeometry();return[new c.style.Style({fill:new c.style.Fill({color:[40,96,144,.4]}),stroke:new c.style.Stroke({color:"#286090",width:2})}),new c.style.Style({zIndex:1/0,image:new c.style.Icon({anchor:[15,28],anchorXUnits:"pixels",anchorYUnits:"pixels",src:"content/images/app/map-pin-filled.svg"}),text:new c.style.Text({textAlign:"center",font:"10pt Tahoma,Arial Normal",text:a.get("label")||"",fill:new c.style.Fill({color:"black"}),stroke:new c.style.Stroke({color:"white",width:2}),offsetX:0,offsetY:20})})]};this.values.overlay=new c.FeatureOverlay({style:e}),this.values.overlay.setMap(this.values.map),this.values.dialog=new f.Maps.Dialog({title:"control.parse.dialog.title",element:this.values.element+"-dialog",visible:!1,width:520,height:250,autofit:!0,buttons:{parse:{text:"control.parse.dialog.button.parse",style:"primary"},clear:{text:"control.parse.dialog.button.clear",style:"default"},close:{text:"control.parse.dialog.button.cancel",style:"default"}},renderContent:function(){var a=[];return a.push('<div class="clearfix" style="padding-bottom: 10px;">'),a.push('<label for="'+d.values.element+'-crs" style="padding-right: 10px; width: 145px;" data-i18n-id="control.parse.dialog.label.crs">'+f.i18n.getResource("control.parse.dialog.label.crs")+"</label>"),a.push('<select name="'+d.values.element+'-crs" id="'+d.values.element+'-crs" class="selectpicker" data-width="120px">'),a.push('<option value="EPSG:4326">WGS84</option>'),a.push('<option value="EPSG:2100" selected="selected">ΕΓΣΑ87</option>'),a.push("</select>"),a.push('<label for="'+d.values.element+'-delimiter" style="padding: 0px 10px;" data-i18n-id="control.parse.dialog.label.delimiter">'+f.i18n.getResource("control.parse.dialog.label.delimiter")+"</label>"),a.push('<select name="'+d.values.element+'-delimiter" id="'+d.values.element+'-delimiter" class="selectpicker" data-width="50px">'),a.push('<option value="." selected="selected">.</option>'),a.push('<option value=",">,</option>'),a.push("</select>"),a.push("</div>"),a.push('<div class="clearfix" style="padding-bottom: 10px;">'),a.push('<label for="'+d.values.element+'-text" style="padding-right: 10px; width: 145px; float: left;" data-i18n-id="control.parse.dialog.label.text">'+f.i18n.getResource("control.parse.dialog.label.text")+"</label>"),a.push('<textarea name="'+d.values.element+'-text" id="'+d.values.element+'-text" class="form-control" rows="3" style="resize: none; width: 330px; float: left;"></textarea>'),a.push("</div>"),a.push('<div class="clearfix alert alert-info" role="alert" style="margin: 0 !important; padding: 7px !important; width: 475px;">'),a.push('<span data-i18n-id="control.parse.dialog.info">'+f.i18n.getResource("control.parse.dialog.info")+"</label>"),a.push("</div>"),a}}),this.values.dialog.on("dialog:close",function(a){d.values.overlay.getFeatures().clear()}),b("#"+this.values.element+"-crs").selectpicker().change(function(){b('[data-id="'+d.values.element+'-crs"]').blur()}),b("#"+this.values.element+"-delimiter").selectpicker().change(function(){b('[data-id="'+d.values.element+'-delimiter"]').blur()}),b("#"+this.values.element+"-type").selectpicker().change(function(){b('[data-id="'+d.values.element+'-type"]').blur()}),this.values.dialog.on("dialog:action",function(a){switch(a.action){case"clear":d.clear();break;case"close":this.hide();break;case"parse":var e,f,g=r(b("#"+d.values.element+"-crs").val(),b("#"+d.values.element+"-delimiter").val(),b("#"+d.values.element+"-text").val()),h=g.initial,i=g.transformed;if(h.length>0){var j=null;if(i.length>1)for(j=[i[0][0],i[0][1],i[0][0],i[0][1]],e=1;e<i.length;e++)j[0]=Math.min(j[0],i[e][0]),j[1]=Math.min(j[1],i[e][1]),j[2]=Math.max(j[2],i[e][0]),j[3]=Math.max(j[3],i[e][1]);d.values.overlay.getFeatures().clear(),d.values.features=new c.Collection;var k=[];for(e=0;e<i.length-1;e++){k.push(i[e]);var l=new c.geom.Point(i[e]),m=h[e][0].toFixed(4)+" , "+h[e][1].toFixed(4);f=new c.Feature({name:"point-"+(e+1),label:m,geometry:l}),d.values.features.push(f)}var n=new c.geom.Polygon([k]);switch(f=new c.Feature({name:"polygo-",label:"",geometry:n}),d.values.features.insertAt(0,f),d.values.overlay.setFeatures(d.values.features),i.length){case 0:break;case 1:d.values.map.getView().setCenter(i[0]),d.values.map.getView().setZoom(17);break;default:var o=d.values.map.getView(),p=d.values.map.getSize();o.fitExtent(j,p)}}d.trigger("parse:completed",{sender:d,coordinates:g})}}),this.render()},execute:function(){this.values.dialog.show()},clear:function(){this.values.overlay.getFeatures().clear()}}),f});
//# sourceMappingURL=controls.min.js.map