/* PublicaMundi Map Client version 1.0.0 2015-11-27 */

define(["jquery","URIjs/URI","shared"],function(a,b,c){"use strict";c.define("Maps.CKAN"),c.Maps.CKAN.Metadata=c.Class(c.Maps.Observable,{initialize:function(a){this.values.path=null,this.values.endpoint=null,"function"==typeof c.Maps.Observable.prototype.initialize&&c.Maps.Observable.prototype.initialize.apply(this,arguments),this.values.catalog={groups:[],organizations:[],packages:[],nodes:[]},this.values.search={packages:[]},this.values.xhr=null},isPreloadingEnabled:function(){return this.values.metadata&&(this.values.metadata.path||this.values.metadata.database)?!0:!1},preload:function(){if(this.isPreloadingEnabled()){var c,d=this;return this.values.metadata.database?(c=new b,"/"===d.values.path?c.segment(["metadata","load"]):c.segment([d.values.path,"metadata","load"])):(c=new b(this.values.metadata.path),this.values.metadata.version&&c.addQuery({v:this.values.metadata.version})),new Promise(function(b,e){a.ajax({url:c.toString().replace(/\/\//g,"/").replace(/:\//g,"://"),context:d}).done(function(a){var c;for(d.values.catalog.nodes=a.nodes||[],d.values.catalog.organizations=a.organizations,d.values.catalog.groups=a.groups,d.values.catalog.packages=a.packages,c=0;c<d.values.catalog.organizations.length;c++)d.values.catalog.organizations[c].loaded=!0;for(c=0;c<d.values.catalog.groups.length;c++)d.values.catalog.groups[c].loaded=!0;b(a)}).fail(function(a,b,d){console.log("Failed to load CKAN organizations : "+c.toString()),e(d)})})}},getNodeById:function(a){return this.values.catalog.nodes.hasOwnProperty(a)?this.values.catalog.nodes[a]:null},isNodeEmpty:function(a){var b=this.getNodeById(a);if(b.hasOwnProperty("isEmpty"))return b.isEmpty;if(b.resources.length>0)return b.isEmpty=!1,b.isEmpty;if(0===b.children.length)return b.isEmpty=!0,b.isEmpty;b.isEmpty=!0;for(var c=0;c<b.children.length;c++){var d=this.isNodeEmpty(b.children[c]);if(!d)return b.isEmpty=!1,b.isEmpty}return b.isEmpty},filterNode:function(a,b,c){var d=this.getNodeById(a);if(!d)return!0;for(var e=0;e<d.resources.length;e++){var f=this.getResourceById(d.resources[e]);if(f.name[c].indexOf(b)>-1)return!1}if(d.children.length>0)for(var g=0;g<d.children.length;g++){var h=this.filterNode(d.children[g],b,c);if(!h)return!1}return!0},getNodes:function(){return this.values.catalog.nodes},getNodeCount:function(){return Object.keys(this.values.catalog.nodes).length},getNodeChidlren:function(a){var b=[];if(a){var c=this.getNodeById(a);for(var d in c.children)b.push(this.getNodeById(c.children[d]))}else for(var e in this.values.catalog.nodes)this.values.catalog.nodes[e].parent||b.push(this.values.catalog.nodes[e]);return b},loadOrganizations:function(){this.values.catalog.organizations=[];var c=this,d=new b(this.values.endpoint);return d.segment(["api","3","action","organization_list"]),d.addQuery({all_fields:!0}),new Promise(function(b,e){a.ajax({url:d.toString(),dataType:"jsonp",context:c}).done(function(a){a.success&&a.result&&(c.values.catalog.organizations=a.result.map(function(a,b,c){return{id:a.id,name:a.name,caption:{el:a.display_name,en:a.display_name},title:{el:a.title,en:a.title},description:{el:a.description,en:a.description},image:a.image_display_url,loaded:!1}})),b(c.values.catalog.organizations)}).fail(function(a,b,c){console.log("Failed to load CKAN organizations : "+d.toString()),e(c)})})},getOrganizations:function(){return this.values.catalog.organizations},loadGroups:function(){this.values.catalog.groups=[];var c=this,d=new b(this.values.endpoint);return d.segment(["api","3","action","group_list"]),d.addQuery({all_fields:!0}),new Promise(function(b,e){a.ajax({url:d.toString(),dataType:"jsonp",context:c}).done(function(a){a.success&&a.result&&(c.values.catalog.groups=a.result.map(function(a,b,c){return{id:a.id,name:a.name,caption:{el:a.display_name,en:a.display_name},title:{el:a.title,en:a.title},description:{el:a.description,en:a.description},image:a.image_display_url,loaded:!1}})),b(c.values.catalog.groups)}).fail(function(a,b,c){console.log("Failed to load CKAN groups : "+d.toString()),e(c)})})},getGroups:function(){return this.values.catalog.groups},isGroupEmpty:function(b){for(var c=this.getPackages(),d=0;d<c.length;d++)if(-1!==a.inArray(b,c[d].groups))return!1;return!0},isOrganizationEmpty:function(a){for(var b=this.getPackages(),c=0;c<b.length;c++)if(a===b[c].organization)return!1;return!0},filterOrganization:function(a,b,c){for(var d=this.getPackages(),e=0;e<d.length;e++)if(a===d[e].organization)for(var f=0;f<d[e].resources.length;f++)if(d[e].resources[f].name[c].indexOf(b)>-1)return!1;return!0},loadPackages:function(){this.values.catalog.packages=[];var c=this,d=new b(this.values.endpoint);return d.segment(["api","3","action","current_package_list_with_resources"]),this.values.xhr&&4!==this.values.xhr.readyState&&(this.values.xhr.abort(),this.values.xhr=null),new Promise(function(b,e){c.values.xhr=a.ajax({url:d.toString(),context:c}).done(function(a){c.values.xhr=null;var d,e,f,g,h,i;if(a.success&&a.result){var j=a.result;for(e=0;e<j.length;e++){for(d={id:j[e].id,name:j[e].name,title:{el:j[e].title,en:j[e].title},notes:{el:j[e].notes,en:j[e].notes},organization:j[e].organization.id,groups:[],resources:[],spatial:null},h=0;h<j[e].groups.length;h++)d.groups.push(j[e].groups[h].id);for(i=0;i<j[e].extras.length;i++)if("spatial"===j[e].extras[i].key){d.spatial=j[e].extras[i].value;break}for(g=0;g<j[e].resources.length;g++)f=j[e].resources[g],"wms"===f.format&&(f["package"]=d.id,f.name={el:f.name,en:f.name},f.description={el:f.description,en:f.description},d.resources.push(f));d.resources.length>0&&c.values.catalog.packages.push(d)}}b(c.values.catalog.packages)}).fail(function(a,b,c){console.log("Failed to load packages from CKAN catalog : "+d.toString()),e(c)})})},getPackages:function(){return this.values.catalog.packages},search:function(c,d){this.values.search.packages=[];var e=this,f=new b(this.values.endpoint);f.segment(["api","3","action","package_search"]);var g={};return c&&(g.q=c),d&&(g.extras={ext_bbox:d.join(",")}),this.values.xhr&&4!==this.values.xhr.readyState&&(this.values.xhr.abort(),this.values.xhr=null),new Promise(function(b,h){e.values.xhr=a.ajax({url:f.toString(),context:this,type:"POST",contentType:"application/json; charset=utf-8",dataType:"json",data:JSON.stringify(g)}).done(function(a){e.values.xhr=null;var f,g,h,i,j;if(a.success&&a.result){var k=a.result.results;for(g=0;g<k.length;g++)if(f={id:k[g].id,name:k[g].name,title:{el:k[g].title,en:k[g].title},notes:{el:k[g].notes,en:k[g].notes},organization:k[g].organization.id,groups:[],resources:[],spatial:k[g].spatial},!d||f.spatial){for(j=0;j<k[g].groups.length;j++)f.groups.push(k[g].groups[j].id);for(i=0;i<k[g].resources.length;i++)h=k[g].resources[i],"wms"===h.format&&(h["package"]=f.id,h.name={el:h.name,en:h.name},h.description={el:h.description,en:h.description},f.resources.push(h));f.resources.length>0&&e.values.search.packages.push(f)}}b({text:c,packages:e.values.search.packages})}).fail(function(a,b,c){console.log("Failed to search CKAN catalog : "+f.toString()),h(c)})})},getFilteredPackages:function(){return this.values.search.packages},getIndexOfOrganization:function(a){for(var b=0,c=this.values.catalog.organizations.length;c>b;b++)if(this.values.catalog.organizations[b].id===a)return b;return-1},getIndexOfGroup:function(a){for(var b=0,c=this.values.catalog.groups.length;c>b;b++)if(this.values.catalog.groups[b].id===a)return b;return-1},getIndexOfPackage:function(a){for(var b=0,c=this.values.catalog.packages.length;c>b;b++)if(this.values.catalog.packages[b].id===a)return b;return-1},loadOrganizationById:function(c){var d=this,e=new b(this.values.endpoint);return e.segment(["api","3","action","organization_show"]),e.addQuery({id:c,include_datasets:!0}),new Promise(function(b,f){var g=d.getIndexOfOrganization(c);return g>=0&&d.values.catalog.organizations[g].loaded===!0?void b(d.values.catalog.organizations[g]):void a.ajax({url:e.toString(),dataType:"jsonp",context:d}).done(function(a){var c,e=null;if(a.success&&a.result){e={id:a.result.id,name:a.result.name,caption:{el:a.result.display_name,en:a.result.display_name},title:{el:a.result.title,en:a.result.title},description:{el:a.result.description,en:a.result.description},image:a.result.image_display_url,loaded:!0};var f,g,h,i,j,k=a.result.packages;for(g=0;g<k.length;g++){for(f={id:k[g].id,name:k[g].name,title:{el:k[g].title,en:k[g].title},notes:{el:k[g].notes,en:k[g].notes},organization:k[g].organization.id,groups:[],resources:[],spatial:k[g].spatial},j=0;j<k[g].groups.length;j++)f.groups.push(k[g].groups[j].id);for(i=0;i<k[g].resources.length;i++)h=k[g].resources[i],"wms"===h.format&&(h["package"]=f.id,h.name={el:h.name,en:h.name},h.description={el:h.description,en:h.description},f.resources.push(h));f.resources.length>0&&(c=d.getIndexOfPackage(f.id),0>c&&d.values.catalog.packages.push(f))}c=d.getIndexOfOrganization(e.id),0>c?d.values.catalog.organizations.push(e):d.values.catalog.organizations[c].loaded=!0}b(e)}).fail(function(a,b,c){console.log("Failed to load CKAN organization : "+e.toString()),f(c)})})},getOrganizationById:function(a){for(var b=0;b<this.values.catalog.organizations.length;b++)if(this.values.catalog.organizations[b].id===a)return this.values.catalog.organizations[b];return null},loadGroupById:function(c){var d=this,e=new b(this.values.endpoint);return e.segment(["api","3","action","group_show"]),e.addQuery({id:c}),new Promise(function(b,f){var g=d.getIndexOfGroup(c);return g>=0&&d.values.catalog.groups[g].loaded===!0?void b(d.values.catalog.groups[g]):void a.ajax({url:e.toString(),dataType:"jsonp",context:d}).done(function(a){var c,e=null;if(a.success&&a.result){e={id:a.result.id,name:a.result.name,caption:{el:a.result.display_name,en:a.result.display_name},title:{el:a.result.title,en:a.result.title},description:{el:a.result.description,en:a.result.description},image:a.result.image_display_url,loaded:!0};var f,g,h,i,j,k=a.result.packages;for(g=0;g<k.length;g++){for(f={id:k[g].id,name:k[g].name,title:{el:k[g].title,en:k[g].title},notes:{el:k[g].notes,en:k[g].notes},organization:k[g].organization.id,groups:[],resources:[],spatial:k[g].spatial},j=0;j<k[g].groups.length;j++)f.groups.push(k[g].groups[j].id);for(i=0;i<k[g].resources.length;i++)h=k[g].resources[i],"wms"===h.format&&(h["package"]=f.id,h.name={el:h.name,en:h.name},h.description={el:h.description,en:h.description},f.resources.push(h));f.resources.length>0&&(c=d.getIndexOfPackage(f.id),0>c&&d.values.catalog.packages.push(f))}c=d.getIndexOfGroup(e.id),0>c?d.values.catalog.groups.push(e):d.values.catalog.groups[c].loaded=!0}b(e)}).fail(function(a,b,c){console.log("Failed to load CKAN organization : "+e.toString()),f(c)})})},getGroupById:function(a){for(var b=0;b<this.values.catalog.groups.length;b++)if(this.values.catalog.groups[b].id===a)return this.values.catalog.groups[b];return null},loadPackageById:function(c){var d=this,e=new b(this.values.endpoint);return e.segment(["api","3","action","package_show"]),e.addQuery({id:c}),new Promise(function(b,f){var g=d.getIndexOfPackage(c);return g>=0?void b(d.values.catalog.packages[g]):void a.ajax({url:e.toString(),dataType:"jsonp",context:d}).done(function(a){var c,e=null;if(a.success&&a.result){e={id:a.result.id,name:a.result.name,title:a.result.title,notes:a.result.notes,organization:a.result.organization.id,groups:[],resources:[],spatial:a.result.spatial};for(var f=0;f<a.result.groups.length;f++)e.groups.push(a.result.groups[f].id);for(var g=0;g<a.result.resources.length;g++)c=a.result.resources[g],"wms"===c.format&&(c["package"]=e.id,e.resources.push(c));e.resources.length>0&&d.values.catalog.packages.push(e)}b(e)}).fail(function(a,b,c){console.log("Failed to load CKAN package : "+e.toString()),f(c)})})},getPackageById:function(a){var b;if(this.values.catalog.packages)for(b=0;b<this.values.catalog.packages.length;b++)if(this.values.catalog.packages[b].id===a)return this.values.catalog.packages[b];if(this.values.search.packages)for(b=0;b<this.values.search.packages.length;b++)if(this.values.search.packages[b].id===a)return this.values.search.packages[b];return null},getResourceById:function(a){var b,c,d;if(this.values.catalog.packages)for(b=0;b<this.values.catalog.packages.length;b++)if(d=this.values.catalog.packages[b],d.resources)for(c=0;c<d.resources.length;c++)if(d.resources[c].id===a)return d.resources[c];if(this.values.search.packages)for(b=0;b<this.values.search.packages.length;b++)if(d=this.values.search.packages[b],d.resources)for(c=0;c<d.resources.length;c++)if(d.resources[c].id===a)return d.resources[c];return null},getObjectTitle:function(a,b){switch(a){case"group":return this.getGroupById(b).caption;case"organization":return this.getOrganizationById(b).caption;case"package":return this.getPackageById(b).title;default:return""}},getObjectDescription:function(c,d){var e=this;return new Promise(function(f,g){var h={};switch(c){case"group":h={title:e.getGroupById(d).caption,description:e.getGroupById(d).description};break;case"organization":h={title:e.getOrganizationById(d).caption,description:e.getOrganizationById(d).description};break;case"package":h={title:e.getPackageById(d).title,description:e.getPackageById(d).notes};break;default:return void f({})}if(h.description)f(h);else{var i=new b;"/"===e.values.path?i.segment(["metadata",c,d]):i.segment([e.values.path,"metadata",c,d]),a.ajax({url:i.toString().replace(/\/\//g,"/").replace(/:\//g,"://"),context:e}).done(function(a){if(a.success){switch(c){case"group":e.getGroupById(d).description=a.text;break;case"organization":e.getOrganizationById(d).description=a.text;break;case"package":e.getPackageById(d).notes=a.text}h.description=a.text,f(h)}else g(null)}).fail(function(a,b,c){console.log("Failed to object description : "+i.toString()),g(c)})}})}})});
//# sourceMappingURL=ckan.min.js.map