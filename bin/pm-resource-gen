#!/usr/bin/python

import sys
import os
import json
import csv
import argparse
import urlparse
import requests

# ./resource_gen.py -output ~/ -catalog http://web.dev.publicamundi.eu/ -timeout 30

def get_orginizations(catalog, timeout, metadata, verbose):
    # Example : http://labs.geodata.gov.gr/api/3/action/organization_list?all_fields=true

    metadata['organizations'] = []

    resource = urlparse.urljoin(catalog, 'api/3/action/organization_list?all_fields=true')
    request_organizations = requests.get(resource, timeout = timeout)

    if request_organizations.status_code == 200:
        organizations = request_organizations.json()
        if organizations['success'] == True:
            for o in organizations['result']:
                query = '?lang_codes=el'

                organization = {
                    'id': o['id'],
                    'name': o['name'],
                    'caption': {
                        'en': o['display_name'],
                        'el': o['display_name']
                    },
                    'title': {
                        'en': o['title'],
                        'el': o['title']
                    },
                     'description': {
                         'en': o['description'],
                         'el': o['description']
                     },
                    'image': o['image_display_url']
                }

                fields = {
                    'caption': o['display_name'],
                    'description': o['description'],
                    'title' : o['title']
                }

                for f in fields:
                    query = query + '&terms=' + fields[f]

                    resource = urlparse.urljoin(catalog, 'api/3/action/term_translation_show' + query)
                    translation_request = requests.get(resource, timeout = timeout)

                    if translation_request.status_code == 200:
                        translation = translation_request.json()
                        if translation['success'] == True:
                            for t in translation['result']:
                                if organization[f]['en'] == t['term']:
                                    organization[f]['el'] = t['term_translation']

                metadata['organizations'].append(organization)

def get_groups(catalog, groups, timeout, metadata, verbose):
    group_translations = None

    if groups:
        group_translations = {}

        with open(groups, mode='r') as topics_file:
            reader = csv.reader(topics_file)
            for row in reader:
                group_translations[row[0]] = {
                    'title_el' : row[1],
                    'title_en' : row[2],
                    'description_el' : row[3],
                    'description_en' : row[4],
                    'logo_url' : row[5]
                }

    # Example : http://labs.geodata.gov.gr/api/3/action/group_list?all_fields=true

    metadata['groups'] = []

    resource = urlparse.urljoin(catalog, 'api/3/action/group_list?all_fields=true')
    request_groups = requests.get(resource, timeout = timeout)

    if request_groups.status_code == 200:
        groups = request_groups.json()
        if groups['success'] == True:
            for g in groups['result']:
                name = g['name']

                translate = True

                title_en = g['title']
                title_el = g['title']

                description_en = g['description']
                description_el = g['description']

                if not group_translations is None and name in group_translations:
                    translate = False

                    title_en = group_translations[name]['title_en']
                    title_el = group_translations[name]['title_el']

                    description_en = group_translations[name]['description_en']
                    description_el = group_translations[name]['description_el']

                group = {
                    'id': g['id'],
                    'name': name,
                    'caption': {
                        'en': title_en,
                        'el': title_el
                    },
                    'title': {
                        'en': title_en,
                        'el': title_el
                    },
                     'description': {
                         'en': description_en,
                         'el': description_el
                     },
                    'image': g['image_display_url']
                }

                if translate:
                    query = '?lang_codes=el'

                    fields = {
                        'caption': g['title'],
                        'description': g['description'],
                        'title' : g['title']
                    }

                    for f in fields:
                        query = query + '&terms=' + fields[f]

                        resource = urlparse.urljoin(catalog, 'api/3/action/term_translation_show' + query)
                        translation_request = requests.get(resource, timeout = timeout)

                        if translation_request.status_code == 200:
                            translation = translation_request.json()
                            if translation['success'] == True:
                                for t in group['result']:
                                    if group[f]['en'] == t['term']:
                                        group[f]['el'] = t['term_translation']

                metadata['groups'].append(group)

def get_packages(catalog, timeout, metadata, verbose):
    metadata['packages'] = []

    organizations = [ p['id'] for p in metadata['organizations'] ]
    groups = [ p['id'] for p in metadata['groups'] ]

    # Example : http://web.dev.publicamundi.eu/api/3/action/organization_show?id=b710fb7c-8f69-470e-9f35-f64364aab3ce&include_datasets=true
    if len(organizations) > 0:
        counter = 0
        total = len(organizations)

        if verbose:
            print 'Loading packages for organizations ...'

        for oId in organizations:
            counter += 1

            resource = urlparse.urljoin(catalog, 'api/3/action/organization_show?id=' + oId + '&include_datasets=true')
            request_packages = requests.get(resource, timeout = timeout)

            if request_packages.status_code == 200:
                packages = request_packages.json()
                if packages['success'] == True:
                    for p in packages['result']['packages']:
                        load_package(catalog, timeout, metadata, p)

            if verbose:
                progress = 100 * counter / total

                # http://stackoverflow.com/questions/3173320/text-progress-bar-in-the-console
                sys.stdout.write('\r[{0}] {1}%'.format(('#'*(progress/5)).ljust(20), progress))
                sys.stdout.flush()

        if verbose: print ''

    # Example : http://web.dev.publicamundi.eu/api/3/action/group_show?id=ddf6fadb-d87a-40ca-b930-5ac68e421732
    if len(groups) > 0:
        counter = 0
        total = len(groups)

        if verbose:
            print 'Loading packages for groups ...'

        for oId in groups:
            counter += 1

            resource = urlparse.urljoin(catalog, 'api/3/action/group_show?id=' + oId)
            request_packages = requests.get(resource, timeout = timeout)

            if request_packages.status_code == 200:
                packages = request_packages.json()
                if packages['success'] == True:
                    for p in packages['result']['packages']:
                        load_package(catalog, timeout, metadata, p)

            if verbose:
                progress = 100 * counter / total

                sys.stdout.write('\r[{0}] {1}%'.format(('#'*(progress/5)).ljust(20), progress))
                sys.stdout.flush()

        if verbose: print ''

def load_package(catalog, timeout, metadata, p):
    if not p['id'] in [ existing['id'] for existing in metadata['packages'] ]:
        query = '?lang_codes=el'

        package = {
            'id': p['id'],
            'name': p['name'],
            'title': {
                'el': p['title'],
                'en': p['title']
            },
            'notes': {
                'el': p['notes'],
                'en': p['notes']
            },
            'organization': p['organization']['id'],
            'groups': [],
            'resources': []
        }

        if 'spatial' in p:
            package['spatial'] = p['spatial']

        if 'groups' in p:
            for g in p['groups']:
               package['groups'].append(g['id'])

        if 'resources' in p:
            for r in p['resources']:
                if r['format'] == 'wms':
                    resource = {
                        'id': r['id'],
                        'resource_group_id': r['resource_group_id'],
                        'format': r['format'],
                        'name': {
                            'el': r['name'],
                            'en': r['name']
                        },
                        'description': {
                            'el': r['description'],
                            'en': r['description']
                        },
                        'url': r['url'],
                        'package': p['id']
                    }
                    if 'wms_server' in r:
                        resource['wms_server'] = r['wms_server']
                    if 'wms_layer' in r:
                        resource['wms_layer'] = r['wms_layer']
                    if 'parent_resource_id' in r:
                        resource['parent_resource_id'] = r['parent_resource_id']

                    package['resources'].append(resource)

        if len(package['resources']) > 0:
            metadata['packages'].append(package)

def get_metadata(output, catalog, groups, timeout, pretty, verbose):
    parts = urlparse.urlsplit(catalog)

    if not parts.scheme or not parts.netloc:
        raise Exception('Invalid URL.')

    if not os.path.isdir(output):
        raise Exception('Folder [{output}] does not exist.'.format(output = output))

    if not groups is None and not os.path.isfile(groups):
        raise Exception('File [{groups}] does not exist.'.format(groups = groups))

    try:
        metadata = {
            'organizations': [],
            'groups': [],
            'packages': []
        }

        if verbose:
            print 'Loading organizations ...'
        get_orginizations(catalog, timeout, metadata, verbose)

        if verbose:
            print 'Loading groups ...'
        get_groups(catalog, groups, timeout, metadata, verbose)

        get_packages(catalog, timeout, metadata, verbose)

        filename = os.path.join(output, 'metadata.json')

        if os.path.exists(filename):
            os.remove(filename)

        with open(filename, 'w') as outfile:
            if pretty:
                json.dump(metadata, outfile, indent=4, separators=(',', ': '))
            else:
                json.dump(metadata, outfile)

        if verbose:
            print 'Export completed. Metadata is writen at [{filename}].'.format(filename = filename)
    except requests.exceptions.HTTPError as ex:
        print 'Export has failed (HTTPError): ' + str(ex)
    except requests.exceptions.ConnectionError as ex:
        print 'Export has failed (ConnectionError): ' + str(ex)
    except requests.exceptions.Timeout as ex:
        print 'Export has failed (Timeout): ' + str(ex)


try:
    parser = argparse.ArgumentParser(description='Downloads organization, group and package metadata from the catalog and extracts information for the Map Client application')
    parser.add_argument('-output', '-o', metavar='path', type=str, help='Folder where the produced files are created', required=True)
    parser.add_argument('-catalog', '-c', metavar='url', type=str, help='CKAN catalog endpoint', required=True)
    parser.add_argument('-group', '-g', metavar='groups', type=str, help='CSV with CKAN topics used for initialization', required=False)
    parser.add_argument('-timeout', '-t', metavar='N', type=int, help='HTTP requests will timeout after N seconds', required=False, default=30)
    parser.add_argument('-pretty', '-p', action='store_true', help='JSON elements and object members will be pretty-printed')
    parser.add_argument('-verbose', '-v', action='store_true', help='Print detailed information for export execution')

    args = parser.parse_args()

    get_metadata(args.output, args.catalog, args.group, args.timeout, args.pretty, args.verbose)
except Exception as ex:
    print 'Export has failed: ' + str(ex)
